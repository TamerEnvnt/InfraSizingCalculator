@page "/"
@using InfraSizingCalculator.Models
@using InfraSizingCalculator.Services
@using InfraSizingCalculator.Components.Modals
@using InfraSizingCalculator.Components.Layout
@using InfraSizingCalculator.Components.Shared
@using InfraSizingCalculator.Components.K8s
@using InfraSizingCalculator.Components.VM
@using InfraSizingCalculator.Services.Interfaces
@using InfraSizingCalculator.Models.Pricing
@using InfraSizingCalculator.Models.Growth
@rendermode InteractiveServer

<PageTitle>Infrastructure Sizing Calculator</PageTitle>

<!-- Three-Panel SPA Layout -->
<HeaderBar OnAction="HandleHeaderAction" />

<LeftSidebar CurrentStep="@currentStep"
             TotalSteps="@GetTotalSteps()"
             StepLabelProvider="GetStepLabel"
             StepSelectionProvider="GetStepSelection"
             OnStepSelected="GoToStep"
             ShowResultsSection="@ShouldShowResultsSection()"
             ActiveResultTab="@GetActiveResultsTab()"
             OnResultTabSelected="HandleResultTabSelected"
             InsightsCount="@GetInsightsCount()"
             CriticalCount="@GetCriticalCount()" />

<div class="main-content">
    <!-- Wizard Content - Only show current step -->
    <div class="wizard-content">
        <!-- Step 1: Platform Type -->
        @if (currentStep == 1)
        {
            <div class="section-header">
                <span class="section-title">Select Platform Type</span>
                <button class="info-btn" @onclick="() => ShowInfo(InfoType.Platform)">?</button>
            </div>
            <div class="selection-grid">
                <div class="selection-card @(selectedPlatform == PlatformType.Native ? "selected" : "")"
                     @onclick="() => SelectPlatformAsync(PlatformType.Native)">
                    <span class="brand-icon native large"></span>
                    <div class="card-title">Native Applications</div>
                    <div class="card-desc">.NET, Java, Node.js, Python, Go</div>
                </div>
                <div class="selection-card @(selectedPlatform == PlatformType.LowCode ? "selected" : "")"
                     @onclick="() => SelectPlatformAsync(PlatformType.LowCode)">
                    <span class="brand-icon lowcode large"></span>
                    <div class="card-title">Low-Code Platform</div>
                    <div class="card-desc">Mendix, OutSystems</div>
                </div>
            </div>
        }

        <!-- Step 2: Deployment Model -->
        @if (currentStep == 2)
        {
            <div class="section-header">
                <span class="section-title">Select Deployment Model</span>
                <button class="info-btn" @onclick="() => ShowInfo(InfoType.Deployment)">?</button>
            </div>
            <div class="selection-grid">
                <div class="selection-card @(selectedDeployment == DeploymentModel.Kubernetes ? "selected" : "")"
                     @onclick="() => SelectDeploymentAsync(DeploymentModel.Kubernetes)">
                    <span class="brand-icon kubernetes large"></span>
                    <div class="card-title">Kubernetes</div>
                    <div class="card-desc">Container orchestration with auto-scaling and self-healing</div>
                </div>
                <div class="selection-card @(selectedDeployment == DeploymentModel.VMs ? "selected" : "")"
                     @onclick="() => SelectDeploymentAsync(DeploymentModel.VMs)">
                    <span class="brand-icon vm large"></span>
                    <div class="card-title">Virtual Machines</div>
                    <div class="card-desc">Traditional VM deployment with dedicated servers</div>
                </div>
            </div>
        }

        <!-- Step 3: Technology Selection -->
        @if (currentStep == 3)
        {
            <div class="section-header">
                <span class="section-title">Select Technology</span>
                <button class="info-btn" @onclick="() => ShowInfo(InfoType.Technology)">?</button>
            </div>
            <div class="tech-grid">
                @foreach (var tech in GetAvailableTechnologies())
                {
                    <div class="tech-card @(selectedTechnology == tech.Technology ? "selected" : "")"
                         style="--brand-color: @tech.BrandColor"
                         @onclick="() => SelectTechnologyAsync(tech.Technology)">
                        <div class="tech-header">
                            <span class="brand-icon @tech.Icon large"></span>
                            <div>
                                <div class="tech-name">@tech.Name</div>
                                <div class="tech-vendor">@tech.Vendor</div>
                            </div>
                            <button class="card-info-btn" @onclick:stopPropagation="true" @onclick="() => ShowTechInfo(tech.Technology)" title="More info">?</button>
                        </div>
                        <div class="tech-desc">@tech.Description</div>
                        <div class="tech-tags">
                            <span class="tech-tag @(tech.IsLowCode ? "lowcode" : "native")">
                                @(tech.IsLowCode ? "Low-Code" : "Native")
                            </span>
                        </div>
                    </div>
                }
            </div>
        }

        <!-- Step 4: Kubernetes Distribution (or Mendix Deployment Options) -->
        @if (currentStep == 4 && selectedDeployment == DeploymentModel.Kubernetes)
        {
            @if (selectedTechnology == Technology.Mendix)
            {
                <!-- Mendix Deployment Options -->
                <div class="section-header">
                    <span class="section-title">Select Mendix Deployment</span>
                    <button class="info-btn" @onclick="() => ShowMendixDeploymentInfo()">?</button>
                </div>

                <!-- Mendix Deployment Category Selection -->
                <div class="mendix-deployment-categories">
                    <div class="mendix-category-card @(mendixDeploymentCategory == MendixDeploymentCategory.Cloud ? "selected" : "")"
                         @onclick="() => SelectMendixCategory(MendixDeploymentCategory.Cloud)">
                        <span class="cat-icon cloud"></span>
                        <div class="category-content">
                            <div class="category-name">Mendix Cloud</div>
                            <div class="category-desc">Fully managed SaaS or Dedicated cloud hosting by Siemens</div>
                        </div>
                        <div class="category-badge recommended">Recommended</div>
                    </div>

                    <div class="mendix-category-card @(mendixDeploymentCategory == MendixDeploymentCategory.PrivateCloud ? "selected" : "")"
                         @onclick="() => SelectMendixCategory(MendixDeploymentCategory.PrivateCloud)">
                        <span class="cat-icon private"></span>
                        <div class="category-content">
                            <div class="category-name">Private Cloud</div>
                            <div class="category-desc">Deploy on Azure, EKS, AKS, GKE, or OpenShift with official support</div>
                        </div>
                        <div class="category-badge supported">Officially Supported</div>
                    </div>

                    <div class="mendix-category-card @(mendixDeploymentCategory == MendixDeploymentCategory.Other ? "selected" : "")"
                         @onclick="() => SelectMendixCategory(MendixDeploymentCategory.Other)">
                        <span class="cat-icon manual"></span>
                        <div class="category-content">
                            <div class="category-name">Other Kubernetes</div>
                            <div class="category-desc">Rancher, K3s, Generic K8s - manual Mendix operator setup</div>
                        </div>
                        <div class="category-badge manual">Manual Setup</div>
                    </div>
                </div>

                <!-- Sub-options based on selected category -->
                @if (mendixDeploymentCategory == MendixDeploymentCategory.Cloud)
                {
                    <div class="mendix-suboptions">
                        <h4>Select Cloud Type</h4>
                        <div class="mendix-option-cards cloud-type">
                            <div class="mendix-option-card @(mendixCloudType == MendixCloudType.SaaS ? "selected" : "")"
                                 @onclick="() => SelectMendixCloudType(MendixCloudType.SaaS)">
                                <span class="brand-icon mendix"></span>
                                <div class="option-name">SaaS (Multi-tenant)</div>
                            </div>
                            <div class="mendix-option-card @(mendixCloudType == MendixCloudType.Dedicated ? "selected" : "")"
                                 @onclick="() => SelectMendixCloudType(MendixCloudType.Dedicated)">
                                <span class="brand-icon mendix"></span>
                                <div class="option-name">Dedicated (Single-tenant)</div>
                            </div>
                        </div>
                    </div>
                }

                @if (mendixDeploymentCategory == MendixDeploymentCategory.PrivateCloud)
                {
                    <div class="mendix-suboptions">
                        <h4>Select Private Cloud Provider <span class="header-badge">Officially Supported</span></h4>
                        <div class="mendix-option-cards">
                            <div class="mendix-option-card azure @(mendixPrivateCloudProvider == MendixPrivateCloudProvider.Azure ? "selected" : "")"
                                 @onclick="() => SelectMendixPrivateCloudProvider(MendixPrivateCloudProvider.Azure)">
                                <span class="brand-icon azure"></span>
                                <div class="option-name">Mendix Azure</div>
                            </div>
                            <div class="mendix-option-card @(mendixPrivateCloudProvider == MendixPrivateCloudProvider.EKS ? "selected" : "")"
                                 @onclick="() => SelectMendixPrivateCloudProvider(MendixPrivateCloudProvider.EKS)">
                                <span class="brand-icon eks"></span>
                                <div class="option-name">Amazon EKS</div>
                            </div>
                            <div class="mendix-option-card @(mendixPrivateCloudProvider == MendixPrivateCloudProvider.AKS ? "selected" : "")"
                                 @onclick="() => SelectMendixPrivateCloudProvider(MendixPrivateCloudProvider.AKS)">
                                <span class="brand-icon aks"></span>
                                <div class="option-name">Azure AKS</div>
                            </div>
                            <div class="mendix-option-card @(mendixPrivateCloudProvider == MendixPrivateCloudProvider.GKE ? "selected" : "")"
                                 @onclick="() => SelectMendixPrivateCloudProvider(MendixPrivateCloudProvider.GKE)">
                                <span class="brand-icon gke"></span>
                                <div class="option-name">Google GKE</div>
                            </div>
                            <div class="mendix-option-card @(mendixPrivateCloudProvider == MendixPrivateCloudProvider.OpenShift ? "selected" : "")"
                                 @onclick="() => SelectMendixPrivateCloudProvider(MendixPrivateCloudProvider.OpenShift)">
                                <span class="brand-icon openshift"></span>
                                <div class="option-name">OpenShift</div>
                            </div>
                        </div>
                    </div>
                }

                @if (mendixDeploymentCategory == MendixDeploymentCategory.Other)
                {
                    <div class="mendix-suboptions">
                        <h4>Select K8s Provider <span class="header-badge manual">Manual Setup</span></h4>
                        <div class="mendix-option-cards other-k8s">
                            <div class="mendix-option-card manual @(mendixPrivateCloudProvider == MendixPrivateCloudProvider.Rancher ? "selected" : "")"
                                 @onclick="() => SelectMendixPrivateCloudProvider(MendixPrivateCloudProvider.Rancher)">
                                <span class="brand-icon rancher"></span>
                                <div class="option-name">Rancher</div>
                            </div>
                            <div class="mendix-option-card manual @(mendixPrivateCloudProvider == MendixPrivateCloudProvider.K3s ? "selected" : "")"
                                 @onclick="() => SelectMendixPrivateCloudProvider(MendixPrivateCloudProvider.K3s)">
                                <span class="brand-icon k3s"></span>
                                <div class="option-name">K3s</div>
                            </div>
                            <div class="mendix-option-card manual @(mendixPrivateCloudProvider == MendixPrivateCloudProvider.GenericK8s ? "selected" : "")"
                                 @onclick="() => SelectMendixPrivateCloudProvider(MendixPrivateCloudProvider.GenericK8s)">
                                <span class="brand-icon k8s"></span>
                                <div class="option-name">Generic K8s</div>
                            </div>
                        </div>
                    </div>
                }
            }
            else
            {
                <!-- Standard Kubernetes Distribution Selection -->
                <div class="section-header">
                    <span class="section-title">Select Kubernetes Distribution</span>
                    <button class="info-btn" @onclick="() => ShowInfo(InfoType.Distribution)">?</button>
                </div>

                <!-- Distribution Tabs + Search (inline) -->
                <div class="distro-header-row">
                    <div class="distro-tabs">
                        <button class="distro-tab @(distributionFilter == "on-prem" ? "active" : "")"
                                @onclick='() => SetDistroFilter("on-prem")'>
                            <span class="brand-icon vm small"></span>
                            <span class="tab-text">Self-Managed</span>
                            <span class="tab-count">@GetDistributionCount("on-prem")</span>
                        </button>
                        <button class="distro-tab @(distributionFilter == "cloud" ? "active" : "")"
                                @onclick='() => SetDistroFilter("cloud")'>
                            <span class="cat-icon cloud" style="width:20px;height:20px;font-size:0.6rem;"></span>
                            <span class="tab-text">Cloud</span>
                            <span class="tab-count">@GetDistributionCount("cloud")</span>
                        </button>
                    </div>
                    <div class="distro-search-inline highlighted">
                        <span class="search-icon icon-search"></span>
                        <input type="text"
                               placeholder="Search distributions..."
                               @bind="distributionSearch"
                               @bind:event="oninput"
                               class="distro-search-input" />
                        @if (!string.IsNullOrEmpty(distributionSearch))
                        {
                            <button class="clear-search" @onclick="() => distributionSearch = string.Empty">Ã—</button>
                        }
                    </div>
                </div>

                @if (distributionFilter == "cloud")
                {
                    <!-- Cloud Sub-Categories (without "All" button) -->
                    <div class="cloud-category-chips">
                        <button class="category-chip major @(cloudCategory == "major" ? "active" : "")"
                                @onclick='() => cloudCategory = "major"'>Major</button>
                        <button class="category-chip openshift @(cloudCategory == "openshift" ? "active" : "")"
                                @onclick='() => cloudCategory = "openshift"'>OpenShift</button>
                        <button class="category-chip rancher @(cloudCategory == "rancher" ? "active" : "")"
                                @onclick='() => cloudCategory = "rancher"'>SUSE</button>
                        <button class="category-chip tanzu @(cloudCategory == "tanzu" ? "active" : "")"
                                @onclick='() => cloudCategory = "tanzu"'>Tanzu</button>
                        <button class="category-chip ubuntu @(cloudCategory == "ubuntu" ? "active" : "")"
                                @onclick='() => cloudCategory = "ubuntu"'>Canonical</button>
                        <button class="category-chip developer @(cloudCategory == "developer" ? "active" : "")"
                                @onclick='() => cloudCategory = "developer"'>Developer</button>
                    </div>
                }

                <!-- Distribution Grid -->
                <div class="distro-grid">
                    @{ var filteredDistros = GetFilteredDistributions().ToList(); }
                    @if (filteredDistros.Count == 0)
                    {
                        <div class="no-results">
                            <span>No distributions found matching "@distributionSearch"</span>
                            <button class="btn-text" @onclick="() => distributionSearch = string.Empty">Clear search</button>
                        </div>
                    }
                    else
                    {
                        @foreach (var distro in filteredDistros)
                        {
                            <div class="distro-card @(selectedDistribution == distro.Distribution ? "selected" : "")"
                                 style="--brand-color: @distro.BrandColor"
                                 @onclick="() => SelectDistributionAsync(distro.Distribution)">
                                <div class="distro-header">
                                    <span class="brand-icon @distro.Icon large"></span>
                                    <div>
                                        <div class="distro-name">@distro.Name</div>
                                        <div class="distro-vendor">@distro.Vendor</div>
                                    </div>
                                    <button class="card-info-btn" @onclick:stopPropagation="true" @onclick="() => ShowDistroInfo(distro.Distribution)" title="More info">?</button>
                                </div>
                                <div class="distro-tags">
                                    @foreach (var tag in distro.Tags)
                                    {
                                        <span class="distro-tag @tag.CssClass">@tag.Label</span>
                                    }
                                </div>
                            </div>
                        }
                    }
                </div>
            }
        }

        <!-- Step 5: Configuration (Tabbed Interface) -->
        @if (currentStep == 5 && selectedDeployment == DeploymentModel.Kubernetes && selectedDistribution != null)
        {
            var distroConfig = DistributionService.GetConfig(selectedDistribution.Value);

            <div class="config-layout">
                <!-- Left: Cluster Mode Selection -->
                <div class="cluster-mode-sidebar">
                    <div class="sidebar-header">
                        <span>Cluster Mode</span>
                        <button class="info-btn small" @onclick="() => ShowInfo(InfoType.ClusterMode)">?</button>
                    </div>
                    <div class="cluster-mode-options">
                        <div class="mode-option @(selectedClusterMode == ClusterMode.MultiCluster ? "selected" : "")"
                             @onclick="() => SelectClusterMode(ClusterMode.MultiCluster)">
                            <span class="mode-icon multi"></span>
                            <div class="mode-text">
                                <span class="mode-name">Multi-Cluster</span>
                                <span class="mode-desc">One cluster per env</span>
                            </div>
                        </div>
                        <div class="mode-option @(IsSingleClusterMode() ? "selected" : "")"
                             @onclick="() => SelectClusterMode(ClusterMode.SharedCluster)">
                            <span class="mode-icon single"></span>
                            <div class="mode-text">
                                <span class="mode-name">Single Cluster</span>
                                <span class="mode-desc">One cluster total</span>
                            </div>
                        </div>
                    </div>

                    <!-- Single Cluster Options -->
                    @if (IsSingleClusterMode())
                    {
                        <div class="single-cluster-selector">
                            <label>Cluster Scope:</label>
                            <select @bind="singleClusterScope">
                                <option value="Shared">Shared Cluster</option>
                                <option value="Dev">Dev Only</option>
                                <option value="Test">Test Only</option>
                                <option value="Stage">Stage Only</option>
                                <option value="Prod">Prod Only</option>
                                <option value="DR">DR Only</option>
                            </select>
                        </div>
                    }
                </div>

                <!-- Right: Tabbed Configuration -->
                <div class="config-tabs-container">
                    <!-- Tab Headers -->
                    <div class="config-tabs">
                        <button class="config-tab @(configTab == "apps" ? "active" : "")" @onclick='() => configTab = "apps"'>
                            Applications
                        </button>
                        <button class="config-tab @(configTab == "nodes" ? "active" : "")" @onclick='() => configTab = "nodes"'>
                            Node Specs
                        </button>
                        <button class="config-tab @(configTab == "settings" ? "active" : "")" @onclick='() => configTab = "settings"'>
                            Settings
                        </button>
                        <button class="config-tab @(configTab == "hadr" ? "active" : "")" @onclick='() => configTab = "hadr"'>
                            HA & DR
                        </button>
                        @if (selectedTechnology == Technology.Mendix)
                        {
                            <button class="config-tab @(configTab == "mendix" ? "active" : "")" @onclick='() => configTab = "mendix"'>
                                Mendix
                            </button>
                        }
                    </div>

                    <!-- Tab Content -->
                    <div class="config-tab-content">
                        <!-- Applications Tab -->
                        @if (configTab == "apps")
                        {
                            <div class="tab-panel">
                                @if (selectedClusterMode == ClusterMode.MultiCluster)
                                {
                                    <!-- Environment Selection for Multi-Cluster Mode -->
                                    <div class="cluster-selection-bar">
                                        <span class="selection-label">Include environments:</span>
                                        <div class="cluster-chips">
                                            @foreach (var env in new[] { EnvironmentType.Dev, EnvironmentType.Test, EnvironmentType.Stage, EnvironmentType.Prod })
                                            {
                                                <label class="cluster-chip @(IsEnvironmentEnabled(env) ? "selected" : "") @(IsProdEnvironment(env) ? "prod" : "nonprod")">
                                                    <input type="checkbox"
                                                           checked="@IsEnvironmentEnabled(env)"
                                                           disabled="@(env == EnvironmentType.Prod)"
                                                           @onchange="(e) => ToggleEnvironment(env, (bool)e.Value!)" />
                                                    <span>@env</span>
                                                </label>
                                            }
                                        </div>
                                    </div>
                                }

                                <!-- App Tiers Configuration - K8sAppsConfig handles all display -->
                                <K8sAppsConfig IsSingleCluster="@IsSingleClusterMode()"
                                               EnabledEnvironments="@enabledEnvironments"
                                               EnvironmentApps="@envApps"
                                               EnvironmentAppsChanged="@((apps) => envApps = apps)"
                                               GetTierSpecFunc="@GetTierSpec" />
                            </div>
                        }

                        <!-- Node Specs Tab -->
                        @if (configTab == "nodes")
                        {
                            <div class="tab-panel">
                                <K8sNodeSpecsConfig IsSingleCluster="@IsSingleClusterMode()"
                                                    EnabledEnvironments="@enabledEnvironments"
                                                    NodeSpecs="@nodeSpecs"
                                                    NodeSpecsChanged="@((specs) => nodeSpecs = specs)"
                                                    HasManagedControlPlane="@distroConfig.HasManagedControlPlane"
                                                    HasInfraNodes="@distroConfig.HasInfraNodes"
                                                    VendorName="@distroConfig.Vendor" />
                            </div>
                        }

                        <!-- Settings Tab -->
                        @if (configTab == "settings")
                        {
                            <div class="tab-panel">
                                <div class="settings-grid-compact">
                                    <!-- Headroom -->
                                    <div class="settings-section-compact">
                                        <div class="settings-section-title">Headroom (Buffer %)</div>
                                        <div class="settings-row">
                                            @foreach (var env in GetVisibleEnvironments())
                                            {
                                                <div class="setting-item">
                                                    <label>@env</label>
                                                    <input type="number" step="0.5" min="0" max="100"
                                                           value="@headroom.GetValueOrDefault(env, 20)"
                                                           disabled="@(!IsEnvironmentEnabled(env))"
                                                           @onchange="@(e => headroom[env] = ParseDouble(e.Value))" />
                                                    <span class="unit">%</span>
                                                </div>
                                            }
                                        </div>
                                    </div>

                                    <!-- Replicas -->
                                    <div class="settings-section-compact">
                                        <div class="settings-section-title">Replicas (Pod Instances)</div>
                                        <div class="settings-row">
                                            @foreach (var env in GetVisibleEnvironments())
                                            {
                                                <div class="setting-item">
                                                    <label>@env</label>
                                                    <input type="number" min="1" max="10"
                                                           value="@replicas.GetValueOrDefault(env, 1)"
                                                           disabled="@(!IsEnvironmentEnabled(env))"
                                                           @onchange="@(e => replicas[env] = ParseInt(e.Value))" />
                                                </div>
                                            }
                                        </div>
                                    </div>

                                    <!-- Overcommit -->
                                    <div class="settings-section-compact">
                                        <div class="settings-section-title">Resource Overcommit Ratios</div>
                                        <p class="settings-hint">1.0 = no overcommit, higher values allow more workloads per node</p>
                                        <div class="overcommit-grid">
                                            <div class="overcommit-group">
                                                <span class="group-title">Production</span>
                                                <div class="overcommit-inputs-compact">
                                                    <div class="setting-item">
                                                        <label>CPU Ratio</label>
                                                        <input type="number" step="0.1" min="0.5" max="4.0" @bind="prodCpuOvercommit" />
                                                    </div>
                                                    <div class="setting-item">
                                                        <label>Memory Ratio</label>
                                                        <input type="number" step="0.1" min="0.5" max="4.0" @bind="prodMemoryOvercommit" />
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="overcommit-group">
                                                <span class="group-title">Non-Production</span>
                                                <div class="overcommit-inputs-compact">
                                                    <div class="setting-item">
                                                        <label>CPU Ratio</label>
                                                        <input type="number" step="0.1" min="0.5" max="4.0" @bind="nonProdCpuOvercommit" />
                                                    </div>
                                                    <div class="setting-item">
                                                        <label>Memory Ratio</label>
                                                        <input type="number" step="0.1" min="0.5" max="4.0" @bind="nonProdMemoryOvercommit" />
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }

                        <!-- HA & DR Tab -->
                        @if (configTab == "hadr")
                        {
                            <div class="tab-panel">
                                <K8sHADRPanel Config="@k8sHADRConfig"
                                              ConfigChanged="@((config) => k8sHADRConfig = config)"
                                              Distribution="@(selectedDistribution ?? Distribution.EKS)" />
                            </div>
                        }

                        <!-- Mendix Tab -->
                        @if (configTab == "mendix" && selectedTechnology == Technology.Mendix)
                        {
                            <div class="tab-panel">
                                <div class="mendix-settings">
                                    <h4 class="settings-section-title">Operator Settings</h4>
                                    <div class="setting-item-large">
                                        <label>Mendix Operator Replicas</label>
                                        <input type="number" min="1" max="5" @bind="mendixOperatorReplicas" />
                                        <span class="hint">Number of Mendix operator instances for high availability</span>
                                    </div>

                                    <h4 class="settings-section-title">Licensing Configuration</h4>

                                    @if (mendixDeploymentCategory != MendixDeploymentCategory.Cloud)
                                    {
                                        <!-- Environment Count (for Private Cloud/Other) -->
                                        <div class="setting-item-large">
                                            <label>Number of Environments</label>
                                            <input type="number" min="1" max="500" @bind="mendixNumberOfEnvironments" />
                                            <span class="hint">Total Mendix environments to license (default: 3)</span>
                                        </div>
                                    }

                                    <!-- User Licensing (all deployment paths) -->
                                    <div class="settings-row">
                                        <div class="setting-item-half">
                                            <label>Internal Users</label>
                                            <input type="number" min="0" step="100" @bind="mendixInternalUsers" />
                                            <span class="hint">Priced per 100 users ($40,800/year)</span>
                                        </div>
                                        <div class="setting-item-half">
                                            <label>External Users (thousands)</label>
                                            <input type="number" min="0" step="250" @bind="mendixExternalUsers" />
                                            <span class="hint">Priced per 250K ($60,000/year)</span>
                                        </div>
                                    </div>

                                    @if (mendixDeploymentCategory == MendixDeploymentCategory.Cloud)
                                    {
                                        <div class="info-note">
                                            <span class="icon icon-bulb"></span>
                                            Resource pack configuration is available in the Pricing step for Mendix Cloud deployments.
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }

        <!-- Step 4: Mendix VM Deployment Options (LowCode + VMs) -->
        @if (currentStep == 4 && selectedDeployment == DeploymentModel.VMs && selectedTechnology == Technology.Mendix)
        {
            <div class="section-header">
                <span class="section-title">Select Mendix Deployment Type</span>
                <button class="info-btn" @onclick="() => ShowMendixDeploymentInfo()">?</button>
            </div>

            <div class="mendix-deployment-categories">
                <div class="mendix-category-card @(mendixOtherDeployment == MendixOtherDeployment.Server ? "selected" : "")"
                     @onclick="() => SelectMendixVMDeployment(MendixOtherDeployment.Server)">
                    <span class="brand-icon vm"></span>
                    <div class="category-content">
                        <div class="category-name">Server (VMs/Docker)</div>
                        <div class="category-desc">Traditional VM or Docker container deployment</div>
                        <div class="category-price">$6,612/app or $33,060 unlimited/year</div>
                    </div>
                </div>
                <div class="mendix-category-card @(mendixOtherDeployment == MendixOtherDeployment.StackIT ? "selected" : "")"
                     @onclick="() => SelectMendixVMDeployment(MendixOtherDeployment.StackIT)">
                    <span class="brand-icon native"></span>
                    <div class="category-content">
                        <div class="category-name">StackIT</div>
                        <div class="category-desc">Schwarz IT cloud platform</div>
                        <div class="category-price">$6,612/app or $33,060 unlimited/year</div>
                    </div>
                </div>
                <div class="mendix-category-card @(mendixOtherDeployment == MendixOtherDeployment.SapBtp ? "selected" : "")"
                     @onclick="() => SelectMendixVMDeployment(MendixOtherDeployment.SapBtp)">
                    <span class="brand-icon sap"></span>
                    <div class="category-content">
                        <div class="category-name">SAP BTP</div>
                        <div class="category-desc">SAP Business Technology Platform</div>
                        <div class="category-price">$6,612/app or $33,060 unlimited/year</div>
                    </div>
                </div>
            </div>

            <p class="info-note" style="margin-top: 1rem;">
                <span class="icon icon-bulb"></span> <strong>Note:</strong> These deployment options do not use Kubernetes.
                For Kubernetes-based deployments, select <strong>Kubernetes</strong> in Step 2.
            </p>
        }

        <!-- VM Configuration (at config step for VMs) -->
        @if (currentStep == GetConfigStep() && selectedDeployment == DeploymentModel.VMs)
        {
            <div class="config-layout">
                <!-- Left: Environment List -->
                <div class="cluster-mode-sidebar">
                    <div class="sidebar-header">
                        <span>Environments</span>
                        <button class="info-btn small" @onclick="() => ShowInfo(InfoType.AppConfig)">?</button>
                    </div>
                    <div class="cluster-mode-options">
                        @foreach (var env in GetVMEnvironmentList())
                        {
                            <div class="mode-option @(IsEnvironmentEnabled(env) ? "selected" : "")"
                                 @onclick="() => ToggleVMEnvironment(env)">
                                <span class="@IconResources.GetEnvIconClass(env)"></span>
                                <div class="mode-text">
                                    <span class="mode-name">@IconResources.GetEnvDisplayName(env)</span>
                                    <span class="mode-desc">@GetVMEnvSummary(env)</span>
                                </div>
                            </div>
                        }
                    </div>
                </div>

                <!-- Right: Tabbed Configuration -->
                <div class="config-tabs-container">
                    <!-- Tab Headers -->
                    <div class="config-tabs">
                        <button class="config-tab @(configTab == "roles" ? "active" : "")" @onclick='() => configTab = "roles"'>
                            Server Roles
                        </button>
                        <button class="config-tab @(configTab == "ha" ? "active" : "")" @onclick='() => configTab = "ha"'>
                            HA & DR
                        </button>
                        <button class="config-tab @(configTab == "settings" ? "active" : "")" @onclick='() => configTab = "settings"'>
                            Settings
                        </button>
                    </div>

                    <!-- Tab Content -->
                    <div class="config-tab-content">
                        <!-- Server Roles Tab -->
                        @if (configTab == "roles")
                        {
                            <div class="tab-panel">
                                <VMServerRolesConfig EnabledEnvironments="@enabledEnvironments"
                                                     EnvironmentConfigs="@vmEnvironmentConfigs"
                                                     EnvironmentConfigsChanged="@((configs) => vmEnvironmentConfigs = configs)"
                                                     AvailableTechnologyRoles="@GetAvailableTechnologyRoles()"
                                                     GetMaxInstances="@GetRoleMaxInstances"
                                                     OnToggleTechRoleRequested="@((args) => ToggleTechVMRole(args.Item1, args.Item2))"
                                                     OnToggleRoleRequested="@((args) => ToggleVMRole(args.Item1, args.Item2))"
                                                     OnRemoveRoleRequested="@((args) => RemoveTechVMRole(args.Item1, args.Item2))" />
                            </div>
                        }

                        <!-- HA & DR Tab -->
                        @if (configTab == "ha")
                        {
                            <div class="tab-panel">
                                <VMHADRConfig EnabledEnvironments="@enabledEnvironments"
                                              EnvironmentConfigs="@vmEnvironmentConfigs"
                                              EnvironmentConfigsChanged="@((configs) => vmEnvironmentConfigs = configs)" />
                            </div>
                        }

                        <!-- VM Settings Tab -->
                        @if (configTab == "settings")
                        {
                            <div class="tab-panel">
                                <div class="settings-grid-compact">
                                    <div class="settings-section-compact">
                                        <div class="settings-section-title">System Overhead</div>
                                        <div class="settings-row">
                                            <div class="setting-item">
                                                <label>Overhead %</label>
                                                <input type="number" min="0" max="50" step="1" @bind="vmSystemOverhead" />
                                                <span class="unit">%</span>
                                            </div>
                                            <p class="settings-hint">Additional overhead for OS, agents, and system processes</p>
                                        </div>
                                    </div>

                                    <div class="settings-section-compact">
                                        <div class="settings-section-title">Storage per Environment</div>
                                        <div class="settings-row">
                                            @foreach (var env in enabledEnvironments.OrderBy(e => e))
                                            {
                                                var config = GetOrCreateVMConfig(env);
                                                <div class="setting-item">
                                                    <label>@env</label>
                                                    <input type="number" min="0" max="1000000" @bind="config.StorageGB" />
                                                    <span class="unit">GB</span>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }

        <!-- Step 6: Pricing (K8s only) -->
        @if (currentStep == 6 && selectedDeployment == DeploymentModel.Kubernetes && selectedDistribution != null && results != null)
        {
            <InfraSizingCalculator.Components.Wizard.Steps.PricingStep
                Distribution="@selectedDistribution"
                Platform="@selectedPlatform"
                TotalNodes="@results.GrandTotal.TotalNodes"
                TotalCores="@results.GrandTotal.TotalCpu"
                TotalRamGB="@results.GrandTotal.TotalRam"
                TotalStorageTB="0"
                MasterNodes="@results.GrandTotal.TotalMasters"
                InfraNodes="@results.GrandTotal.TotalInfra"
                WorkerNodes="@results.GrandTotal.TotalWorkers"
                HasProduction="@enabledEnvironments.Contains(EnvironmentType.Prod)"
                MendixCategory="@mendixDeploymentCategory"
                MendixCloudType="@mendixCloudType"
                MendixPrivateProvider="@mendixPrivateCloudProvider"
                MendixOtherType="@mendixOtherDeployment"
                MendixEnvironments="@mendixNumberOfEnvironments"
                MendixInternalUsers="@mendixInternalUsers"
                MendixExternalUsers="@mendixExternalUsers"
                OnPricingConfigured="HandlePricingConfigured"
                OnApplyAlternative="HandleApplyAlternative"
                OnSaveScenario="OpenSaveScenarioModal" />
        }

        <!-- Step 7: K8s Results -->
        @if (currentStep == 7 && results != null && selectedDeployment == DeploymentModel.Kubernetes)
        {
            <div class="results-panel">
                <!-- Cluster Mode Info Banner -->
                <div class="cluster-mode-banner @GetClusterModeBannerClass()">
                    <span class="banner-icon">@GetClusterModeIcon()</span>
                    <span class="banner-text">@GetClusterModeDescription()</span>
                </div>

                <!-- Tab content controlled by sidebar navigation -->
                <!-- Sizing Tab Content - Using Data Grid Layout -->
                @if (k8sResultsTab == "sizing")
                {
                    <div class="sizing-tab-content">
                        <!-- All Environments Data Grid -->
                        <div class="sizing-data-grid">
                            <table class="data-grid-table">
                                <thead>
                                    <tr>
                                        <th class="env-col">Environment</th>
                                        <th class="num-col">Apps</th>
                                        <th class="num-col">Pods</th>
                                        @if (!IsSharedClusterMode())
                                        {
                                            <th class="num-col">Masters</th>
                                            <th class="num-col">Infra</th>
                                        }
                                        <th class="num-col">Workers</th>
                                        <th class="num-col total-col">Nodes</th>
                                        <th class="num-col">vCPU</th>
                                        <th class="num-col">RAM (GB)</th>
                                        <th class="num-col">Disk (GB)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var env in results.Environments)
                                    {
                                        <tr class="env-row env-@env.Environment.ToString().ToLower()">
                                            <td class="env-col">
                                                <span class="env-badge">
                                                    <span class="env-indicator"></span>
                                                    @env.Environment
                                                </span>
                                            </td>
                                            <td class="num-col">@env.Apps</td>
                                            <td class="num-col">@env.Pods</td>
                                            @if (!IsSharedClusterMode())
                                            {
                                                @if (IsManagedControlPlane())
                                                {
                                                    <td class="num-col managed-indicator" title="Control plane managed by cloud provider">Managed</td>
                                                }
                                                else
                                                {
                                                    <td class="num-col">@env.Masters</td>
                                                }
                                                <td class="num-col">@env.Infra</td>
                                            }
                                            <td class="num-col">@env.Workers</td>
                                            <td class="num-col total-col"><strong>@env.TotalNodes</strong></td>
                                            <td class="num-col">@env.TotalCpu</td>
                                            <td class="num-col">@env.TotalRam.ToString("N0")</td>
                                            <td class="num-col">@env.TotalDisk.ToString("N0")</td>
                                        </tr>
                                    }
                                </tbody>
                                <tfoot>
                                    <tr class="totals-row">
                                        <td class="env-col"><strong>Total</strong></td>
                                        <td class="num-col">@results.Environments.Sum(e => e.Apps)</td>
                                        <td class="num-col">@results.Environments.Sum(e => e.Pods)</td>
                                        @if (!IsSharedClusterMode())
                                        {
                                            @if (IsManagedControlPlane())
                                            {
                                                <td class="num-col managed-indicator">-</td>
                                            }
                                            else
                                            {
                                                <td class="num-col">@results.Environments.Sum(e => e.Masters)</td>
                                            }
                                            <td class="num-col">@results.Environments.Sum(e => e.Infra)</td>
                                        }
                                        <td class="num-col">@results.Environments.Sum(e => e.Workers)</td>
                                        <td class="num-col total-col"><strong>@results.GrandTotal.TotalNodes</strong></td>
                                        <td class="num-col">@results.GrandTotal.TotalCpu</td>
                                        <td class="num-col">@results.GrandTotal.TotalRam.ToString("N0")</td>
                                        <td class="num-col">@results.GrandTotal.TotalDisk.ToString("N0")</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                }

                <!-- Cost Tab Content - Different layouts based on deployment type -->
                @if (k8sResultsTab == "cost")
                {
                    <div class="cost-tab-content @(costSubTab == "cloud" ? "cloud-active" : "")">
                        @if (IsMendixCloudDeployment())
                        {
                            <!-- Mendix Cloud Pricing (SaaS/Dedicated) -->
                            <div class="mendix-cloud-cost-panel">
                                <div class="cost-header-notice">
                                    <span class="notice-icon icon icon-cloud"></span>
                                    <span class="notice-text">Mendix Cloud @(mendixCloudType == MendixCloudType.Dedicated ? "Dedicated" : "SaaS")</span>
                                </div>
                                @if (pricingResult?.MendixCost != null)
                                {
                                    <div class="cost-panel mendix-cost-display">
                                        <div class="cost-header-row">
                                            <span class="cost-label">Monthly Total</span>
                                            <div class="cost-total-row">
                                                <span class="total-amount large">@FormatCurrency(pricingResult.MendixCost.TotalPerMonth)</span>
                                                <span class="total-period">/month</span>
                                            </div>
                                        </div>
                                        <div class="cost-breakdown-grid">
                                            @if (pricingResult.MendixCost.PlatformLicenseCost > 0)
                                            {
                                                <div class="breakdown-item">
                                                    <span class="breakdown-label">Platform License</span>
                                                    <span class="breakdown-value">@FormatCurrency(pricingResult.MendixCost.PlatformLicenseCost / 12)/mo</span>
                                                </div>
                                            }
                                            @if (pricingResult.MendixCost.DeploymentFeeCost > 0)
                                            {
                                                <div class="breakdown-item">
                                                    <span class="breakdown-label">Deployment</span>
                                                    <span class="breakdown-value">@FormatCurrency(pricingResult.MendixCost.DeploymentFeeCost / 12)/mo</span>
                                                </div>
                                            }
                                            @if (pricingResult.MendixCost.EnvironmentCost > 0)
                                            {
                                                <div class="breakdown-item">
                                                    <span class="breakdown-label">Environments</span>
                                                    <span class="breakdown-value">@FormatCurrency(pricingResult.MendixCost.EnvironmentCost / 12)/mo</span>
                                                </div>
                                            }
                                            @if (pricingResult.MendixCost.UserLicenseCost > 0)
                                            {
                                                <div class="breakdown-item">
                                                    <span class="breakdown-label">User Licensing</span>
                                                    <span class="breakdown-value">@FormatCurrency(pricingResult.MendixCost.UserLicenseCost / 12)/mo</span>
                                                </div>
                                            }
                                        </div>
                                        <div class="cost-tco-summary">
                                            <div class="tco-item">
                                                <span class="tco-value">@FormatCurrency(pricingResult.MendixCost.TotalPerYear)</span>
                                                <span class="tco-label">/year</span>
                                            </div>
                                            <div class="tco-item highlight">
                                                <span class="tco-value">@FormatCurrency(pricingResult.MendixCost.TotalThreeYear)</span>
                                                <span class="tco-label">3yr TCO</span>
                                            </div>
                                        </div>
                                    </div>
                                }
                                else
                                {
                                    <div class="cost-panel cloud-info">
                                        <div class="info-box">
                                            <span class="info-icon icon icon-info"></span>
                                            <div class="info-content">
                                                <h4>Configure in Pricing Step</h4>
                                                <p>Complete the Pricing step to see calculated Mendix costs.</p>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else if (IsOnPremDistribution())
                        {
                            <!-- Cost Sub-tabs for On-Prem Distributions -->
                            <div class="cost-sub-tabs">
                                <button class="cost-sub-tab @(costSubTab == "onprem" ? "active" : "")"
                                        @onclick='() => costSubTab = "onprem"'>
                                    On-Premises
                                    @if (pricingResult?.HasCosts == true && pricingResult.OnPremCost != null)
                                    {
                                        <span class="tab-price">@FormatCurrency(pricingResult.OnPremCost.MonthlyTotal)/mo</span>
                                    }
                                    else
                                    {
                                        <span class="tab-price na">N/A</span>
                                    }
                                </button>
                                <button class="cost-sub-tab @(costSubTab == "cloud" ? "active" : "")"
                                        @onclick='() => costSubTab = "cloud"'>
                                    Cloud Alternatives
                                    @if (k8sCostEstimate != null)
                                    {
                                        <span class="tab-price">@FormatCurrency(k8sCostEstimate.MonthlyTotal)/mo</span>
                                    }
                                </button>
                                @if (selectedTechnology == Technology.Mendix && pricingResult?.MendixCost != null)
                                {
                                    <button class="cost-sub-tab @(costSubTab == "mendix" ? "active" : "")"
                                            @onclick='() => costSubTab = "mendix"'>
                                        Mendix Licensing
                                        <span class="tab-price">@FormatCurrency(pricingResult.MendixCost.TotalPerMonth)/mo</span>
                                    </button>
                                }
                            </div>

                            <!-- On-Prem Tab Content -->
                            @if (costSubTab == "onprem")
                            {
                                @if (pricingResult?.HasCosts == true && pricingResult.OnPremCost != null)
                                {
                                    <div class="cost-panel onprem-panel">
                                        <div class="cost-header-row">
                                            <span class="cost-label">Monthly Total</span>
                                            <div class="cost-total-row">
                                                <span class="total-amount large">@FormatCurrency(pricingResult.OnPremCost.MonthlyTotal)</span>
                                                <span class="total-period">/month</span>
                                            </div>
                                        </div>
                                        <div class="cost-breakdown-grid">
                                            <div class="breakdown-item">
                                                <span class="breakdown-label">License</span>
                                                <span class="breakdown-value">@FormatCurrency(pricingResult.OnPremCost.MonthlyLicense)</span>
                                            </div>
                                            <div class="breakdown-item">
                                                <span class="breakdown-label">Hardware</span>
                                                <span class="breakdown-value">@FormatCurrency(pricingResult.OnPremCost.MonthlyHardware)</span>
                                            </div>
                                            <div class="breakdown-item">
                                                <span class="breakdown-label">Data Center</span>
                                                <span class="breakdown-value">@FormatCurrency(pricingResult.OnPremCost.MonthlyDataCenter)</span>
                                            </div>
                                            <div class="breakdown-item">
                                                <span class="breakdown-label">Labor</span>
                                                <span class="breakdown-value">@FormatCurrency(pricingResult.OnPremCost.MonthlyLabor)</span>
                                            </div>
                                        </div>
                                        <div class="cost-tco-summary">
                                            <div class="tco-item">
                                                <span class="tco-value">@FormatCurrency(pricingResult.OnPremCost.YearlyTotal)</span>
                                                <span class="tco-label">/year</span>
                                            </div>
                                            <div class="tco-item">
                                                <span class="tco-value">@FormatCurrency(pricingResult.OnPremCost.ThreeYearTCO)</span>
                                                <span class="tco-label">3yr TCO</span>
                                            </div>
                                            <div class="tco-item">
                                                <span class="tco-value">@FormatCurrency(pricingResult.OnPremCost.YearlyTotal * 5)</span>
                                                <span class="tco-label">5yr TCO</span>
                                            </div>
                                        </div>
                                    </div>
                                }
                                else
                                {
                                    <div class="cost-panel pricing-disabled">
                                        <div class="pricing-not-enabled-notice">
                                            <span class="notice-icon icon icon-bulb"></span>
                                            <span class="notice-text">On-premises pricing not enabled.</span>
                                        </div>
                                        <p class="pricing-help">To see on-premises cost estimates, enable pricing in the Pricing step.</p>
                                        <button class="btn-secondary" @onclick="BackToPricing">
                                            <span>Go to Pricing Step</span>
                                        </button>
                                    </div>
                                }
                            }

                            <!-- Cloud Alternatives Tab Content -->
                            @if (costSubTab == "cloud")
                            {
                                <div class="cost-panel cloud-panel cloud-comparison-panel">
                                    @{
                                        var cloudAlts = GetCloudAlternativesForBreakdown();
                                        var lowestCost = cloudAlts.Min(a => a.MonthlyCost);
                                        var workerCount = results?.GrandTotal.TotalWorkers ?? 3;
                                    }

                                    <!-- Two Column Layout: Comparison Cards + Summary Sidebar -->
                                    <div class="cloud-comparison-layout">
                                        <!-- Left: Cloud Provider Comparison Cards -->
                                        <div class="cloud-cards-section">
                                            <div class="section-header">
                                                <span class="header-icon icon icon-cloud"></span>
                                                <span class="header-title">Cloud Alternatives Comparison</span>
                                                <span class="header-subtitle">Click to select, compare costs across providers</span>
                                            </div>

                                            @if (IsOpenShiftDistribution())
                                            {
                                                <!-- OpenShift Managed Options -->
                                                <div class="provider-group">
                                                    <div class="group-label">
                                                        <span class="label-dot openshift"></span>
                                                        Managed OpenShift <span class="recommended-badge">Recommended</span>
                                                    </div>
                                                    <div class="cloud-cards-grid">
                                                        @foreach (var alt in cloudAlts.Where(a => a.IsOpenShiftManaged))
                                                        {
                                                            var isLowest = alt.MonthlyCost == lowestCost;
                                                            var isSelected = selectedCloudAlt == alt.Key;
                                                            <div class="cloud-alt-card @alt.ProviderClass @(isLowest ? "lowest" : "") @(isSelected ? "selected" : "")"
                                                                 @onclick="() => SelectCloudAlternative(alt.Key)">
                                                                @if (isLowest) { <span class="lowest-badge">Lowest</span> }
                                                                <div class="card-provider">
                                                                    <span class="provider-dot @alt.ProviderClass"></span>
                                                                    @alt.Name
                                                                </div>
                                                                <div class="card-price">@FormatCurrency(alt.MonthlyCost)<span class="per-month">/mo</span></div>
                                                                <div class="card-details">
                                                                    <span>@alt.InstanceType</span>
                                                                    <span>@workerCount workers</span>
                                                                </div>
                                                                <div class="card-tco">3yr: @FormatCurrency(alt.MonthlyCost * 36)</div>
                                                            </div>
                                                        }
                                                    </div>
                                                </div>
                                            }

                                            <!-- Standard Managed K8s Options -->
                                            <div class="provider-group">
                                                <div class="group-label">
                                                    <span class="label-dot k8s"></span>
                                                    Managed Kubernetes @(IsOpenShiftDistribution() ? "(Alternative)" : "")
                                                </div>
                                                <div class="cloud-cards-grid">
                                                    @foreach (var alt in cloudAlts.Where(a => !a.IsOpenShiftManaged))
                                                    {
                                                        var isLowest = alt.MonthlyCost == lowestCost;
                                                        var isSelected = selectedCloudAlt == alt.Key;
                                                        <div class="cloud-alt-card @alt.ProviderClass @(isLowest ? "lowest" : "") @(isSelected ? "selected" : "")"
                                                             @onclick="() => SelectCloudAlternative(alt.Key)">
                                                            @if (isLowest) { <span class="lowest-badge">Lowest</span> }
                                                            <div class="card-provider">
                                                                <span class="provider-dot @alt.ProviderClass"></span>
                                                                @alt.Name
                                                            </div>
                                                            <div class="card-price">@FormatCurrency(alt.MonthlyCost)<span class="per-month">/mo</span></div>
                                                            <div class="card-details">
                                                                <span>@alt.InstanceType</span>
                                                                <span>@workerCount workers</span>
                                                            </div>
                                                            <div class="card-tco">3yr: @FormatCurrency(alt.MonthlyCost * 36)</div>
                                                        </div>
                                                    }
                                                </div>
                                            </div>

                                            <!-- Selected Provider Details -->
                                            @if (!string.IsNullOrEmpty(selectedCloudAlt))
                                            {
                                                var selected = cloudAlts.FirstOrDefault(a => a.Key == selectedCloudAlt);
                                                if (selected != null)
                                                {
                                                    <div class="selected-details-panel">
                                                        <div class="details-header">
                                                            <span class="provider-dot @selected.ProviderClass"></span>
                                                            <strong>@selected.Name</strong> - @selected.Description
                                                        </div>
                                                        <div class="details-breakdown">
                                                            <div class="breakdown-item">
                                                                <span>Compute (@workerCount Ã— @selected.InstanceType)</span>
                                                                <span>@FormatCurrency(selected.ComputeCost)/mo</span>
                                                            </div>
                                                            <div class="breakdown-item">
                                                                <span>Control Plane</span>
                                                                <span>@(selected.ControlPlaneCost > 0 ? FormatCurrency(selected.ControlPlaneCost) + "/mo" : "Free")</span>
                                                            </div>
                                                            <div class="breakdown-item">
                                                                <span>Storage</span>
                                                                <span>@FormatCurrency(selected.StorageCost)/mo</span>
                                                            </div>
                                                            @if (selected.LicenseCost > 0)
                                                            {
                                                                <div class="breakdown-item highlight">
                                                                    <span>License/Service Fee</span>
                                                                    <span>@FormatCurrency(selected.LicenseCost)/mo</span>
                                                                </div>
                                                            }
                                                        </div>
                                                        <div class="details-actions">
                                                            <button class="btn-apply-cloud" @onclick="() => ApplyCloudAlternative(selected)">
                                                                Switch to @selected.Name
                                                            </button>
                                                        </div>
                                                    </div>
                                                }
                                            }
                                        </div>

                                        <!-- Right: Summary Sidebar -->
                                        <div class="cloud-summary-sidebar">
                                            <!-- Node Comparison -->
                                            <div class="sidebar-card">
                                                <div class="card-title">Node Comparison</div>
                                                <div class="comparison-rows">
                                                    <div class="comp-row onprem">
                                                        <span class="comp-label">On-Prem</span>
                                                        <span class="comp-nodes">@(results?.GrandTotal.TotalNodes ?? 0) nodes</span>
                                                        <div class="node-breakdown">
                                                            <span class="node-badge master">@(results?.GrandTotal.TotalMasters ?? 0)M</span>
                                                            <span class="node-badge infra">@(results?.GrandTotal.TotalInfra ?? 0)I</span>
                                                            <span class="node-badge worker">@(results?.GrandTotal.TotalWorkers ?? 0)W</span>
                                                        </div>
                                                    </div>
                                                    <div class="comp-row cloud">
                                                        <span class="comp-label">Cloud</span>
                                                        <span class="comp-nodes">@workerCount workers</span>
                                                        <div class="node-breakdown">
                                                            <span class="node-badge managed">Managed CP</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="comparison-note">
                                                    Cloud = @((results?.GrandTotal.TotalMasters ?? 0) + (results?.GrandTotal.TotalInfra ?? 0)) fewer nodes to manage
                                                </div>
                                            </div>

                                            <!-- Cost Comparison -->
                                            <div class="sidebar-card">
                                                <div class="card-title">Cost Comparison</div>
                                                <div class="cost-compare-list">
                                                    <div class="cost-item @(pricingResult?.HasCosts == true ? "" : "na")">
                                                        <span>On-Prem</span>
                                                        <span class="cost-value">@(pricingResult?.HasCosts == true ? FormatCurrency(pricingResult.OnPremCost?.MonthlyTotal ?? 0) + "/mo" : "N/A")</span>
                                                    </div>
                                                    @foreach (var alt in cloudAlts.OrderBy(a => a.MonthlyCost).Take(3))
                                                    {
                                                        var isLowest = alt.MonthlyCost == lowestCost;
                                                        <div class="cost-item @(isLowest ? "lowest" : "")">
                                                            <span><span class="provider-dot small @alt.ProviderClass"></span> @alt.Name</span>
                                                            <span class="cost-value">@FormatCurrency(alt.MonthlyCost)/mo</span>
                                                        </div>
                                                    }
                                                </div>
                                            </div>

                                            <!-- Recommendation -->
                                            <div class="sidebar-card recommendation">
                                                <div class="card-title">Recommendation</div>
                                                @{
                                                    var cheapest = cloudAlts.OrderBy(a => a.MonthlyCost).First();
                                                    var onPremCost = pricingResult?.OnPremCost?.MonthlyTotal ?? 0;
                                                    var cloudSavings = onPremCost > 0 ? onPremCost - cheapest.MonthlyCost : 0;
                                                }
                                                <div class="recommendation-content">
                                                    <div class="rec-provider">
                                                        <span class="provider-dot @cheapest.ProviderClass"></span>
                                                        <strong>@cheapest.Name</strong>
                                                    </div>
                                                    <div class="rec-price">@FormatCurrency(cheapest.MonthlyCost)/mo</div>
                                                    @if (cloudSavings > 0)
                                                    {
                                                        <div class="rec-savings positive">
                                                            Save @FormatCurrency(cloudSavings)/mo vs On-Prem
                                                        </div>
                                                    }
                                                    else if (cloudSavings < 0 && onPremCost > 0)
                                                    {
                                                        <div class="rec-savings negative">
                                                            On-Prem @FormatCurrency(Math.Abs(cloudSavings))/mo cheaper
                                                        </div>
                                                    }
                                                </div>
                                                <button class="btn-apply-recommendation" @onclick="() => ApplyCloudAlternative(cheapest)">
                                                    Apply Recommendation
                                                </button>
                                            </div>

                                            <!-- Action: Keep Current -->
                                            <div class="sidebar-card keep-current">
                                                <div class="current-selection">
                                                    <span>Current: <strong>@(selectedDistribution?.ToString() ?? "Not set")</strong></span>
                                                </div>
                                                <button class="btn-keep-current" @onclick="SwitchToOnPremTab">
                                                    Keep On-Prem Selection
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }

                            <!-- Mendix Licensing Tab Content -->
                            @if (costSubTab == "mendix" && selectedTechnology == Technology.Mendix && pricingResult?.MendixCost != null)
                            {
                                <div class="cost-panel mendix-cost-display">
                                    <div class="cost-header-row">
                                        <span class="cost-label">Mendix Monthly License Cost</span>
                                        <div class="cost-total-row">
                                            <span class="total-amount large">@FormatCurrency(pricingResult.MendixCost.TotalPerMonth)</span>
                                            <span class="total-period">/month</span>
                                        </div>
                                    </div>
                                    <div class="cost-breakdown-grid">
                                        @if (pricingResult.MendixCost.PlatformLicenseCost > 0)
                                        {
                                            <div class="breakdown-item">
                                                <span class="breakdown-label">Platform License</span>
                                                <span class="breakdown-value">@FormatCurrency(pricingResult.MendixCost.PlatformLicenseCost / 12)/mo</span>
                                            </div>
                                        }
                                        @if (pricingResult.MendixCost.DeploymentFeeCost > 0)
                                        {
                                            <div class="breakdown-item">
                                                <span class="breakdown-label">Deployment Fee</span>
                                                <span class="breakdown-value">@FormatCurrency(pricingResult.MendixCost.DeploymentFeeCost / 12)/mo</span>
                                            </div>
                                        }
                                        @if (pricingResult.MendixCost.EnvironmentCost > 0)
                                        {
                                            <div class="breakdown-item">
                                                <span class="breakdown-label">Environment Licensing</span>
                                                <span class="breakdown-value">@FormatCurrency(pricingResult.MendixCost.EnvironmentCost / 12)/mo</span>
                                            </div>
                                        }
                                        @if (pricingResult.MendixCost.UserLicenseCost > 0)
                                        {
                                            <div class="breakdown-item">
                                                <span class="breakdown-label">User Licensing</span>
                                                <span class="breakdown-value">@FormatCurrency(pricingResult.MendixCost.UserLicenseCost / 12)/mo</span>
                                            </div>
                                        }
                                    </div>
                                    @if (!string.IsNullOrEmpty(pricingResult.MendixCost.EnvironmentDetails))
                                    {
                                        <div class="mendix-env-details">
                                            <span class="details-label">Environment Breakdown:</span>
                                            <span class="details-value">@pricingResult.MendixCost.EnvironmentDetails</span>
                                        </div>
                                    }
                                    <div class="cost-tco-summary">
                                        <div class="tco-item">
                                            <span class="tco-value">@FormatCurrency(pricingResult.MendixCost.TotalPerYear)</span>
                                            <span class="tco-label">/year</span>
                                        </div>
                                        <div class="tco-item highlight">
                                            <span class="tco-value">@FormatCurrency(pricingResult.MendixCost.TotalThreeYear)</span>
                                            <span class="tco-label">3yr TCO</span>
                                        </div>
                                    </div>
                                    <div class="mendix-license-note">
                                        <span class="note-icon icon icon-bulb"></span>
                                        <span>Mendix licensing is separate from infrastructure costs. Prices from June 2025 pricebook.</span>
                                    </div>
                                </div>
                            }
                        }
                        else if (k8sCostLoading)
                        {
                            <div class="cost-loading">Calculating costs...</div>
                        }
                        else if (k8sCostEstimate != null)
                        {
                            <!-- Cost Summary Bar (always visible) -->
                            <div class="cost-summary-bar">
                                <div class="cost-summary-item primary">
                                    <span class="cost-amount">@FormatCurrency(k8sCostEstimate.MonthlyTotal)</span>
                                    <span class="cost-period">/month</span>
                                </div>
                                <div class="cost-summary-item">
                                    <span class="cost-amount">@FormatCurrency(k8sCostEstimate.YearlyTotal)</span>
                                    <span class="cost-period">/year</span>
                                </div>
                                <div class="cost-summary-item">
                                    <span class="cost-amount">@FormatCurrency(k8sCostEstimate.ThreeYearTCO)</span>
                                    <span class="cost-period">3yr TCO</span>
                                </div>
                                <div class="cost-summary-item">
                                    <span class="cost-amount">@FormatCurrency(k8sCostEstimate.FiveYearTCO)</span>
                                    <span class="cost-period">5yr TCO</span>
                                </div>
                            </div>

                            <!-- Two-Column Layout: Breakdown + By Environment -->
                            <div class="cost-two-column">
                                <!-- Left: Cost Breakdown by Category -->
                                <div class="cost-column">
                                    <div class="cost-section-header">Cost Breakdown</div>
                                    <table class="cost-breakdown-table">
                                        <thead>
                                            <tr>
                                                <th>Category</th>
                                                <th class="num-col">Monthly</th>
                                                <th class="num-col">%</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var cat in k8sCostEstimate.Breakdown.Values.OrderByDescending(b => b.Monthly))
                                            {
                                                <tr>
                                                    <td>
                                                        <span class="cat-icon">@GetCostCategoryIcon(cat.Category)</span>
                                                        @cat.Description
                                                    </td>
                                                    <td class="num-col">@FormatCurrency(cat.Monthly)</td>
                                                    <td class="num-col pct-col">
                                                        <div class="pct-bar" style="--pct: @cat.Percentage%"></div>
                                                        @cat.Percentage.ToString("F0")%
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>

                                <!-- Right: Cost by Environment -->
                                <div class="cost-column">
                                    <div class="cost-section-header">By Environment</div>
                                    <table class="cost-env-table">
                                        <thead>
                                            <tr>
                                                <th>Environment</th>
                                                <th class="num-col">Nodes</th>
                                                <th class="num-col">Monthly</th>
                                                <th class="num-col">%</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var env in k8sCostEstimate.EnvironmentCosts.Values.OrderByDescending(e => e.MonthlyCost))
                                            {
                                                <tr class="env-row env-@env.EnvironmentName.ToLower()">
                                                    <td class="env-col">
                                                        <span class="env-badge">
                                                            <span class="env-indicator"></span>
                                                            @env.EnvironmentName
                                                        </span>
                                                    </td>
                                                    <td class="num-col">@env.Nodes</td>
                                                    <td class="num-col">@FormatCurrency(env.MonthlyCost)</td>
                                                    <td class="num-col">@env.Percentage.ToString("F0")%</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Pricing Options (collapsible) -->
                            <div class="collapsible-section @(k8sPricingOptionsOpen ? "open" : "")">
                                <button type="button" class="collapsible-header" @onclick="() => k8sPricingOptionsOpen = !k8sPricingOptionsOpen">
                                    <span class="collapsible-icon">@(k8sPricingOptionsOpen ? "â–¼" : "â–¶")</span>
                                    <span>Pricing Options</span>
                                </button>
                                @if (k8sPricingOptionsOpen)
                                {
                                    <div class="collapsible-content">
                                        <InfraSizingCalculator.Components.Configuration.PricingSelector
                                            Options="@k8sCostOptions"
                                            Distribution="@selectedDistribution?.ToString()"
                                            OnCalculate="HandleK8sCostCalculate" />
                                    </div>
                                }
                            </div>

                            <!-- Notes (collapsible, if any) -->
                            @if (k8sCostEstimate.Notes.Any())
                            {
                                <div class="collapsible-section @(k8sCostNotesOpen ? "open" : "")">
                                    <button type="button" class="collapsible-header" @onclick="() => k8sCostNotesOpen = !k8sCostNotesOpen">
                                        <span class="collapsible-icon">@(k8sCostNotesOpen ? "â–¼" : "â–¶")</span>
                                        <span>Notes & Assumptions (@k8sCostEstimate.Notes.Count)</span>
                                    </button>
                                    @if (k8sCostNotesOpen)
                                    {
                                        <div class="collapsible-content">
                                            <ul class="cost-notes-list">
                                                @foreach (var note in k8sCostEstimate.Notes)
                                                {
                                                    <li>@note</li>
                                                }
                                            </ul>
                                        </div>
                                    }
                                </div>
                            }

                            <!-- Pricing Info Footer -->
                            @if (!string.IsNullOrEmpty(k8sCostEstimate.PricingSource))
                            {
                                <div class="cost-footer">
                                    <span>@k8sCostEstimate.Provider - @k8sCostEstimate.Region</span>
                                    <span>@k8sCostEstimate.CalculatedAt.ToString("MMM d, yyyy HH:mm")</span>
                                </div>
                            }
                        }
                        else
                        {
                            <!-- No estimate yet - show pricing selector -->
                            <div class="cost-no-estimate">
                                <p>Configure pricing options and calculate costs</p>
                                <InfraSizingCalculator.Components.Configuration.PricingSelector
                                    Options="@k8sCostOptions"
                                    Distribution="@selectedDistribution?.ToString()"
                                    OnCalculate="HandleK8sCostCalculate" />
                            </div>
                        }
                    </div>
                }

                <!-- Insights Tab Content -->
                @if (k8sResultsTab == "insights" && validationWarnings?.Any() == true)
                {
                    <div class="insights-tab-content">
                        <InfraSizingCalculator.Components.Results.ResultsWarnings Warnings="validationWarnings" />
                    </div>
                }

                <!-- Growth Tab Content - Using GrowthPlanningView Component -->
                @if (k8sResultsTab == "growth")
                {
                    <div class="growth-tab-content">
                        <InfraSizingCalculator.Components.Results.GrowthPlanningView
                            Settings="@k8sGrowthSettings"
                            Projection="@k8sGrowthProjection"
                            OnCalculate="HandleK8sGrowthCalculate"
                            SettingsChanged="HandleK8sGrowthSettingsFromComponent" />
                    </div>
                }

            </div>
        }

        <!-- VM Pricing Step (step 5 for non-Mendix, step 6 for Mendix) -->
        @if (currentStep == GetPricingStep() && selectedDeployment == DeploymentModel.VMs)
        {
            <div class="pricing-step vm-pricing">
                @if (selectedTechnology == Technology.Mendix && vmResults != null)
                {
                    <!-- Mendix VM Pricing -->
                    <div class="step-header">
                        <h3>Mendix License Pricing</h3>
                    <p class="step-description">
                        Review Mendix licensing costs for your <strong>@GetMendixVMDeploymentName()</strong> deployment.
                    </p>
                </div>

                <div class="mendix-vm-pricing-panel">
                    @{
                        var (perApp, unlimited) = GetMendixVMDeploymentPricing();
                    }

                    <div class="pricing-option-cards">
                        <div class="pricing-option-card @(!mendixIsUnlimitedApps ? "selected" : "")"
                             @onclick="() => mendixIsUnlimitedApps = false">
                            <div class="option-header">
                                <span class="option-icon icon icon-app"></span>
                                <span class="option-title">Per-App License</span>
                            </div>
                            <div class="option-price">@FormatCurrency(perApp)/app/year</div>
                            <div class="option-desc">Best for smaller deployments with few apps</div>
                            @if (!mendixIsUnlimitedApps)
                            {
                                <div class="app-count-input">
                                    <label>Number of Apps:</label>
                                    <input type="number" min="1" max="100" @bind="mendixNumberOfApps" />
                                </div>
                                <div class="option-total">Total: @FormatCurrency(perApp * mendixNumberOfApps)/year</div>
                            }
                        </div>

                        <div class="pricing-option-card @(mendixIsUnlimitedApps ? "selected" : "")"
                             @onclick="() => mendixIsUnlimitedApps = true">
                            <div class="option-header">
                                <span class="option-icon icon icon-infinity"></span>
                                <span class="option-title">Unlimited Apps License</span>
                            </div>
                            <div class="option-price">@FormatCurrency(unlimited)/year</div>
                            <div class="option-desc">Best for enterprise deployments with many apps</div>
                            @if (mendixIsUnlimitedApps)
                            {
                                <div class="option-total">Total: @FormatCurrency(unlimited)/year</div>
                            }
                        </div>
                    </div>

                    <div class="pricing-summary">
                        <div class="summary-row">
                            <span>Deployment Type:</span>
                            <span>@GetMendixVMDeploymentName()</span>
                        </div>
                        <div class="summary-row">
                            <span>License Type:</span>
                            <span>@(mendixIsUnlimitedApps ? "Unlimited Apps" : $"{mendixNumberOfApps} App(s)")</span>
                        </div>
                        <div class="summary-row total">
                            <span>Annual Mendix License:</span>
                            <span class="total-value">@FormatCurrency(mendixIsUnlimitedApps ? unlimited : perApp * mendixNumberOfApps)/year</span>
                        </div>
                    </div>

                    <div class="pricing-note">
                        <span class="icon icon-bulb"></span> <strong>Note:</strong> This is the Mendix license cost only. Infrastructure costs (VMs, storage, networking) are separate.
                    </div>
                </div>
                }
                else if (selectedTechnology == Technology.OutSystems && vmResults != null)
                {
                    <!-- OutSystems VM Pricing with Accordions -->
                    // Pre-calculate all pricing values using new model
                    var osBaseCost = outsystemsPricingSettings.GetEditionBasePrice(outsystemsEdition);
                    var osAoIncluded = outsystemsPricingSettings.GetIncludedAOs(outsystemsEdition);
                    var osUsersIncluded = outsystemsPricingSettings.GetIncludedInternalUsers(outsystemsEdition);
                    var osAdditionalAOs = Math.Max(0, outsystemsApplicationObjects - osAoIncluded);
                    var osAoPacksCount = osAdditionalAOs > 0 ? (int)Math.Ceiling(osAdditionalAOs / (double)outsystemsPricingSettings.AOPackSize) : 0;
                    var osAoCost = osAoPacksCount * outsystemsPricingSettings.AdditionalAOPackPrice;
                    var osAdditionalUsers = Math.Max(0, outsystemsInternalUsers - osUsersIncluded);
                    var osUserPacksCount = osAdditionalUsers > 0 ? (int)Math.Ceiling(osAdditionalUsers / (double)outsystemsPricingSettings.InternalUserPackSize) : 0;
                    var osInternalUserCost = osUserPacksCount * outsystemsPricingSettings.AdditionalInternalUserPackPrice;
                    var osExternalUserCost = outsystemsPricingSettings.CalculateExternalUsersCost(outsystemsExternalSessions);
                    var osTotalAnnual = osBaseCost + osAoCost + osInternalUserCost + osExternalUserCost;

                    <div class="step-header">
                        <h3>OutSystems License Pricing</h3>
                        <p class="step-description">
                            Configure OutSystems subscription licensing for your self-managed deployment.
                        </p>
                    </div>

                    <div class="outsystems-vm-pricing-panel accordion-layout">
                        <!-- Edition Selection Accordion -->
                        <div class="pricing-accordion @(outsystemsActiveAccordion == "edition" ? "open" : "")">
                            <button type="button" class="accordion-header" @onclick='() => outsystemsActiveAccordion = outsystemsActiveAccordion == "edition" ? "" : "edition"'>
                                <span class="accordion-chevron">@(outsystemsActiveAccordion == "edition" ? "â–¼" : "â–¶")</span>
                                <span class="accordion-icon">ðŸ“¦</span>
                                <span class="accordion-title">Edition Selection</span>
                                <span class="accordion-summary">@outsystemsEdition - @FormatCurrency(osBaseCost)/yr</span>
                            </button>
                            @if (outsystemsActiveAccordion == "edition")
                            {
                                <div class="accordion-content">
                                    <div class="pricing-option-cards compact">
                                        <div class="pricing-option-card @(outsystemsEdition == OutSystemsEdition.Standard ? "selected" : "")"
                                             @onclick="() => outsystemsEdition = OutSystemsEdition.Standard" @onclick:stopPropagation="true">
                                            <div class="option-header">
                                                <span class="option-title">Standard Edition</span>
                                            </div>
                                            <div class="option-price">@FormatCurrency(outsystemsPricingSettings.StandardEditionBasePrice)/year</div>
                                            <div class="option-desc">@outsystemsPricingSettings.StandardEditionAOsIncluded AOs, @outsystemsPricingSettings.StandardEditionInternalUsersIncluded users</div>
                                        </div>

                                        <div class="pricing-option-card @(outsystemsEdition == OutSystemsEdition.Enterprise ? "selected" : "")"
                                             @onclick="() => outsystemsEdition = OutSystemsEdition.Enterprise" @onclick:stopPropagation="true">
                                            <div class="option-header">
                                                <span class="option-title">Enterprise Edition</span>
                                            </div>
                                            <div class="option-price">@FormatCurrency(outsystemsPricingSettings.EnterpriseEditionBasePrice)/year</div>
                                            <div class="option-desc">@outsystemsPricingSettings.EnterpriseEditionAOsIncluded AOs, @outsystemsPricingSettings.EnterpriseEditionInternalUsersIncluded users</div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>

                        <!-- Licensing Configuration Accordion -->
                        <div class="pricing-accordion @(outsystemsActiveAccordion == "licensing" ? "open" : "")">
                            <button type="button" class="accordion-header" @onclick='() => outsystemsActiveAccordion = outsystemsActiveAccordion == "licensing" ? "" : "licensing"'>
                                <span class="accordion-chevron">@(outsystemsActiveAccordion == "licensing" ? "â–¼" : "â–¶")</span>
                                <span class="accordion-icon">âš™ï¸</span>
                                <span class="accordion-title">Licensing Configuration</span>
                                <span class="accordion-summary">@outsystemsApplicationObjects AOs, @outsystemsInternalUsers users - @FormatCurrency(osAoCost + osInternalUserCost + osExternalUserCost)/yr</span>
                            </button>
                            @if (outsystemsActiveAccordion == "licensing")
                            {
                                <div class="accordion-content compact-form">
                                    <div class="config-row-inline">
                                        <label>AOs</label>
                                        <input type="number" min="1" max="5000" @bind="outsystemsApplicationObjects" class="config-input-sm" @onclick:stopPropagation="true" />
                                        <span class="config-info-inline">@osAoIncluded incl @if (osAdditionalAOs > 0) { <span class="extra">+@osAoPacksCount pk</span> }</span>
                                    </div>
                                    <div class="config-row-inline">
                                        <label>Users</label>
                                        <input type="number" min="0" max="10000" @bind="outsystemsInternalUsers" class="config-input-sm" @onclick:stopPropagation="true" />
                                        <span class="config-info-inline">@osUsersIncluded incl @if (osAdditionalUsers > 0) { <span class="extra">+@osUserPacksCount pk</span> }</span>
                                    </div>
                                    <div class="config-row-inline">
                                        <label>External</label>
                                        <input type="number" min="0" max="1000000" step="1000" @bind="outsystemsExternalSessions" class="config-input-sm" @onclick:stopPropagation="true" />
                                        <span class="config-info-inline">
                                            @if (outsystemsExternalSessions > 0) {
                                                var extPacks = (int)Math.Ceiling(outsystemsExternalSessions / (double)outsystemsPricingSettings.ExternalUserPackSize);
                                                <span class="extra">@extPacks pk</span>
                                            } else { <span>sessions/mo</span> }
                                        </span>
                                    </div>
                                </div>
                            }
                        </div>

                        <!-- Cost Summary - Always visible, compact -->
                        <div class="pricing-summary-compact">
                            <div class="summary-items">
                                <div class="summary-item">
                                    <span class="item-label">Monthly</span>
                                    <span class="item-value">@FormatCurrency(osTotalAnnual / 12)</span>
                                </div>
                                <div class="summary-item highlight">
                                    <span class="item-label">Annual</span>
                                    <span class="item-value">@FormatCurrency(osTotalAnnual)</span>
                                </div>
                                <div class="summary-item">
                                    <span class="item-label">3-Year</span>
                                    <span class="item-value">@FormatCurrency(osTotalAnnual * 3)</span>
                                </div>
                            </div>
                            <div class="summary-note">
                                <span class="icon icon-bulb"></span> License cost only. Infrastructure costs shown on results page.
                            </div>
                        </div>
                    </div>
                }
                else
                {
                    <!-- Native VM Pricing (no software licensing) -->
                    <div class="step-header">
                        <h3>Infrastructure Pricing</h3>
                        <p class="step-description">
                            No software licensing costs required for @(selectedTechnology?.ToString() ?? "Native") applications.
                            Infrastructure costs depend on your hosting provider.
                        </p>
                    </div>

                    <div class="native-vm-pricing-panel">
                        <div class="info-card">
                            <span class="info-icon icon icon-info"></span>
                            <div class="info-content">
                                <strong>Infrastructure Costs</strong>
                                <p>Your @(selectedTechnology?.ToString() ?? "application") deployment requires virtual machines but has no software licensing fees.</p>
                                <p>Estimate infrastructure costs based on your cloud or on-premises provider pricing.</p>
                            </div>
                        </div>

                        @if (vmResults != null)
                        {
                            <div class="vm-summary-card">
                                <div class="summary-title">Resource Requirements</div>
                                <div class="summary-grid">
                                    <div class="summary-item">
                                        <span class="item-value">@vmResults.GrandTotal.TotalVMs</span>
                                        <span class="item-label">Total VMs</span>
                                    </div>
                                    <div class="summary-item">
                                        <span class="item-value">@vmResults.GrandTotal.TotalCpu</span>
                                        <span class="item-label">vCPU</span>
                                    </div>
                                    <div class="summary-item">
                                        <span class="item-value">@vmResults.GrandTotal.TotalRam.ToString("N0")</span>
                                        <span class="item-label">RAM (GB)</span>
                                    </div>
                                    <div class="summary-item">
                                        <span class="item-value">@vmResults.GrandTotal.TotalDisk.ToString("N0")</span>
                                        <span class="item-label">Disk (GB)</span>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>
        }

        <!-- VM Results Step (step 6 for non-Mendix, step 7 for Mendix) -->
        @if (currentStep >= GetResultsStep() && vmResults != null && selectedDeployment == DeploymentModel.VMs)
        {
            <div class="results-panel">
                <!-- VM Mode Banner -->
                <div class="cluster-mode-banner vm-mode">
                    <span class="banner-icon icon icon-server"></span>
                    <span class="banner-text">Virtual Machine Sizing - @vmResults.TechnologyName</span>
                </div>

                <!-- Tab content controlled by sidebar navigation -->
                <!-- Sizing Tab Content -->
                @if (vmResultsTab == "sizing")
                {
                    <!-- VM Results Data Grid -->
                    <div class="sizing-data-grid">
                        <table class="data-grid-table">
                            <thead>
                                <tr>
                                    <th class="env-col">Environment</th>
                                    <th>HA Pattern</th>
                                    <th class="num-col total-col">VMs</th>
                                    <th class="num-col">vCPU</th>
                                    <th class="num-col">RAM (GB)</th>
                                    <th class="num-col">Disk (GB)</th>
                                    <th class="num-col">LB VMs</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var env in vmResults.Environments)
                                {
                                    <tr class="env-row env-@env.EnvironmentName.ToLower()">
                                        <td class="env-col">
                                            <span class="env-badge env-@env.EnvironmentName.ToLower()">@env.EnvironmentName</span>
                                        </td>
                                        <td>@GetHAPatternDisplay(env.HAPattern)</td>
                                        <td class="num-col total-col">@env.TotalVMs</td>
                                        <td class="num-col">@env.TotalCpu</td>
                                        <td class="num-col">@env.TotalRam.ToString("N0")</td>
                                        <td class="num-col">@env.TotalDisk.ToString("N0")</td>
                                        <td class="num-col">@env.LoadBalancerVMs</td>
                                    </tr>
                                }
                            </tbody>
                            <tfoot>
                                <tr class="totals-row">
                                    <td class="env-col"><strong>Grand Total</strong></td>
                                    <td>-</td>
                                    <td class="num-col total-col"><strong>@vmResults.GrandTotal.TotalVMs</strong></td>
                                    <td class="num-col"><strong>@vmResults.GrandTotal.TotalCpu</strong></td>
                                    <td class="num-col"><strong>@vmResults.GrandTotal.TotalRam.ToString("N0")</strong></td>
                                    <td class="num-col"><strong>@vmResults.GrandTotal.TotalDisk.ToString("N0")</strong></td>
                                    <td class="num-col"><strong>@vmResults.GrandTotal.TotalLoadBalancerVMs</strong></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <!-- Role Breakdown per Environment (Horizontal Accordion - left to right) -->
                    <details class="sizing-details-section role-breakdown-section">
                        <summary>Role Breakdown by Environment (@vmResults.Environments.Sum(e => e.Roles.Count) total roles)</summary>
                        <div class="role-breakdown-horizontal">
                            <HorizontalAccordion SingleExpand="true"
                                                 ExpandedPanel="@expandedRoleBreakdownEnv"
                                                 ExpandedPanelChanged="@((val) => expandedRoleBreakdownEnv = val)"
                                                 AdditionalClass="role-breakdown-accordion">
                                @foreach (var env in vmResults.Environments)
                                {
                                    var envName = env.EnvironmentName;
                                    var envClass = GetEnvCssClass(envName);
                                    var haPatternText = env.HAPattern != HAPattern.None ? $" | HA: {env.HAPattern}" : "";
                                    <HorizontalAccordionPanel Key="@envName"
                                                              Title="@envName"
                                                              ShortTitle="@GetShortEnvName(envName)"
                                                              Subtitle="@($"{env.Roles.Count} roles{haPatternText}")"
                                                              AdditionalClass="@envClass">
                                        @if (env.Roles.Count > 0)
                                        {
                                            <div class="env-panel-header">
                                                <span class="env-ha-badge @(env.HAPattern != HAPattern.None ? "ha-active" : "")">
                                                    HA: @FormatHAPattern(env.HAPattern)
                                                </span>
                                            </div>
                                            <table class="data-grid-table compact role-table">
                                                <thead>
                                                    <tr>
                                                        <th>Role</th>
                                                        <th>Size</th>
                                                        <th class="num-col">Instances</th>
                                                        <th class="num-col">CPU/VM</th>
                                                        <th class="num-col">RAM/VM</th>
                                                        <th class="num-col">Total CPU</th>
                                                        <th class="num-col">Total RAM</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @foreach (var role in env.Roles)
                                                    {
                                                        <tr>
                                                            <td>@role.RoleName</td>
                                                            <td>@role.Size</td>
                                                            <td class="num-col">@role.TotalInstances</td>
                                                            <td class="num-col">@role.CpuPerInstance</td>
                                                            <td class="num-col">@role.RamPerInstance GB</td>
                                                            <td class="num-col">@role.TotalCpu</td>
                                                            <td class="num-col">@role.TotalRam GB</td>
                                                        </tr>
                                                    }
                                                </tbody>
                                            </table>
                                        }
                                        else
                                        {
                                            <div class="env-no-roles">
                                                <span class="no-roles-icon">[!]</span>
                                                <span>No roles configured for this environment</span>
                                            </div>
                                        }
                                    </HorizontalAccordionPanel>
                                }
                            </HorizontalAccordion>
                        </div>
                    </details>
                }

                <!-- Cost Tab Content -->
                @if (vmResultsTab == "cost")
                {
                    <div class="cost-tab-content">
                        @if (vmCostLoading)
                        {
                            <div class="cost-loading">Calculating costs...</div>
                        }
                        else if (vmCostEstimate != null)
                        {
                            <!-- Cost Summary Bar (always visible) -->
                            <div class="cost-summary-bar">
                                <div class="cost-summary-item primary">
                                    <span class="cost-amount">@FormatCurrency(vmCostEstimate.MonthlyTotal)</span>
                                    <span class="cost-period">/month</span>
                                </div>
                                <div class="cost-summary-item">
                                    <span class="cost-amount">@FormatCurrency(vmCostEstimate.YearlyTotal)</span>
                                    <span class="cost-period">/year</span>
                                </div>
                                <div class="cost-summary-item">
                                    <span class="cost-label">3-Year TCO</span>
                                    <span class="cost-amount">@FormatCurrency(vmCostEstimate.ThreeYearTCO)</span>
                                </div>
                                <div class="cost-summary-item">
                                    <span class="cost-label">5-Year TCO</span>
                                    <span class="cost-amount">@FormatCurrency(vmCostEstimate.FiveYearTCO)</span>
                                </div>
                            </div>

                            <!-- Two-column layout: Current Breakdown | Alternative Pricing -->
                            <div class="cost-two-column">
                                <!-- Current Cost Breakdown -->
                                <div class="cost-column">
                                    <div class="cost-section-header">
                                        <span>ðŸ“Š Cost Breakdown</span>
                                    </div>
                                    <div class="cost-breakdown-compact">
                                        <div class="breakdown-section">
                                            <div class="section-title">By Category</div>
                                            @foreach (var category in vmCostEstimate.Breakdown.Values.OrderByDescending(b => b.Monthly))
                                            {
                                                <div class="breakdown-row">
                                                    <span class="category-icon">@GetCostCategoryIcon(category.Category)</span>
                                                    <span class="category-name">@category.Description</span>
                                                    <span class="category-cost">@FormatCurrency(category.Monthly)</span>
                                                    <span class="category-pct">@category.Percentage.ToString("F0")%</span>
                                                </div>
                                            }
                                        </div>
                                        <div class="breakdown-section">
                                            <div class="section-title">By Environment</div>
                                            @foreach (var env in vmCostEstimate.EnvironmentCosts.Values.OrderByDescending(e => e.MonthlyCost))
                                            {
                                                <div class="breakdown-row">
                                                    <span class="env-dot env-@env.EnvironmentName.ToLower()"></span>
                                                    <span class="env-name">@env.EnvironmentName</span>
                                                    <span class="env-vms">@env.Nodes VMs</span>
                                                    <span class="env-cost">@FormatCurrency(env.MonthlyCost)</span>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>

                                <!-- Alternative Pricing -->
                                <div class="cost-column">
                                    <div class="cost-section-header">
                                        <span>âš™ Alternative Pricing</span>
                                    </div>
                                    <InfraSizingCalculator.Components.Configuration.PricingSelector
                                        Options="@vmCostOptions"
                                        Distribution="@selectedTechnology?.ToString()"
                                        OnCalculate="HandleVMCostCalculate" />
                                </div>
                            </div>
                        }
                        else
                        {
                            <!-- Show pricing selector when no estimate yet -->
                            <div class="cost-initial-setup">
                                <p>Configure pricing options and calculate costs:</p>
                                <InfraSizingCalculator.Components.Configuration.PricingSelector
                                    Options="@vmCostOptions"
                                    Distribution="@selectedTechnology?.ToString()"
                                    OnCalculate="HandleVMCostCalculate" />
                            </div>
                        }
                    </div>
                }

                <!-- Insights Tab Content -->
                @if (vmResultsTab == "insights" && vmValidationWarnings?.Any() == true)
                {
                    <div class="insights-tab-content">
                        <InfraSizingCalculator.Components.Results.ResultsWarnings Warnings="vmValidationWarnings" />
                    </div>
                }

                <!-- Growth Tab Content - Using GrowthPlanningView Component -->
                @if (vmResultsTab == "growth")
                {
                    <div class="growth-tab-content">
                        <InfraSizingCalculator.Components.Results.GrowthPlanningView
                            Settings="@vmGrowthSettings"
                            Projection="@vmGrowthProjection"
                            OnCalculate="HandleVMGrowthCalculate"
                            SettingsChanged="HandleVMGrowthSettingsFromComponent" />
                    </div>
                }

            </div>
        }
    </div>

    <!-- Wizard Footer -->
    <div class="wizard-footer">
        @if (currentStep >= GetResultsStep())
        {
            <button class="btn-nav" @onclick="BackToPricing">
                â† Back to Pricing
            </button>
            <span class="step-indicator">Results</span>
            <button class="btn-nav primary" @onclick="StartNewCalculation">
                New Calculation
            </button>
        }
        else
        {
            <button class="btn-nav" @onclick="PreviousStep" disabled="@(currentStep == 1)">
                Back
            </button>
            <span class="step-indicator">Step @currentStep of @GetTotalSteps()</span>
            <button class="btn-nav primary" @onclick="NextStep" disabled="@(!CanProceed())">
                @(IsLastStep() ? "Calculate" : "Next")
            </button>
        }
    </div>
</div>

<!-- Right Stats Sidebar -->
<RightStatsSidebar HasResults="@(results != null || vmResults != null)"
                   TotalNodes="@GetTotalNodes()"
                   TotalCPU="@GetTotalCPU()"
                   TotalRAM="@GetTotalRAM()"
                   TotalDisk="@GetTotalDisk()"
                   MonthlyEstimate="@GetMonthlyEstimate()"
                   CostProvider="@GetCostProvider()"
                   ShowPricingNotAvailable="@ShouldShowPricingNA()"
                   WarningsCount="@GetWarningsCount()"
                   CriticalCount="@GetCriticalCount()"
                   RecommendationsCount="@GetRecommendationsCount()"
                   OnExport="HandleExport"
                   OnShare="HandleShare"
                   OnSave="() => showSaveScenarioModal = true" />

<!-- Settings Modal -->
@if (showSettings)
{
    <div class="modal-overlay" @onclick="CloseSettings">
        <div class="modal-content settings-modal" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h2>Default Settings</h2>
                <button class="modal-close" @onclick="CloseSettings">Ã—</button>
            </div>
            <div class="settings-body">
                <div class="settings-tabs">
                    <button class="settings-tab @(settingsTab == "infra" ? "active" : "")" @onclick='() => settingsTab = "infra"'>Infrastructure</button>
                    <button class="settings-tab @(settingsTab == "k8s" ? "active" : "")" @onclick='() => settingsTab = "k8s"'>Kubernetes</button>
                    <button class="settings-tab @(settingsTab == "headroom" ? "active" : "")" @onclick='() => settingsTab = "headroom"'>Headroom</button>
                    <button class="settings-tab @(settingsTab == "replicas" ? "active" : "")" @onclick='() => settingsTab = "replicas"'>Replicas</button>
                    <button class="settings-tab @(settingsTab == "nodes" ? "active" : "")" @onclick='() => settingsTab = "nodes"'>Node Defaults</button>
                    <button class="settings-tab @(settingsTab == "tiers" ? "active" : "")" @onclick='() => settingsTab = "tiers"'>App Tiers</button>
                    <button class="settings-tab @(settingsTab == "pricing" ? "active" : "")" @onclick='() => settingsTab = "pricing"'>Pricing</button>
                    <button class="settings-tab @(settingsTab == "mendix" ? "active" : "")" @onclick='() => settingsTab = "mendix"'>Mendix</button>
                </div>

                <div class="settings-panel-container">
                    <!-- Infrastructure Tab -->
                    @if (settingsTab == "infra")
                    {
                        <div class="settings-panel">
                            <h3>Infrastructure Thresholds</h3>
                            <div class="settings-grid">
                                <div class="settings-item">
                                    <label>Large Deployment Threshold</label>
                                    <input type="number" @bind="settings.LargeDeploymentThreshold" />
                                    <div class="hint">Apps count that triggers 5 infra nodes (default: 50)</div>
                                </div>
                                <div class="settings-item">
                                    <label>Large Cluster Worker Threshold</label>
                                    <input type="number" @bind="settings.LargeClusterThreshold" />
                                    <div class="hint">Workers count that triggers 5 masters (default: 100)</div>
                                </div>
                                <div class="settings-item">
                                    <label>Apps Per Infra Node</label>
                                    <input type="number" @bind="settings.AppsPerInfraNode" />
                                    <div class="hint">Ratio for scaling infra nodes (default: 25)</div>
                                </div>
                                <div class="settings-item">
                                    <label>Min Infra Nodes (Large)</label>
                                    <input type="number" @bind="settings.MinProdInfraLarge" />
                                    <div class="hint">Min infra for large deployments (default: 5)</div>
                                </div>
                                <div class="settings-item">
                                    <label>Min Infra Nodes (Small)</label>
                                    <input type="number" @bind="settings.MinProdInfraSmall" />
                                    <div class="hint">Min infra for small deployments (default: 3)</div>
                                </div>
                                <div class="settings-item">
                                    <label>Max Infra Nodes</label>
                                    <input type="number" @bind="settings.MaxInfraNodes" />
                                    <div class="hint">Maximum infra nodes cap (default: 10)</div>
                                </div>
                            </div>
                        </div>
                    }

                    <!-- Kubernetes Tab -->
                    @if (settingsTab == "k8s")
                    {
                        <div class="settings-panel">
                            <h3>Kubernetes Resource Parameters</h3>
                            <div class="settings-section">
                                <h4>Production Settings</h4>
                                <div class="settings-grid">
                                    <div class="settings-item">
                                        <label>CPU Overcommit Ratio</label>
                                        <input type="number" step="0.1" @bind="settings.ProdCpuOvercommit" />
                                        <div class="hint">1:1 = no overcommit (default: 1.0)</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>Memory Overcommit Ratio</label>
                                        <input type="number" step="0.1" @bind="settings.ProdMemoryOvercommit" />
                                        <div class="hint">1:1 = no overcommit (default: 1.0)</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>Resource Buffer (%)</label>
                                        <input type="number" @bind="settings.ProdResourceBuffer" />
                                        <div class="hint">Headroom percentage (default: 30)</div>
                                    </div>
                                </div>
                            </div>
                            <div class="settings-section">
                                <h4>Non-Production Settings</h4>
                                <div class="settings-grid">
                                    <div class="settings-item">
                                        <label>CPU Overcommit Ratio</label>
                                        <input type="number" step="0.1" @bind="settings.NonProdCpuOvercommit" />
                                        <div class="hint">Higher values reduce cost (default: 1.0)</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>Memory Overcommit Ratio</label>
                                        <input type="number" step="0.1" @bind="settings.NonProdMemoryOvercommit" />
                                        <div class="hint">Higher values reduce cost (default: 1.0)</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>Resource Buffer (%)</label>
                                        <input type="number" @bind="settings.NonProdResourceBuffer" />
                                        <div class="hint">Headroom percentage (default: 15)</div>
                                    </div>
                                </div>
                            </div>
                            <div class="settings-section">
                                <h4>System Settings</h4>
                                <div class="settings-grid">
                                    <div class="settings-item">
                                        <label>Node System Reserve (%)</label>
                                        <input type="number" @bind="settings.NodeSystemReserve" />
                                        <div class="hint">Reserved for kubelet, OS (default: 15)</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>Min Worker Nodes</label>
                                        <input type="number" @bind="settings.MinWorkerNodes" />
                                        <div class="hint">Minimum workers per cluster (default: 3)</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }

                    <!-- Headroom Tab -->
                    @if (settingsTab == "headroom")
                    {
                        <div class="settings-panel">
                            <h3>Worker Headroom Percentages</h3>
                            <p class="settings-desc">Extra capacity for scaling and burst traffic</p>
                            <div class="settings-grid">
                                <div class="settings-item">
                                    <label>Dev Headroom (%)</label>
                                    <input type="number" @bind="settings.HeadroomDev" />
                                </div>
                                <div class="settings-item">
                                    <label>Test Headroom (%)</label>
                                    <input type="number" @bind="settings.HeadroomTest" />
                                </div>
                                <div class="settings-item">
                                    <label>Stage Headroom (%)</label>
                                    <input type="number" @bind="settings.HeadroomStage" />
                                </div>
                                <div class="settings-item">
                                    <label>Prod Headroom (%)</label>
                                    <input type="number" step="0.1" @bind="settings.HeadroomProd" />
                                </div>
                                <div class="settings-item">
                                    <label>DR Headroom (%)</label>
                                    <input type="number" step="0.1" @bind="settings.HeadroomDR" />
                                </div>
                            </div>
                        </div>
                    }

                    <!-- Replicas Tab -->
                    @if (settingsTab == "replicas")
                    {
                        <div class="settings-panel">
                            <h3>Default Replica Counts</h3>
                            <p class="settings-desc">Application instances per environment</p>
                            <div class="settings-grid">
                                <div class="settings-item">
                                    <label>Dev Replicas</label>
                                    <input type="number" @bind="settings.ReplicasDev" />
                                </div>
                                <div class="settings-item">
                                    <label>Test Replicas</label>
                                    <input type="number" @bind="settings.ReplicasTest" />
                                </div>
                                <div class="settings-item">
                                    <label>Stage Replicas</label>
                                    <input type="number" @bind="settings.ReplicasStage" />
                                </div>
                                <div class="settings-item">
                                    <label>Prod Replicas</label>
                                    <input type="number" @bind="settings.ReplicasProd" />
                                </div>
                                <div class="settings-item">
                                    <label>DR Replicas</label>
                                    <input type="number" @bind="settings.ReplicasDR" />
                                </div>
                            </div>

                            <div class="settings-section" style="margin-top: 20px;">
                                <h4>Mendix Platform Settings</h4>
                                <div class="settings-grid">
                                    <div class="settings-item">
                                        <label>Mendix Operator Replicas</label>
                                        <input type="number" @bind="settings.MendixOperatorReplicas" min="1" />
                                        <div class="hint">Number of Mendix operator instances (default: 2)</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }

                    <!-- Node Defaults Tab -->
                    @if (settingsTab == "nodes")
                    {
                        <div class="settings-panel">
                            <h3>Default Node Specifications</h3>
                            <p class="settings-desc">Default node sizes loaded when selecting a distribution</p>

                            <div class="settings-section">
                                <h4>Control Plane Defaults</h4>
                                <div class="node-defaults-grid">
                                    <div class="node-default-group">
                                        <label>Production</label>
                                        <div class="inline-inputs">
                                            <div><label>CPU</label><input type="number" @bind="settings.ProdMasterCpu" /></div>
                                            <div><label>RAM</label><input type="number" @bind="settings.ProdMasterRam" /></div>
                                            <div><label>Disk</label><input type="number" @bind="settings.ProdMasterDisk" /></div>
                                        </div>
                                    </div>
                                    <div class="node-default-group">
                                        <label>Non-Production</label>
                                        <div class="inline-inputs">
                                            <div><label>CPU</label><input type="number" @bind="settings.NonProdMasterCpu" /></div>
                                            <div><label>RAM</label><input type="number" @bind="settings.NonProdMasterRam" /></div>
                                            <div><label>Disk</label><input type="number" @bind="settings.NonProdMasterDisk" /></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="settings-section">
                                <h4>Infrastructure Defaults (OpenShift)</h4>
                                <div class="node-defaults-grid">
                                    <div class="node-default-group">
                                        <label>Production</label>
                                        <div class="inline-inputs">
                                            <div><label>CPU</label><input type="number" @bind="settings.ProdInfraCpu" /></div>
                                            <div><label>RAM</label><input type="number" @bind="settings.ProdInfraRam" /></div>
                                            <div><label>Disk</label><input type="number" @bind="settings.ProdInfraDisk" /></div>
                                        </div>
                                    </div>
                                    <div class="node-default-group">
                                        <label>Non-Production</label>
                                        <div class="inline-inputs">
                                            <div><label>CPU</label><input type="number" @bind="settings.NonProdInfraCpu" /></div>
                                            <div><label>RAM</label><input type="number" @bind="settings.NonProdInfraRam" /></div>
                                            <div><label>Disk</label><input type="number" @bind="settings.NonProdInfraDisk" /></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="settings-section">
                                <h4>Worker Defaults</h4>
                                <div class="node-defaults-grid">
                                    <div class="node-default-group">
                                        <label>Production</label>
                                        <div class="inline-inputs">
                                            <div><label>CPU</label><input type="number" @bind="settings.ProdWorkerCpu" /></div>
                                            <div><label>RAM</label><input type="number" @bind="settings.ProdWorkerRam" /></div>
                                            <div><label>Disk</label><input type="number" @bind="settings.ProdWorkerDisk" /></div>
                                        </div>
                                    </div>
                                    <div class="node-default-group">
                                        <label>Non-Production</label>
                                        <div class="inline-inputs">
                                            <div><label>CPU</label><input type="number" @bind="settings.NonProdWorkerCpu" /></div>
                                            <div><label>RAM</label><input type="number" @bind="settings.NonProdWorkerRam" /></div>
                                            <div><label>Disk</label><input type="number" @bind="settings.NonProdWorkerDisk" /></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }

                    <!-- App Tiers Tab -->
                    @if (settingsTab == "tiers")
                    {
                        <div class="settings-panel">
                            <h3>Application Tier Specifications</h3>
                            <p class="settings-desc">Resource allocation per application size (CPU cores / RAM GB)</p>

                            @foreach (var tech in new[] { ("dotnet", ".NET"), ("java", "Java"), ("nodejs", "Node.js"), ("python", "Python"), ("go", "Go"), ("mendix", "Mendix") })
                            {
                                <div class="settings-section">
                                    <h4>@tech.Item2</h4>
                                    <div class="settings-grid">
                                        @foreach (var tier in new[] { "Small", "Medium", "Large", "XLarge" })
                                        {
                                            <div class="settings-item">
                                                <label>@tier CPU (cores)</label>
                                                <input type="number" step="0.125" value="@GetTierCpu(tech.Item1, tier)"
                                                       @onchange="@(e => SetTierCpu(tech.Item1, tier, ParseDouble(e.Value)))" />
                                            </div>
                                            <div class="settings-item">
                                                <label>@tier RAM (GB)</label>
                                                <input type="number" step="0.25" value="@GetTierRam(tech.Item1, tier)"
                                                       @onchange="@(e => SetTierRam(tech.Item1, tier, ParseDouble(e.Value)))" />
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    }

                    <!-- Pricing Tab -->
                    @if (settingsTab == "pricing")
                    {
                        <div class="settings-panel">
                            <h3>On-Premises Pricing Defaults</h3>
                            <p class="settings-desc">Configure default costs for on-premises deployments (used for TCO comparisons)</p>

                            <div class="settings-section">
                                <h4>Hardware Costs</h4>
                                <div class="settings-grid">
                                    <div class="settings-item">
                                        <label>Server Base Cost ($)</label>
                                        <input type="number" min="0" step="100" @bind="onPremPricing.Hardware.ServerCost" />
                                        <div class="hint">Base server hardware cost (default: $5,000)</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>Per CPU Core ($)</label>
                                        <input type="number" min="0" step="10" @bind="onPremPricing.Hardware.PerCpuCore" />
                                        <div class="hint">Cost per CPU core (default: $100)</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>Per GB RAM ($)</label>
                                        <input type="number" min="0" step="1" @bind="onPremPricing.Hardware.PerGBRam" />
                                        <div class="hint">Cost per GB of RAM (default: $10)</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>VMs Per Server</label>
                                        <input type="number" min="1" max="20" @bind="onPremPricing.Hardware.VMsPerServer" />
                                        <div class="hint">VMs per physical server (default: 4)</div>
                                    </div>
                                </div>
                            </div>

                            <div class="settings-section">
                                <h4>Data Center Costs</h4>
                                <div class="settings-grid">
                                    <div class="settings-item">
                                        <label>Rack Unit/Month ($)</label>
                                        <input type="number" min="0" step="10" @bind="onPremPricing.DataCenter.RackUnitPerMonth" />
                                        <div class="hint">Monthly cost per rack unit (default: $100)</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>Power per kWh ($)</label>
                                        <input type="number" min="0" step="0.01" @bind="onPremPricing.DataCenter.PowerPerKWh" />
                                        <div class="hint">Power cost per kWh (default: $0.12)</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>PUE</label>
                                        <input type="number" min="1" max="3" step="0.1" @bind="onPremPricing.DataCenter.PUE" />
                                        <div class="hint">Power Usage Effectiveness (default: 1.5)</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>Cooling Overhead (%)</label>
                                        <input type="number" min="0" max="100" @bind="onPremPricing.DataCenter.CoolingPercent" />
                                        <div class="hint">Cooling as % of power (default: 30%)</div>
                                    </div>
                                </div>
                            </div>

                            <div class="settings-section">
                                <h4>Labor Costs</h4>
                                <div class="settings-grid">
                                    <div class="settings-item">
                                        <label>DevOps Engineer/Month ($)</label>
                                        <input type="number" min="0" step="500" @bind="onPremPricing.Labor.DevOpsEngineerMonthly" />
                                        <div class="hint">Monthly salary (default: $12,000)</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>SysAdmin/Month ($)</label>
                                        <input type="number" min="0" step="500" @bind="onPremPricing.Labor.SysAdminMonthly" />
                                        <div class="hint">Monthly salary (default: $9,000)</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>DBA/Month ($)</label>
                                        <input type="number" min="0" step="500" @bind="onPremPricing.Labor.DBAMonthly" />
                                        <div class="hint">Monthly salary (default: $11,000)</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>Nodes Per Engineer</label>
                                        <input type="number" min="1" max="100" @bind="onPremPricing.Labor.NodesPerEngineer" />
                                        <div class="hint">Nodes managed per engineer (default: 25)</div>
                                    </div>
                                </div>
                            </div>

                            <div class="settings-section">
                                <h4>License Costs</h4>
                                <div class="settings-grid">
                                    <div class="settings-item">
                                        <label>OpenShift/Node/Year ($)</label>
                                        <input type="number" min="0" step="100" @bind="onPremPricing.Licensing.OpenShiftPerNodeYear" />
                                        <div class="hint">Annual license per node (default: $2,500)</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>Tanzu/Core/Year ($)</label>
                                        <input type="number" min="0" step="100" @bind="onPremPricing.Licensing.TanzuPerCoreYear" />
                                        <div class="hint">Annual license per core (default: $1,500)</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>Rancher/Node/Year ($)</label>
                                        <input type="number" min="0" step="100" @bind="onPremPricing.Licensing.RancherEnterprisePerNodeYear" />
                                        <div class="hint">Annual support per node (default: $1,000)</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>Charmed K8s/Node/Year ($)</label>
                                        <input type="number" min="0" step="100" @bind="onPremPricing.Licensing.CharmedK8sPerNodeYear" />
                                        <div class="hint">Annual support per node (default: $500)</div>
                                    </div>
                                </div>
                            </div>

                            <div class="settings-section">
                                <h4>Global Settings</h4>
                                <div class="settings-grid">
                                    <div class="settings-item">
                                        <label>Hardware Refresh (Years)</label>
                                        <input type="number" min="1" max="10" @bind="onPremPricing.HardwareRefreshYears" />
                                        <div class="hint">Hardware refresh cycle (default: 5 years)</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>Maintenance Overhead (%)</label>
                                        <input type="number" min="0" max="50" @bind="onPremPricing.HardwareMaintenancePercent" />
                                        <div class="hint">Annual maintenance as % of hardware (default: 15%)</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }

                    <!-- Mendix Pricing Tab -->
                    @if (settingsTab == "mendix")
                    {
                        <div class="settings-panel mendix-settings-panel">
                            <h3>Mendix Platform Pricing</h3>
                            <p class="settings-desc">Official Mendix pricing from the June 2025 pricebook. Update these values when pricing changes.</p>

                            <div class="settings-section">
                                <h4>Cloud Tokens & Base Pricing</h4>
                                <div class="settings-grid">
                                    <div class="settings-item">
                                        <label>Cloud Token Price ($)</label>
                                        <input type="number" min="0" step="0.01" @bind="mendixPricingSettings.CloudTokenPrice" />
                                        <div class="hint">Price per cloud token (default: $51.60)</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>Cloud Dedicated/Year ($)</label>
                                        <input type="number" min="0" step="100" @bind="mendixPricingSettings.CloudDedicatedPricePerYear" />
                                        <div class="hint">Mendix Cloud Dedicated (default: $368,100)</div>
                                    </div>
                                </div>
                            </div>

                            <div class="settings-section">
                                <h4>Mendix on Azure</h4>
                                <div class="settings-grid">
                                    <div class="settings-item">
                                        <label>Base Price/Year ($)</label>
                                        <input type="number" min="0" step="10" @bind="mendixPricingSettings.AzureBasePricePerYear" />
                                        <div class="hint">Base annual fee (default: $6,612)</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>Included Environments</label>
                                        <input type="number" min="1" max="10" @bind="mendixPricingSettings.AzureBaseEnvironmentsIncluded" />
                                        <div class="hint">Environments in base (default: 3)</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>Additional Env Price ($)</label>
                                        <input type="number" min="0" step="10" @bind="mendixPricingSettings.AzureAdditionalEnvironmentPrice" />
                                        <div class="hint">Per additional environment (default: $722.40)</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>Additional Env Tokens</label>
                                        <input type="number" min="0" @bind="mendixPricingSettings.AzureAdditionalEnvironmentTokens" />
                                        <div class="hint">Tokens per additional env (default: 14)</div>
                                    </div>
                                </div>
                            </div>

                            <div class="settings-section">
                                <h4>Mendix on Kubernetes</h4>
                                <div class="settings-grid">
                                    <div class="settings-item">
                                        <label>Base Price/Year ($)</label>
                                        <input type="number" min="0" step="10" @bind="mendixPricingSettings.K8sBasePricePerYear" />
                                        <div class="hint">Base annual fee (default: $6,360)</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>Included Environments</label>
                                        <input type="number" min="0" max="10" @bind="mendixPricingSettings.K8sBaseEnvironmentsIncluded" />
                                        <div class="hint">Environments in base (default: 0)</div>
                                    </div>
                                </div>
                                <h5 style="margin-top: 15px;">Environment Tiers (Price per Environment)</h5>
                                <div class="settings-grid">
                                    @if (mendixPricingSettings.K8sEnvironmentTiers != null)
                                    {
                                        @foreach (var tier in mendixPricingSettings.K8sEnvironmentTiers)
                                        {
                                            <div class="settings-item">
                                                <label>@tier.MinEnvironments-@(tier.MaxEnvironments == -1 ? "âˆž" : tier.MaxEnvironments.ToString()) Envs ($)</label>
                                                <input type="number" min="0" step="10" @bind="tier.PricePerEnvironment" />
                                            </div>
                                        }
                                    }
                                </div>
                            </div>

                            <div class="settings-section">
                                <h4>Server / StackIT / SAP BTP Deployments</h4>
                                <div class="settings-grid">
                                    <div class="settings-item">
                                        <label>Server Per-App/Year ($)</label>
                                        <input type="number" min="0" step="100" @bind="mendixPricingSettings.ServerPerAppPricePerYear" />
                                        <div class="hint">Default: $6,612</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>Server Unlimited/Year ($)</label>
                                        <input type="number" min="0" step="100" @bind="mendixPricingSettings.ServerUnlimitedAppsPricePerYear" />
                                        <div class="hint">Default: $33,060</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>StackIT Per-App/Year ($)</label>
                                        <input type="number" min="0" step="100" @bind="mendixPricingSettings.StackITPerAppPricePerYear" />
                                        <div class="hint">Default: $6,612</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>StackIT Unlimited/Year ($)</label>
                                        <input type="number" min="0" step="100" @bind="mendixPricingSettings.StackITUnlimitedAppsPricePerYear" />
                                        <div class="hint">Default: $33,060</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>SAP BTP Per-App/Year ($)</label>
                                        <input type="number" min="0" step="100" @bind="mendixPricingSettings.SapBtpPerAppPricePerYear" />
                                        <div class="hint">Default: $6,612</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>SAP BTP Unlimited/Year ($)</label>
                                        <input type="number" min="0" step="100" @bind="mendixPricingSettings.SapBtpUnlimitedAppsPricePerYear" />
                                        <div class="hint">Default: $33,060</div>
                                    </div>
                                </div>
                            </div>

                            <div class="settings-section">
                                <h4>User & Platform Licensing</h4>
                                <div class="settings-grid">
                                    <div class="settings-item">
                                        <label>Platform Premium/Year ($)</label>
                                        <input type="number" min="0" step="100" @bind="mendixPricingSettings.PlatformPremiumUnlimitedPerYear" />
                                        <div class="hint">Unlimited apps license (default: $65,400)</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>Internal Users/100/Year ($)</label>
                                        <input type="number" min="0" step="100" @bind="mendixPricingSettings.InternalUsersPer100PerYear" />
                                        <div class="hint">Per 100 internal users (default: $40,800)</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>External Users/250K/Year ($)</label>
                                        <input type="number" min="0" step="100" @bind="mendixPricingSettings.ExternalUsersPer250KPerYear" />
                                        <div class="hint">Per 250K external users (default: $60,000)</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>Volume Discount (%)</label>
                                        <input type="number" min="0" max="50" step="1" @bind="mendixPricingSettings.VolumeDiscountPercent" />
                                        <div class="hint">Discount on platform + user licenses (default: 10%)</div>
                                    </div>
                                </div>
                            </div>

                            <div class="settings-section">
                                <h4>Additional Storage Pricing</h4>
                                <div class="settings-grid">
                                    <div class="settings-item">
                                        <label>File Storage/100GB/Year ($)</label>
                                        <input type="number" min="0" step="1" @bind="mendixPricingSettings.AdditionalFileStoragePer100GB" />
                                        <div class="hint">Default: $123</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>DB Storage/100GB/Year ($)</label>
                                        <input type="number" min="0" step="1" @bind="mendixPricingSettings.AdditionalDatabaseStoragePer100GB" />
                                        <div class="hint">Default: $246</div>
                                    </div>
                                </div>
                            </div>

                            <div class="settings-section">
                                <h4>ðŸ¤– GenAI Add-ons</h4>
                                <div class="settings-grid">
                                    <div class="settings-item">
                                        <label>Knowledge Base/Year ($)</label>
                                        <input type="number" min="0" step="100" @bind="mendixPricingSettings.GenAIKnowledgeBasePricePerYear" />
                                        <div class="hint">Default: $12,000</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>Knowledge Base Tokens</label>
                                        <input type="number" min="0" @bind="mendixPricingSettings.GenAIKnowledgeBaseTokens" />
                                        <div class="hint">Cloud tokens included (default: 232)</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>Customer Enablement ($)</label>
                                        <input type="number" min="0" step="100" @bind="mendixPricingSettings.CustomerEnablementPrice" />
                                        <div class="hint">One-time fee (default: $11,000)</div>
                                    </div>
                                </div>
                            </div>

                            <details class="settings-collapsible">
                                <summary>Standard Resource Packs (99.5% SLA)</summary>
                                <div class="resource-packs-grid">
                                    @if (mendixPricingSettings.StandardResourcePacks != null)
                                    {
                                        @foreach (var pack in mendixPricingSettings.StandardResourcePacks)
                                        {
                                            <div class="resource-pack-item">
                                                <label>@pack.DisplayName Price/Year ($)</label>
                                                <input type="number" min="0" step="100" @bind="pack.PricePerYear" />
                                                <span class="pack-specs">@pack.MxMemoryGB GB | @pack.MxVCpu vCPU | @pack.DbStorageGB GB DB</span>
                                            </div>
                                        }
                                    }
                                </div>
                            </details>

                            <details class="settings-collapsible">
                                <summary>Premium Resource Packs (99.95% SLA + Fallback)</summary>
                                <div class="resource-packs-grid">
                                    @if (mendixPricingSettings.PremiumResourcePacks != null)
                                    {
                                        @foreach (var pack in mendixPricingSettings.PremiumResourcePacks)
                                        {
                                            <div class="resource-pack-item">
                                                <label>@pack.DisplayName Price/Year ($)</label>
                                                <input type="number" min="0" step="100" @bind="pack.PricePerYear" />
                                                <span class="pack-specs">@pack.MxMemoryGB GB | @pack.MxVCpu vCPU | @pack.DbStorageGB GB DB</span>
                                            </div>
                                        }
                                    }
                                </div>
                            </details>

                            <details class="settings-collapsible">
                                <summary>Premium Plus Resource Packs (Multi-Region Failover)</summary>
                                <div class="resource-packs-grid">
                                    @if (mendixPricingSettings.PremiumPlusResourcePacks != null)
                                    {
                                        @foreach (var pack in mendixPricingSettings.PremiumPlusResourcePacks)
                                        {
                                            <div class="resource-pack-item">
                                                <label>@pack.DisplayName Price/Year ($)</label>
                                                <input type="number" min="0" step="100" @bind="pack.PricePerYear" />
                                                <span class="pack-specs">@pack.MxMemoryGB GB | @pack.MxVCpu vCPU | @pack.DbStorageGB GB DB</span>
                                            </div>
                                        }
                                    }
                                </div>
                            </details>

                            <details class="settings-collapsible">
                                <summary>GenAI Model Packs</summary>
                                <div class="resource-packs-grid">
                                    @if (mendixPricingSettings.GenAIModelPacks != null)
                                    {
                                        @foreach (var pack in mendixPricingSettings.GenAIModelPacks)
                                        {
                                            <div class="resource-pack-item">
                                                <label>@pack.Size Price/Year ($)</label>
                                                <input type="number" min="0" step="100" @bind="pack.PricePerYear" />
                                                <span class="pack-specs">@pack.CloudTokens tokens</span>
                                            </div>
                                        }
                                    }
                                </div>
                            </details>
                        </div>
                    }
                </div>
            </div>
            <div class="modal-footer">
                <div class="modal-footer-left">
                    <button class="modal-btn reset" @onclick="ResetSettings">Reset to Defaults</button>
                </div>
                <button class="modal-btn primary" @onclick="SaveAndCloseSettings">Save & Close</button>
            </div>
        </div>
    </div>
}

<!-- Profiles removed - using Scenarios instead -->

<!-- Info Modal -->
@if (showInfoModal)
{
    <div class="modal-overlay" @onclick="() => showInfoModal = false">
        <div class="modal-content" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h2>@infoModalTitle</h2>
                <button class="modal-close" @onclick="() => showInfoModal = false">Ã—</button>
            </div>
            <div class="modal-body info-content">
                @((MarkupString)infoModalContent)
            </div>
            <div class="modal-footer">
                <button class="modal-btn primary" @onclick="() => showInfoModal = false">Close</button>
            </div>
        </div>
    </div>
}

<!-- Save Scenario Modal -->
@if (showSaveScenarioModal)
{
    <SaveScenarioModal @bind-IsVisible="showSaveScenarioModal"
                       K8sInput="@GetK8sSizingInput()"
                       K8sResult="@results"
                       VMInput="@GetVMSizingInput()"
                       VMResult="@vmResults"
                       CostEstimate="@(results != null ? k8sCostEstimate : vmCostEstimate)"
                       OnSaved="HandleScenarioSaved" />
}

<!-- Toast Notification -->
@if (showShareCopied)
{
    <div class="toast-notification success">
        <span class="toast-icon icon icon-check"></span>
        <span class="toast-message">Link copied to clipboard!</span>
    </div>
}

