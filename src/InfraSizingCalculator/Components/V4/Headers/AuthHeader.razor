@*
    AuthHeader.razor - v0.4.4 Header for authenticated users

    Matches wireframe 01-dashboard-k8s.html:
    - Logo left
    - Export + Calculate + Settings + Avatar right
    - No scenario selector (it's in the side panel)
*@

<div class="header-logo">
    <a href="/" data-testid="header-logo">InfraSizing</a>
</div>
<div class="header-center"></div>
<div class="header-right">
    <button class="btn btn-sm btn-secondary" @onclick="HandleExport" data-testid="btn-export">Export</button>
    <button class="btn btn-sm btn-primary" @onclick="HandleCalculate" data-testid="btn-calculate">Calculate</button>
    <a href="/settings" class="btn btn-sm btn-ghost" data-testid="btn-settings">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="3"/>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4"/>
        </svg>
    </a>
    <div class="user-avatar" @onclick="ToggleUserMenu" data-testid="user-avatar">
        @GetUserInitials()
    </div>

    @* User dropdown menu *@
    @if (_userMenuOpen)
    {
        <div class="user-dropdown" data-testid="user-dropdown">
            <div class="user-dropdown-header">
                <span class="user-name">@UserName</span>
                <span class="user-email">@UserEmail</span>
            </div>
            <div class="user-dropdown-divider"></div>
            <a href="/scenarios" class="user-dropdown-item">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                </svg>
                My Scenarios
            </a>
            <a href="/settings" class="user-dropdown-item">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83"/>
                </svg>
                Settings
            </a>
            <div class="user-dropdown-divider"></div>
            <button class="user-dropdown-item logout" @onclick="HandleLogout">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                    <polyline points="16 17 21 12 16 7"/>
                    <line x1="21" y1="12" x2="9" y2="12"/>
                </svg>
                Sign Out
            </button>
        </div>
    }
</div>

@* Click outside to close dropdown *@
@if (_userMenuOpen)
{
    <div class="header-overlay" @onclick="CloseDropdowns" data-testid="header-overlay"></div>
}

@code {
    private bool _userMenuOpen = false;

    /// <summary>
    /// Current user's display name
    /// </summary>
    [Parameter]
    public string? UserName { get; set; }

    /// <summary>
    /// Current user's email
    /// </summary>
    [Parameter]
    public string? UserEmail { get; set; }

    /// <summary>
    /// Callback when Export is clicked
    /// </summary>
    [Parameter]
    public EventCallback OnExport { get; set; }

    /// <summary>
    /// Callback when Calculate is clicked
    /// </summary>
    [Parameter]
    public EventCallback OnCalculate { get; set; }

    /// <summary>
    /// Callback when logout is requested
    /// </summary>
    [Parameter]
    public EventCallback OnLogout { get; set; }

    private string GetUserInitials()
    {
        if (string.IsNullOrEmpty(UserName))
            return "?";

        var parts = UserName.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
            return $"{parts[0][0]}{parts[1][0]}".ToUpper();

        return UserName.Length >= 1
            ? UserName.Substring(0, 1).ToUpper()
            : "?";
    }

    private void ToggleUserMenu()
    {
        _userMenuOpen = !_userMenuOpen;
    }

    private void CloseDropdowns()
    {
        _userMenuOpen = false;
    }

    private async Task HandleExport()
    {
        await OnExport.InvokeAsync();
    }

    private async Task HandleCalculate()
    {
        await OnCalculate.InvokeAsync();
    }

    private async Task HandleLogout()
    {
        CloseDropdowns();
        await OnLogout.InvokeAsync();
    }
}
