@using InfraSizingCalculator.Models.Growth

<div class="growth-timeline @AdditionalClass">
    @if (Projection != null)
    {
        <!-- Warnings Section -->
        @if (Projection.Warnings.Any() && Projection.Settings.ShowClusterLimitWarnings)
        {
            <div class="timeline-section warnings-section">
                <h4>
                    <span class="section-icon">‚ö†Ô∏è</span>
                    Cluster Limit Warnings
                    <span class="warning-count">(@Projection.Warnings.Count)</span>
                </h4>
                <div class="warnings-list">
                    @foreach (var warning in Projection.Warnings.OrderBy(w => w.YearTriggered).ThenByDescending(w => w.Severity))
                    {
                        <div class="warning-item severity-@warning.Severity.ToString().ToLower()">
                            <div class="warning-year">
                                <span class="year-badge">Year @warning.YearTriggered</span>
                            </div>
                            <div class="warning-content">
                                <div class="warning-header">
                                    <span class="warning-type">@GetWarningTypeIcon(warning.Type) @warning.ResourceType</span>
                                    <span class="warning-severity">@warning.Severity</span>
                                </div>
                                <p class="warning-message">@warning.Message</p>
                                <div class="warning-details">
                                    <span class="detail-item">
                                        <span class="detail-label">Current:</span>
                                        <span class="detail-value">@warning.CurrentValue.ToString("N0")</span>
                                    </span>
                                    <span class="detail-item">
                                        <span class="detail-label">Projected:</span>
                                        <span class="detail-value">@warning.ProjectedValue.ToString("N0")</span>
                                    </span>
                                    <span class="detail-item">
                                        <span class="detail-label">Limit:</span>
                                        <span class="detail-value">@warning.Limit.ToString("N0")</span>
                                    </span>
                                    <span class="detail-item highlight">
                                        <span class="detail-label">% of Limit:</span>
                                        <span class="detail-value">@warning.PercentageOfLimit.ToString("F0")%</span>
                                    </span>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        }

        <!-- Recommendations Section -->
        @if (Projection.Recommendations.Any())
        {
            <div class="timeline-section recommendations-section">
                <h4>
                    <span class="section-icon">üí°</span>
                    Scaling Recommendations
                    <span class="recommendation-count">(@Projection.Recommendations.Count)</span>
                </h4>
                <div class="recommendations-list">
                    @foreach (var rec in Projection.Recommendations.OrderBy(r => r.Priority))
                    {
                        <div class="recommendation-item priority-@rec.Priority">
                            <div class="rec-priority">
                                <span class="priority-badge">P@rec.Priority</span>
                                @if (rec.RecommendedYear > 0)
                                {
                                    <span class="rec-year">Year @rec.RecommendedYear</span>
                                }
                            </div>
                            <div class="rec-content">
                                <div class="rec-header">
                                    <span class="rec-icon">@rec.Icon</span>
                                    <span class="rec-title">@rec.Title</span>
                                    <span class="rec-type type-@rec.Type.ToString().ToLower()">@GetRecommendationTypeLabel(rec.Type)</span>
                                </div>
                                <p class="rec-description">@rec.Description</p>
                                @if (rec.EstimatedCostImpact != 0)
                                {
                                    <div class="rec-cost-impact @(rec.EstimatedCostImpact > 0 ? "increase" : "savings")">
                                        <span class="cost-label">Est. Cost Impact:</span>
                                        <span class="cost-value">
                                            @(rec.EstimatedCostImpact > 0 ? "+" : "")@FormatCurrency(rec.EstimatedCostImpact)/mo
                                        </span>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>
        }

        <!-- Timeline Milestones -->
        @if (Projection.Summary.MajorScalingYear.HasValue || Projection.Summary.CriticalWarningCount > 0)
        {
            <div class="timeline-section milestones-section">
                <h4>
                    <span class="section-icon">üìÖ</span>
                    Key Milestones
                </h4>
                <div class="milestones-timeline">
                    <div class="timeline-line"></div>
                    @foreach (var year in Enumerable.Range(1, Projection.Settings.ProjectionYears))
                    {
                        var yearWarnings = Projection.Warnings.Where(w => w.YearTriggered == year).ToList();
                        var yearRecs = Projection.Recommendations.Where(r => r.RecommendedYear == year).ToList();
                        var isMajorYear = Projection.Summary.MajorScalingYear == year;
                        var hasCritical = yearWarnings.Any(w => w.Severity == Models.Growth.WarningSeverity.Critical);

                        <div class="milestone @(isMajorYear ? "major" : "") @(hasCritical ? "critical" : "") @(yearWarnings.Any() || yearRecs.Any() ? "has-events" : "")">
                            <div class="milestone-marker"></div>
                            <div class="milestone-content">
                                <span class="milestone-year">Year @year</span>
                                @if (yearWarnings.Any() || yearRecs.Any())
                                {
                                    <div class="milestone-events">
                                        @if (yearWarnings.Any())
                                        {
                                            <span class="event-badge warnings">@yearWarnings.Count warning(s)</span>
                                        }
                                        @if (yearRecs.Any())
                                        {
                                            <span class="event-badge recs">@yearRecs.Count action(s)</span>
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>
        }

        <!-- Summary Stats -->
        <div class="timeline-section summary-section">
            <h4>
                <span class="section-icon">üìä</span>
                Projection Summary
            </h4>
            <div class="summary-stats">
                <div class="stat-item">
                    <span class="stat-label">Projection Period</span>
                    <span class="stat-value">@Projection.Settings.ProjectionYears Year(s)</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Growth Pattern</span>
                    <span class="stat-value">@Projection.Settings.Pattern</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Annual Growth Rate</span>
                    <span class="stat-value">@Projection.Settings.AnnualGrowthRate%</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Total Warnings</span>
                    <span class="stat-value @(Projection.Summary.WarningCount > 0 ? "warning" : "")">@Projection.Summary.WarningCount</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Critical Warnings</span>
                    <span class="stat-value @(Projection.Summary.CriticalWarningCount > 0 ? "critical" : "")">@Projection.Summary.CriticalWarningCount</span>
                </div>
                @if (Projection.Summary.MajorScalingYear.HasValue)
                {
                    <div class="stat-item highlight">
                        <span class="stat-label">Major Scaling Year</span>
                        <span class="stat-value">Year @Projection.Summary.MajorScalingYear</span>
                    </div>
                }
            </div>
        </div>

        @if (!Projection.Warnings.Any() && !Projection.Recommendations.Any())
        {
            <div class="no-issues">
                <span class="no-issues-icon">‚úÖ</span>
                <p>No cluster limit warnings or scaling recommendations for the projected period.</p>
                <p class="no-issues-detail">Your infrastructure should handle the projected growth within cluster limits.</p>
            </div>
        }
    }
    else
    {
        <div class="no-projection">
            <span class="no-projection-icon">üìÖ</span>
            <p>Calculate a growth projection to see timeline, warnings, and recommendations.</p>
        </div>
    }
</div>

@code {
    [Parameter] public GrowthProjection? Projection { get; set; }
    [Parameter] public string? AdditionalClass { get; set; }

    private string GetWarningTypeIcon(WarningType type) => type switch
    {
        WarningType.NodeLimit => "üñ•Ô∏è",
        WarningType.PodLimit => "üì¶",
        WarningType.CpuCapacity => "‚ö°",
        WarningType.MemoryCapacity => "üìä",
        WarningType.StorageCapacity => "üíæ",
        WarningType.CostThreshold => "üí∞",
        WarningType.ClusterSplit => "üåê",
        _ => "‚ö†Ô∏è"
    };

    private string GetRecommendationTypeLabel(RecommendationType type) => type switch
    {
        RecommendationType.UpgradeNodeSize => "Upgrade",
        RecommendationType.AddWorkerNodes => "Scale Out",
        RecommendationType.SplitCluster => "Split",
        RecommendationType.AddCluster => "New Cluster",
        RecommendationType.EnableAutoscaling => "Autoscale",
        RecommendationType.OptimizeResources => "Optimize",
        RecommendationType.ReviewOverprovisioning => "Review",
        RecommendationType.ConsiderManagedService => "Managed",
        _ => type.ToString()
    };

    private string FormatCurrency(decimal value)
    {
        var absValue = Math.Abs(value);
        if (absValue >= 1_000_000)
            return $"${value / 1_000_000:F2}M";
        if (absValue >= 1_000)
            return $"${value / 1_000:F1}K";
        return $"${value:F0}";
    }
}

<style>
    .growth-timeline {
        background: var(--background-card);
        border-radius: 8px;
        padding: 1.5rem;
    }

    .timeline-section {
        margin-bottom: 2rem;
    }

    .timeline-section:last-child {
        margin-bottom: 0;
    }

    .timeline-section h4 {
        margin: 0 0 1rem 0;
        color: var(--text-primary);
        font-size: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .section-icon {
        font-size: 1.1rem;
    }

    .warning-count,
    .recommendation-count {
        font-size: 0.8rem;
        color: var(--text-secondary);
        font-weight: normal;
    }

    /* Warnings */
    .warnings-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .warning-item {
        display: flex;
        gap: 1rem;
        padding: 1rem;
        border-radius: 8px;
        background: var(--background-dark);
        border-left: 4px solid;
    }

    .warning-item.severity-info {
        border-left-color: #3498db;
    }

    .warning-item.severity-warning {
        border-left-color: #f39c12;
        background: rgba(243, 156, 18, 0.1);
    }

    .warning-item.severity-critical {
        border-left-color: #e74c3c;
        background: rgba(231, 76, 60, 0.1);
    }

    .warning-year {
        flex-shrink: 0;
    }

    .year-badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        background: var(--background-card);
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--text-primary);
    }

    .warning-content {
        flex: 1;
    }

    .warning-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }

    .warning-type {
        font-weight: 600;
        color: var(--text-primary);
    }

    .warning-severity {
        font-size: 0.7rem;
        padding: 0.15rem 0.4rem;
        border-radius: 3px;
        text-transform: uppercase;
        font-weight: 600;
    }

    .severity-info .warning-severity {
        background: rgba(52, 152, 219, 0.2);
        color: #3498db;
    }

    .severity-warning .warning-severity {
        background: rgba(243, 156, 18, 0.2);
        color: #f39c12;
    }

    .severity-critical .warning-severity {
        background: rgba(231, 76, 60, 0.2);
        color: #e74c3c;
    }

    .warning-message {
        margin: 0 0 0.75rem 0;
        color: var(--text-secondary);
        font-size: 0.9rem;
    }

    .warning-details {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .detail-item {
        font-size: 0.8rem;
    }

    .detail-label {
        color: var(--text-secondary);
    }

    .detail-value {
        color: var(--text-primary);
        font-weight: 500;
        margin-left: 0.25rem;
    }

    .detail-item.highlight .detail-value {
        color: var(--primary-color);
    }

    /* Recommendations */
    .recommendations-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .recommendation-item {
        display: flex;
        gap: 1rem;
        padding: 1rem;
        border-radius: 8px;
        background: var(--background-dark);
        border: 1px solid var(--border-color);
    }

    .recommendation-item.priority-1 {
        border-color: var(--primary-color);
        border-width: 2px;
    }

    .rec-priority {
        flex-shrink: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.25rem;
    }

    .priority-badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        background: var(--primary-color);
        color: white;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: 700;
    }

    .rec-year {
        font-size: 0.7rem;
        color: var(--text-secondary);
    }

    .rec-content {
        flex: 1;
    }

    .rec-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
    }

    .rec-icon {
        font-size: 1.2rem;
    }

    .rec-title {
        font-weight: 600;
        color: var(--text-primary);
    }

    .rec-type {
        font-size: 0.65rem;
        padding: 0.15rem 0.4rem;
        border-radius: 3px;
        text-transform: uppercase;
        font-weight: 600;
        background: var(--background-card);
        color: var(--text-secondary);
    }

    .rec-description {
        margin: 0 0 0.5rem 0;
        color: var(--text-secondary);
        font-size: 0.9rem;
    }

    .rec-cost-impact {
        font-size: 0.8rem;
        padding: 0.5rem;
        border-radius: 4px;
        display: inline-block;
    }

    .rec-cost-impact.increase {
        background: rgba(243, 156, 18, 0.1);
        color: #f39c12;
    }

    .rec-cost-impact.savings {
        background: rgba(39, 174, 96, 0.1);
        color: #27ae60;
    }

    .cost-label {
        font-weight: 500;
    }

    .cost-value {
        font-weight: 600;
        margin-left: 0.25rem;
    }

    /* Milestones Timeline */
    .milestones-timeline {
        position: relative;
        padding-left: 2rem;
    }

    .timeline-line {
        position: absolute;
        left: 8px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: var(--border-color);
    }

    .milestone {
        position: relative;
        padding: 0.75rem 0;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .milestone-marker {
        position: absolute;
        left: -2rem;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: var(--background-card);
        border: 3px solid var(--border-color);
        z-index: 1;
    }

    .milestone.has-events .milestone-marker {
        border-color: var(--primary-color);
        background: var(--primary-color);
    }

    .milestone.critical .milestone-marker {
        border-color: #e74c3c;
        background: #e74c3c;
    }

    .milestone.major .milestone-marker {
        border-color: #f39c12;
        background: #f39c12;
        width: 20px;
        height: 20px;
        left: calc(-2rem - 2px);
    }

    .milestone-content {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .milestone-year {
        font-weight: 600;
        color: var(--text-primary);
        min-width: 60px;
    }

    .milestone-events {
        display: flex;
        gap: 0.5rem;
    }

    .event-badge {
        font-size: 0.7rem;
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
    }

    .event-badge.warnings {
        background: rgba(243, 156, 18, 0.2);
        color: #f39c12;
    }

    .event-badge.recs {
        background: rgba(52, 152, 219, 0.2);
        color: #3498db;
    }

    /* Summary Stats */
    .summary-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
    }

    .stat-item {
        display: flex;
        flex-direction: column;
        padding: 0.75rem;
        background: var(--background-dark);
        border-radius: 6px;
    }

    .stat-item.highlight {
        border: 2px solid var(--primary-color);
    }

    .stat-label {
        font-size: 0.75rem;
        color: var(--text-secondary);
        margin-bottom: 0.25rem;
    }

    .stat-value {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-primary);
    }

    .stat-value.warning {
        color: #f39c12;
    }

    .stat-value.critical {
        color: #e74c3c;
    }

    /* No Issues State */
    .no-issues {
        text-align: center;
        padding: 2rem;
        background: rgba(39, 174, 96, 0.1);
        border-radius: 8px;
    }

    .no-issues-icon {
        font-size: 2.5rem;
        display: block;
        margin-bottom: 0.5rem;
    }

    .no-issues p {
        margin: 0;
        color: var(--text-primary);
    }

    .no-issues-detail {
        margin-top: 0.5rem !important;
        color: var(--text-secondary) !important;
        font-size: 0.9rem;
    }

    /* No Projection State */
    .no-projection {
        text-align: center;
        padding: 3rem;
        color: var(--text-secondary);
    }

    .no-projection-icon {
        font-size: 3rem;
        display: block;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    /* Light theme */
    [data-theme="light"] .growth-timeline {
        background: #fff;
        border: 1px solid var(--border-color);
    }

    [data-theme="light"] .warning-item,
    [data-theme="light"] .recommendation-item,
    [data-theme="light"] .stat-item {
        background: #f8f9fa;
    }
</style>
