@*
    ExportModal.razor - v0.4.4 Export Modal
    Matches wireframe: 20-export-modal.html

    - Modal overlay with centered dialog
    - Format selection: Excel, PDF, JSON, CSV
    - Include options checkboxes
    - Date range and currency dropdowns
    - Export preview section
*@

@using InfraSizingCalculator.Services.Interfaces

<div class="modal-overlay @(IsVisible ? "visible" : "")" @onclick="HandleOverlayClick" data-testid="export-modal">
    <div class="modal" @onclick:stopPropagation="true">
        <!-- Header -->
        <div class="modal-header">
            <div class="modal-title">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7 10 12 15 17 10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                Export Configuration
            </div>
            <button class="close-btn" @onclick="Close">Ã—</button>
        </div>

        <!-- Body -->
        <div class="modal-body">
            <!-- Scenario Info -->
            <div class="scenario-info">
                <div class="scenario-name">@ScenarioName</div>
                <div class="scenario-meta">
                    <span class="badge badge-@ScenarioType">@(ScenarioType == "k8s" ? "K8s" : "VM")</span>
                    @ScenarioDetails
                </div>
            </div>

            <!-- Format Selection -->
            <div class="form-label">Export Format</div>
            <div class="export-format">
                <div class="format-card @(_selectedFormat == "excel" ? "selected" : "")" @onclick='() => SelectFormat("excel")'>
                    <div class="format-icon excel">XLS</div>
                    <span class="format-label">Excel</span>
                </div>
                <div class="format-card @(_selectedFormat == "pdf" ? "selected" : "")" @onclick='() => SelectFormat("pdf")'>
                    <div class="format-icon pdf">PDF</div>
                    <span class="format-label">PDF</span>
                </div>
                <div class="format-card @(_selectedFormat == "json" ? "selected" : "")" @onclick='() => SelectFormat("json")'>
                    <div class="format-icon json">{}</div>
                    <span class="format-label">JSON</span>
                </div>
                <div class="format-card @(_selectedFormat == "csv" ? "selected" : "")" @onclick='() => SelectFormat("csv")'>
                    <div class="format-icon csv">CSV</div>
                    <span class="format-label">CSV</span>
                </div>
            </div>

            <!-- Include Options -->
            <div class="section-divider">
                <div class="form-label">Include in Export</div>
                <div class="include-options">
                    <div class="include-option @(_includeConfig ? "selected" : "")" @onclick="() => _includeConfig = !_includeConfig">
                        <div class="checkbox-icon"></div>
                        <div class="option-info">
                            <div class="option-label">Configuration Summary</div>
                            <div class="option-desc">Platform, applications, and node specifications</div>
                        </div>
                    </div>
                    <div class="include-option @(_includeSizing ? "selected" : "")" @onclick="() => _includeSizing = !_includeSizing">
                        <div class="checkbox-icon"></div>
                        <div class="option-info">
                            <div class="option-label">Sizing Results</div>
                            <div class="option-desc">Node counts, resource allocations, distribution breakdown</div>
                        </div>
                    </div>
                    <div class="include-option @(_includeCost ? "selected" : "")" @onclick="() => _includeCost = !_includeCost">
                        <div class="checkbox-icon"></div>
                        <div class="option-info">
                            <div class="option-label">Cost Analysis</div>
                            <div class="option-desc">Monthly costs, TCO projections, cost per application</div>
                        </div>
                    </div>
                    <div class="include-option @(_includeGrowth ? "selected" : "")" @onclick="() => _includeGrowth = !_includeGrowth">
                        <div class="checkbox-icon"></div>
                        <div class="option-info">
                            <div class="option-label">Growth Projections</div>
                            <div class="option-desc">5-year capacity and cost projections</div>
                        </div>
                    </div>
                    <div class="include-option @(_includeCloud ? "selected" : "")" @onclick="() => _includeCloud = !_includeCloud">
                        <div class="checkbox-icon"></div>
                        <div class="option-info">
                            <div class="option-label">Cloud Alternatives Comparison</div>
                            <div class="option-desc">Comparison with managed cloud services</div>
                        </div>
                    </div>
                    <div class="include-option @(_includeTables ? "selected" : "")" @onclick="() => _includeTables = !_includeTables">
                        <div class="checkbox-icon"></div>
                        <div class="option-info">
                            <div class="option-label">Detailed Breakdown Tables</div>
                            <div class="option-desc">Per-node and per-application resource tables</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Additional Options -->
            <div class="section-divider">
                <div class="options-grid">
                    <div class="form-group">
                        <label class="form-label">Date Range</label>
                        <select class="form-select" @bind="_dateRange">
                            <option value="current">Current snapshot</option>
                            <option value="30">Last 30 days</option>
                            <option value="90">Last 90 days</option>
                            <option value="custom">Custom range</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Currency</label>
                        <select class="form-select" @bind="_currency">
                            <option value="USD">USD ($)</option>
                            <option value="EUR">EUR</option>
                            <option value="GBP">GBP</option>
                            <option value="AUD">AUD (A$)</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Preview -->
            <div class="preview-section">
                <div class="preview-header">
                    <span class="preview-title">Export Preview</span>
                    <span class="file-size">~@GetEstimatedSize()</span>
                </div>
                <div class="preview-content">
                    @if (_includeConfig)
                    {
                        <div class="preview-item">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                            <span>Configuration Summary (1 @GetSheetLabel())</span>
                        </div>
                    }
                    @if (_includeSizing)
                    {
                        <div class="preview-item">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                            <span>Sizing Results (2 @GetSheetLabel()s)</span>
                        </div>
                    }
                    @if (_includeCost)
                    {
                        <div class="preview-item">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                            <span>Cost Analysis @(_selectedFormat == "excel" ? "with charts " : "")(1 @GetSheetLabel())</span>
                        </div>
                    }
                    @if (_includeGrowth)
                    {
                        <div class="preview-item">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                            <span>Growth Projections (1 @GetSheetLabel())</span>
                        </div>
                    }
                    @if (_includeCloud)
                    {
                        <div class="preview-item">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                            <span>Cloud Alternatives (1 @GetSheetLabel())</span>
                        </div>
                    }
                    @if (_includeTables)
                    {
                        <div class="preview-item">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                            <span>Detailed Breakdown Tables (3 @GetSheetLabel()s)</span>
                        </div>
                    }
                    @if (!HasSelectedOptions())
                    {
                        <div class="preview-empty">Select at least one option to export</div>
                    }
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="modal-footer">
            <button class="btn btn-secondary" @onclick="Close">Cancel</button>
            <button class="btn btn-primary" @onclick="Export" disabled="@(!HasSelectedOptions() || _isExporting)">
                @if (_isExporting)
                {
                    <span class="spinner"></span>
                    <span>Exporting...</span>
                }
                else
                {
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    <span>Export @GetFormatName()</span>
                }
            </button>
        </div>
    </div>
</div>

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public EventCallback OnExport { get; set; }
    [Parameter] public string ScenarioName { get; set; } = "Untitled Scenario";
    [Parameter] public string ScenarioType { get; set; } = "k8s";
    [Parameter] public string ScenarioDetails { get; set; } = "";

    private string _selectedFormat = "excel";
    private bool _includeConfig = true;
    private bool _includeSizing = true;
    private bool _includeCost = true;
    private bool _includeGrowth = false;
    private bool _includeCloud = false;
    private bool _includeTables = true;
    private string _dateRange = "current";
    private string _currency = "USD";
    private bool _isExporting = false;

    private void SelectFormat(string format)
    {
        _selectedFormat = format;
    }

    private string GetFormatName() => _selectedFormat switch
    {
        "excel" => "Excel",
        "pdf" => "PDF",
        "json" => "JSON",
        "csv" => "CSV",
        _ => "File"
    };

    private string GetSheetLabel() => _selectedFormat switch
    {
        "excel" => "sheet",
        "pdf" => "page",
        "json" => "section",
        "csv" => "file",
        _ => "section"
    };

    private string GetEstimatedSize()
    {
        var count = 0;
        if (_includeConfig) count += 30;
        if (_includeSizing) count += 60;
        if (_includeCost) count += 50;
        if (_includeGrowth) count += 40;
        if (_includeCloud) count += 35;
        if (_includeTables) count += 80;

        return _selectedFormat switch
        {
            "excel" => $"{count} KB",
            "pdf" => $"{count * 2} KB",
            "json" => $"{count / 2} KB",
            "csv" => $"{count / 3} KB",
            _ => $"{count} KB"
        };
    }

    private bool HasSelectedOptions() =>
        _includeConfig || _includeSizing || _includeCost ||
        _includeGrowth || _includeCloud || _includeTables;

    private async Task Close()
    {
        await IsVisibleChanged.InvokeAsync(false);
    }

    private void HandleOverlayClick()
    {
        _ = Close();
    }

    private async Task Export()
    {
        _isExporting = true;
        StateHasChanged();

        try
        {
            // Simulate export delay
            await Task.Delay(1500);
            await OnExport.InvokeAsync();
            await Close();
        }
        finally
        {
            _isExporting = false;
            StateHasChanged();
        }
    }
}
