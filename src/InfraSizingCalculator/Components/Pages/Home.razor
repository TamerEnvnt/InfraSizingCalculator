@page "/"
@inject IK8sSizingService K8sSizingService
@inject IVMSizingService VMSizingService
@inject IDistributionService DistributionService
@inject ITechnologyService TechnologyService
@inject IExportService ExportService
@inject IJSRuntime JSRuntime
@inject ConfigurationSharingService SharingService
@inject ValidationRecommendationService ValidationService
@inject ICostEstimationService CostEstimationService
@inject IPricingService PricingService
@inject IScenarioService ScenarioService
@inject IGrowthPlanningService GrowthPlanningService
@inject NavigationManager NavigationManager
@inject IPricingSettingsService PricingSettingsService
@using InfraSizingCalculator.Models
@using InfraSizingCalculator.Services
@using InfraSizingCalculator.Components.Modals
@using InfraSizingCalculator.Components.Layout
@using InfraSizingCalculator.Components.Shared
@using InfraSizingCalculator.Components.K8s
@using InfraSizingCalculator.Components.VM
@using InfraSizingCalculator.Services.Interfaces
@using InfraSizingCalculator.Models.Pricing
@using InfraSizingCalculator.Models.Growth
@rendermode InteractiveServer

<PageTitle>Infrastructure Sizing Calculator</PageTitle>

<!-- Three-Panel SPA Layout -->
<HeaderBar OnAction="HandleHeaderAction" />

<LeftSidebar CurrentStep="@currentStep"
             TotalSteps="@GetTotalSteps()"
             StepLabelProvider="GetStepLabel"
             StepSelectionProvider="GetStepSelection"
             OnStepSelected="GoToStep"
             ShowResultsSection="@ShouldShowResultsSection()"
             ActiveResultTab="@GetActiveResultsTab()"
             OnResultTabSelected="HandleResultTabSelected"
             InsightsCount="@GetInsightsCount()"
             CriticalCount="@GetCriticalCount()" />

<div class="main-content">
    <!-- Wizard Content - Only show current step -->
    <div class="wizard-content">
        <!-- Step 1: Platform Type -->
        @if (currentStep == 1)
        {
            <div class="section-header">
                <span class="section-title">Select Platform Type</span>
                <button class="info-btn" @onclick="() => ShowInfo(InfoType.Platform)">?</button>
            </div>
            <div class="selection-grid">
                <div class="selection-card @(selectedPlatform == PlatformType.Native ? "selected" : "")"
                     @onclick="() => SelectPlatformAsync(PlatformType.Native)">
                    <span class="brand-icon native large"></span>
                    <div class="card-title">Native Applications</div>
                    <div class="card-desc">.NET, Java, Node.js, Python, Go</div>
                </div>
                <div class="selection-card @(selectedPlatform == PlatformType.LowCode ? "selected" : "")"
                     @onclick="() => SelectPlatformAsync(PlatformType.LowCode)">
                    <span class="brand-icon lowcode large"></span>
                    <div class="card-title">Low-Code Platform</div>
                    <div class="card-desc">Mendix, OutSystems</div>
                </div>
            </div>
        }

        <!-- Step 2: Deployment Model -->
        @if (currentStep == 2)
        {
            <div class="section-header">
                <span class="section-title">Select Deployment Model</span>
                <button class="info-btn" @onclick="() => ShowInfo(InfoType.Deployment)">?</button>
            </div>
            <div class="selection-grid">
                <div class="selection-card @(selectedDeployment == DeploymentModel.Kubernetes ? "selected" : "")"
                     @onclick="() => SelectDeploymentAsync(DeploymentModel.Kubernetes)">
                    <span class="brand-icon kubernetes large"></span>
                    <div class="card-title">Kubernetes</div>
                    <div class="card-desc">Container orchestration with auto-scaling and self-healing</div>
                </div>
                <div class="selection-card @(selectedDeployment == DeploymentModel.VMs ? "selected" : "")"
                     @onclick="() => SelectDeploymentAsync(DeploymentModel.VMs)">
                    <span class="brand-icon vm large"></span>
                    <div class="card-title">Virtual Machines</div>
                    <div class="card-desc">Traditional VM deployment with dedicated servers</div>
                </div>
            </div>
        }

        <!-- Step 3: Technology Selection -->
        @if (currentStep == 3)
        {
            <div class="section-header">
                <span class="section-title">Select Technology</span>
                <button class="info-btn" @onclick="() => ShowInfo(InfoType.Technology)">?</button>
            </div>
            <div class="tech-grid">
                @foreach (var tech in GetAvailableTechnologies())
                {
                    <div class="tech-card @(selectedTechnology == tech.Technology ? "selected" : "")"
                         style="--brand-color: @tech.BrandColor"
                         @onclick="() => SelectTechnologyAsync(tech.Technology)">
                        <div class="tech-header">
                            <span class="brand-icon @tech.Icon large"></span>
                            <div>
                                <div class="tech-name">@tech.Name</div>
                                <div class="tech-vendor">@tech.Vendor</div>
                            </div>
                            <button class="card-info-btn" @onclick:stopPropagation="true" @onclick="() => ShowTechInfo(tech.Technology)" title="More info">?</button>
                        </div>
                        <div class="tech-desc">@tech.Description</div>
                        <div class="tech-tags">
                            <span class="tech-tag @(tech.IsLowCode ? "lowcode" : "native")">
                                @(tech.IsLowCode ? "Low-Code" : "Native")
                            </span>
                        </div>
                    </div>
                }
            </div>
        }

        <!-- Step 4: Kubernetes Distribution (or Mendix Deployment Options) -->
        @if (currentStep == 4 && selectedDeployment == DeploymentModel.Kubernetes)
        {
            @if (selectedTechnology == Technology.Mendix)
            {
                <!-- Mendix Deployment Options -->
                <div class="section-header">
                    <span class="section-title">Select Mendix Deployment</span>
                    <button class="info-btn" @onclick="() => ShowMendixDeploymentInfo()">?</button>
                </div>

                <!-- Mendix Deployment Category Selection -->
                <div class="mendix-deployment-categories">
                    <div class="mendix-category-card @(mendixDeploymentCategory == MendixDeploymentCategory.Cloud ? "selected" : "")"
                         @onclick="() => SelectMendixCategory(MendixDeploymentCategory.Cloud)">
                        <span class="cat-icon cloud"></span>
                        <div class="category-content">
                            <div class="category-name">Mendix Cloud</div>
                            <div class="category-desc">Fully managed SaaS or Dedicated cloud hosting by Siemens</div>
                        </div>
                        <div class="category-badge recommended">Recommended</div>
                    </div>

                    <div class="mendix-category-card @(mendixDeploymentCategory == MendixDeploymentCategory.PrivateCloud ? "selected" : "")"
                         @onclick="() => SelectMendixCategory(MendixDeploymentCategory.PrivateCloud)">
                        <span class="cat-icon private"></span>
                        <div class="category-content">
                            <div class="category-name">Private Cloud</div>
                            <div class="category-desc">Deploy on Azure, EKS, AKS, GKE, or OpenShift with official support</div>
                        </div>
                        <div class="category-badge supported">Officially Supported</div>
                    </div>

                    <div class="mendix-category-card @(mendixDeploymentCategory == MendixDeploymentCategory.Other ? "selected" : "")"
                         @onclick="() => SelectMendixCategory(MendixDeploymentCategory.Other)">
                        <span class="cat-icon manual"></span>
                        <div class="category-content">
                            <div class="category-name">Other Kubernetes</div>
                            <div class="category-desc">Rancher, K3s, Generic K8s - manual Mendix operator setup</div>
                        </div>
                        <div class="category-badge manual">Manual Setup</div>
                    </div>
                </div>

                <!-- Sub-options based on selected category -->
                @if (mendixDeploymentCategory == MendixDeploymentCategory.Cloud)
                {
                    <div class="mendix-suboptions">
                        <h4>Select Cloud Type</h4>
                        <div class="mendix-option-cards cloud-type">
                            <div class="mendix-option-card @(mendixCloudType == MendixCloudType.SaaS ? "selected" : "")"
                                 @onclick="() => SelectMendixCloudType(MendixCloudType.SaaS)">
                                <span class="brand-icon mendix"></span>
                                <div class="option-name">SaaS (Multi-tenant)</div>
                            </div>
                            <div class="mendix-option-card @(mendixCloudType == MendixCloudType.Dedicated ? "selected" : "")"
                                 @onclick="() => SelectMendixCloudType(MendixCloudType.Dedicated)">
                                <span class="brand-icon mendix"></span>
                                <div class="option-name">Dedicated (Single-tenant)</div>
                            </div>
                        </div>
                    </div>
                }

                @if (mendixDeploymentCategory == MendixDeploymentCategory.PrivateCloud)
                {
                    <div class="mendix-suboptions">
                        <h4>Select Private Cloud Provider <span class="header-badge">Officially Supported</span></h4>
                        <div class="mendix-option-cards">
                            <div class="mendix-option-card azure @(mendixPrivateCloudProvider == MendixPrivateCloudProvider.Azure ? "selected" : "")"
                                 @onclick="() => SelectMendixPrivateCloudProvider(MendixPrivateCloudProvider.Azure)">
                                <span class="brand-icon azure"></span>
                                <div class="option-name">Mendix Azure</div>
                            </div>
                            <div class="mendix-option-card @(mendixPrivateCloudProvider == MendixPrivateCloudProvider.EKS ? "selected" : "")"
                                 @onclick="() => SelectMendixPrivateCloudProvider(MendixPrivateCloudProvider.EKS)">
                                <span class="brand-icon eks"></span>
                                <div class="option-name">Amazon EKS</div>
                            </div>
                            <div class="mendix-option-card @(mendixPrivateCloudProvider == MendixPrivateCloudProvider.AKS ? "selected" : "")"
                                 @onclick="() => SelectMendixPrivateCloudProvider(MendixPrivateCloudProvider.AKS)">
                                <span class="brand-icon aks"></span>
                                <div class="option-name">Azure AKS</div>
                            </div>
                            <div class="mendix-option-card @(mendixPrivateCloudProvider == MendixPrivateCloudProvider.GKE ? "selected" : "")"
                                 @onclick="() => SelectMendixPrivateCloudProvider(MendixPrivateCloudProvider.GKE)">
                                <span class="brand-icon gke"></span>
                                <div class="option-name">Google GKE</div>
                            </div>
                            <div class="mendix-option-card @(mendixPrivateCloudProvider == MendixPrivateCloudProvider.OpenShift ? "selected" : "")"
                                 @onclick="() => SelectMendixPrivateCloudProvider(MendixPrivateCloudProvider.OpenShift)">
                                <span class="brand-icon openshift"></span>
                                <div class="option-name">OpenShift</div>
                            </div>
                        </div>
                    </div>
                }

                @if (mendixDeploymentCategory == MendixDeploymentCategory.Other)
                {
                    <div class="mendix-suboptions">
                        <h4>Select K8s Provider <span class="header-badge manual">Manual Setup</span></h4>
                        <div class="mendix-option-cards other-k8s">
                            <div class="mendix-option-card manual @(mendixPrivateCloudProvider == MendixPrivateCloudProvider.Rancher ? "selected" : "")"
                                 @onclick="() => SelectMendixPrivateCloudProvider(MendixPrivateCloudProvider.Rancher)">
                                <span class="brand-icon rancher"></span>
                                <div class="option-name">Rancher</div>
                            </div>
                            <div class="mendix-option-card manual @(mendixPrivateCloudProvider == MendixPrivateCloudProvider.K3s ? "selected" : "")"
                                 @onclick="() => SelectMendixPrivateCloudProvider(MendixPrivateCloudProvider.K3s)">
                                <span class="brand-icon k3s"></span>
                                <div class="option-name">K3s</div>
                            </div>
                            <div class="mendix-option-card manual @(mendixPrivateCloudProvider == MendixPrivateCloudProvider.GenericK8s ? "selected" : "")"
                                 @onclick="() => SelectMendixPrivateCloudProvider(MendixPrivateCloudProvider.GenericK8s)">
                                <span class="brand-icon k8s"></span>
                                <div class="option-name">Generic K8s</div>
                            </div>
                        </div>
                    </div>
                }
            }
            else
            {
                <!-- Standard Kubernetes Distribution Selection -->
                <div class="section-header">
                    <span class="section-title">Select Kubernetes Distribution</span>
                    <button class="info-btn" @onclick="() => ShowInfo(InfoType.Distribution)">?</button>
                </div>

                <!-- Distribution Tabs + Search (inline) -->
                <div class="distro-header-row">
                    <div class="distro-tabs">
                        <button class="distro-tab @(distributionFilter == "on-prem" ? "active" : "")"
                                @onclick='() => SetDistroFilter("on-prem")'>
                            <span class="brand-icon vm small"></span>
                            <span class="tab-text">Self-Managed</span>
                            <span class="tab-count">@GetDistributionCount("on-prem")</span>
                        </button>
                        <button class="distro-tab @(distributionFilter == "cloud" ? "active" : "")"
                                @onclick='() => SetDistroFilter("cloud")'>
                            <span class="cat-icon cloud" style="width:20px;height:20px;font-size:0.6rem;"></span>
                            <span class="tab-text">Cloud</span>
                            <span class="tab-count">@GetDistributionCount("cloud")</span>
                        </button>
                    </div>
                    <div class="distro-search-inline highlighted">
                        <span class="search-icon icon-search"></span>
                        <input type="text"
                               placeholder="Search distributions..."
                               @bind="distributionSearch"
                               @bind:event="oninput"
                               class="distro-search-input" />
                        @if (!string.IsNullOrEmpty(distributionSearch))
                        {
                            <button class="clear-search" @onclick="() => distributionSearch = string.Empty">Ã—</button>
                        }
                    </div>
                </div>

                @if (distributionFilter == "cloud")
                {
                    <!-- Cloud Sub-Categories (without "All" button) -->
                    <div class="cloud-category-chips">
                        <button class="category-chip major @(cloudCategory == "major" ? "active" : "")"
                                @onclick='() => cloudCategory = "major"'>Major</button>
                        <button class="category-chip openshift @(cloudCategory == "openshift" ? "active" : "")"
                                @onclick='() => cloudCategory = "openshift"'>OpenShift</button>
                        <button class="category-chip rancher @(cloudCategory == "rancher" ? "active" : "")"
                                @onclick='() => cloudCategory = "rancher"'>SUSE</button>
                        <button class="category-chip tanzu @(cloudCategory == "tanzu" ? "active" : "")"
                                @onclick='() => cloudCategory = "tanzu"'>Tanzu</button>
                        <button class="category-chip ubuntu @(cloudCategory == "ubuntu" ? "active" : "")"
                                @onclick='() => cloudCategory = "ubuntu"'>Canonical</button>
                        <button class="category-chip developer @(cloudCategory == "developer" ? "active" : "")"
                                @onclick='() => cloudCategory = "developer"'>Developer</button>
                    </div>
                }

                <!-- Distribution Grid -->
                <div class="distro-grid">
                    @{ var filteredDistros = GetFilteredDistributions().ToList(); }
                    @if (filteredDistros.Count == 0)
                    {
                        <div class="no-results">
                            <span>No distributions found matching "@distributionSearch"</span>
                            <button class="btn-text" @onclick="() => distributionSearch = string.Empty">Clear search</button>
                        </div>
                    }
                    else
                    {
                        @foreach (var distro in filteredDistros)
                        {
                            <div class="distro-card @(selectedDistribution == distro.Distribution ? "selected" : "")"
                                 style="--brand-color: @distro.BrandColor"
                                 @onclick="() => SelectDistributionAsync(distro.Distribution)">
                                <div class="distro-header">
                                    <span class="brand-icon @distro.Icon large"></span>
                                    <div>
                                        <div class="distro-name">@distro.Name</div>
                                        <div class="distro-vendor">@distro.Vendor</div>
                                    </div>
                                    <button class="card-info-btn" @onclick:stopPropagation="true" @onclick="() => ShowDistroInfo(distro.Distribution)" title="More info">?</button>
                                </div>
                                <div class="distro-tags">
                                    @foreach (var tag in distro.Tags)
                                    {
                                        <span class="distro-tag @tag.CssClass">@tag.Label</span>
                                    }
                                </div>
                            </div>
                        }
                    }
                </div>
            }
        }

        <!-- Step 5: Configuration (Tabbed Interface) -->
        @if (currentStep == 5 && selectedDeployment == DeploymentModel.Kubernetes && selectedDistribution != null)
        {
            var distroConfig = DistributionService.GetConfig(selectedDistribution.Value);

            <div class="config-layout">
                <!-- Left: Cluster Mode Selection -->
                <div class="cluster-mode-sidebar">
                    <div class="sidebar-header">
                        <span>Cluster Mode</span>
                        <button class="info-btn small" @onclick="() => ShowInfo(InfoType.ClusterMode)">?</button>
                    </div>
                    <div class="cluster-mode-options">
                        <div class="mode-option @(selectedClusterMode == ClusterMode.MultiCluster ? "selected" : "")"
                             @onclick="() => SelectClusterMode(ClusterMode.MultiCluster)">
                            <span class="mode-icon multi"></span>
                            <div class="mode-text">
                                <span class="mode-name">Multi-Cluster</span>
                                <span class="mode-desc">One cluster per env</span>
                            </div>
                        </div>
                        <div class="mode-option @(IsSingleClusterMode() ? "selected" : "")"
                             @onclick="() => SelectClusterMode(ClusterMode.SharedCluster)">
                            <span class="mode-icon single"></span>
                            <div class="mode-text">
                                <span class="mode-name">Single Cluster</span>
                                <span class="mode-desc">One cluster total</span>
                            </div>
                        </div>
                    </div>

                    <!-- Single Cluster Options -->
                    @if (IsSingleClusterMode())
                    {
                        <div class="single-cluster-selector">
                            <label>Cluster Scope:</label>
                            <select @bind="singleClusterScope">
                                <option value="Shared">Shared Cluster</option>
                                <option value="Dev">Dev Only</option>
                                <option value="Test">Test Only</option>
                                <option value="Stage">Stage Only</option>
                                <option value="Prod">Prod Only</option>
                                <option value="DR">DR Only</option>
                            </select>
                        </div>
                    }
                </div>

                <!-- Right: Tabbed Configuration -->
                <div class="config-tabs-container">
                    <!-- Tab Headers -->
                    <div class="config-tabs">
                        <button class="config-tab @(configTab == "apps" ? "active" : "")" @onclick='() => configTab = "apps"'>
                            Applications
                        </button>
                        <button class="config-tab @(configTab == "nodes" ? "active" : "")" @onclick='() => configTab = "nodes"'>
                            Node Specs
                        </button>
                        <button class="config-tab @(configTab == "settings" ? "active" : "")" @onclick='() => configTab = "settings"'>
                            Settings
                        </button>
                        <button class="config-tab @(configTab == "hadr" ? "active" : "")" @onclick='() => configTab = "hadr"'>
                            HA & DR
                        </button>
                        @if (selectedTechnology == Technology.Mendix)
                        {
                            <button class="config-tab @(configTab == "mendix" ? "active" : "")" @onclick='() => configTab = "mendix"'>
                                Mendix
                            </button>
                        }
                    </div>

                    <!-- Tab Content -->
                    <div class="config-tab-content">
                        <!-- Applications Tab -->
                        @if (configTab == "apps")
                        {
                            <div class="tab-panel">
                                @if (selectedClusterMode == ClusterMode.MultiCluster)
                                {
                                    <!-- Environment Selection for Multi-Cluster Mode -->
                                    <div class="cluster-selection-bar">
                                        <span class="selection-label">Include environments:</span>
                                        <div class="cluster-chips">
                                            @foreach (var env in new[] { EnvironmentType.Dev, EnvironmentType.Test, EnvironmentType.Stage, EnvironmentType.Prod })
                                            {
                                                <label class="cluster-chip @(IsEnvironmentEnabled(env) ? "selected" : "") @(IsProdEnvironment(env) ? "prod" : "nonprod")">
                                                    <input type="checkbox"
                                                           checked="@IsEnvironmentEnabled(env)"
                                                           disabled="@(env == EnvironmentType.Prod)"
                                                           @onchange="(e) => ToggleEnvironment(env, (bool)e.Value!)" />
                                                    <span>@env</span>
                                                </label>
                                            }
                                        </div>
                                    </div>
                                }

                                <!-- App Tiers Configuration - K8sAppsConfig handles all display -->
                                <K8sAppsConfig IsSingleCluster="@IsSingleClusterMode()"
                                               EnabledEnvironments="@enabledEnvironments"
                                               EnvironmentApps="@envApps"
                                               EnvironmentAppsChanged="@((apps) => envApps = apps)"
                                               GetTierSpecFunc="@GetTierSpec" />
                            </div>
                        }

                        <!-- Node Specs Tab -->
                        @if (configTab == "nodes")
                        {
                            <div class="tab-panel">
                                <K8sNodeSpecsConfig IsSingleCluster="@IsSingleClusterMode()"
                                                    EnabledEnvironments="@enabledEnvironments"
                                                    NodeSpecs="@nodeSpecs"
                                                    NodeSpecsChanged="@((specs) => nodeSpecs = specs)"
                                                    HasManagedControlPlane="@distroConfig.HasManagedControlPlane"
                                                    HasInfraNodes="@distroConfig.HasInfraNodes"
                                                    VendorName="@distroConfig.Vendor" />
                            </div>
                        }

                        <!-- Settings Tab -->
                        @if (configTab == "settings")
                        {
                            <div class="tab-panel">
                                <div class="settings-grid-compact">
                                    <!-- Headroom -->
                                    <div class="settings-section-compact">
                                        <div class="settings-section-title">Headroom (Buffer %)</div>
                                        <div class="settings-row">
                                            @foreach (var env in GetVisibleEnvironments())
                                            {
                                                <div class="setting-item">
                                                    <label>@env</label>
                                                    <input type="number" step="0.5" min="0" max="100"
                                                           value="@headroom.GetValueOrDefault(env, 20)"
                                                           disabled="@(!IsEnvironmentEnabled(env))"
                                                           @onchange="@(e => headroom[env] = ParseDouble(e.Value))" />
                                                    <span class="unit">%</span>
                                                </div>
                                            }
                                        </div>
                                    </div>

                                    <!-- Replicas -->
                                    <div class="settings-section-compact">
                                        <div class="settings-section-title">Replicas (Pod Instances)</div>
                                        <div class="settings-row">
                                            @foreach (var env in GetVisibleEnvironments())
                                            {
                                                <div class="setting-item">
                                                    <label>@env</label>
                                                    <input type="number" min="1" max="10"
                                                           value="@replicas.GetValueOrDefault(env, 1)"
                                                           disabled="@(!IsEnvironmentEnabled(env))"
                                                           @onchange="@(e => replicas[env] = ParseInt(e.Value))" />
                                                </div>
                                            }
                                        </div>
                                    </div>

                                    <!-- Overcommit -->
                                    <div class="settings-section-compact">
                                        <div class="settings-section-title">Resource Overcommit Ratios</div>
                                        <p class="settings-hint">1.0 = no overcommit, higher values allow more workloads per node</p>
                                        <div class="overcommit-grid">
                                            <div class="overcommit-group">
                                                <span class="group-title">Production</span>
                                                <div class="overcommit-inputs-compact">
                                                    <div class="setting-item">
                                                        <label>CPU Ratio</label>
                                                        <input type="number" step="0.1" min="0.5" max="4.0" @bind="prodCpuOvercommit" />
                                                    </div>
                                                    <div class="setting-item">
                                                        <label>Memory Ratio</label>
                                                        <input type="number" step="0.1" min="0.5" max="4.0" @bind="prodMemoryOvercommit" />
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="overcommit-group">
                                                <span class="group-title">Non-Production</span>
                                                <div class="overcommit-inputs-compact">
                                                    <div class="setting-item">
                                                        <label>CPU Ratio</label>
                                                        <input type="number" step="0.1" min="0.5" max="4.0" @bind="nonProdCpuOvercommit" />
                                                    </div>
                                                    <div class="setting-item">
                                                        <label>Memory Ratio</label>
                                                        <input type="number" step="0.1" min="0.5" max="4.0" @bind="nonProdMemoryOvercommit" />
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }

                        <!-- HA & DR Tab -->
                        @if (configTab == "hadr")
                        {
                            <div class="tab-panel">
                                <K8sHADRPanel Config="@k8sHADRConfig"
                                              ConfigChanged="@((config) => k8sHADRConfig = config)"
                                              Distribution="@(selectedDistribution ?? Distribution.EKS)" />
                            </div>
                        }

                        <!-- Mendix Tab -->
                        @if (configTab == "mendix" && selectedTechnology == Technology.Mendix)
                        {
                            <div class="tab-panel">
                                <div class="mendix-settings">
                                    <h4 class="settings-section-title">Operator Settings</h4>
                                    <div class="setting-item-large">
                                        <label>Mendix Operator Replicas</label>
                                        <input type="number" min="1" max="5" @bind="mendixOperatorReplicas" />
                                        <span class="hint">Number of Mendix operator instances for high availability</span>
                                    </div>

                                    <h4 class="settings-section-title">Licensing Configuration</h4>

                                    @if (mendixDeploymentCategory != MendixDeploymentCategory.Cloud)
                                    {
                                        <!-- Environment Count (for Private Cloud/Other) -->
                                        <div class="setting-item-large">
                                            <label>Number of Environments</label>
                                            <input type="number" min="1" max="500" @bind="mendixNumberOfEnvironments" />
                                            <span class="hint">Total Mendix environments to license (default: 3)</span>
                                        </div>
                                    }

                                    <!-- User Licensing (all deployment paths) -->
                                    <div class="settings-row">
                                        <div class="setting-item-half">
                                            <label>Internal Users</label>
                                            <input type="number" min="0" step="100" @bind="mendixInternalUsers" />
                                            <span class="hint">Priced per 100 users ($40,800/year)</span>
                                        </div>
                                        <div class="setting-item-half">
                                            <label>External Users (thousands)</label>
                                            <input type="number" min="0" step="250" @bind="mendixExternalUsers" />
                                            <span class="hint">Priced per 250K ($60,000/year)</span>
                                        </div>
                                    </div>

                                    @if (mendixDeploymentCategory == MendixDeploymentCategory.Cloud)
                                    {
                                        <div class="info-note">
                                            <span class="icon icon-bulb"></span>
                                            Resource pack configuration is available in the Pricing step for Mendix Cloud deployments.
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }

        <!-- Step 4: Mendix VM Deployment Options (LowCode + VMs) -->
        @if (currentStep == 4 && selectedDeployment == DeploymentModel.VMs && selectedTechnology == Technology.Mendix)
        {
            <div class="section-header">
                <span class="section-title">Select Mendix Deployment Type</span>
                <button class="info-btn" @onclick="() => ShowMendixDeploymentInfo()">?</button>
            </div>

            <div class="mendix-deployment-categories">
                <div class="mendix-category-card @(mendixOtherDeployment == MendixOtherDeployment.Server ? "selected" : "")"
                     @onclick="() => SelectMendixVMDeployment(MendixOtherDeployment.Server)">
                    <span class="brand-icon vm"></span>
                    <div class="category-content">
                        <div class="category-name">Server (VMs/Docker)</div>
                        <div class="category-desc">Traditional VM or Docker container deployment</div>
                        <div class="category-price">$6,612/app or $33,060 unlimited/year</div>
                    </div>
                </div>
                <div class="mendix-category-card @(mendixOtherDeployment == MendixOtherDeployment.StackIT ? "selected" : "")"
                     @onclick="() => SelectMendixVMDeployment(MendixOtherDeployment.StackIT)">
                    <span class="brand-icon native"></span>
                    <div class="category-content">
                        <div class="category-name">StackIT</div>
                        <div class="category-desc">Schwarz IT cloud platform</div>
                        <div class="category-price">$6,612/app or $33,060 unlimited/year</div>
                    </div>
                </div>
                <div class="mendix-category-card @(mendixOtherDeployment == MendixOtherDeployment.SapBtp ? "selected" : "")"
                     @onclick="() => SelectMendixVMDeployment(MendixOtherDeployment.SapBtp)">
                    <span class="brand-icon sap"></span>
                    <div class="category-content">
                        <div class="category-name">SAP BTP</div>
                        <div class="category-desc">SAP Business Technology Platform</div>
                        <div class="category-price">$6,612/app or $33,060 unlimited/year</div>
                    </div>
                </div>
            </div>

            <p class="info-note" style="margin-top: 1rem;">
                <span class="icon icon-bulb"></span> <strong>Note:</strong> These deployment options do not use Kubernetes.
                For Kubernetes-based deployments, select <strong>Kubernetes</strong> in Step 2.
            </p>
        }

        <!-- VM Configuration (at config step for VMs) -->
        @if (currentStep == GetConfigStep() && selectedDeployment == DeploymentModel.VMs)
        {
            <div class="config-layout">
                <!-- Left: Environment List -->
                <div class="cluster-mode-sidebar">
                    <div class="sidebar-header">
                        <span>Environments</span>
                        <button class="info-btn small" @onclick="() => ShowInfo(InfoType.AppConfig)">?</button>
                    </div>
                    <div class="cluster-mode-options">
                        @foreach (var env in GetVMEnvironmentList())
                        {
                            <div class="mode-option @(IsEnvironmentEnabled(env) ? "selected" : "")"
                                 @onclick="() => ToggleVMEnvironment(env)">
                                <span class="@IconResources.GetEnvIconClass(env)"></span>
                                <div class="mode-text">
                                    <span class="mode-name">@IconResources.GetEnvDisplayName(env)</span>
                                    <span class="mode-desc">@GetVMEnvSummary(env)</span>
                                </div>
                            </div>
                        }
                    </div>
                </div>

                <!-- Right: Tabbed Configuration -->
                <div class="config-tabs-container">
                    <!-- Tab Headers -->
                    <div class="config-tabs">
                        <button class="config-tab @(configTab == "roles" ? "active" : "")" @onclick='() => configTab = "roles"'>
                            Server Roles
                        </button>
                        <button class="config-tab @(configTab == "ha" ? "active" : "")" @onclick='() => configTab = "ha"'>
                            HA & DR
                        </button>
                        <button class="config-tab @(configTab == "settings" ? "active" : "")" @onclick='() => configTab = "settings"'>
                            Settings
                        </button>
                    </div>

                    <!-- Tab Content -->
                    <div class="config-tab-content">
                        <!-- Server Roles Tab -->
                        @if (configTab == "roles")
                        {
                            <div class="tab-panel">
                                <VMServerRolesConfig EnabledEnvironments="@enabledEnvironments"
                                                     EnvironmentConfigs="@vmEnvironmentConfigs"
                                                     EnvironmentConfigsChanged="@((configs) => vmEnvironmentConfigs = configs)"
                                                     AvailableTechnologyRoles="@GetAvailableTechnologyRoles()"
                                                     GetMaxInstances="@GetRoleMaxInstances"
                                                     OnToggleTechRoleRequested="@((args) => ToggleTechVMRole(args.Item1, args.Item2))"
                                                     OnToggleRoleRequested="@((args) => ToggleVMRole(args.Item1, args.Item2))"
                                                     OnRemoveRoleRequested="@((args) => RemoveTechVMRole(args.Item1, args.Item2))" />
                            </div>
                        }

                        <!-- HA & DR Tab -->
                        @if (configTab == "ha")
                        {
                            <div class="tab-panel">
                                <VMHADRConfig EnabledEnvironments="@enabledEnvironments"
                                              EnvironmentConfigs="@vmEnvironmentConfigs"
                                              EnvironmentConfigsChanged="@((configs) => vmEnvironmentConfigs = configs)" />
                            </div>
                        }

                        <!-- VM Settings Tab -->
                        @if (configTab == "settings")
                        {
                            <div class="tab-panel">
                                <div class="settings-grid-compact">
                                    <div class="settings-section-compact">
                                        <div class="settings-section-title">System Overhead</div>
                                        <div class="settings-row">
                                            <div class="setting-item">
                                                <label>Overhead %</label>
                                                <input type="number" min="0" max="50" step="1" @bind="vmSystemOverhead" />
                                                <span class="unit">%</span>
                                            </div>
                                            <p class="settings-hint">Additional overhead for OS, agents, and system processes</p>
                                        </div>
                                    </div>

                                    <div class="settings-section-compact">
                                        <div class="settings-section-title">Storage per Environment</div>
                                        <div class="settings-row">
                                            @foreach (var env in enabledEnvironments.OrderBy(e => e))
                                            {
                                                var config = GetOrCreateVMConfig(env);
                                                <div class="setting-item">
                                                    <label>@env</label>
                                                    <input type="number" min="0" max="1000000" @bind="config.StorageGB" />
                                                    <span class="unit">GB</span>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }

        <!-- Step 6: Pricing (K8s only) -->
        @if (currentStep == 6 && selectedDeployment == DeploymentModel.Kubernetes && selectedDistribution != null && results != null)
        {
            <InfraSizingCalculator.Components.Wizard.Steps.PricingStep
                Distribution="@selectedDistribution"
                Platform="@selectedPlatform"
                TotalNodes="@results.GrandTotal.TotalNodes"
                TotalCores="@results.GrandTotal.TotalCpu"
                TotalRamGB="@results.GrandTotal.TotalRam"
                TotalStorageTB="0"
                MasterNodes="@results.GrandTotal.TotalMasters"
                InfraNodes="@results.GrandTotal.TotalInfra"
                WorkerNodes="@results.GrandTotal.TotalWorkers"
                HasProduction="@enabledEnvironments.Contains(EnvironmentType.Prod)"
                MendixCategory="@mendixDeploymentCategory"
                MendixCloudType="@mendixCloudType"
                MendixPrivateProvider="@mendixPrivateCloudProvider"
                MendixOtherType="@mendixOtherDeployment"
                MendixEnvironments="@mendixNumberOfEnvironments"
                MendixInternalUsers="@mendixInternalUsers"
                MendixExternalUsers="@mendixExternalUsers"
                OnPricingConfigured="HandlePricingConfigured"
                OnApplyAlternative="HandleApplyAlternative"
                OnSaveScenario="OpenSaveScenarioModal" />
        }

        <!-- Step 7: K8s Results -->
        @if (currentStep == 7 && results != null && selectedDeployment == DeploymentModel.Kubernetes)
        {
            <div class="results-panel">
                <!-- Cluster Mode Info Banner -->
                <div class="cluster-mode-banner @GetClusterModeBannerClass()">
                    <span class="banner-icon">@GetClusterModeIcon()</span>
                    <span class="banner-text">@GetClusterModeDescription()</span>
                </div>

                <!-- Tab content controlled by sidebar navigation -->
                <!-- Sizing Tab Content - Using Data Grid Layout -->
                @if (k8sResultsTab == "sizing")
                {
                    <div class="sizing-tab-content">
                        <!-- All Environments Data Grid -->
                        <div class="sizing-data-grid">
                            <table class="data-grid-table">
                                <thead>
                                    <tr>
                                        <th class="env-col">Environment</th>
                                        <th class="num-col">Apps</th>
                                        <th class="num-col">Pods</th>
                                        @if (!IsSharedClusterMode())
                                        {
                                            <th class="num-col">Masters</th>
                                            <th class="num-col">Infra</th>
                                        }
                                        <th class="num-col">Workers</th>
                                        <th class="num-col total-col">Nodes</th>
                                        <th class="num-col">vCPU</th>
                                        <th class="num-col">RAM (GB)</th>
                                        <th class="num-col">Disk (GB)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var env in results.Environments)
                                    {
                                        <tr class="env-row env-@env.Environment.ToString().ToLower()">
                                            <td class="env-col">
                                                <span class="env-badge">
                                                    <span class="env-indicator"></span>
                                                    @env.Environment
                                                </span>
                                            </td>
                                            <td class="num-col">@env.Apps</td>
                                            <td class="num-col">@env.Pods</td>
                                            @if (!IsSharedClusterMode())
                                            {
                                                @if (IsManagedControlPlane())
                                                {
                                                    <td class="num-col managed-indicator" title="Control plane managed by cloud provider">Managed</td>
                                                }
                                                else
                                                {
                                                    <td class="num-col">@env.Masters</td>
                                                }
                                                <td class="num-col">@env.Infra</td>
                                            }
                                            <td class="num-col">@env.Workers</td>
                                            <td class="num-col total-col"><strong>@env.TotalNodes</strong></td>
                                            <td class="num-col">@env.TotalCpu</td>
                                            <td class="num-col">@env.TotalRam.ToString("N0")</td>
                                            <td class="num-col">@env.TotalDisk.ToString("N0")</td>
                                        </tr>
                                    }
                                </tbody>
                                <tfoot>
                                    <tr class="totals-row">
                                        <td class="env-col"><strong>Total</strong></td>
                                        <td class="num-col">@results.Environments.Sum(e => e.Apps)</td>
                                        <td class="num-col">@results.Environments.Sum(e => e.Pods)</td>
                                        @if (!IsSharedClusterMode())
                                        {
                                            @if (IsManagedControlPlane())
                                            {
                                                <td class="num-col managed-indicator">-</td>
                                            }
                                            else
                                            {
                                                <td class="num-col">@results.Environments.Sum(e => e.Masters)</td>
                                            }
                                            <td class="num-col">@results.Environments.Sum(e => e.Infra)</td>
                                        }
                                        <td class="num-col">@results.Environments.Sum(e => e.Workers)</td>
                                        <td class="num-col total-col"><strong>@results.GrandTotal.TotalNodes</strong></td>
                                        <td class="num-col">@results.GrandTotal.TotalCpu</td>
                                        <td class="num-col">@results.GrandTotal.TotalRam.ToString("N0")</td>
                                        <td class="num-col">@results.GrandTotal.TotalDisk.ToString("N0")</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                }

                <!-- Cost Tab Content - Different layouts based on deployment type -->
                @if (k8sResultsTab == "cost")
                {
                    <div class="cost-tab-content @(costSubTab == "cloud" ? "cloud-active" : "")">
                        @if (IsMendixCloudDeployment())
                        {
                            <!-- Mendix Cloud Pricing (SaaS/Dedicated) -->
                            <div class="mendix-cloud-cost-panel">
                                <div class="cost-header-notice">
                                    <span class="notice-icon icon icon-cloud"></span>
                                    <span class="notice-text">Mendix Cloud @(mendixCloudType == MendixCloudType.Dedicated ? "Dedicated" : "SaaS")</span>
                                </div>
                                @if (pricingResult?.MendixCost != null)
                                {
                                    <div class="cost-panel mendix-cost-display">
                                        <div class="cost-header-row">
                                            <span class="cost-label">Monthly Total</span>
                                            <div class="cost-total-row">
                                                <span class="total-amount large">@FormatCurrency(pricingResult.MendixCost.TotalPerMonth)</span>
                                                <span class="total-period">/month</span>
                                            </div>
                                        </div>
                                        <div class="cost-breakdown-grid">
                                            @if (pricingResult.MendixCost.PlatformLicenseCost > 0)
                                            {
                                                <div class="breakdown-item">
                                                    <span class="breakdown-label">Platform License</span>
                                                    <span class="breakdown-value">@FormatCurrency(pricingResult.MendixCost.PlatformLicenseCost / 12)/mo</span>
                                                </div>
                                            }
                                            @if (pricingResult.MendixCost.DeploymentFeeCost > 0)
                                            {
                                                <div class="breakdown-item">
                                                    <span class="breakdown-label">Deployment</span>
                                                    <span class="breakdown-value">@FormatCurrency(pricingResult.MendixCost.DeploymentFeeCost / 12)/mo</span>
                                                </div>
                                            }
                                            @if (pricingResult.MendixCost.EnvironmentCost > 0)
                                            {
                                                <div class="breakdown-item">
                                                    <span class="breakdown-label">Environments</span>
                                                    <span class="breakdown-value">@FormatCurrency(pricingResult.MendixCost.EnvironmentCost / 12)/mo</span>
                                                </div>
                                            }
                                            @if (pricingResult.MendixCost.UserLicenseCost > 0)
                                            {
                                                <div class="breakdown-item">
                                                    <span class="breakdown-label">User Licensing</span>
                                                    <span class="breakdown-value">@FormatCurrency(pricingResult.MendixCost.UserLicenseCost / 12)/mo</span>
                                                </div>
                                            }
                                        </div>
                                        <div class="cost-tco-summary">
                                            <div class="tco-item">
                                                <span class="tco-value">@FormatCurrency(pricingResult.MendixCost.TotalPerYear)</span>
                                                <span class="tco-label">/year</span>
                                            </div>
                                            <div class="tco-item highlight">
                                                <span class="tco-value">@FormatCurrency(pricingResult.MendixCost.TotalThreeYear)</span>
                                                <span class="tco-label">3yr TCO</span>
                                            </div>
                                        </div>
                                    </div>
                                }
                                else
                                {
                                    <div class="cost-panel cloud-info">
                                        <div class="info-box">
                                            <span class="info-icon icon icon-info"></span>
                                            <div class="info-content">
                                                <h4>Configure in Pricing Step</h4>
                                                <p>Complete the Pricing step to see calculated Mendix costs.</p>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else if (IsOnPremDistribution())
                        {
                            <!-- Cost Sub-tabs for On-Prem Distributions -->
                            <div class="cost-sub-tabs">
                                <button class="cost-sub-tab @(costSubTab == "onprem" ? "active" : "")"
                                        @onclick='() => costSubTab = "onprem"'>
                                    On-Premises
                                    @if (pricingResult?.HasCosts == true && pricingResult.OnPremCost != null)
                                    {
                                        <span class="tab-price">@FormatCurrency(pricingResult.OnPremCost.MonthlyTotal)/mo</span>
                                    }
                                    else
                                    {
                                        <span class="tab-price na">N/A</span>
                                    }
                                </button>
                                <button class="cost-sub-tab @(costSubTab == "cloud" ? "active" : "")"
                                        @onclick='() => costSubTab = "cloud"'>
                                    Cloud Alternatives
                                    @if (k8sCostEstimate != null)
                                    {
                                        <span class="tab-price">@FormatCurrency(k8sCostEstimate.MonthlyTotal)/mo</span>
                                    }
                                </button>
                                @if (selectedTechnology == Technology.Mendix && pricingResult?.MendixCost != null)
                                {
                                    <button class="cost-sub-tab @(costSubTab == "mendix" ? "active" : "")"
                                            @onclick='() => costSubTab = "mendix"'>
                                        Mendix Licensing
                                        <span class="tab-price">@FormatCurrency(pricingResult.MendixCost.TotalPerMonth)/mo</span>
                                    </button>
                                }
                            </div>

                            <!-- On-Prem Tab Content -->
                            @if (costSubTab == "onprem")
                            {
                                @if (pricingResult?.HasCosts == true && pricingResult.OnPremCost != null)
                                {
                                    <div class="cost-panel onprem-panel">
                                        <div class="cost-header-row">
                                            <span class="cost-label">Monthly Total</span>
                                            <div class="cost-total-row">
                                                <span class="total-amount large">@FormatCurrency(pricingResult.OnPremCost.MonthlyTotal)</span>
                                                <span class="total-period">/month</span>
                                            </div>
                                        </div>
                                        <div class="cost-breakdown-grid">
                                            <div class="breakdown-item">
                                                <span class="breakdown-label">License</span>
                                                <span class="breakdown-value">@FormatCurrency(pricingResult.OnPremCost.MonthlyLicense)</span>
                                            </div>
                                            <div class="breakdown-item">
                                                <span class="breakdown-label">Hardware</span>
                                                <span class="breakdown-value">@FormatCurrency(pricingResult.OnPremCost.MonthlyHardware)</span>
                                            </div>
                                            <div class="breakdown-item">
                                                <span class="breakdown-label">Data Center</span>
                                                <span class="breakdown-value">@FormatCurrency(pricingResult.OnPremCost.MonthlyDataCenter)</span>
                                            </div>
                                            <div class="breakdown-item">
                                                <span class="breakdown-label">Labor</span>
                                                <span class="breakdown-value">@FormatCurrency(pricingResult.OnPremCost.MonthlyLabor)</span>
                                            </div>
                                        </div>
                                        <div class="cost-tco-summary">
                                            <div class="tco-item">
                                                <span class="tco-value">@FormatCurrency(pricingResult.OnPremCost.YearlyTotal)</span>
                                                <span class="tco-label">/year</span>
                                            </div>
                                            <div class="tco-item">
                                                <span class="tco-value">@FormatCurrency(pricingResult.OnPremCost.ThreeYearTCO)</span>
                                                <span class="tco-label">3yr TCO</span>
                                            </div>
                                            <div class="tco-item">
                                                <span class="tco-value">@FormatCurrency(pricingResult.OnPremCost.YearlyTotal * 5)</span>
                                                <span class="tco-label">5yr TCO</span>
                                            </div>
                                        </div>
                                    </div>
                                }
                                else
                                {
                                    <div class="cost-panel pricing-disabled">
                                        <div class="pricing-not-enabled-notice">
                                            <span class="notice-icon icon icon-bulb"></span>
                                            <span class="notice-text">On-premises pricing not enabled.</span>
                                        </div>
                                        <p class="pricing-help">To see on-premises cost estimates, enable pricing in the Pricing step.</p>
                                        <button class="btn-secondary" @onclick="BackToPricing">
                                            <span>Go to Pricing Step</span>
                                        </button>
                                    </div>
                                }
                            }

                            <!-- Cloud Alternatives Tab Content -->
                            @if (costSubTab == "cloud")
                            {
                                <div class="cost-panel cloud-panel cloud-comparison-panel">
                                    @{
                                        var cloudAlts = GetCloudAlternativesForBreakdown();
                                        var lowestCost = cloudAlts.Min(a => a.MonthlyCost);
                                        var workerCount = results?.GrandTotal.TotalWorkers ?? 3;
                                    }

                                    <!-- Two Column Layout: Comparison Cards + Summary Sidebar -->
                                    <div class="cloud-comparison-layout">
                                        <!-- Left: Cloud Provider Comparison Cards -->
                                        <div class="cloud-cards-section">
                                            <div class="section-header">
                                                <span class="header-icon icon icon-cloud"></span>
                                                <span class="header-title">Cloud Alternatives Comparison</span>
                                                <span class="header-subtitle">Click to select, compare costs across providers</span>
                                            </div>

                                            @if (IsOpenShiftDistribution())
                                            {
                                                <!-- OpenShift Managed Options -->
                                                <div class="provider-group">
                                                    <div class="group-label">
                                                        <span class="label-dot openshift"></span>
                                                        Managed OpenShift <span class="recommended-badge">Recommended</span>
                                                    </div>
                                                    <div class="cloud-cards-grid">
                                                        @foreach (var alt in cloudAlts.Where(a => a.IsOpenShiftManaged))
                                                        {
                                                            var isLowest = alt.MonthlyCost == lowestCost;
                                                            var isSelected = selectedCloudAlt == alt.Key;
                                                            <div class="cloud-alt-card @alt.ProviderClass @(isLowest ? "lowest" : "") @(isSelected ? "selected" : "")"
                                                                 @onclick="() => SelectCloudAlternative(alt.Key)">
                                                                @if (isLowest) { <span class="lowest-badge">Lowest</span> }
                                                                <div class="card-provider">
                                                                    <span class="provider-dot @alt.ProviderClass"></span>
                                                                    @alt.Name
                                                                </div>
                                                                <div class="card-price">@FormatCurrency(alt.MonthlyCost)<span class="per-month">/mo</span></div>
                                                                <div class="card-details">
                                                                    <span>@alt.InstanceType</span>
                                                                    <span>@workerCount workers</span>
                                                                </div>
                                                                <div class="card-tco">3yr: @FormatCurrency(alt.MonthlyCost * 36)</div>
                                                            </div>
                                                        }
                                                    </div>
                                                </div>
                                            }

                                            <!-- Standard Managed K8s Options -->
                                            <div class="provider-group">
                                                <div class="group-label">
                                                    <span class="label-dot k8s"></span>
                                                    Managed Kubernetes @(IsOpenShiftDistribution() ? "(Alternative)" : "")
                                                </div>
                                                <div class="cloud-cards-grid">
                                                    @foreach (var alt in cloudAlts.Where(a => !a.IsOpenShiftManaged))
                                                    {
                                                        var isLowest = alt.MonthlyCost == lowestCost;
                                                        var isSelected = selectedCloudAlt == alt.Key;
                                                        <div class="cloud-alt-card @alt.ProviderClass @(isLowest ? "lowest" : "") @(isSelected ? "selected" : "")"
                                                             @onclick="() => SelectCloudAlternative(alt.Key)">
                                                            @if (isLowest) { <span class="lowest-badge">Lowest</span> }
                                                            <div class="card-provider">
                                                                <span class="provider-dot @alt.ProviderClass"></span>
                                                                @alt.Name
                                                            </div>
                                                            <div class="card-price">@FormatCurrency(alt.MonthlyCost)<span class="per-month">/mo</span></div>
                                                            <div class="card-details">
                                                                <span>@alt.InstanceType</span>
                                                                <span>@workerCount workers</span>
                                                            </div>
                                                            <div class="card-tco">3yr: @FormatCurrency(alt.MonthlyCost * 36)</div>
                                                        </div>
                                                    }
                                                </div>
                                            </div>

                                            <!-- Selected Provider Details -->
                                            @if (!string.IsNullOrEmpty(selectedCloudAlt))
                                            {
                                                var selected = cloudAlts.FirstOrDefault(a => a.Key == selectedCloudAlt);
                                                if (selected != null)
                                                {
                                                    <div class="selected-details-panel">
                                                        <div class="details-header">
                                                            <span class="provider-dot @selected.ProviderClass"></span>
                                                            <strong>@selected.Name</strong> - @selected.Description
                                                        </div>
                                                        <div class="details-breakdown">
                                                            <div class="breakdown-item">
                                                                <span>Compute (@workerCount Ã— @selected.InstanceType)</span>
                                                                <span>@FormatCurrency(selected.ComputeCost)/mo</span>
                                                            </div>
                                                            <div class="breakdown-item">
                                                                <span>Control Plane</span>
                                                                <span>@(selected.ControlPlaneCost > 0 ? FormatCurrency(selected.ControlPlaneCost) + "/mo" : "Free")</span>
                                                            </div>
                                                            <div class="breakdown-item">
                                                                <span>Storage</span>
                                                                <span>@FormatCurrency(selected.StorageCost)/mo</span>
                                                            </div>
                                                            @if (selected.LicenseCost > 0)
                                                            {
                                                                <div class="breakdown-item highlight">
                                                                    <span>License/Service Fee</span>
                                                                    <span>@FormatCurrency(selected.LicenseCost)/mo</span>
                                                                </div>
                                                            }
                                                        </div>
                                                        <div class="details-actions">
                                                            <button class="btn-apply-cloud" @onclick="() => ApplyCloudAlternative(selected)">
                                                                Switch to @selected.Name
                                                            </button>
                                                        </div>
                                                    </div>
                                                }
                                            }
                                        </div>

                                        <!-- Right: Summary Sidebar -->
                                        <div class="cloud-summary-sidebar">
                                            <!-- Node Comparison -->
                                            <div class="sidebar-card">
                                                <div class="card-title">Node Comparison</div>
                                                <div class="comparison-rows">
                                                    <div class="comp-row onprem">
                                                        <span class="comp-label">On-Prem</span>
                                                        <span class="comp-nodes">@(results?.GrandTotal.TotalNodes ?? 0) nodes</span>
                                                        <div class="node-breakdown">
                                                            <span class="node-badge master">@(results?.GrandTotal.TotalMasters ?? 0)M</span>
                                                            <span class="node-badge infra">@(results?.GrandTotal.TotalInfra ?? 0)I</span>
                                                            <span class="node-badge worker">@(results?.GrandTotal.TotalWorkers ?? 0)W</span>
                                                        </div>
                                                    </div>
                                                    <div class="comp-row cloud">
                                                        <span class="comp-label">Cloud</span>
                                                        <span class="comp-nodes">@workerCount workers</span>
                                                        <div class="node-breakdown">
                                                            <span class="node-badge managed">Managed CP</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="comparison-note">
                                                    Cloud = @((results?.GrandTotal.TotalMasters ?? 0) + (results?.GrandTotal.TotalInfra ?? 0)) fewer nodes to manage
                                                </div>
                                            </div>

                                            <!-- Cost Comparison -->
                                            <div class="sidebar-card">
                                                <div class="card-title">Cost Comparison</div>
                                                <div class="cost-compare-list">
                                                    <div class="cost-item @(pricingResult?.HasCosts == true ? "" : "na")">
                                                        <span>On-Prem</span>
                                                        <span class="cost-value">@(pricingResult?.HasCosts == true ? FormatCurrency(pricingResult.OnPremCost?.MonthlyTotal ?? 0) + "/mo" : "N/A")</span>
                                                    </div>
                                                    @foreach (var alt in cloudAlts.OrderBy(a => a.MonthlyCost).Take(3))
                                                    {
                                                        var isLowest = alt.MonthlyCost == lowestCost;
                                                        <div class="cost-item @(isLowest ? "lowest" : "")">
                                                            <span><span class="provider-dot small @alt.ProviderClass"></span> @alt.Name</span>
                                                            <span class="cost-value">@FormatCurrency(alt.MonthlyCost)/mo</span>
                                                        </div>
                                                    }
                                                </div>
                                            </div>

                                            <!-- Recommendation -->
                                            <div class="sidebar-card recommendation">
                                                <div class="card-title">Recommendation</div>
                                                @{
                                                    var cheapest = cloudAlts.OrderBy(a => a.MonthlyCost).First();
                                                    var onPremCost = pricingResult?.OnPremCost?.MonthlyTotal ?? 0;
                                                    var cloudSavings = onPremCost > 0 ? onPremCost - cheapest.MonthlyCost : 0;
                                                }
                                                <div class="recommendation-content">
                                                    <div class="rec-provider">
                                                        <span class="provider-dot @cheapest.ProviderClass"></span>
                                                        <strong>@cheapest.Name</strong>
                                                    </div>
                                                    <div class="rec-price">@FormatCurrency(cheapest.MonthlyCost)/mo</div>
                                                    @if (cloudSavings > 0)
                                                    {
                                                        <div class="rec-savings positive">
                                                            Save @FormatCurrency(cloudSavings)/mo vs On-Prem
                                                        </div>
                                                    }
                                                    else if (cloudSavings < 0 && onPremCost > 0)
                                                    {
                                                        <div class="rec-savings negative">
                                                            On-Prem @FormatCurrency(Math.Abs(cloudSavings))/mo cheaper
                                                        </div>
                                                    }
                                                </div>
                                                <button class="btn-apply-recommendation" @onclick="() => ApplyCloudAlternative(cheapest)">
                                                    Apply Recommendation
                                                </button>
                                            </div>

                                            <!-- Action: Keep Current -->
                                            <div class="sidebar-card keep-current">
                                                <div class="current-selection">
                                                    <span>Current: <strong>@(selectedDistribution?.ToString() ?? "Not set")</strong></span>
                                                </div>
                                                <button class="btn-keep-current" @onclick="SwitchToOnPremTab">
                                                    Keep On-Prem Selection
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }

                            <!-- Mendix Licensing Tab Content -->
                            @if (costSubTab == "mendix" && selectedTechnology == Technology.Mendix && pricingResult?.MendixCost != null)
                            {
                                <div class="cost-panel mendix-cost-display">
                                    <div class="cost-header-row">
                                        <span class="cost-label">Mendix Monthly License Cost</span>
                                        <div class="cost-total-row">
                                            <span class="total-amount large">@FormatCurrency(pricingResult.MendixCost.TotalPerMonth)</span>
                                            <span class="total-period">/month</span>
                                        </div>
                                    </div>
                                    <div class="cost-breakdown-grid">
                                        @if (pricingResult.MendixCost.PlatformLicenseCost > 0)
                                        {
                                            <div class="breakdown-item">
                                                <span class="breakdown-label">Platform License</span>
                                                <span class="breakdown-value">@FormatCurrency(pricingResult.MendixCost.PlatformLicenseCost / 12)/mo</span>
                                            </div>
                                        }
                                        @if (pricingResult.MendixCost.DeploymentFeeCost > 0)
                                        {
                                            <div class="breakdown-item">
                                                <span class="breakdown-label">Deployment Fee</span>
                                                <span class="breakdown-value">@FormatCurrency(pricingResult.MendixCost.DeploymentFeeCost / 12)/mo</span>
                                            </div>
                                        }
                                        @if (pricingResult.MendixCost.EnvironmentCost > 0)
                                        {
                                            <div class="breakdown-item">
                                                <span class="breakdown-label">Environment Licensing</span>
                                                <span class="breakdown-value">@FormatCurrency(pricingResult.MendixCost.EnvironmentCost / 12)/mo</span>
                                            </div>
                                        }
                                        @if (pricingResult.MendixCost.UserLicenseCost > 0)
                                        {
                                            <div class="breakdown-item">
                                                <span class="breakdown-label">User Licensing</span>
                                                <span class="breakdown-value">@FormatCurrency(pricingResult.MendixCost.UserLicenseCost / 12)/mo</span>
                                            </div>
                                        }
                                    </div>
                                    @if (!string.IsNullOrEmpty(pricingResult.MendixCost.EnvironmentDetails))
                                    {
                                        <div class="mendix-env-details">
                                            <span class="details-label">Environment Breakdown:</span>
                                            <span class="details-value">@pricingResult.MendixCost.EnvironmentDetails</span>
                                        </div>
                                    }
                                    <div class="cost-tco-summary">
                                        <div class="tco-item">
                                            <span class="tco-value">@FormatCurrency(pricingResult.MendixCost.TotalPerYear)</span>
                                            <span class="tco-label">/year</span>
                                        </div>
                                        <div class="tco-item highlight">
                                            <span class="tco-value">@FormatCurrency(pricingResult.MendixCost.TotalThreeYear)</span>
                                            <span class="tco-label">3yr TCO</span>
                                        </div>
                                    </div>
                                    <div class="mendix-license-note">
                                        <span class="note-icon icon icon-bulb"></span>
                                        <span>Mendix licensing is separate from infrastructure costs. Prices from June 2025 pricebook.</span>
                                    </div>
                                </div>
                            }
                        }
                        else if (k8sCostLoading)
                        {
                            <div class="cost-loading">Calculating costs...</div>
                        }
                        else if (k8sCostEstimate != null)
                        {
                            <!-- Cost Summary Bar (always visible) -->
                            <div class="cost-summary-bar">
                                <div class="cost-summary-item primary">
                                    <span class="cost-amount">@FormatCurrency(k8sCostEstimate.MonthlyTotal)</span>
                                    <span class="cost-period">/month</span>
                                </div>
                                <div class="cost-summary-item">
                                    <span class="cost-amount">@FormatCurrency(k8sCostEstimate.YearlyTotal)</span>
                                    <span class="cost-period">/year</span>
                                </div>
                                <div class="cost-summary-item">
                                    <span class="cost-amount">@FormatCurrency(k8sCostEstimate.ThreeYearTCO)</span>
                                    <span class="cost-period">3yr TCO</span>
                                </div>
                                <div class="cost-summary-item">
                                    <span class="cost-amount">@FormatCurrency(k8sCostEstimate.FiveYearTCO)</span>
                                    <span class="cost-period">5yr TCO</span>
                                </div>
                            </div>

                            <!-- Two-Column Layout: Breakdown + By Environment -->
                            <div class="cost-two-column">
                                <!-- Left: Cost Breakdown by Category -->
                                <div class="cost-column">
                                    <div class="cost-section-header">Cost Breakdown</div>
                                    <table class="cost-breakdown-table">
                                        <thead>
                                            <tr>
                                                <th>Category</th>
                                                <th class="num-col">Monthly</th>
                                                <th class="num-col">%</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var cat in k8sCostEstimate.Breakdown.Values.OrderByDescending(b => b.Monthly))
                                            {
                                                <tr>
                                                    <td>
                                                        <span class="cat-icon">@GetCostCategoryIcon(cat.Category)</span>
                                                        @cat.Description
                                                    </td>
                                                    <td class="num-col">@FormatCurrency(cat.Monthly)</td>
                                                    <td class="num-col pct-col">
                                                        <div class="pct-bar" style="--pct: @cat.Percentage%"></div>
                                                        @cat.Percentage.ToString("F0")%
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>

                                <!-- Right: Cost by Environment -->
                                <div class="cost-column">
                                    <div class="cost-section-header">By Environment</div>
                                    <table class="cost-env-table">
                                        <thead>
                                            <tr>
                                                <th>Environment</th>
                                                <th class="num-col">Nodes</th>
                                                <th class="num-col">Monthly</th>
                                                <th class="num-col">%</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var env in k8sCostEstimate.EnvironmentCosts.Values.OrderByDescending(e => e.MonthlyCost))
                                            {
                                                <tr class="env-row env-@env.EnvironmentName.ToLower()">
                                                    <td class="env-col">
                                                        <span class="env-badge">
                                                            <span class="env-indicator"></span>
                                                            @env.EnvironmentName
                                                        </span>
                                                    </td>
                                                    <td class="num-col">@env.Nodes</td>
                                                    <td class="num-col">@FormatCurrency(env.MonthlyCost)</td>
                                                    <td class="num-col">@env.Percentage.ToString("F0")%</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Pricing Options (collapsible) -->
                            <div class="collapsible-section @(k8sPricingOptionsOpen ? "open" : "")">
                                <button type="button" class="collapsible-header" @onclick="() => k8sPricingOptionsOpen = !k8sPricingOptionsOpen">
                                    <span class="collapsible-icon">@(k8sPricingOptionsOpen ? "â–¼" : "â–¶")</span>
                                    <span>Pricing Options</span>
                                </button>
                                @if (k8sPricingOptionsOpen)
                                {
                                    <div class="collapsible-content">
                                        <InfraSizingCalculator.Components.Configuration.PricingSelector
                                            Options="@k8sCostOptions"
                                            Distribution="@selectedDistribution?.ToString()"
                                            OnCalculate="HandleK8sCostCalculate" />
                                    </div>
                                }
                            </div>

                            <!-- Notes (collapsible, if any) -->
                            @if (k8sCostEstimate.Notes.Any())
                            {
                                <div class="collapsible-section @(k8sCostNotesOpen ? "open" : "")">
                                    <button type="button" class="collapsible-header" @onclick="() => k8sCostNotesOpen = !k8sCostNotesOpen">
                                        <span class="collapsible-icon">@(k8sCostNotesOpen ? "â–¼" : "â–¶")</span>
                                        <span>Notes & Assumptions (@k8sCostEstimate.Notes.Count)</span>
                                    </button>
                                    @if (k8sCostNotesOpen)
                                    {
                                        <div class="collapsible-content">
                                            <ul class="cost-notes-list">
                                                @foreach (var note in k8sCostEstimate.Notes)
                                                {
                                                    <li>@note</li>
                                                }
                                            </ul>
                                        </div>
                                    }
                                </div>
                            }

                            <!-- Pricing Info Footer -->
                            @if (!string.IsNullOrEmpty(k8sCostEstimate.PricingSource))
                            {
                                <div class="cost-footer">
                                    <span>@k8sCostEstimate.Provider - @k8sCostEstimate.Region</span>
                                    <span>@k8sCostEstimate.CalculatedAt.ToString("MMM d, yyyy HH:mm")</span>
                                </div>
                            }
                        }
                        else
                        {
                            <!-- No estimate yet - show pricing selector -->
                            <div class="cost-no-estimate">
                                <p>Configure pricing options and calculate costs</p>
                                <InfraSizingCalculator.Components.Configuration.PricingSelector
                                    Options="@k8sCostOptions"
                                    Distribution="@selectedDistribution?.ToString()"
                                    OnCalculate="HandleK8sCostCalculate" />
                            </div>
                        }
                    </div>
                }

                <!-- Insights Tab Content -->
                @if (k8sResultsTab == "insights" && validationWarnings?.Any() == true)
                {
                    <div class="insights-tab-content">
                        <InfraSizingCalculator.Components.Results.ResultsWarnings Warnings="validationWarnings" />
                    </div>
                }

                <!-- Growth Tab Content - Using GrowthPlanningView Component -->
                @if (k8sResultsTab == "growth")
                {
                    <div class="growth-tab-content">
                        <InfraSizingCalculator.Components.Results.GrowthPlanningView
                            Settings="@k8sGrowthSettings"
                            Projection="@k8sGrowthProjection"
                            OnCalculate="HandleK8sGrowthCalculate"
                            SettingsChanged="HandleK8sGrowthSettingsFromComponent" />
                    </div>
                }

            </div>
        }

        <!-- VM Pricing Step (step 5 for non-Mendix, step 6 for Mendix) -->
        @if (currentStep == GetPricingStep() && selectedDeployment == DeploymentModel.VMs)
        {
            <div class="pricing-step vm-pricing">
                @if (selectedTechnology == Technology.Mendix && vmResults != null)
                {
                    <!-- Mendix VM Pricing -->
                    <div class="step-header">
                        <h3>Mendix License Pricing</h3>
                    <p class="step-description">
                        Review Mendix licensing costs for your <strong>@GetMendixVMDeploymentName()</strong> deployment.
                    </p>
                </div>

                <div class="mendix-vm-pricing-panel">
                    @{
                        var (perApp, unlimited) = GetMendixVMDeploymentPricing();
                    }

                    <div class="pricing-option-cards">
                        <div class="pricing-option-card @(!mendixIsUnlimitedApps ? "selected" : "")"
                             @onclick="() => mendixIsUnlimitedApps = false">
                            <div class="option-header">
                                <span class="option-icon icon icon-app"></span>
                                <span class="option-title">Per-App License</span>
                            </div>
                            <div class="option-price">@FormatCurrency(perApp)/app/year</div>
                            <div class="option-desc">Best for smaller deployments with few apps</div>
                            @if (!mendixIsUnlimitedApps)
                            {
                                <div class="app-count-input">
                                    <label>Number of Apps:</label>
                                    <input type="number" min="1" max="100" @bind="mendixNumberOfApps" />
                                </div>
                                <div class="option-total">Total: @FormatCurrency(perApp * mendixNumberOfApps)/year</div>
                            }
                        </div>

                        <div class="pricing-option-card @(mendixIsUnlimitedApps ? "selected" : "")"
                             @onclick="() => mendixIsUnlimitedApps = true">
                            <div class="option-header">
                                <span class="option-icon icon icon-infinity"></span>
                                <span class="option-title">Unlimited Apps License</span>
                            </div>
                            <div class="option-price">@FormatCurrency(unlimited)/year</div>
                            <div class="option-desc">Best for enterprise deployments with many apps</div>
                            @if (mendixIsUnlimitedApps)
                            {
                                <div class="option-total">Total: @FormatCurrency(unlimited)/year</div>
                            }
                        </div>
                    </div>

                    <div class="pricing-summary">
                        <div class="summary-row">
                            <span>Deployment Type:</span>
                            <span>@GetMendixVMDeploymentName()</span>
                        </div>
                        <div class="summary-row">
                            <span>License Type:</span>
                            <span>@(mendixIsUnlimitedApps ? "Unlimited Apps" : $"{mendixNumberOfApps} App(s)")</span>
                        </div>
                        <div class="summary-row total">
                            <span>Annual Mendix License:</span>
                            <span class="total-value">@FormatCurrency(mendixIsUnlimitedApps ? unlimited : perApp * mendixNumberOfApps)/year</span>
                        </div>
                    </div>

                    <div class="pricing-note">
                        <span class="icon icon-bulb"></span> <strong>Note:</strong> This is the Mendix license cost only. Infrastructure costs (VMs, storage, networking) are separate.
                    </div>
                </div>
                }
                else if (selectedTechnology == Technology.OutSystems && vmResults != null)
                {
                    <!-- OutSystems VM Pricing with Accordions -->
                    // Pre-calculate all pricing values using new model
                    var osBaseCost = outsystemsPricingSettings.GetEditionBasePrice(outsystemsEdition);
                    var osAoIncluded = outsystemsPricingSettings.GetIncludedAOs(outsystemsEdition);
                    var osUsersIncluded = outsystemsPricingSettings.GetIncludedInternalUsers(outsystemsEdition);
                    var osAdditionalAOs = Math.Max(0, outsystemsApplicationObjects - osAoIncluded);
                    var osAoPacksCount = osAdditionalAOs > 0 ? (int)Math.Ceiling(osAdditionalAOs / (double)outsystemsPricingSettings.AOPackSize) : 0;
                    var osAoCost = osAoPacksCount * outsystemsPricingSettings.AdditionalAOPackPrice;
                    var osAdditionalUsers = Math.Max(0, outsystemsInternalUsers - osUsersIncluded);
                    var osUserPacksCount = osAdditionalUsers > 0 ? (int)Math.Ceiling(osAdditionalUsers / (double)outsystemsPricingSettings.InternalUserPackSize) : 0;
                    var osInternalUserCost = osUserPacksCount * outsystemsPricingSettings.AdditionalInternalUserPackPrice;
                    var osExternalUserCost = outsystemsPricingSettings.CalculateExternalUsersCost(outsystemsExternalSessions);
                    var osTotalAnnual = osBaseCost + osAoCost + osInternalUserCost + osExternalUserCost;

                    <div class="step-header">
                        <h3>OutSystems License Pricing</h3>
                        <p class="step-description">
                            Configure OutSystems subscription licensing for your self-managed deployment.
                        </p>
                    </div>

                    <div class="outsystems-vm-pricing-panel accordion-layout">
                        <!-- Edition Selection Accordion -->
                        <div class="pricing-accordion @(outsystemsActiveAccordion == "edition" ? "open" : "")">
                            <button type="button" class="accordion-header" @onclick='() => outsystemsActiveAccordion = outsystemsActiveAccordion == "edition" ? "" : "edition"'>
                                <span class="accordion-chevron">@(outsystemsActiveAccordion == "edition" ? "â–¼" : "â–¶")</span>
                                <span class="accordion-icon">ðŸ“¦</span>
                                <span class="accordion-title">Edition Selection</span>
                                <span class="accordion-summary">@outsystemsEdition - @FormatCurrency(osBaseCost)/yr</span>
                            </button>
                            @if (outsystemsActiveAccordion == "edition")
                            {
                                <div class="accordion-content">
                                    <div class="pricing-option-cards compact">
                                        <div class="pricing-option-card @(outsystemsEdition == OutSystemsEdition.Standard ? "selected" : "")"
                                             @onclick="() => outsystemsEdition = OutSystemsEdition.Standard" @onclick:stopPropagation="true">
                                            <div class="option-header">
                                                <span class="option-title">Standard Edition</span>
                                            </div>
                                            <div class="option-price">@FormatCurrency(outsystemsPricingSettings.StandardEditionBasePrice)/year</div>
                                            <div class="option-desc">@outsystemsPricingSettings.StandardEditionAOsIncluded AOs, @outsystemsPricingSettings.StandardEditionInternalUsersIncluded users</div>
                                        </div>

                                        <div class="pricing-option-card @(outsystemsEdition == OutSystemsEdition.Enterprise ? "selected" : "")"
                                             @onclick="() => outsystemsEdition = OutSystemsEdition.Enterprise" @onclick:stopPropagation="true">
                                            <div class="option-header">
                                                <span class="option-title">Enterprise Edition</span>
                                            </div>
                                            <div class="option-price">@FormatCurrency(outsystemsPricingSettings.EnterpriseEditionBasePrice)/year</div>
                                            <div class="option-desc">@outsystemsPricingSettings.EnterpriseEditionAOsIncluded AOs, @outsystemsPricingSettings.EnterpriseEditionInternalUsersIncluded users</div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>

                        <!-- Licensing Configuration Accordion -->
                        <div class="pricing-accordion @(outsystemsActiveAccordion == "licensing" ? "open" : "")">
                            <button type="button" class="accordion-header" @onclick='() => outsystemsActiveAccordion = outsystemsActiveAccordion == "licensing" ? "" : "licensing"'>
                                <span class="accordion-chevron">@(outsystemsActiveAccordion == "licensing" ? "â–¼" : "â–¶")</span>
                                <span class="accordion-icon">âš™ï¸</span>
                                <span class="accordion-title">Licensing Configuration</span>
                                <span class="accordion-summary">@outsystemsApplicationObjects AOs, @outsystemsInternalUsers users - @FormatCurrency(osAoCost + osInternalUserCost + osExternalUserCost)/yr</span>
                            </button>
                            @if (outsystemsActiveAccordion == "licensing")
                            {
                                <div class="accordion-content compact-form">
                                    <div class="config-row-inline">
                                        <label>AOs</label>
                                        <input type="number" min="1" max="5000" @bind="outsystemsApplicationObjects" class="config-input-sm" @onclick:stopPropagation="true" />
                                        <span class="config-info-inline">@osAoIncluded incl @if (osAdditionalAOs > 0) { <span class="extra">+@osAoPacksCount pk</span> }</span>
                                    </div>
                                    <div class="config-row-inline">
                                        <label>Users</label>
                                        <input type="number" min="0" max="10000" @bind="outsystemsInternalUsers" class="config-input-sm" @onclick:stopPropagation="true" />
                                        <span class="config-info-inline">@osUsersIncluded incl @if (osAdditionalUsers > 0) { <span class="extra">+@osUserPacksCount pk</span> }</span>
                                    </div>
                                    <div class="config-row-inline">
                                        <label>External</label>
                                        <input type="number" min="0" max="1000000" step="1000" @bind="outsystemsExternalSessions" class="config-input-sm" @onclick:stopPropagation="true" />
                                        <span class="config-info-inline">
                                            @if (outsystemsExternalSessions > 0) {
                                                var extPacks = (int)Math.Ceiling(outsystemsExternalSessions / (double)outsystemsPricingSettings.ExternalUserPackSize);
                                                <span class="extra">@extPacks pk</span>
                                            } else { <span>sessions/mo</span> }
                                        </span>
                                    </div>
                                </div>
                            }
                        </div>

                        <!-- Cost Summary - Always visible, compact -->
                        <div class="pricing-summary-compact">
                            <div class="summary-items">
                                <div class="summary-item">
                                    <span class="item-label">Monthly</span>
                                    <span class="item-value">@FormatCurrency(osTotalAnnual / 12)</span>
                                </div>
                                <div class="summary-item highlight">
                                    <span class="item-label">Annual</span>
                                    <span class="item-value">@FormatCurrency(osTotalAnnual)</span>
                                </div>
                                <div class="summary-item">
                                    <span class="item-label">3-Year</span>
                                    <span class="item-value">@FormatCurrency(osTotalAnnual * 3)</span>
                                </div>
                            </div>
                            <div class="summary-note">
                                <span class="icon icon-bulb"></span> License cost only. Infrastructure costs shown on results page.
                            </div>
                        </div>
                    </div>
                }
                else
                {
                    <!-- Native VM Pricing (no software licensing) -->
                    <div class="step-header">
                        <h3>Infrastructure Pricing</h3>
                        <p class="step-description">
                            No software licensing costs required for @(selectedTechnology?.ToString() ?? "Native") applications.
                            Infrastructure costs depend on your hosting provider.
                        </p>
                    </div>

                    <div class="native-vm-pricing-panel">
                        <div class="info-card">
                            <span class="info-icon icon icon-info"></span>
                            <div class="info-content">
                                <strong>Infrastructure Costs</strong>
                                <p>Your @(selectedTechnology?.ToString() ?? "application") deployment requires virtual machines but has no software licensing fees.</p>
                                <p>Estimate infrastructure costs based on your cloud or on-premises provider pricing.</p>
                            </div>
                        </div>

                        @if (vmResults != null)
                        {
                            <div class="vm-summary-card">
                                <div class="summary-title">Resource Requirements</div>
                                <div class="summary-grid">
                                    <div class="summary-item">
                                        <span class="item-value">@vmResults.GrandTotal.TotalVMs</span>
                                        <span class="item-label">Total VMs</span>
                                    </div>
                                    <div class="summary-item">
                                        <span class="item-value">@vmResults.GrandTotal.TotalCpu</span>
                                        <span class="item-label">vCPU</span>
                                    </div>
                                    <div class="summary-item">
                                        <span class="item-value">@vmResults.GrandTotal.TotalRam.ToString("N0")</span>
                                        <span class="item-label">RAM (GB)</span>
                                    </div>
                                    <div class="summary-item">
                                        <span class="item-value">@vmResults.GrandTotal.TotalDisk.ToString("N0")</span>
                                        <span class="item-label">Disk (GB)</span>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>
        }

        <!-- VM Results Step (step 6 for non-Mendix, step 7 for Mendix) -->
        @if (currentStep >= GetResultsStep() && vmResults != null && selectedDeployment == DeploymentModel.VMs)
        {
            <div class="results-panel">
                <!-- VM Mode Banner -->
                <div class="cluster-mode-banner vm-mode">
                    <span class="banner-icon icon icon-server"></span>
                    <span class="banner-text">Virtual Machine Sizing - @vmResults.TechnologyName</span>
                </div>

                <!-- Tab content controlled by sidebar navigation -->
                <!-- Sizing Tab Content -->
                @if (vmResultsTab == "sizing")
                {
                    <!-- VM Results Data Grid -->
                    <div class="sizing-data-grid">
                        <table class="data-grid-table">
                            <thead>
                                <tr>
                                    <th class="env-col">Environment</th>
                                    <th>HA Pattern</th>
                                    <th class="num-col total-col">VMs</th>
                                    <th class="num-col">vCPU</th>
                                    <th class="num-col">RAM (GB)</th>
                                    <th class="num-col">Disk (GB)</th>
                                    <th class="num-col">LB VMs</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var env in vmResults.Environments)
                                {
                                    <tr class="env-row env-@env.EnvironmentName.ToLower()">
                                        <td class="env-col">
                                            <span class="env-badge env-@env.EnvironmentName.ToLower()">@env.EnvironmentName</span>
                                        </td>
                                        <td>@GetHAPatternDisplay(env.HAPattern)</td>
                                        <td class="num-col total-col">@env.TotalVMs</td>
                                        <td class="num-col">@env.TotalCpu</td>
                                        <td class="num-col">@env.TotalRam.ToString("N0")</td>
                                        <td class="num-col">@env.TotalDisk.ToString("N0")</td>
                                        <td class="num-col">@env.LoadBalancerVMs</td>
                                    </tr>
                                }
                            </tbody>
                            <tfoot>
                                <tr class="totals-row">
                                    <td class="env-col"><strong>Grand Total</strong></td>
                                    <td>-</td>
                                    <td class="num-col total-col"><strong>@vmResults.GrandTotal.TotalVMs</strong></td>
                                    <td class="num-col"><strong>@vmResults.GrandTotal.TotalCpu</strong></td>
                                    <td class="num-col"><strong>@vmResults.GrandTotal.TotalRam.ToString("N0")</strong></td>
                                    <td class="num-col"><strong>@vmResults.GrandTotal.TotalDisk.ToString("N0")</strong></td>
                                    <td class="num-col"><strong>@vmResults.GrandTotal.TotalLoadBalancerVMs</strong></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <!-- Role Breakdown per Environment (Horizontal Accordion - left to right) -->
                    <details class="sizing-details-section role-breakdown-section">
                        <summary>Role Breakdown by Environment (@vmResults.Environments.Sum(e => e.Roles.Count) total roles)</summary>
                        <div class="role-breakdown-horizontal">
                            <HorizontalAccordion SingleExpand="true"
                                                 ExpandedPanel="@expandedRoleBreakdownEnv"
                                                 ExpandedPanelChanged="@((val) => expandedRoleBreakdownEnv = val)"
                                                 AdditionalClass="role-breakdown-accordion">
                                @foreach (var env in vmResults.Environments)
                                {
                                    var envName = env.EnvironmentName;
                                    var envClass = GetEnvCssClass(envName);
                                    var haPatternText = env.HAPattern != HAPattern.None ? $" | HA: {env.HAPattern}" : "";
                                    <HorizontalAccordionPanel Key="@envName"
                                                              Title="@envName"
                                                              ShortTitle="@GetShortEnvName(envName)"
                                                              Subtitle="@($"{env.Roles.Count} roles{haPatternText}")"
                                                              AdditionalClass="@envClass">
                                        @if (env.Roles.Count > 0)
                                        {
                                            <div class="env-panel-header">
                                                <span class="env-ha-badge @(env.HAPattern != HAPattern.None ? "ha-active" : "")">
                                                    HA: @FormatHAPattern(env.HAPattern)
                                                </span>
                                            </div>
                                            <table class="data-grid-table compact role-table">
                                                <thead>
                                                    <tr>
                                                        <th>Role</th>
                                                        <th>Size</th>
                                                        <th class="num-col">Instances</th>
                                                        <th class="num-col">CPU/VM</th>
                                                        <th class="num-col">RAM/VM</th>
                                                        <th class="num-col">Total CPU</th>
                                                        <th class="num-col">Total RAM</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @foreach (var role in env.Roles)
                                                    {
                                                        <tr>
                                                            <td>@role.RoleName</td>
                                                            <td>@role.Size</td>
                                                            <td class="num-col">@role.TotalInstances</td>
                                                            <td class="num-col">@role.CpuPerInstance</td>
                                                            <td class="num-col">@role.RamPerInstance GB</td>
                                                            <td class="num-col">@role.TotalCpu</td>
                                                            <td class="num-col">@role.TotalRam GB</td>
                                                        </tr>
                                                    }
                                                </tbody>
                                            </table>
                                        }
                                        else
                                        {
                                            <div class="env-no-roles">
                                                <span class="no-roles-icon">[!]</span>
                                                <span>No roles configured for this environment</span>
                                            </div>
                                        }
                                    </HorizontalAccordionPanel>
                                }
                            </HorizontalAccordion>
                        </div>
                    </details>
                }

                <!-- Cost Tab Content -->
                @if (vmResultsTab == "cost")
                {
                    <div class="cost-tab-content">
                        @if (vmCostLoading)
                        {
                            <div class="cost-loading">Calculating costs...</div>
                        }
                        else if (vmCostEstimate != null)
                        {
                            <!-- Cost Summary Bar (always visible) -->
                            <div class="cost-summary-bar">
                                <div class="cost-summary-item primary">
                                    <span class="cost-amount">@FormatCurrency(vmCostEstimate.MonthlyTotal)</span>
                                    <span class="cost-period">/month</span>
                                </div>
                                <div class="cost-summary-item">
                                    <span class="cost-amount">@FormatCurrency(vmCostEstimate.YearlyTotal)</span>
                                    <span class="cost-period">/year</span>
                                </div>
                                <div class="cost-summary-item">
                                    <span class="cost-label">3-Year TCO</span>
                                    <span class="cost-amount">@FormatCurrency(vmCostEstimate.ThreeYearTCO)</span>
                                </div>
                                <div class="cost-summary-item">
                                    <span class="cost-label">5-Year TCO</span>
                                    <span class="cost-amount">@FormatCurrency(vmCostEstimate.FiveYearTCO)</span>
                                </div>
                            </div>

                            <!-- Two-column layout: Current Breakdown | Alternative Pricing -->
                            <div class="cost-two-column">
                                <!-- Current Cost Breakdown -->
                                <div class="cost-column">
                                    <div class="cost-section-header">
                                        <span>ðŸ“Š Cost Breakdown</span>
                                    </div>
                                    <div class="cost-breakdown-compact">
                                        <div class="breakdown-section">
                                            <div class="section-title">By Category</div>
                                            @foreach (var category in vmCostEstimate.Breakdown.Values.OrderByDescending(b => b.Monthly))
                                            {
                                                <div class="breakdown-row">
                                                    <span class="category-icon">@GetCostCategoryIcon(category.Category)</span>
                                                    <span class="category-name">@category.Description</span>
                                                    <span class="category-cost">@FormatCurrency(category.Monthly)</span>
                                                    <span class="category-pct">@category.Percentage.ToString("F0")%</span>
                                                </div>
                                            }
                                        </div>
                                        <div class="breakdown-section">
                                            <div class="section-title">By Environment</div>
                                            @foreach (var env in vmCostEstimate.EnvironmentCosts.Values.OrderByDescending(e => e.MonthlyCost))
                                            {
                                                <div class="breakdown-row">
                                                    <span class="env-dot env-@env.EnvironmentName.ToLower()"></span>
                                                    <span class="env-name">@env.EnvironmentName</span>
                                                    <span class="env-vms">@env.Nodes VMs</span>
                                                    <span class="env-cost">@FormatCurrency(env.MonthlyCost)</span>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>

                                <!-- Alternative Pricing -->
                                <div class="cost-column">
                                    <div class="cost-section-header">
                                        <span>âš™ Alternative Pricing</span>
                                    </div>
                                    <InfraSizingCalculator.Components.Configuration.PricingSelector
                                        Options="@vmCostOptions"
                                        Distribution="@selectedTechnology?.ToString()"
                                        OnCalculate="HandleVMCostCalculate" />
                                </div>
                            </div>
                        }
                        else
                        {
                            <!-- Show pricing selector when no estimate yet -->
                            <div class="cost-initial-setup">
                                <p>Configure pricing options and calculate costs:</p>
                                <InfraSizingCalculator.Components.Configuration.PricingSelector
                                    Options="@vmCostOptions"
                                    Distribution="@selectedTechnology?.ToString()"
                                    OnCalculate="HandleVMCostCalculate" />
                            </div>
                        }
                    </div>
                }

                <!-- Insights Tab Content -->
                @if (vmResultsTab == "insights" && vmValidationWarnings?.Any() == true)
                {
                    <div class="insights-tab-content">
                        <InfraSizingCalculator.Components.Results.ResultsWarnings Warnings="vmValidationWarnings" />
                    </div>
                }

                <!-- Growth Tab Content - Using GrowthPlanningView Component -->
                @if (vmResultsTab == "growth")
                {
                    <div class="growth-tab-content">
                        <InfraSizingCalculator.Components.Results.GrowthPlanningView
                            Settings="@vmGrowthSettings"
                            Projection="@vmGrowthProjection"
                            OnCalculate="HandleVMGrowthCalculate"
                            SettingsChanged="HandleVMGrowthSettingsFromComponent" />
                    </div>
                }

            </div>
        }
    </div>

    <!-- Wizard Footer -->
    <div class="wizard-footer">
        @if (currentStep >= GetResultsStep())
        {
            <button class="btn-nav" @onclick="BackToPricing">
                â† Back to Pricing
            </button>
            <span class="step-indicator">Results</span>
            <button class="btn-nav primary" @onclick="StartNewCalculation">
                New Calculation
            </button>
        }
        else
        {
            <button class="btn-nav" @onclick="PreviousStep" disabled="@(currentStep == 1)">
                Back
            </button>
            <span class="step-indicator">Step @currentStep of @GetTotalSteps()</span>
            <button class="btn-nav primary" @onclick="NextStep" disabled="@(!CanProceed())">
                @(IsLastStep() ? "Calculate" : "Next")
            </button>
        }
    </div>
</div>

<!-- Right Stats Sidebar -->
<RightStatsSidebar HasResults="@(results != null || vmResults != null)"
                   TotalNodes="@GetTotalNodes()"
                   TotalCPU="@GetTotalCPU()"
                   TotalRAM="@GetTotalRAM()"
                   TotalDisk="@GetTotalDisk()"
                   MonthlyEstimate="@GetMonthlyEstimate()"
                   CostProvider="@GetCostProvider()"
                   ShowPricingNotAvailable="@ShouldShowPricingNA()"
                   WarningsCount="@GetWarningsCount()"
                   CriticalCount="@GetCriticalCount()"
                   RecommendationsCount="@GetRecommendationsCount()"
                   OnExport="HandleExport"
                   OnShare="HandleShare"
                   OnSave="() => showSaveScenarioModal = true" />

<!-- Settings Modal -->
@if (showSettings)
{
    <div class="modal-overlay" @onclick="CloseSettings">
        <div class="modal-content settings-modal" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h2>Default Settings</h2>
                <button class="modal-close" @onclick="CloseSettings">Ã—</button>
            </div>
            <div class="settings-body">
                <div class="settings-tabs">
                    <button class="settings-tab @(settingsTab == "infra" ? "active" : "")" @onclick='() => settingsTab = "infra"'>Infrastructure</button>
                    <button class="settings-tab @(settingsTab == "k8s" ? "active" : "")" @onclick='() => settingsTab = "k8s"'>Kubernetes</button>
                    <button class="settings-tab @(settingsTab == "headroom" ? "active" : "")" @onclick='() => settingsTab = "headroom"'>Headroom</button>
                    <button class="settings-tab @(settingsTab == "replicas" ? "active" : "")" @onclick='() => settingsTab = "replicas"'>Replicas</button>
                    <button class="settings-tab @(settingsTab == "nodes" ? "active" : "")" @onclick='() => settingsTab = "nodes"'>Node Defaults</button>
                    <button class="settings-tab @(settingsTab == "tiers" ? "active" : "")" @onclick='() => settingsTab = "tiers"'>App Tiers</button>
                    <button class="settings-tab @(settingsTab == "pricing" ? "active" : "")" @onclick='() => settingsTab = "pricing"'>Pricing</button>
                    <button class="settings-tab @(settingsTab == "mendix" ? "active" : "")" @onclick='() => settingsTab = "mendix"'>Mendix</button>
                </div>

                <div class="settings-panel-container">
                    <!-- Infrastructure Tab -->
                    @if (settingsTab == "infra")
                    {
                        <div class="settings-panel">
                            <h3>Infrastructure Thresholds</h3>
                            <div class="settings-grid">
                                <div class="settings-item">
                                    <label>Large Deployment Threshold</label>
                                    <input type="number" @bind="settings.LargeDeploymentThreshold" />
                                    <div class="hint">Apps count that triggers 5 infra nodes (default: 50)</div>
                                </div>
                                <div class="settings-item">
                                    <label>Large Cluster Worker Threshold</label>
                                    <input type="number" @bind="settings.LargeClusterThreshold" />
                                    <div class="hint">Workers count that triggers 5 masters (default: 100)</div>
                                </div>
                                <div class="settings-item">
                                    <label>Apps Per Infra Node</label>
                                    <input type="number" @bind="settings.AppsPerInfraNode" />
                                    <div class="hint">Ratio for scaling infra nodes (default: 25)</div>
                                </div>
                                <div class="settings-item">
                                    <label>Min Infra Nodes (Large)</label>
                                    <input type="number" @bind="settings.MinProdInfraLarge" />
                                    <div class="hint">Min infra for large deployments (default: 5)</div>
                                </div>
                                <div class="settings-item">
                                    <label>Min Infra Nodes (Small)</label>
                                    <input type="number" @bind="settings.MinProdInfraSmall" />
                                    <div class="hint">Min infra for small deployments (default: 3)</div>
                                </div>
                                <div class="settings-item">
                                    <label>Max Infra Nodes</label>
                                    <input type="number" @bind="settings.MaxInfraNodes" />
                                    <div class="hint">Maximum infra nodes cap (default: 10)</div>
                                </div>
                            </div>
                        </div>
                    }

                    <!-- Kubernetes Tab -->
                    @if (settingsTab == "k8s")
                    {
                        <div class="settings-panel">
                            <h3>Kubernetes Resource Parameters</h3>
                            <div class="settings-section">
                                <h4>Production Settings</h4>
                                <div class="settings-grid">
                                    <div class="settings-item">
                                        <label>CPU Overcommit Ratio</label>
                                        <input type="number" step="0.1" @bind="settings.ProdCpuOvercommit" />
                                        <div class="hint">1:1 = no overcommit (default: 1.0)</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>Memory Overcommit Ratio</label>
                                        <input type="number" step="0.1" @bind="settings.ProdMemoryOvercommit" />
                                        <div class="hint">1:1 = no overcommit (default: 1.0)</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>Resource Buffer (%)</label>
                                        <input type="number" @bind="settings.ProdResourceBuffer" />
                                        <div class="hint">Headroom percentage (default: 30)</div>
                                    </div>
                                </div>
                            </div>
                            <div class="settings-section">
                                <h4>Non-Production Settings</h4>
                                <div class="settings-grid">
                                    <div class="settings-item">
                                        <label>CPU Overcommit Ratio</label>
                                        <input type="number" step="0.1" @bind="settings.NonProdCpuOvercommit" />
                                        <div class="hint">Higher values reduce cost (default: 1.0)</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>Memory Overcommit Ratio</label>
                                        <input type="number" step="0.1" @bind="settings.NonProdMemoryOvercommit" />
                                        <div class="hint">Higher values reduce cost (default: 1.0)</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>Resource Buffer (%)</label>
                                        <input type="number" @bind="settings.NonProdResourceBuffer" />
                                        <div class="hint">Headroom percentage (default: 15)</div>
                                    </div>
                                </div>
                            </div>
                            <div class="settings-section">
                                <h4>System Settings</h4>
                                <div class="settings-grid">
                                    <div class="settings-item">
                                        <label>Node System Reserve (%)</label>
                                        <input type="number" @bind="settings.NodeSystemReserve" />
                                        <div class="hint">Reserved for kubelet, OS (default: 15)</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>Min Worker Nodes</label>
                                        <input type="number" @bind="settings.MinWorkerNodes" />
                                        <div class="hint">Minimum workers per cluster (default: 3)</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }

                    <!-- Headroom Tab -->
                    @if (settingsTab == "headroom")
                    {
                        <div class="settings-panel">
                            <h3>Worker Headroom Percentages</h3>
                            <p class="settings-desc">Extra capacity for scaling and burst traffic</p>
                            <div class="settings-grid">
                                <div class="settings-item">
                                    <label>Dev Headroom (%)</label>
                                    <input type="number" @bind="settings.HeadroomDev" />
                                </div>
                                <div class="settings-item">
                                    <label>Test Headroom (%)</label>
                                    <input type="number" @bind="settings.HeadroomTest" />
                                </div>
                                <div class="settings-item">
                                    <label>Stage Headroom (%)</label>
                                    <input type="number" @bind="settings.HeadroomStage" />
                                </div>
                                <div class="settings-item">
                                    <label>Prod Headroom (%)</label>
                                    <input type="number" step="0.1" @bind="settings.HeadroomProd" />
                                </div>
                                <div class="settings-item">
                                    <label>DR Headroom (%)</label>
                                    <input type="number" step="0.1" @bind="settings.HeadroomDR" />
                                </div>
                            </div>
                        </div>
                    }

                    <!-- Replicas Tab -->
                    @if (settingsTab == "replicas")
                    {
                        <div class="settings-panel">
                            <h3>Default Replica Counts</h3>
                            <p class="settings-desc">Application instances per environment</p>
                            <div class="settings-grid">
                                <div class="settings-item">
                                    <label>Dev Replicas</label>
                                    <input type="number" @bind="settings.ReplicasDev" />
                                </div>
                                <div class="settings-item">
                                    <label>Test Replicas</label>
                                    <input type="number" @bind="settings.ReplicasTest" />
                                </div>
                                <div class="settings-item">
                                    <label>Stage Replicas</label>
                                    <input type="number" @bind="settings.ReplicasStage" />
                                </div>
                                <div class="settings-item">
                                    <label>Prod Replicas</label>
                                    <input type="number" @bind="settings.ReplicasProd" />
                                </div>
                                <div class="settings-item">
                                    <label>DR Replicas</label>
                                    <input type="number" @bind="settings.ReplicasDR" />
                                </div>
                            </div>

                            <div class="settings-section" style="margin-top: 20px;">
                                <h4>Mendix Platform Settings</h4>
                                <div class="settings-grid">
                                    <div class="settings-item">
                                        <label>Mendix Operator Replicas</label>
                                        <input type="number" @bind="settings.MendixOperatorReplicas" min="1" />
                                        <div class="hint">Number of Mendix operator instances (default: 2)</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }

                    <!-- Node Defaults Tab -->
                    @if (settingsTab == "nodes")
                    {
                        <div class="settings-panel">
                            <h3>Default Node Specifications</h3>
                            <p class="settings-desc">Default node sizes loaded when selecting a distribution</p>

                            <div class="settings-section">
                                <h4>Control Plane Defaults</h4>
                                <div class="node-defaults-grid">
                                    <div class="node-default-group">
                                        <label>Production</label>
                                        <div class="inline-inputs">
                                            <div><label>CPU</label><input type="number" @bind="settings.ProdMasterCpu" /></div>
                                            <div><label>RAM</label><input type="number" @bind="settings.ProdMasterRam" /></div>
                                            <div><label>Disk</label><input type="number" @bind="settings.ProdMasterDisk" /></div>
                                        </div>
                                    </div>
                                    <div class="node-default-group">
                                        <label>Non-Production</label>
                                        <div class="inline-inputs">
                                            <div><label>CPU</label><input type="number" @bind="settings.NonProdMasterCpu" /></div>
                                            <div><label>RAM</label><input type="number" @bind="settings.NonProdMasterRam" /></div>
                                            <div><label>Disk</label><input type="number" @bind="settings.NonProdMasterDisk" /></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="settings-section">
                                <h4>Infrastructure Defaults (OpenShift)</h4>
                                <div class="node-defaults-grid">
                                    <div class="node-default-group">
                                        <label>Production</label>
                                        <div class="inline-inputs">
                                            <div><label>CPU</label><input type="number" @bind="settings.ProdInfraCpu" /></div>
                                            <div><label>RAM</label><input type="number" @bind="settings.ProdInfraRam" /></div>
                                            <div><label>Disk</label><input type="number" @bind="settings.ProdInfraDisk" /></div>
                                        </div>
                                    </div>
                                    <div class="node-default-group">
                                        <label>Non-Production</label>
                                        <div class="inline-inputs">
                                            <div><label>CPU</label><input type="number" @bind="settings.NonProdInfraCpu" /></div>
                                            <div><label>RAM</label><input type="number" @bind="settings.NonProdInfraRam" /></div>
                                            <div><label>Disk</label><input type="number" @bind="settings.NonProdInfraDisk" /></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="settings-section">
                                <h4>Worker Defaults</h4>
                                <div class="node-defaults-grid">
                                    <div class="node-default-group">
                                        <label>Production</label>
                                        <div class="inline-inputs">
                                            <div><label>CPU</label><input type="number" @bind="settings.ProdWorkerCpu" /></div>
                                            <div><label>RAM</label><input type="number" @bind="settings.ProdWorkerRam" /></div>
                                            <div><label>Disk</label><input type="number" @bind="settings.ProdWorkerDisk" /></div>
                                        </div>
                                    </div>
                                    <div class="node-default-group">
                                        <label>Non-Production</label>
                                        <div class="inline-inputs">
                                            <div><label>CPU</label><input type="number" @bind="settings.NonProdWorkerCpu" /></div>
                                            <div><label>RAM</label><input type="number" @bind="settings.NonProdWorkerRam" /></div>
                                            <div><label>Disk</label><input type="number" @bind="settings.NonProdWorkerDisk" /></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }

                    <!-- App Tiers Tab -->
                    @if (settingsTab == "tiers")
                    {
                        <div class="settings-panel">
                            <h3>Application Tier Specifications</h3>
                            <p class="settings-desc">Resource allocation per application size (CPU cores / RAM GB)</p>

                            @foreach (var tech in new[] { ("dotnet", ".NET"), ("java", "Java"), ("nodejs", "Node.js"), ("python", "Python"), ("go", "Go"), ("mendix", "Mendix") })
                            {
                                <div class="settings-section">
                                    <h4>@tech.Item2</h4>
                                    <div class="settings-grid">
                                        @foreach (var tier in new[] { "Small", "Medium", "Large", "XLarge" })
                                        {
                                            <div class="settings-item">
                                                <label>@tier CPU (cores)</label>
                                                <input type="number" step="0.125" value="@GetTierCpu(tech.Item1, tier)"
                                                       @onchange="@(e => SetTierCpu(tech.Item1, tier, ParseDouble(e.Value)))" />
                                            </div>
                                            <div class="settings-item">
                                                <label>@tier RAM (GB)</label>
                                                <input type="number" step="0.25" value="@GetTierRam(tech.Item1, tier)"
                                                       @onchange="@(e => SetTierRam(tech.Item1, tier, ParseDouble(e.Value)))" />
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    }

                    <!-- Pricing Tab -->
                    @if (settingsTab == "pricing")
                    {
                        <div class="settings-panel">
                            <h3>On-Premises Pricing Defaults</h3>
                            <p class="settings-desc">Configure default costs for on-premises deployments (used for TCO comparisons)</p>

                            <div class="settings-section">
                                <h4>Hardware Costs</h4>
                                <div class="settings-grid">
                                    <div class="settings-item">
                                        <label>Server Base Cost ($)</label>
                                        <input type="number" min="0" step="100" @bind="onPremPricing.Hardware.ServerCost" />
                                        <div class="hint">Base server hardware cost (default: $5,000)</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>Per CPU Core ($)</label>
                                        <input type="number" min="0" step="10" @bind="onPremPricing.Hardware.PerCpuCore" />
                                        <div class="hint">Cost per CPU core (default: $100)</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>Per GB RAM ($)</label>
                                        <input type="number" min="0" step="1" @bind="onPremPricing.Hardware.PerGBRam" />
                                        <div class="hint">Cost per GB of RAM (default: $10)</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>VMs Per Server</label>
                                        <input type="number" min="1" max="20" @bind="onPremPricing.Hardware.VMsPerServer" />
                                        <div class="hint">VMs per physical server (default: 4)</div>
                                    </div>
                                </div>
                            </div>

                            <div class="settings-section">
                                <h4>Data Center Costs</h4>
                                <div class="settings-grid">
                                    <div class="settings-item">
                                        <label>Rack Unit/Month ($)</label>
                                        <input type="number" min="0" step="10" @bind="onPremPricing.DataCenter.RackUnitPerMonth" />
                                        <div class="hint">Monthly cost per rack unit (default: $100)</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>Power per kWh ($)</label>
                                        <input type="number" min="0" step="0.01" @bind="onPremPricing.DataCenter.PowerPerKWh" />
                                        <div class="hint">Power cost per kWh (default: $0.12)</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>PUE</label>
                                        <input type="number" min="1" max="3" step="0.1" @bind="onPremPricing.DataCenter.PUE" />
                                        <div class="hint">Power Usage Effectiveness (default: 1.5)</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>Cooling Overhead (%)</label>
                                        <input type="number" min="0" max="100" @bind="onPremPricing.DataCenter.CoolingPercent" />
                                        <div class="hint">Cooling as % of power (default: 30%)</div>
                                    </div>
                                </div>
                            </div>

                            <div class="settings-section">
                                <h4>Labor Costs</h4>
                                <div class="settings-grid">
                                    <div class="settings-item">
                                        <label>DevOps Engineer/Month ($)</label>
                                        <input type="number" min="0" step="500" @bind="onPremPricing.Labor.DevOpsEngineerMonthly" />
                                        <div class="hint">Monthly salary (default: $12,000)</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>SysAdmin/Month ($)</label>
                                        <input type="number" min="0" step="500" @bind="onPremPricing.Labor.SysAdminMonthly" />
                                        <div class="hint">Monthly salary (default: $9,000)</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>DBA/Month ($)</label>
                                        <input type="number" min="0" step="500" @bind="onPremPricing.Labor.DBAMonthly" />
                                        <div class="hint">Monthly salary (default: $11,000)</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>Nodes Per Engineer</label>
                                        <input type="number" min="1" max="100" @bind="onPremPricing.Labor.NodesPerEngineer" />
                                        <div class="hint">Nodes managed per engineer (default: 25)</div>
                                    </div>
                                </div>
                            </div>

                            <div class="settings-section">
                                <h4>License Costs</h4>
                                <div class="settings-grid">
                                    <div class="settings-item">
                                        <label>OpenShift/Node/Year ($)</label>
                                        <input type="number" min="0" step="100" @bind="onPremPricing.Licensing.OpenShiftPerNodeYear" />
                                        <div class="hint">Annual license per node (default: $2,500)</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>Tanzu/Core/Year ($)</label>
                                        <input type="number" min="0" step="100" @bind="onPremPricing.Licensing.TanzuPerCoreYear" />
                                        <div class="hint">Annual license per core (default: $1,500)</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>Rancher/Node/Year ($)</label>
                                        <input type="number" min="0" step="100" @bind="onPremPricing.Licensing.RancherEnterprisePerNodeYear" />
                                        <div class="hint">Annual support per node (default: $1,000)</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>Charmed K8s/Node/Year ($)</label>
                                        <input type="number" min="0" step="100" @bind="onPremPricing.Licensing.CharmedK8sPerNodeYear" />
                                        <div class="hint">Annual support per node (default: $500)</div>
                                    </div>
                                </div>
                            </div>

                            <div class="settings-section">
                                <h4>Global Settings</h4>
                                <div class="settings-grid">
                                    <div class="settings-item">
                                        <label>Hardware Refresh (Years)</label>
                                        <input type="number" min="1" max="10" @bind="onPremPricing.HardwareRefreshYears" />
                                        <div class="hint">Hardware refresh cycle (default: 5 years)</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>Maintenance Overhead (%)</label>
                                        <input type="number" min="0" max="50" @bind="onPremPricing.HardwareMaintenancePercent" />
                                        <div class="hint">Annual maintenance as % of hardware (default: 15%)</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }

                    <!-- Mendix Pricing Tab -->
                    @if (settingsTab == "mendix")
                    {
                        <div class="settings-panel mendix-settings-panel">
                            <h3>Mendix Platform Pricing</h3>
                            <p class="settings-desc">Official Mendix pricing from the June 2025 pricebook. Update these values when pricing changes.</p>

                            <div class="settings-section">
                                <h4>Cloud Tokens & Base Pricing</h4>
                                <div class="settings-grid">
                                    <div class="settings-item">
                                        <label>Cloud Token Price ($)</label>
                                        <input type="number" min="0" step="0.01" @bind="mendixPricingSettings.CloudTokenPrice" />
                                        <div class="hint">Price per cloud token (default: $51.60)</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>Cloud Dedicated/Year ($)</label>
                                        <input type="number" min="0" step="100" @bind="mendixPricingSettings.CloudDedicatedPricePerYear" />
                                        <div class="hint">Mendix Cloud Dedicated (default: $368,100)</div>
                                    </div>
                                </div>
                            </div>

                            <div class="settings-section">
                                <h4>Mendix on Azure</h4>
                                <div class="settings-grid">
                                    <div class="settings-item">
                                        <label>Base Price/Year ($)</label>
                                        <input type="number" min="0" step="10" @bind="mendixPricingSettings.AzureBasePricePerYear" />
                                        <div class="hint">Base annual fee (default: $6,612)</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>Included Environments</label>
                                        <input type="number" min="1" max="10" @bind="mendixPricingSettings.AzureBaseEnvironmentsIncluded" />
                                        <div class="hint">Environments in base (default: 3)</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>Additional Env Price ($)</label>
                                        <input type="number" min="0" step="10" @bind="mendixPricingSettings.AzureAdditionalEnvironmentPrice" />
                                        <div class="hint">Per additional environment (default: $722.40)</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>Additional Env Tokens</label>
                                        <input type="number" min="0" @bind="mendixPricingSettings.AzureAdditionalEnvironmentTokens" />
                                        <div class="hint">Tokens per additional env (default: 14)</div>
                                    </div>
                                </div>
                            </div>

                            <div class="settings-section">
                                <h4>Mendix on Kubernetes</h4>
                                <div class="settings-grid">
                                    <div class="settings-item">
                                        <label>Base Price/Year ($)</label>
                                        <input type="number" min="0" step="10" @bind="mendixPricingSettings.K8sBasePricePerYear" />
                                        <div class="hint">Base annual fee (default: $6,360)</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>Included Environments</label>
                                        <input type="number" min="0" max="10" @bind="mendixPricingSettings.K8sBaseEnvironmentsIncluded" />
                                        <div class="hint">Environments in base (default: 0)</div>
                                    </div>
                                </div>
                                <h5 style="margin-top: 15px;">Environment Tiers (Price per Environment)</h5>
                                <div class="settings-grid">
                                    @if (mendixPricingSettings.K8sEnvironmentTiers != null)
                                    {
                                        @foreach (var tier in mendixPricingSettings.K8sEnvironmentTiers)
                                        {
                                            <div class="settings-item">
                                                <label>@tier.MinEnvironments-@(tier.MaxEnvironments == -1 ? "âˆž" : tier.MaxEnvironments.ToString()) Envs ($)</label>
                                                <input type="number" min="0" step="10" @bind="tier.PricePerEnvironment" />
                                            </div>
                                        }
                                    }
                                </div>
                            </div>

                            <div class="settings-section">
                                <h4>Server / StackIT / SAP BTP Deployments</h4>
                                <div class="settings-grid">
                                    <div class="settings-item">
                                        <label>Server Per-App/Year ($)</label>
                                        <input type="number" min="0" step="100" @bind="mendixPricingSettings.ServerPerAppPricePerYear" />
                                        <div class="hint">Default: $6,612</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>Server Unlimited/Year ($)</label>
                                        <input type="number" min="0" step="100" @bind="mendixPricingSettings.ServerUnlimitedAppsPricePerYear" />
                                        <div class="hint">Default: $33,060</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>StackIT Per-App/Year ($)</label>
                                        <input type="number" min="0" step="100" @bind="mendixPricingSettings.StackITPerAppPricePerYear" />
                                        <div class="hint">Default: $6,612</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>StackIT Unlimited/Year ($)</label>
                                        <input type="number" min="0" step="100" @bind="mendixPricingSettings.StackITUnlimitedAppsPricePerYear" />
                                        <div class="hint">Default: $33,060</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>SAP BTP Per-App/Year ($)</label>
                                        <input type="number" min="0" step="100" @bind="mendixPricingSettings.SapBtpPerAppPricePerYear" />
                                        <div class="hint">Default: $6,612</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>SAP BTP Unlimited/Year ($)</label>
                                        <input type="number" min="0" step="100" @bind="mendixPricingSettings.SapBtpUnlimitedAppsPricePerYear" />
                                        <div class="hint">Default: $33,060</div>
                                    </div>
                                </div>
                            </div>

                            <div class="settings-section">
                                <h4>User & Platform Licensing</h4>
                                <div class="settings-grid">
                                    <div class="settings-item">
                                        <label>Platform Premium/Year ($)</label>
                                        <input type="number" min="0" step="100" @bind="mendixPricingSettings.PlatformPremiumUnlimitedPerYear" />
                                        <div class="hint">Unlimited apps license (default: $65,400)</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>Internal Users/100/Year ($)</label>
                                        <input type="number" min="0" step="100" @bind="mendixPricingSettings.InternalUsersPer100PerYear" />
                                        <div class="hint">Per 100 internal users (default: $40,800)</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>External Users/250K/Year ($)</label>
                                        <input type="number" min="0" step="100" @bind="mendixPricingSettings.ExternalUsersPer250KPerYear" />
                                        <div class="hint">Per 250K external users (default: $60,000)</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>Volume Discount (%)</label>
                                        <input type="number" min="0" max="50" step="1" @bind="mendixPricingSettings.VolumeDiscountPercent" />
                                        <div class="hint">Discount on platform + user licenses (default: 10%)</div>
                                    </div>
                                </div>
                            </div>

                            <div class="settings-section">
                                <h4>Additional Storage Pricing</h4>
                                <div class="settings-grid">
                                    <div class="settings-item">
                                        <label>File Storage/100GB/Year ($)</label>
                                        <input type="number" min="0" step="1" @bind="mendixPricingSettings.AdditionalFileStoragePer100GB" />
                                        <div class="hint">Default: $123</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>DB Storage/100GB/Year ($)</label>
                                        <input type="number" min="0" step="1" @bind="mendixPricingSettings.AdditionalDatabaseStoragePer100GB" />
                                        <div class="hint">Default: $246</div>
                                    </div>
                                </div>
                            </div>

                            <div class="settings-section">
                                <h4>ðŸ¤– GenAI Add-ons</h4>
                                <div class="settings-grid">
                                    <div class="settings-item">
                                        <label>Knowledge Base/Year ($)</label>
                                        <input type="number" min="0" step="100" @bind="mendixPricingSettings.GenAIKnowledgeBasePricePerYear" />
                                        <div class="hint">Default: $12,000</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>Knowledge Base Tokens</label>
                                        <input type="number" min="0" @bind="mendixPricingSettings.GenAIKnowledgeBaseTokens" />
                                        <div class="hint">Cloud tokens included (default: 232)</div>
                                    </div>
                                    <div class="settings-item">
                                        <label>Customer Enablement ($)</label>
                                        <input type="number" min="0" step="100" @bind="mendixPricingSettings.CustomerEnablementPrice" />
                                        <div class="hint">One-time fee (default: $11,000)</div>
                                    </div>
                                </div>
                            </div>

                            <details class="settings-collapsible">
                                <summary>Standard Resource Packs (99.5% SLA)</summary>
                                <div class="resource-packs-grid">
                                    @if (mendixPricingSettings.StandardResourcePacks != null)
                                    {
                                        @foreach (var pack in mendixPricingSettings.StandardResourcePacks)
                                        {
                                            <div class="resource-pack-item">
                                                <label>@pack.DisplayName Price/Year ($)</label>
                                                <input type="number" min="0" step="100" @bind="pack.PricePerYear" />
                                                <span class="pack-specs">@pack.MxMemoryGB GB | @pack.MxVCpu vCPU | @pack.DbStorageGB GB DB</span>
                                            </div>
                                        }
                                    }
                                </div>
                            </details>

                            <details class="settings-collapsible">
                                <summary>Premium Resource Packs (99.95% SLA + Fallback)</summary>
                                <div class="resource-packs-grid">
                                    @if (mendixPricingSettings.PremiumResourcePacks != null)
                                    {
                                        @foreach (var pack in mendixPricingSettings.PremiumResourcePacks)
                                        {
                                            <div class="resource-pack-item">
                                                <label>@pack.DisplayName Price/Year ($)</label>
                                                <input type="number" min="0" step="100" @bind="pack.PricePerYear" />
                                                <span class="pack-specs">@pack.MxMemoryGB GB | @pack.MxVCpu vCPU | @pack.DbStorageGB GB DB</span>
                                            </div>
                                        }
                                    }
                                </div>
                            </details>

                            <details class="settings-collapsible">
                                <summary>Premium Plus Resource Packs (Multi-Region Failover)</summary>
                                <div class="resource-packs-grid">
                                    @if (mendixPricingSettings.PremiumPlusResourcePacks != null)
                                    {
                                        @foreach (var pack in mendixPricingSettings.PremiumPlusResourcePacks)
                                        {
                                            <div class="resource-pack-item">
                                                <label>@pack.DisplayName Price/Year ($)</label>
                                                <input type="number" min="0" step="100" @bind="pack.PricePerYear" />
                                                <span class="pack-specs">@pack.MxMemoryGB GB | @pack.MxVCpu vCPU | @pack.DbStorageGB GB DB</span>
                                            </div>
                                        }
                                    }
                                </div>
                            </details>

                            <details class="settings-collapsible">
                                <summary>GenAI Model Packs</summary>
                                <div class="resource-packs-grid">
                                    @if (mendixPricingSettings.GenAIModelPacks != null)
                                    {
                                        @foreach (var pack in mendixPricingSettings.GenAIModelPacks)
                                        {
                                            <div class="resource-pack-item">
                                                <label>@pack.Size Price/Year ($)</label>
                                                <input type="number" min="0" step="100" @bind="pack.PricePerYear" />
                                                <span class="pack-specs">@pack.CloudTokens tokens</span>
                                            </div>
                                        }
                                    }
                                </div>
                            </details>
                        </div>
                    }
                </div>
            </div>
            <div class="modal-footer">
                <div class="modal-footer-left">
                    <button class="modal-btn reset" @onclick="ResetSettings">Reset to Defaults</button>
                </div>
                <button class="modal-btn primary" @onclick="SaveAndCloseSettings">Save & Close</button>
            </div>
        </div>
    </div>
}

<!-- Profiles removed - using Scenarios instead -->

<!-- Info Modal -->
@if (showInfoModal)
{
    <div class="modal-overlay" @onclick="() => showInfoModal = false">
        <div class="modal-content" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h2>@infoModalTitle</h2>
                <button class="modal-close" @onclick="() => showInfoModal = false">Ã—</button>
            </div>
            <div class="modal-body info-content">
                @((MarkupString)infoModalContent)
            </div>
            <div class="modal-footer">
                <button class="modal-btn primary" @onclick="() => showInfoModal = false">Close</button>
            </div>
        </div>
    </div>
}

<!-- Save Scenario Modal -->
@if (showSaveScenarioModal)
{
    <SaveScenarioModal @bind-IsVisible="showSaveScenarioModal"
                       K8sInput="@GetK8sSizingInput()"
                       K8sResult="@results"
                       VMInput="@GetVMSizingInput()"
                       VMResult="@vmResults"
                       CostEstimate="@(results != null ? k8sCostEstimate : vmCostEstimate)"
                       OnSaved="HandleScenarioSaved" />
}

<!-- Toast Notification -->
@if (showShareCopied)
{
    <div class="toast-notification success">
        <span class="toast-icon icon icon-check"></span>
        <span class="toast-message">Link copied to clipboard!</span>
    </div>
}

@code {
    // Wizard state
    private int currentStep = 1;
    private PlatformType? selectedPlatform;
    private DeploymentModel? selectedDeployment;
    private Technology? selectedTechnology;
    private Distribution? selectedDistribution;
    private ClusterMode? selectedClusterMode = ClusterMode.MultiCluster;
    private string distributionFilter = "on-prem"; // Default to Self-Managed tab
    private string cloudCategory = "major"; // Cloud sub-category filter (no "all" option)
    private string distributionSearch = "";
    private string configTab = "apps"; // apps, nodes, settings, mendix
    private EnvironmentType selectedSingleEnvironment = EnvironmentType.Prod;
    private string singleClusterScope = "Shared"; // Options: Shared, Dev, Test, Stage, Prod, DR
    private EnvironmentType selectedNodeSpecsEnv = EnvironmentType.Prod; // For multi-cluster node specs tabs

    // Modal state
    private bool showSettings = false;
    private bool showInfoModal = false;
    private bool showSaveScenarioModal = false;
    private string settingsTab = "infra";
    private string infoModalTitle = "";
    private string infoModalContent = "";

    // Environment app counts (per environment)
    private Dictionary<EnvironmentType, AppConfig> envApps = new()
    {
        { EnvironmentType.Dev, new AppConfig { Medium = 70 } },
        { EnvironmentType.Test, new AppConfig { Medium = 70 } },
        { EnvironmentType.Stage, new AppConfig { Medium = 70 } },
        { EnvironmentType.Prod, new AppConfig { Medium = 70 } }
    };

    private HashSet<EnvironmentType> enabledEnvironments = new()
    {
        EnvironmentType.Dev,
        EnvironmentType.Test,
        EnvironmentType.Stage,
        EnvironmentType.Prod
    };

    // Node specs (editable on main page, loaded from settings defaults)
    private NodeSpecsConfig nodeSpecs = new();
    private Models.K8sHADRConfig k8sHADRConfig = new();

    // Resource configuration (editable on main page, loaded from settings defaults)
    private double prodCpuOvercommit = 1.0;
    private double prodMemoryOvercommit = 1.0;
    private double nonProdCpuOvercommit = 1.0;
    private double nonProdMemoryOvercommit = 1.0;

    // Headroom per environment (editable on main page)
    // Matches JS defaults: Dev/Test=33%, Stage=0%, Prod=37.5%
    private Dictionary<EnvironmentType, double> headroom = new()
    {
        { EnvironmentType.Dev, 33 },
        { EnvironmentType.Test, 33 },
        { EnvironmentType.Stage, 0 },
        { EnvironmentType.Prod, 37.5 }
    };

    // Replicas per environment (editable on main page)
    private Dictionary<EnvironmentType, int> replicas = new()
    {
        { EnvironmentType.Dev, 1 },
        { EnvironmentType.Test, 1 },
        { EnvironmentType.Stage, 2 },
        { EnvironmentType.Prod, 3 }
    };

    // Mendix-specific settings (editable on main page when Mendix selected)
    private int mendixOperatorReplicas = 2;

    // Mendix deployment configuration (for LowCode flow)
    private MendixDeploymentCategory? mendixDeploymentCategory = null;
    private MendixCloudType mendixCloudType = MendixCloudType.SaaS;
    private MendixPrivateCloudProvider? mendixPrivateCloudProvider = null;
    private MendixOtherDeployment? mendixOtherDeployment = null;
    private bool mendixIsUnlimitedApps = true;
    private int mendixNumberOfApps = 1;
    private int mendixNumberOfEnvironments = 3;
    private int mendixInternalUsers = 100;
    private int mendixExternalUsers = 0;
    private string mendixResourcePackSize = "M";

    // Settings (defaults only)
    private UICalculatorSettings settings = new();

    // On-prem pricing defaults
    private OnPremPricing onPremPricing = new();

    // Mendix pricing settings (from official pricebook)
    private MendixPricingSettings mendixPricingSettings = new();

    // OutSystems pricing configuration
    private OutSystemsEdition outsystemsEdition = OutSystemsEdition.Standard;
    private int outsystemsApplicationObjects = 150;  // Default to 1 AO pack (typical medium app)
    private int outsystemsInternalUsers = 100;       // Included in Standard
    private int outsystemsExternalSessions = 0;      // Monthly sessions for external users
    private OutSystemsPricingSettings outsystemsPricingSettings = new();
    private string outsystemsActiveAccordion = "edition"; // "edition" or "licensing" - only one open at a time

    // Results
    private K8sSizingResult? results;
    private VMSizingResult? vmResults;

    // Pricing step result
    private PricingStepResult? pricingResult;

    // Validation warnings
    private List<ValidationWarning>? validationWarnings;
    private List<ValidationWarning>? vmValidationWarnings;

    // Share functionality
    private bool showShareCopied = false;

    // Cost estimation state
    private string k8sResultsTab = "sizing"; // "sizing", "cost", or "insights"
    private string vmResultsTab = "sizing"; // "sizing", "cost", or "insights"
    private string? expandedRoleBreakdownEnv = null; // Accordion state for role breakdown - only one env open at a time
    private string costSubTab = "onprem"; // "onprem" or "cloud" - for on-prem distributions
    private string selectedCloudAlt = ""; // Selected cloud alternative key for comparison
    private CostEstimate? k8sCostEstimate;
    private CostEstimate? vmCostEstimate;
    private CostEstimationOptions k8sCostOptions = new();
    private CostEstimationOptions vmCostOptions = new();
    private bool k8sCostLoading = false;
    private bool vmCostLoading = false;
    private bool k8sPricingOptionsOpen = false;
    private bool k8sCostNotesOpen = false;
    private bool vmPricingOptionsOpen = false;
    private bool vmCostNotesOpen = false;
    private string vmCostAccordion = "current"; // "current", "alternative", or "" (both collapsed)

    // VM Configuration state
    private Dictionary<EnvironmentType, VMEnvironmentConfig> vmEnvironmentConfigs = new();
    private VMEnvironmentConfig? vmManagementEnvConfig; // e.g., OutSystems LifeTime
    private double vmSystemOverhead = 15;

    // Growth planning state
    private string k8sGrowthSubTab = "settings"; // "settings", "projection", or "timeline"
    private string vmGrowthSubTab = "settings"; // "settings", "projection", or "timeline"
    private GrowthSettings k8sGrowthSettings = new();
    private GrowthSettings vmGrowthSettings = new();
    private GrowthProjection? k8sGrowthProjection;
    private GrowthProjection? vmGrowthProjection;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadSettingsFromStorage();
            await LoadFromSharedUrlAsync();
            StateHasChanged();
        }
    }

    private async Task LoadFromSharedUrlAsync()
    {
        try
        {
            var sharedConfig = await SharingService.ParseFromUrlAsync();
            if (sharedConfig == null) return;

            if (sharedConfig.Type == "k8s" && sharedConfig.K8sInput != null)
            {
                await ApplyK8sSharedConfig(sharedConfig.K8sInput);
            }
            else if (sharedConfig.Type == "vm" && sharedConfig.VMInput != null)
            {
                await ApplyVMSharedConfig(sharedConfig.VMInput);
            }

            // Clear the URL parameter after loading
            await SharingService.ClearUrlParameterAsync();
        }
        catch
        {
            // Silently fail - shared config is optional
        }
    }

    private async Task ApplyK8sSharedConfig(K8sSizingInput input)
    {
        // Set platform based on technology
        var techConfig = TechnologyService.GetConfig(input.Technology);
        selectedPlatform = techConfig.IsLowCode ? PlatformType.LowCode : PlatformType.Native;

        // Set selections
        selectedDeployment = DeploymentModel.Kubernetes;
        selectedTechnology = input.Technology;
        selectedDistribution = input.Distribution;
        selectedClusterMode = input.ClusterMode;

        // Set enabled environments (DR is no longer a separate environment - it's a config option)
        enabledEnvironments = input.EnabledEnvironments ?? new HashSet<EnvironmentType>
        {
            EnvironmentType.Dev, EnvironmentType.Test, EnvironmentType.Stage, EnvironmentType.Prod
        };
        // Filter out any legacy DR entries from shared configs
        enabledEnvironments.Remove(EnvironmentType.DR);

        // Set app counts per environment
        if (input.EnvironmentApps != null)
        {
            foreach (var kvp in input.EnvironmentApps.Where(x => x.Key != EnvironmentType.DR))
            {
                envApps[kvp.Key] = kvp.Value;
            }
        }
        else
        {
            // Use ProdApps/NonProdApps as fallback
            envApps[EnvironmentType.Prod] = input.ProdApps;
            envApps[EnvironmentType.Dev] = input.NonProdApps;
            envApps[EnvironmentType.Test] = input.NonProdApps;
            envApps[EnvironmentType.Stage] = input.NonProdApps;
        }

        // Set headroom
        if (input.Headroom != null)
        {
            headroom[EnvironmentType.Dev] = input.Headroom.Dev;
            headroom[EnvironmentType.Test] = input.Headroom.Test;
            headroom[EnvironmentType.Stage] = input.Headroom.Stage;
            headroom[EnvironmentType.Prod] = input.Headroom.Prod;
        }

        // Set replicas
        if (input.Replicas != null)
        {
            replicas[EnvironmentType.Dev] = input.Replicas.NonProd;
            replicas[EnvironmentType.Test] = input.Replicas.NonProd;
            replicas[EnvironmentType.Stage] = input.Replicas.Stage;
            replicas[EnvironmentType.Prod] = input.Replicas.Prod;
        }

        // Set overcommit
        if (input.ProdOvercommit != null)
        {
            prodCpuOvercommit = input.ProdOvercommit.Cpu;
            prodMemoryOvercommit = input.ProdOvercommit.Memory;
        }
        if (input.NonProdOvercommit != null)
        {
            nonProdCpuOvercommit = input.NonProdOvercommit.Cpu;
            nonProdMemoryOvercommit = input.NonProdOvercommit.Memory;
        }

        // Load node specs from distribution defaults
        LoadNodeSpecsFromSettings();

        // Calculate results automatically (skip pricing step for shared configs)
        currentStep = 7;
        await CalculateK8s();
    }

    private async Task ApplyVMSharedConfig(VMSizingInput input)
    {
        // Set platform based on technology
        var techConfig = TechnologyService.GetConfig(input.Technology);
        selectedPlatform = techConfig.IsLowCode ? PlatformType.LowCode : PlatformType.Native;

        // Set selections
        selectedDeployment = DeploymentModel.VMs;
        selectedTechnology = input.Technology;

        // Set enabled environments (DR is no longer a separate environment - it's a config option)
        enabledEnvironments = input.EnabledEnvironments ?? new HashSet<EnvironmentType>
        {
            EnvironmentType.Dev, EnvironmentType.Test, EnvironmentType.Stage, EnvironmentType.Prod
        };
        // Filter out any legacy DR entries from shared configs
        enabledEnvironments.Remove(EnvironmentType.DR);

        // Set VM configs (filter out any legacy DR entries)
        if (input.EnvironmentConfigs != null)
        {
            vmEnvironmentConfigs = new Dictionary<EnvironmentType, VMEnvironmentConfig>(
                input.EnvironmentConfigs.Where(x => x.Key != EnvironmentType.DR));
        }

        // Set system overhead
        vmSystemOverhead = input.SystemOverheadPercent;

        // Calculate results automatically
        currentStep = 5;
        await CalculateVM();
    }

    // Step management
    private int GetTotalSteps()
    {
        // K8s: 1-Platform, 2-Deployment, 3-Technology, 4-Distribution, 5-Configure, 6-Pricing, 7-Results
        // VMs (Mendix): 1-Platform, 2-Deployment, 3-Technology, 4-DeploymentType, 5-Configure, 6-Pricing, 7-Results
        // VMs (Other): 1-Platform, 2-Deployment, 3-Technology, 4-Configure, 5-Pricing, 6-Results
        if (selectedDeployment == DeploymentModel.Kubernetes)
        {
            return 7;
        }
        // VMs with Mendix have deployment type selection step
        if (selectedDeployment == DeploymentModel.VMs && selectedTechnology == Technology.Mendix)
        {
            return 7;
        }
        return 6; // Non-Mendix VMs: skip deployment type step but include pricing
    }

    private int GetConfigStep()
    {
        if (selectedDeployment == DeploymentModel.Kubernetes)
            return 5;
        // Mendix VMs: config at step 5 (after deployment type at step 4)
        if (selectedTechnology == Technology.Mendix)
            return 5;
        // Non-Mendix VMs: config at step 4 (no deployment type step)
        return 4;
    }

    private int GetPricingStep()
    {
        if (selectedDeployment == DeploymentModel.Kubernetes)
            return 6;
        // Mendix VMs: pricing at step 6 (after config at step 5)
        if (selectedTechnology == Technology.Mendix)
            return 6;
        // Non-Mendix VMs: pricing at step 5 (after config at step 4)
        return 5;
    }

    private int GetResultsStep()
    {
        if (selectedDeployment == DeploymentModel.Kubernetes)
            return 7;
        // Mendix VMs: results at step 7 (after pricing at step 6)
        if (selectedTechnology == Technology.Mendix)
            return 7;
        // Non-Mendix VMs: results at step 6 (after pricing at step 5)
        return 6;
    }

    private string GetStepLabel(int step)
    {
        if (selectedDeployment == DeploymentModel.Kubernetes)
        {
            return step switch { 1 => "Platform", 2 => "Deployment", 3 => "Technology", 4 => "Distribution", 5 => "Configure", 6 => "Pricing", 7 => "Results", _ => "" };
        }
        // VMs with Mendix
        if (selectedTechnology == Technology.Mendix)
        {
            return step switch { 1 => "Platform", 2 => "Deployment", 3 => "Technology", 4 => "Deployment Type", 5 => "Configure", 6 => "Pricing", 7 => "Results", _ => "" };
        }
        // Non-Mendix VMs
        return step switch { 1 => "Platform", 2 => "Deployment", 3 => "Technology", 4 => "Configure", 5 => "Pricing", 6 => "Results", _ => "" };
    }

    private string? GetStepSelection(int step)
    {
        if (selectedDeployment == DeploymentModel.Kubernetes)
        {
            return step switch
            {
                1 => selectedPlatform?.ToString(),
                2 => selectedDeployment?.ToString(),
                3 => selectedTechnology?.ToString(),
                4 => GetDistributionDisplayName(),
                5 => selectedClusterMode == ClusterMode.MultiCluster ? "Multi-Cluster" : $"Single ({singleClusterScope})",
                6 => pricingResult?.HasCosts == true ? "Configured" : (pricingResult?.IsOnPrem == true ? "N/A" : null),
                _ => null
            };
        }
        // VM flow (Mendix)
        if (selectedTechnology == Technology.Mendix)
        {
            return step switch
            {
                1 => selectedPlatform?.ToString(),
                2 => "Virtual Machines",
                3 => selectedTechnology?.ToString(),
                4 => GetMendixVMDeploymentDisplayName(),
                5 => enabledEnvironments.Count > 0 ? $"{enabledEnvironments.Count} env(s)" : null,
                6 => "Configured",
                _ => null
            };
        }
        // VM flow (Non-Mendix)
        return step switch
        {
            1 => selectedPlatform?.ToString(),
            2 => "Virtual Machines",
            3 => selectedTechnology?.ToString(),
            4 => enabledEnvironments.Count > 0 ? $"{enabledEnvironments.Count} env(s)" : null,
            5 => "Configured",
            _ => null
        };
    }

    private string? GetDistributionDisplayName()
    {
        // For Mendix deployments, show the Mendix deployment type instead of K8s distribution
        if (selectedTechnology == Technology.Mendix)
        {
            if (mendixDeploymentCategory == MendixDeploymentCategory.Cloud)
            {
                return mendixCloudType == MendixCloudType.Dedicated ? "Mendix Cloud Dedicated" : "Mendix Cloud SaaS";
            }
            if (mendixDeploymentCategory == MendixDeploymentCategory.PrivateCloud)
            {
                return mendixPrivateCloudProvider switch
                {
                    MendixPrivateCloudProvider.Azure => "Mendix on Azure",
                    MendixPrivateCloudProvider.EKS => "Mendix on EKS",
                    MendixPrivateCloudProvider.AKS => "Mendix on AKS",
                    MendixPrivateCloudProvider.GKE => "Mendix on GKE",
                    MendixPrivateCloudProvider.OpenShift => "Mendix on OpenShift",
                    _ => selectedDistribution?.ToString()
                };
            }
            if (mendixDeploymentCategory == MendixDeploymentCategory.Other)
            {
                return mendixPrivateCloudProvider switch
                {
                    MendixPrivateCloudProvider.Rancher => "Rancher (Manual)",
                    MendixPrivateCloudProvider.K3s => "K3s (Manual)",
                    MendixPrivateCloudProvider.GenericK8s => "Generic K8s (Manual)",
                    _ => selectedDistribution?.ToString()
                };
            }
        }
        return selectedDistribution?.ToString();
    }

    private string? GetMendixVMDeploymentDisplayName()
    {
        return mendixOtherDeployment switch
        {
            MendixOtherDeployment.Server => "Server (VMs)",
            MendixOtherDeployment.StackIT => "StackIT",
            MendixOtherDeployment.SapBtp => "SAP BTP",
            _ => "Not selected"
        };
    }

    // Cluster mode helpers
    private string GetClusterModeIcon()
    {
        if (selectedClusterMode == ClusterMode.MultiCluster)
        {
            return "MC";
        }

        // Single Cluster mode - check scope
        return singleClusterScope == "Shared" ? "SC" : "SE";
    }

    private string GetClusterModeDescription()
    {
        if (selectedClusterMode == ClusterMode.MultiCluster)
        {
            return $"Multi-Cluster: {results?.Environments.Count ?? 0} separate clusters (one per environment)";
        }

        // Single Cluster mode - check scope
        if (singleClusterScope == "Shared")
        {
            return "Shared Cluster: All environments in a single cluster with namespace isolation";
        }

        return $"Single Environment: Sizing for {singleClusterScope} only";
    }

    private string GetClusterModeBannerClass()
    {
        if (selectedClusterMode == ClusterMode.MultiCluster)
        {
            return "multi";
        }

        // Single Cluster mode - check scope
        return singleClusterScope == "Shared" ? "shared" : "single";
    }

    private int GetClusterCount() => selectedClusterMode switch
    {
        ClusterMode.MultiCluster => results?.Environments.Count ?? 0,
        ClusterMode.SharedCluster => 1,
        ClusterMode.PerEnvironment => 1,
        _ => 0
    };

    // Single Cluster mode helpers
    private bool IsSingleClusterMode() => selectedClusterMode == ClusterMode.SharedCluster || selectedClusterMode == ClusterMode.PerEnvironment;

    private bool IsManagedControlPlane()
    {
        if (selectedDistribution == null) return false;
        var config = DistributionService.GetConfig(selectedDistribution.Value);
        return config.HasManagedControlPlane;
    }

    private bool IsOnPremDistribution()
    {
        // Check Mendix deployment category first
        if (selectedTechnology == Technology.Mendix && selectedDeployment == DeploymentModel.Kubernetes)
        {
            // Mendix Cloud (SaaS/Dedicated) is never on-prem
            if (mendixDeploymentCategory == MendixDeploymentCategory.Cloud)
                return false;

            // Mendix Private Cloud - check the provider
            if (mendixDeploymentCategory == MendixDeploymentCategory.PrivateCloud)
            {
                // Azure, EKS, AKS, GKE are cloud-managed, not on-prem
                return mendixPrivateCloudProvider switch
                {
                    MendixPrivateCloudProvider.Azure => false,
                    MendixPrivateCloudProvider.EKS => false,
                    MendixPrivateCloudProvider.AKS => false,
                    MendixPrivateCloudProvider.GKE => false,
                    MendixPrivateCloudProvider.OpenShift => true,
                    _ => false
                };
            }

            // Mendix Other K8s - check the provider (Rancher, K3s, GenericK8s are self-managed)
            if (mendixDeploymentCategory == MendixDeploymentCategory.Other)
            {
                return mendixPrivateCloudProvider switch
                {
                    MendixPrivateCloudProvider.Rancher => true,
                    MendixPrivateCloudProvider.K3s => true,
                    MendixPrivateCloudProvider.GenericK8s => true,
                    _ => true
                };
            }
        }

        // For non-Mendix K8s, check the distribution
        if (selectedDistribution == null) return false;

        // On-prem distributions don't have managed control plane and are not cloud-native
        return selectedDistribution.Value switch
        {
            Distribution.OpenShift => true,
            Distribution.Kubernetes => true,
            Distribution.Rancher => true,
            Distribution.RKE2 => true,
            Distribution.K3s => true,
            Distribution.MicroK8s => true,
            Distribution.Charmed => true,
            Distribution.Tanzu => true,
            _ => false
        };
    }

    private bool IsOpenShiftDistribution()
    {
        if (selectedDistribution == null) return false;
        return selectedDistribution.Value switch
        {
            Distribution.OpenShift => true,
            Distribution.OpenShiftROSA => true,
            Distribution.OpenShiftARO => true,
            Distribution.OpenShiftDedicated => true,
            Distribution.OpenShiftIBM => true,
            _ => false
        };
    }

    private bool IsMendixCloudDeployment()
    {
        // True only for Mendix Cloud SaaS or Dedicated (not Private Cloud or Other K8s)
        return selectedTechnology == Technology.Mendix
            && selectedDeployment == DeploymentModel.Kubernetes
            && mendixDeploymentCategory == MendixDeploymentCategory.Cloud;
    }

    private bool IsManagedCloudDeployment()
    {
        // Check if it's a managed cloud deployment (not self-managed on-prem)
        // 1. Mendix Cloud is managed
        if (IsMendixCloudDeployment()) return true;

        // 2. Mendix Private Cloud with cloud providers
        if (selectedTechnology == Technology.Mendix && selectedDeployment == DeploymentModel.Kubernetes)
        {
            if (mendixDeploymentCategory == MendixDeploymentCategory.PrivateCloud)
            {
                return mendixPrivateCloudProvider switch
                {
                    MendixPrivateCloudProvider.Azure => true,
                    MendixPrivateCloudProvider.EKS => true,
                    MendixPrivateCloudProvider.AKS => true,
                    MendixPrivateCloudProvider.GKE => true,
                    _ => false
                };
            }
            return false; // Other K8s is self-managed
        }

        // 3. Non-Mendix: check if distribution has managed control plane
        if (selectedDistribution.HasValue)
        {
            var config = DistributionService.GetConfig(selectedDistribution.Value);
            return config.HasManagedControlPlane;
        }

        return false;
    }

    // Cloud Alternative Info model for breakdown comparison
    private class CloudAlternativeInfo
    {
        public string Key { get; set; } = "";
        public string Name { get; set; } = "";
        public string Description { get; set; } = "";
        public string ProviderClass { get; set; } = "";
        public string InstanceType { get; set; } = "";
        public decimal MonthlyCost { get; set; }
        public decimal ComputeCost { get; set; }
        public decimal ControlPlaneCost { get; set; }
        public decimal StorageCost { get; set; }
        public decimal LicenseCost { get; set; }
        public bool IsOpenShiftManaged { get; set; }
        public Distribution TargetDistribution { get; set; }
    }

    private void SwitchToOnPremTab()
    {
        costSubTab = "onprem";
    }

    private List<CloudAlternativeInfo> GetCloudAlternativesForBreakdown()
    {
        var alternatives = new List<CloudAlternativeInfo>();
        var workerCount = results?.GrandTotal.TotalWorkers ?? 3;
        var totalCpu = results?.GrandTotal.TotalCpu ?? 48;
        var totalRam = results?.GrandTotal.TotalRam ?? 192;

        // Calculate instance sizing - use worker specs from results
        var cpuPerWorker = totalCpu / Math.Max(workerCount, 1);
        var ramPerWorker = totalRam / Math.Max(workerCount, 1);

        // AWS EKS
        var eksInstanceType = GetInstanceType("aws", cpuPerWorker, ramPerWorker);
        var eksComputeCost = GetComputeCost("aws", eksInstanceType, workerCount);
        alternatives.Add(new CloudAlternativeInfo
        {
            Key = "eks",
            Name = "AWS EKS",
            Description = "Managed Kubernetes on AWS",
            ProviderClass = "aws",
            InstanceType = eksInstanceType,
            ComputeCost = eksComputeCost,
            ControlPlaneCost = 73, // $0.10/hr
            StorageCost = workerCount * 50 * 0.10m, // 50GB gp3 per worker
            LicenseCost = 0,
            MonthlyCost = eksComputeCost + 73 + (workerCount * 50 * 0.10m),
            IsOpenShiftManaged = false,
            TargetDistribution = Distribution.EKS
        });

        // Azure AKS
        var aksInstanceType = GetInstanceType("azure", cpuPerWorker, ramPerWorker);
        var aksComputeCost = GetComputeCost("azure", aksInstanceType, workerCount);
        alternatives.Add(new CloudAlternativeInfo
        {
            Key = "aks",
            Name = "Azure AKS",
            Description = "Managed Kubernetes on Azure (Free control plane)",
            ProviderClass = "azure",
            InstanceType = aksInstanceType,
            ComputeCost = aksComputeCost,
            ControlPlaneCost = 0, // Free!
            StorageCost = workerCount * 50 * 0.08m, // 50GB managed disk per worker
            LicenseCost = 0,
            MonthlyCost = aksComputeCost + (workerCount * 50 * 0.08m),
            IsOpenShiftManaged = false,
            TargetDistribution = Distribution.AKS
        });

        // Google GKE
        var gkeInstanceType = GetInstanceType("gcp", cpuPerWorker, ramPerWorker);
        var gkeComputeCost = GetComputeCost("gcp", gkeInstanceType, workerCount);
        alternatives.Add(new CloudAlternativeInfo
        {
            Key = "gke",
            Name = "Google GKE",
            Description = "Managed Kubernetes on GCP",
            ProviderClass = "gcp",
            InstanceType = gkeInstanceType,
            ComputeCost = gkeComputeCost,
            ControlPlaneCost = 73, // $0.10/hr
            StorageCost = workerCount * 50 * 0.08m, // 50GB pd-ssd per worker
            LicenseCost = 0,
            MonthlyCost = gkeComputeCost + 73 + (workerCount * 50 * 0.08m),
            IsOpenShiftManaged = false,
            TargetDistribution = Distribution.GKE
        });

        // Add OpenShift managed options if current selection is OpenShift
        if (IsOpenShiftDistribution())
        {
            // ROSA (AWS)
            alternatives.Add(new CloudAlternativeInfo
            {
                Key = "rosa",
                Name = "ROSA (AWS)",
                Description = "Red Hat OpenShift Service on AWS",
                ProviderClass = "aws",
                InstanceType = eksInstanceType,
                ComputeCost = eksComputeCost,
                ControlPlaneCost = 125, // ~$0.171/hr
                StorageCost = workerCount * 100 * 0.10m, // 100GB gp3 per worker
                LicenseCost = workerCount * 125, // ~$0.171/hr per 4 vCPU
                MonthlyCost = eksComputeCost + 125 + (workerCount * 100 * 0.10m) + (workerCount * 125),
                IsOpenShiftManaged = true,
                TargetDistribution = Distribution.OpenShiftROSA
            });

            // ARO (Azure)
            alternatives.Add(new CloudAlternativeInfo
            {
                Key = "aro",
                Name = "ARO (Azure)",
                Description = "Azure Red Hat OpenShift",
                ProviderClass = "azure",
                InstanceType = aksInstanceType,
                ComputeCost = aksComputeCost * 1.1m, // Slightly higher for D8s_v4 typical
                ControlPlaneCost = 0, // Included in VM pricing
                StorageCost = workerCount * 100 * 0.08m, // 100GB managed disk per worker
                LicenseCost = workerCount * 110, // OpenShift license included
                MonthlyCost = (aksComputeCost * 1.1m) + (workerCount * 100 * 0.08m) + (workerCount * 110),
                IsOpenShiftManaged = true,
                TargetDistribution = Distribution.OpenShiftARO
            });

            // OpenShift Dedicated (GCP)
            alternatives.Add(new CloudAlternativeInfo
            {
                Key = "osd",
                Name = "OSD (GCP)",
                Description = "OpenShift Dedicated on Google Cloud",
                ProviderClass = "gcp",
                InstanceType = gkeInstanceType,
                ComputeCost = gkeComputeCost,
                ControlPlaneCost = 150, // Managed fee
                StorageCost = workerCount * 100 * 0.08m, // 100GB pd-ssd per worker
                LicenseCost = workerCount * 120, // OpenShift license
                MonthlyCost = gkeComputeCost + 150 + (workerCount * 100 * 0.08m) + (workerCount * 120),
                IsOpenShiftManaged = true,
                TargetDistribution = Distribution.OpenShiftDedicated
            });
        }

        return alternatives;
    }

    private string GetInstanceType(string provider, decimal cpuPerWorker, decimal ramPerWorker)
    {
        // Simple instance type mapping based on CPU/RAM
        return provider switch
        {
            "aws" => cpuPerWorker >= 16 ? "m6i.4xlarge" : cpuPerWorker >= 8 ? "m6i.2xlarge" : "m6i.xlarge",
            "azure" => cpuPerWorker >= 16 ? "Standard_D16s_v5" : cpuPerWorker >= 8 ? "Standard_D8s_v5" : "Standard_D4s_v5",
            "gcp" => cpuPerWorker >= 16 ? "n2-standard-16" : cpuPerWorker >= 8 ? "n2-standard-8" : "n2-standard-4",
            _ => "standard"
        };
    }

    private decimal GetComputeCost(string provider, string instanceType, int nodeCount)
    {
        // Approximate monthly costs for common instance types
        var hourlyRate = instanceType switch
        {
            "m6i.xlarge" => 0.192m,
            "m6i.2xlarge" => 0.384m,
            "m6i.4xlarge" => 0.768m,
            "Standard_D4s_v5" => 0.192m,
            "Standard_D8s_v5" => 0.384m,
            "Standard_D16s_v5" => 0.768m,
            "n2-standard-4" => 0.195m,
            "n2-standard-8" => 0.389m,
            "n2-standard-16" => 0.778m,
            _ => 0.40m
        };
        return hourlyRate * 730 * nodeCount; // 730 hours/month
    }

    private void SelectCloudAlternative(string key)
    {
        selectedCloudAlt = selectedCloudAlt == key ? "" : key;
    }

    private void ApplyCloudAlternative(CloudAlternativeInfo alt)
    {
        // Change the distribution to the cloud alternative
        selectedDistribution = alt.TargetDistribution;
        costSubTab = "onprem"; // Switch back to main tab
        selectedCloudAlt = "";

        // Re-calculate sizing with new distribution
        if (results != null)
        {
            // Trigger recalculation
            StateHasChanged();
        }
    }

    private bool IsSharedClusterMode() => IsSingleClusterMode() && singleClusterScope == "Shared";

    private EnvironmentType GetSingleClusterEnvironment() => singleClusterScope switch
    {
        "Dev" => EnvironmentType.Dev,
        "Test" => EnvironmentType.Test,
        "Stage" => EnvironmentType.Stage,
        "Prod" => EnvironmentType.Prod,
        "DR" => EnvironmentType.DR,
        _ => EnvironmentType.Prod // Default for "Shared" - will use all envs
    };

    private IEnumerable<EnvironmentType> GetSingleClusterEnvironments()
    {
        if (singleClusterScope == "Shared")
        {
            return new[] { EnvironmentType.Dev, EnvironmentType.Test, EnvironmentType.Stage, EnvironmentType.Prod };
        }
        return new[] { GetSingleClusterEnvironment() };
    }

    private void BackToConfiguration()
    {
        currentStep = 5;
    }

    private void BackToPricing()
    {
        // Go back to pricing step (varies by deployment/technology)
        // K8s: step 6, Mendix VMs: step 6, OutSystems VMs: step 5
        currentStep = GetPricingStep();
    }

    // Pricing step helpers
    private int GetTotalNodesForPricing()
    {
        // Estimate total nodes from app configuration
        var totalApps = 0;
        foreach (var env in enabledEnvironments)
        {
            if (envApps.TryGetValue(env, out var apps))
            {
                totalApps += apps.Small + apps.Medium + apps.Large + apps.XLarge;
            }
        }
        // Rough estimate: 1 node per 3 apps minimum
        return Math.Max(3, (int)Math.Ceiling(totalApps / 3.0));
    }

    private int GetTotalCoresForPricing()
    {
        // Estimate total cores based on app sizes
        var totalCores = 0;
        foreach (var env in enabledEnvironments)
        {
            if (envApps.TryGetValue(env, out var apps))
            {
                totalCores += apps.Small * 2 + apps.Medium * 4 + apps.Large * 8 + apps.XLarge * 16;
            }
        }
        return Math.Max(8, totalCores); // Minimum 8 cores
    }

    private int GetTotalRamForPricing()
    {
        // Estimate total RAM based on app sizes
        var totalRam = 0;
        foreach (var env in enabledEnvironments)
        {
            if (envApps.TryGetValue(env, out var apps))
            {
                totalRam += apps.Small * 4 + apps.Medium * 8 + apps.Large * 16 + apps.XLarge * 32;
            }
        }
        return Math.Max(16, totalRam); // Minimum 16 GB
    }

    private void HandlePricingConfigured(PricingStepResult result)
    {
        pricingResult = result;
        StateHasChanged();
    }

    private async Task HandleApplyAlternative(Distribution newDistribution)
    {
        // Change distribution only - keep technology, apps, and environment config
        selectedDistribution = newDistribution;

        // Recalculate results with the new distribution
        await CalculateK8s();

        // Navigate to results step to see the updated sizing
        currentStep = 7;
        StateHasChanged();
    }

    private void OpenSaveScenarioModal()
    {
        showSaveScenarioModal = true;
        StateHasChanged();
    }

    private void StartNewCalculation()
    {
        results = null;
        currentStep = 1;
        ResetConfiguration();
    }

    // Selection handlers with auto-advance and scroll - CASCADE RESET on step change
    private async Task SelectPlatformAsync(PlatformType platform)
    {
        selectedPlatform = platform;
        // CASCADE RESET: Reset all subsequent selections
        selectedDeployment = null;
        selectedTechnology = null;
        selectedDistribution = null;
        selectedClusterMode = ClusterMode.MultiCluster;
        nodeSpecs = new NodeSpecsConfig();
        results = null;
        currentStep = 2;
        StateHasChanged();
        await Task.Delay(100);
        await JSRuntime.InvokeVoidAsync("scrollToElement", "step2");
    }

    private async Task SelectDeploymentAsync(DeploymentModel deployment)
    {
        selectedDeployment = deployment;
        // CASCADE RESET: Reset all subsequent selections
        selectedTechnology = null;
        selectedDistribution = null;
        selectedClusterMode = ClusterMode.MultiCluster;
        nodeSpecs = new NodeSpecsConfig();
        results = null;
        currentStep = 3;
        StateHasChanged();
        await Task.Delay(100);
        await JSRuntime.InvokeVoidAsync("scrollToElement", "step3");
    }

    private async Task SelectTechnologyAsync(Technology technology)
    {
        selectedTechnology = technology;
        // CASCADE RESET: Reset distribution and node specs
        selectedDistribution = null;
        selectedClusterMode = ClusterMode.MultiCluster;
        nodeSpecs = new NodeSpecsConfig();
        results = null;
        vmResults = null;

        // Adjust default app counts based on platform type
        var techConfig = TechnologyService.GetConfig(technology);
        if (techConfig.PlatformType == PlatformType.LowCode)
        {
            // Low-code platforms typically have fewer, larger apps
            // Default to 10 medium apps instead of 70
            foreach (var env in enabledEnvironments)
            {
                envApps[env] = new AppConfig { Medium = 10 };
            }
        }
        else
        {
            // Native platforms: use standard defaults
            foreach (var env in enabledEnvironments)
            {
                envApps[env] = new AppConfig { Medium = 70 };
            }
        }

        // Reset VM configs to use new technology-specific roles
        OnTechnologyChanged();

        if (selectedDeployment == DeploymentModel.Kubernetes)
        {
            currentStep = 4;
            StateHasChanged();
            await Task.Delay(100);
            await JSRuntime.InvokeVoidAsync("scrollToElement", "step4");
        }
        else
        {
            // VM mode
            if (technology == Technology.Mendix)
            {
                // Mendix VMs need deployment type selection first (step 4)
                currentStep = 4;
                StateHasChanged();
                await Task.Delay(100);
                await JSRuntime.InvokeVoidAsync("scrollToElement", "step4");
            }
            else
            {
                // Non-Mendix VMs go directly to configuration
                configTab = "roles";
                currentStep = GetConfigStep();
                StateHasChanged();
                await Task.Delay(100);
                await JSRuntime.InvokeVoidAsync("scrollToElement", "step5");
            }
        }
    }

    private async Task SelectDistributionAsync(Distribution distribution)
    {
        selectedDistribution = distribution;
        // Reset cluster mode and results when distribution changes
        selectedClusterMode = ClusterMode.MultiCluster;
        results = null;

        // Load node specs from settings defaults for this distribution
        LoadNodeSpecsFromSettings();

        currentStep = GetConfigStep();
        StateHasChanged();
        await Task.Delay(100);
        await JSRuntime.InvokeVoidAsync("scrollToElement", "step5");
    }

    // ==================== Mendix Deployment Selection ====================

    private void SelectMendixCategory(MendixDeploymentCategory category)
    {
        mendixDeploymentCategory = category;
        // Reset sub-selections
        mendixPrivateCloudProvider = null;
        mendixOtherDeployment = null;
        mendixCloudType = MendixCloudType.SaaS;
    }

    private async Task SelectMendixCloudType(MendixCloudType cloudType)
    {
        mendixCloudType = cloudType;
        // Map Mendix Cloud to a suitable distribution for sizing
        // Use a cloud-managed K8s for the sizing calculation
        selectedDistribution = Distribution.EKS; // Default to EKS for cloud
        LoadNodeSpecsFromSettings();
        currentStep = GetConfigStep();
        StateHasChanged();
        await Task.Delay(100);
        await JSRuntime.InvokeVoidAsync("scrollToElement", "step5");
    }

    private async Task SelectMendixPrivateCloudProvider(MendixPrivateCloudProvider provider)
    {
        mendixPrivateCloudProvider = provider;
        mendixOtherDeployment = null;

        // Map Mendix provider to distribution for sizing
        selectedDistribution = provider switch
        {
            MendixPrivateCloudProvider.Azure => Distribution.AKS,
            MendixPrivateCloudProvider.EKS => Distribution.EKS,
            MendixPrivateCloudProvider.AKS => Distribution.AKS,
            MendixPrivateCloudProvider.GKE => Distribution.GKE,
            MendixPrivateCloudProvider.OpenShift => Distribution.OpenShift,
            MendixPrivateCloudProvider.Rancher => Distribution.Rancher,
            MendixPrivateCloudProvider.K3s => Distribution.K3s,
            MendixPrivateCloudProvider.GenericK8s => Distribution.Kubernetes,
            MendixPrivateCloudProvider.Docker => Distribution.Kubernetes, // Use generic K8s for sizing
            _ => Distribution.Kubernetes
        };

        LoadNodeSpecsFromSettings();
        currentStep = GetConfigStep();
        StateHasChanged();
        await Task.Delay(100);
        await JSRuntime.InvokeVoidAsync("scrollToElement", "step5");
    }

    private async Task SelectMendixOtherDeployment(MendixOtherDeployment deployment)
    {
        mendixOtherDeployment = deployment;
        mendixPrivateCloudProvider = null;

        // For VM-based deployments, we'll still use K8s sizing as approximation
        selectedDistribution = Distribution.Kubernetes;
        LoadNodeSpecsFromSettings();
        currentStep = GetConfigStep();
        StateHasChanged();
        await Task.Delay(100);
        await JSRuntime.InvokeVoidAsync("scrollToElement", "step5");
    }

    // Mendix VM deployment selection (for VMs path)
    private async Task SelectMendixVMDeployment(MendixOtherDeployment deployment)
    {
        mendixOtherDeployment = deployment;
        mendixDeploymentCategory = MendixDeploymentCategory.Other;
        mendixPrivateCloudProvider = null;

        // Go to VM configuration step
        configTab = "roles";
        currentStep = 5;
        StateHasChanged();
        await Task.Delay(100);
        await JSRuntime.InvokeVoidAsync("scrollToElement", "step5");
    }

    private string GetMendixVMDeploymentName()
    {
        return mendixOtherDeployment switch
        {
            MendixOtherDeployment.Server => "Mendix on Server (VMs/Docker)",
            MendixOtherDeployment.StackIT => "Mendix on StackIT",
            MendixOtherDeployment.SapBtp => "Mendix on SAP BTP",
            _ => "Mendix Deployment"
        };
    }

    private (decimal perApp, decimal unlimited) GetMendixVMDeploymentPricing()
    {
        var mendixPricing = PricingSettingsService.GetMendixPricingSettings();
        return mendixOtherDeployment switch
        {
            MendixOtherDeployment.Server => (mendixPricing.ServerPerAppPricePerYear, mendixPricing.ServerUnlimitedAppsPricePerYear),
            MendixOtherDeployment.StackIT => (mendixPricing.StackITPerAppPricePerYear, mendixPricing.StackITUnlimitedAppsPricePerYear),
            MendixOtherDeployment.SapBtp => (mendixPricing.SapBtpPerAppPricePerYear, mendixPricing.SapBtpUnlimitedAppsPricePerYear),
            _ => (mendixPricing.ServerPerAppPricePerYear, mendixPricing.ServerUnlimitedAppsPricePerYear)
        };
    }

    private void ShowMendixDeploymentInfo()
    {
        infoModalTitle = "Mendix Deployment Options";
        infoModalContent = @"
            <h3>Mendix Cloud</h3>
            <p><strong>SaaS:</strong> Multi-tenant managed service. Pay per resource pack based on app requirements. Best for most use cases.</p>
            <p><strong>Dedicated:</strong> Single-tenant infrastructure for enterprise customers with strict compliance requirements.</p>

            <h3>Private Cloud (Officially Supported)</h3>
            <p>Deploy Mendix on your own Kubernetes infrastructure with official support:</p>
            <ul>
                <li><strong>Mendix on Azure:</strong> Managed Mendix deployment on Microsoft Azure</li>
                <li><strong>EKS, AKS, GKE:</strong> Self-managed Mendix for Private Cloud on major cloud Kubernetes services</li>
                <li><strong>OpenShift:</strong> Deploy on Red Hat OpenShift with official support</li>
            </ul>

            <h3>Other Kubernetes (Manual Setup)</h3>
            <p>Unsupported Kubernetes distributions requiring manual Mendix operator setup:</p>
            <ul>
                <li><strong>Rancher:</strong> SUSE Rancher managed Kubernetes</li>
                <li><strong>K3s:</strong> Lightweight Kubernetes</li>
                <li><strong>Generic K8s:</strong> Any other Kubernetes distribution</li>
            </ul>

            <h3>VM Deployments</h3>
            <p>For non-Kubernetes deployments, select <strong>VMs</strong> in Step 2:</p>
            <ul>
                <li><strong>Server (VMs/Docker):</strong> Traditional deployment on virtual machines or containers</li>
                <li><strong>StackIT:</strong> Schwarz IT cloud platform</li>
                <li><strong>SAP BTP:</strong> SAP Business Technology Platform</li>
            </ul>
        ";
        showInfoModal = true;
    }

    private void SetDistroFilter(string filter)
    {
        distributionFilter = filter;
        if (filter == "cloud" && string.IsNullOrEmpty(cloudCategory))
        {
            cloudCategory = "major"; // Default to Major category
        }
    }

    private void SelectClusterMode(ClusterMode mode)
    {
        selectedClusterMode = mode;
        results = null;
    }

    private void GoBack()
    {
        if (currentStep > 1)
        {
            currentStep--;
            results = null;
        }
    }

    // Wizard navigation
    private void GoToStep(int step)
    {
        // Only allow going to completed steps (going back)
        if (step < currentStep)
        {
            currentStep = step;
            results = null;
        }
    }

    private void PreviousStep()
    {
        if (currentStep > 1)
        {
            currentStep--;
            results = null;
        }
    }

    private async Task NextStep()
    {
        if (!CanProceed()) return;

        if (IsLastStep())
        {
            // Go to results step (varies by deployment/technology)
            // K8s: step 7, Mendix VMs: step 7, OutSystems VMs: step 6
            currentStep = GetResultsStep();
        }
        else
        {
            // Calculate at appropriate steps
            if (selectedDeployment == DeploymentModel.Kubernetes && currentStep == 5)
            {
                // K8s: Calculate before going to pricing step
                await CalculateK8s();
            }
            else if (selectedDeployment == DeploymentModel.VMs && currentStep == GetConfigStep())
            {
                // VMs: Calculate when leaving config step (step 4 for non-Mendix, step 5 for Mendix)
                await CalculateVM();
            }
            currentStep++;
        }
    }

    private bool CanProceed()
    {
        // Steps 1-3 are the same for all flows
        if (currentStep == 1) return selectedPlatform != null;
        if (currentStep == 2) return selectedDeployment != null;
        if (currentStep == 3) return selectedTechnology != null;

        // Pricing step always allows proceed
        if (currentStep == GetPricingStep()) return true;

        // Config step requires roles/apps configured
        if (currentStep == GetConfigStep())
        {
            if (selectedDeployment == DeploymentModel.VMs)
            {
                return HasVMRolesConfigured();
            }
            // K8s: need cluster mode and apps configured
            return selectedClusterMode != null && HasAppsConfigured();
        }

        // Step 4 for specific flows
        if (currentStep == 4)
        {
            // K8s step 4: need distribution selected
            if (selectedDeployment == DeploymentModel.Kubernetes)
            {
                return selectedDistribution != null;
            }
            // Mendix VM step 4: need deployment type selected
            if (selectedDeployment == DeploymentModel.VMs && selectedTechnology == Technology.Mendix)
            {
                return mendixOtherDeployment != null;
            }
        }

        return false;
    }

    private bool HasVMRolesConfigured()
    {
        return enabledEnvironments.Any(env =>
            vmEnvironmentConfigs.TryGetValue(env, out var config) &&
            config.Roles.Count > 0);
    }

    private bool IsLastStep()
    {
        // Last configurable step (before results) is the pricing step
        // K8s: step 6, Mendix VMs: step 6, OutSystems VMs: step 5
        return currentStep == GetPricingStep();
    }

    private bool HasAppsConfigured()
    {
        return enabledEnvironments.Any(env =>
            envApps.TryGetValue(env, out var config) &&
            (config.Small > 0 || config.Medium > 0 || config.Large > 0 || config.XLarge > 0));
    }

    private void ResetWizard()
    {
        currentStep = 1;
        selectedPlatform = null;
        selectedDeployment = null;
        selectedTechnology = null;
        selectedDistribution = null;
        selectedClusterMode = ClusterMode.MultiCluster;
        results = null;
        vmResults = null;
        vmEnvironmentConfigs.Clear();
        ResetEnvApps();
    }

    private void ResetConfiguration()
    {
        ResetEnvApps();
        results = null;
        vmResults = null;
    }

    private void ResetEnvApps()
    {
        foreach (var env in envApps.Keys.ToList())
        {
            envApps[env] = new AppConfig { Medium = 70 };
        }
        enabledEnvironments = new HashSet<EnvironmentType>
        {
            EnvironmentType.Dev, EnvironmentType.Test, EnvironmentType.Stage, EnvironmentType.Prod
        };
    }

    // Load all configuration from settings defaults when distribution is selected
    private void LoadConfigFromSettings()
    {
        // Node specs
        nodeSpecs = new NodeSpecsConfig
        {
            ProdMasterCpu = settings.ProdMasterCpu,
            ProdMasterRam = settings.ProdMasterRam,
            ProdMasterDisk = settings.ProdMasterDisk,
            NonProdMasterCpu = settings.NonProdMasterCpu,
            NonProdMasterRam = settings.NonProdMasterRam,
            NonProdMasterDisk = settings.NonProdMasterDisk,
            ProdInfraCpu = settings.ProdInfraCpu,
            ProdInfraRam = settings.ProdInfraRam,
            ProdInfraDisk = settings.ProdInfraDisk,
            NonProdInfraCpu = settings.NonProdInfraCpu,
            NonProdInfraRam = settings.NonProdInfraRam,
            NonProdInfraDisk = settings.NonProdInfraDisk,
            ProdWorkerCpu = settings.ProdWorkerCpu,
            ProdWorkerRam = settings.ProdWorkerRam,
            ProdWorkerDisk = settings.ProdWorkerDisk,
            NonProdWorkerCpu = settings.NonProdWorkerCpu,
            NonProdWorkerRam = settings.NonProdWorkerRam,
            NonProdWorkerDisk = settings.NonProdWorkerDisk
        };

        // Overcommit ratios
        prodCpuOvercommit = settings.ProdCpuOvercommit;
        prodMemoryOvercommit = settings.ProdMemoryOvercommit;
        nonProdCpuOvercommit = settings.NonProdCpuOvercommit;
        nonProdMemoryOvercommit = settings.NonProdMemoryOvercommit;

        // Headroom per environment
        headroom[EnvironmentType.Dev] = settings.HeadroomDev;
        headroom[EnvironmentType.Test] = settings.HeadroomTest;
        headroom[EnvironmentType.Stage] = settings.HeadroomStage;
        headroom[EnvironmentType.Prod] = settings.HeadroomProd;
        headroom[EnvironmentType.DR] = settings.HeadroomDR;

        // Replicas per environment
        replicas[EnvironmentType.Dev] = settings.ReplicasDev;
        replicas[EnvironmentType.Test] = settings.ReplicasTest;
        replicas[EnvironmentType.Stage] = settings.ReplicasStage;
        replicas[EnvironmentType.Prod] = settings.ReplicasProd;
        replicas[EnvironmentType.DR] = settings.ReplicasDR;

        // Mendix operator replicas
        mendixOperatorReplicas = settings.MendixOperatorReplicas;
    }

    // Legacy alias for compatibility
    private void LoadNodeSpecsFromSettings() => LoadConfigFromSettings();

    // Environment helpers
    private bool IsEnvironmentEnabled(EnvironmentType env) => enabledEnvironments.Contains(env);

    private bool IsProdEnvironment(EnvironmentType env) => env == EnvironmentType.Prod;

    // Returns the list of environments for VM deployment sidebar
    // Includes LifeTime only when OutSystems is selected
    private IEnumerable<EnvironmentType> GetVMEnvironmentList()
    {
        var baseEnvs = new[] { EnvironmentType.Dev, EnvironmentType.Test, EnvironmentType.Stage, EnvironmentType.Prod };

        // Add LifeTime for OutSystems
        if (selectedTechnology == Technology.OutSystems)
        {
            return baseEnvs.Append(EnvironmentType.LifeTime);
        }

        return baseEnvs;
    }

    private IEnumerable<EnvironmentType> GetVisibleEnvironments()
    {
        if (selectedClusterMode == ClusterMode.PerEnvironment)
        {
            return new[] { selectedSingleEnvironment };
        }
        return new[] { EnvironmentType.Dev, EnvironmentType.Test, EnvironmentType.Stage, EnvironmentType.Prod };
    }

    private string GetTierSpec(AppTier tier)
    {
        if (selectedTechnology == null) return "";
        var techConfig = TechnologyService.GetConfig(selectedTechnology.Value);
        if (techConfig.Tiers.TryGetValue(tier, out var specs))
        {
            return $"{specs.Cpu} CPU, {specs.Ram} GB RAM";
        }
        return "";
    }

    // Unified workload methods - use Prod as the reference environment for single cluster
    private int GetTotalApps(AppTier tier)
    {
        // For unified input, we use Prod environment as the base
        return GetEnvApps(EnvironmentType.Prod, tier);
    }

    private void SetTotalApps(AppTier tier, int count)
    {
        // Set the same count for all enabled environments
        foreach (var env in enabledEnvironments)
        {
            SetEnvApps(env, tier, count);
        }
    }

    private int GetTotalAppCount()
    {
        return GetTotalApps(AppTier.Small) + GetTotalApps(AppTier.Medium) +
               GetTotalApps(AppTier.Large) + GetTotalApps(AppTier.XLarge);
    }

    private string GetEstimatedCpu()
    {
        if (selectedTechnology == null) return "0";
        var techConfig = TechnologyService.GetConfig(selectedTechnology.Value);
        double total = 0;
        foreach (var tier in new[] { AppTier.Small, AppTier.Medium, AppTier.Large, AppTier.XLarge })
        {
            if (techConfig.Tiers.TryGetValue(tier, out var specs))
            {
                total += GetTotalApps(tier) * specs.Cpu;
            }
        }
        return total.ToString("0.#");
    }

    private string GetEstimatedMemory()
    {
        if (selectedTechnology == null) return "0";
        var techConfig = TechnologyService.GetConfig(selectedTechnology.Value);
        double total = 0;
        foreach (var tier in new[] { AppTier.Small, AppTier.Medium, AppTier.Large, AppTier.XLarge })
        {
            if (techConfig.Tiers.TryGetValue(tier, out var specs))
            {
                total += GetTotalApps(tier) * specs.Ram;
            }
        }
        return total.ToString("0.#");
    }

    private void ToggleEnvironment(EnvironmentType env, bool enabled)
    {
        if (env == EnvironmentType.Prod) return;
        if (enabled) enabledEnvironments.Add(env);
        else enabledEnvironments.Remove(env);
    }

    private int GetEnvApps(EnvironmentType env, AppTier tier)
    {
        if (!envApps.TryGetValue(env, out var config)) return 0;
        return tier switch
        {
            AppTier.Small => config.Small,
            AppTier.Medium => config.Medium,
            AppTier.Large => config.Large,
            AppTier.XLarge => config.XLarge,
            _ => 0
        };
    }

    private void SetEnvApps(EnvironmentType env, AppTier tier, int count)
    {
        if (!envApps.ContainsKey(env)) envApps[env] = new AppConfig();
        switch (tier)
        {
            case AppTier.Small: envApps[env].Small = count; break;
            case AppTier.Medium: envApps[env].Medium = count; break;
            case AppTier.Large: envApps[env].Large = count; break;
            case AppTier.XLarge: envApps[env].XLarge = count; break;
        }
    }

    private static int ParseInt(object? value) => int.TryParse(value?.ToString(), out var result) ? result : 0;

    // Wrapper methods for per-environment app UI
    private int GetEnvAppCount(EnvironmentType env, AppTier tier) => GetEnvApps(env, tier);

    private void SetEnvAppCount(EnvironmentType env, AppTier tier, int count) => SetEnvApps(env, tier, count);

    private int GetEnvTotalApps(EnvironmentType env)
    {
        if (!envApps.TryGetValue(env, out var config)) return 0;
        return config.Small + config.Medium + config.Large + config.XLarge;
    }
    private static double ParseDouble(object? value) => double.TryParse(value?.ToString(), out var result) ? result : 0;

    // Settings
    private void OpenSettings() => showSettings = true;
    private void CloseSettings() => showSettings = false;

    private async Task SaveAndCloseSettings()
    {
        await SaveSettingsToStorage();
        showSettings = false;
    }

    private void ResetSettings()
    {
        settings = new UICalculatorSettings();
        mendixPricingSettings = new MendixPricingSettings();
    }

    private async Task SaveSettingsToStorage()
    {
        var json = System.Text.Json.JsonSerializer.Serialize(settings);
        await JSRuntime.InvokeVoidAsync("localStorage.setItem", "calculatorSettings", json);

        // Save Mendix pricing settings through the pricing service
        await PricingSettingsService.UpdateMendixPricingSettingsAsync(mendixPricingSettings);
    }

    private async Task LoadSettingsFromStorage()
    {
        try
        {
            var json = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "calculatorSettings");
            if (!string.IsNullOrEmpty(json))
            {
                settings = System.Text.Json.JsonSerializer.Deserialize<UICalculatorSettings>(json) ?? new();
            }

            // Load Mendix pricing settings from the pricing service
            mendixPricingSettings = PricingSettingsService.GetMendixPricingSettings();
        }
        catch { }
    }

    // Tier settings helpers
    private double GetTierCpu(string tech, string tier)
    {
        return (tech, tier) switch
        {
            ("dotnet", "Small") => settings.DotNetSmallCpu,
            ("dotnet", "Medium") => settings.DotNetMediumCpu,
            ("dotnet", "Large") => settings.DotNetLargeCpu,
            ("dotnet", "XLarge") => settings.DotNetXLargeCpu,
            ("java", "Small") => settings.JavaSmallCpu,
            ("java", "Medium") => settings.JavaMediumCpu,
            ("java", "Large") => settings.JavaLargeCpu,
            ("java", "XLarge") => settings.JavaXLargeCpu,
            ("nodejs", "Small") => settings.NodeJsSmallCpu,
            ("nodejs", "Medium") => settings.NodeJsMediumCpu,
            ("nodejs", "Large") => settings.NodeJsLargeCpu,
            ("nodejs", "XLarge") => settings.NodeJsXLargeCpu,
            ("python", "Small") => settings.PythonSmallCpu,
            ("python", "Medium") => settings.PythonMediumCpu,
            ("python", "Large") => settings.PythonLargeCpu,
            ("python", "XLarge") => settings.PythonXLargeCpu,
            ("go", "Small") => settings.GoSmallCpu,
            ("go", "Medium") => settings.GoMediumCpu,
            ("go", "Large") => settings.GoLargeCpu,
            ("go", "XLarge") => settings.GoXLargeCpu,
            ("mendix", "Small") => settings.MendixSmallCpu,
            ("mendix", "Medium") => settings.MendixMediumCpu,
            ("mendix", "Large") => settings.MendixLargeCpu,
            ("mendix", "XLarge") => settings.MendixXLargeCpu,
            _ => 0.5
        };
    }

    private double GetTierRam(string tech, string tier)
    {
        return (tech, tier) switch
        {
            ("dotnet", "Small") => settings.DotNetSmallRam,
            ("dotnet", "Medium") => settings.DotNetMediumRam,
            ("dotnet", "Large") => settings.DotNetLargeRam,
            ("dotnet", "XLarge") => settings.DotNetXLargeRam,
            ("java", "Small") => settings.JavaSmallRam,
            ("java", "Medium") => settings.JavaMediumRam,
            ("java", "Large") => settings.JavaLargeRam,
            ("java", "XLarge") => settings.JavaXLargeRam,
            ("nodejs", "Small") => settings.NodeJsSmallRam,
            ("nodejs", "Medium") => settings.NodeJsMediumRam,
            ("nodejs", "Large") => settings.NodeJsLargeRam,
            ("nodejs", "XLarge") => settings.NodeJsXLargeRam,
            ("python", "Small") => settings.PythonSmallRam,
            ("python", "Medium") => settings.PythonMediumRam,
            ("python", "Large") => settings.PythonLargeRam,
            ("python", "XLarge") => settings.PythonXLargeRam,
            ("go", "Small") => settings.GoSmallRam,
            ("go", "Medium") => settings.GoMediumRam,
            ("go", "Large") => settings.GoLargeRam,
            ("go", "XLarge") => settings.GoXLargeRam,
            ("mendix", "Small") => settings.MendixSmallRam,
            ("mendix", "Medium") => settings.MendixMediumRam,
            ("mendix", "Large") => settings.MendixLargeRam,
            ("mendix", "XLarge") => settings.MendixXLargeRam,
            _ => 1
        };
    }

    private void SetTierCpu(string tech, string tier, double value)
    {
        switch ((tech, tier))
        {
            case ("dotnet", "Small"): settings.DotNetSmallCpu = value; break;
            case ("dotnet", "Medium"): settings.DotNetMediumCpu = value; break;
            case ("dotnet", "Large"): settings.DotNetLargeCpu = value; break;
            case ("dotnet", "XLarge"): settings.DotNetXLargeCpu = value; break;
            case ("java", "Small"): settings.JavaSmallCpu = value; break;
            case ("java", "Medium"): settings.JavaMediumCpu = value; break;
            case ("java", "Large"): settings.JavaLargeCpu = value; break;
            case ("java", "XLarge"): settings.JavaXLargeCpu = value; break;
            case ("nodejs", "Small"): settings.NodeJsSmallCpu = value; break;
            case ("nodejs", "Medium"): settings.NodeJsMediumCpu = value; break;
            case ("nodejs", "Large"): settings.NodeJsLargeCpu = value; break;
            case ("nodejs", "XLarge"): settings.NodeJsXLargeCpu = value; break;
            case ("python", "Small"): settings.PythonSmallCpu = value; break;
            case ("python", "Medium"): settings.PythonMediumCpu = value; break;
            case ("python", "Large"): settings.PythonLargeCpu = value; break;
            case ("python", "XLarge"): settings.PythonXLargeCpu = value; break;
            case ("go", "Small"): settings.GoSmallCpu = value; break;
            case ("go", "Medium"): settings.GoMediumCpu = value; break;
            case ("go", "Large"): settings.GoLargeCpu = value; break;
            case ("go", "XLarge"): settings.GoXLargeCpu = value; break;
            case ("mendix", "Small"): settings.MendixSmallCpu = value; break;
            case ("mendix", "Medium"): settings.MendixMediumCpu = value; break;
            case ("mendix", "Large"): settings.MendixLargeCpu = value; break;
            case ("mendix", "XLarge"): settings.MendixXLargeCpu = value; break;
        }
    }

    private void SetTierRam(string tech, string tier, double value)
    {
        switch ((tech, tier))
        {
            case ("dotnet", "Small"): settings.DotNetSmallRam = value; break;
            case ("dotnet", "Medium"): settings.DotNetMediumRam = value; break;
            case ("dotnet", "Large"): settings.DotNetLargeRam = value; break;
            case ("dotnet", "XLarge"): settings.DotNetXLargeRam = value; break;
            case ("java", "Small"): settings.JavaSmallRam = value; break;
            case ("java", "Medium"): settings.JavaMediumRam = value; break;
            case ("java", "Large"): settings.JavaLargeRam = value; break;
            case ("java", "XLarge"): settings.JavaXLargeRam = value; break;
            case ("nodejs", "Small"): settings.NodeJsSmallRam = value; break;
            case ("nodejs", "Medium"): settings.NodeJsMediumRam = value; break;
            case ("nodejs", "Large"): settings.NodeJsLargeRam = value; break;
            case ("nodejs", "XLarge"): settings.NodeJsXLargeRam = value; break;
            case ("python", "Small"): settings.PythonSmallRam = value; break;
            case ("python", "Medium"): settings.PythonMediumRam = value; break;
            case ("python", "Large"): settings.PythonLargeRam = value; break;
            case ("python", "XLarge"): settings.PythonXLargeRam = value; break;
            case ("go", "Small"): settings.GoSmallRam = value; break;
            case ("go", "Medium"): settings.GoMediumRam = value; break;
            case ("go", "Large"): settings.GoLargeRam = value; break;
            case ("go", "XLarge"): settings.GoXLargeRam = value; break;
            case ("mendix", "Small"): settings.MendixSmallRam = value; break;
            case ("mendix", "Medium"): settings.MendixMediumRam = value; break;
            case ("mendix", "Large"): settings.MendixLargeRam = value; break;
            case ("mendix", "XLarge"): settings.MendixXLargeRam = value; break;
        }
    }

    // Calculate
    private async Task CalculateK8s()
    {
        if (selectedDistribution == null || selectedTechnology == null || selectedClusterMode == null) return;

        // Determine the effective cluster mode based on singleClusterScope
        var effectiveClusterMode = selectedClusterMode.Value;
        var effectiveEnabledEnvs = enabledEnvironments;

        // For Single Cluster mode, adjust based on scope
        if (IsSingleClusterMode())
        {
            if (singleClusterScope == "Shared")
            {
                // Shared cluster: use SharedCluster mode with all enabled environments
                effectiveClusterMode = ClusterMode.SharedCluster;
            }
            else
            {
                // Single environment: use PerEnvironment mode with only that environment enabled
                effectiveClusterMode = ClusterMode.PerEnvironment;
                var singleEnv = GetSingleClusterEnvironment();
                effectiveEnabledEnvs = new HashSet<EnvironmentType> { singleEnv };
            }
        }

        // Use values from main page (NOT from settings - settings are only for defaults)
        var input = new K8sSizingInput
        {
            Distribution = selectedDistribution.Value,
            Technology = selectedTechnology.Value,
            ClusterMode = effectiveClusterMode,
            // For PerEnvironment mode, set the selected environment
            SelectedEnvironment = singleClusterScope != "Shared" ? GetSingleClusterEnvironment() : EnvironmentType.Prod,
            // Pass per-environment app counts from main page
            EnvironmentApps = new Dictionary<EnvironmentType, AppConfig>(envApps),
            // Also set Prod/NonProd as fallback
            ProdApps = envApps.GetValueOrDefault(EnvironmentType.Prod, new AppConfig { Medium = 70 }),
            NonProdApps = envApps.GetValueOrDefault(EnvironmentType.Dev, new AppConfig { Medium = 70 }),
            EnabledEnvironments = effectiveEnabledEnvs,
            EnableHeadroom = true,
            // Use headroom values from main page (defaults match JS: 33/33/0/37.5/37.5)
            Headroom = new HeadroomSettings
            {
                Dev = headroom.GetValueOrDefault(EnvironmentType.Dev, 33),
                Test = headroom.GetValueOrDefault(EnvironmentType.Test, 33),
                Stage = headroom.GetValueOrDefault(EnvironmentType.Stage, 0),
                Prod = headroom.GetValueOrDefault(EnvironmentType.Prod, 37.5),
                DR = headroom.GetValueOrDefault(EnvironmentType.DR, 37.5)
            },
            // Use replica values from main page
            Replicas = new ReplicaSettings
            {
                NonProd = replicas.GetValueOrDefault(EnvironmentType.Dev, 1),
                Stage = replicas.GetValueOrDefault(EnvironmentType.Stage, 2),
                Prod = replicas.GetValueOrDefault(EnvironmentType.Prod, 3)
            },
            // Use overcommit values from main page
            ProdOvercommit = new OvercommitSettings
            {
                Cpu = prodCpuOvercommit,
                Memory = prodMemoryOvercommit
            },
            NonProdOvercommit = new OvercommitSettings
            {
                Cpu = nonProdCpuOvercommit,
                Memory = nonProdMemoryOvercommit
            },
            // HA/DR configuration from the HA & DR tab
            HADRConfig = k8sHADRConfig
        };

        // If custom node specs are provided via main page, use them
        if (selectedDistribution != null)
        {
            var distroConfig = DistributionService.GetConfig(selectedDistribution.Value);

            // For multi-cluster mode, pass per-environment specs
            Dictionary<EnvironmentType, NodeSpecs>? perEnvControlPlane = null;
            Dictionary<EnvironmentType, NodeSpecs>? perEnvWorker = null;
            Dictionary<EnvironmentType, NodeSpecs>? perEnvInfra = null;

            if (selectedClusterMode == ClusterMode.MultiCluster)
            {
                perEnvControlPlane = new Dictionary<EnvironmentType, NodeSpecs>
                {
                    [EnvironmentType.Dev] = nodeSpecs.GetControlPlaneSpecs(EnvironmentType.Dev),
                    [EnvironmentType.Test] = nodeSpecs.GetControlPlaneSpecs(EnvironmentType.Test),
                    [EnvironmentType.Stage] = nodeSpecs.GetControlPlaneSpecs(EnvironmentType.Stage),
                    [EnvironmentType.Prod] = nodeSpecs.GetControlPlaneSpecs(EnvironmentType.Prod),
                    [EnvironmentType.DR] = nodeSpecs.GetControlPlaneSpecs(EnvironmentType.DR)
                };
                perEnvWorker = new Dictionary<EnvironmentType, NodeSpecs>
                {
                    [EnvironmentType.Dev] = nodeSpecs.GetWorkerSpecs(EnvironmentType.Dev),
                    [EnvironmentType.Test] = nodeSpecs.GetWorkerSpecs(EnvironmentType.Test),
                    [EnvironmentType.Stage] = nodeSpecs.GetWorkerSpecs(EnvironmentType.Stage),
                    [EnvironmentType.Prod] = nodeSpecs.GetWorkerSpecs(EnvironmentType.Prod),
                    [EnvironmentType.DR] = nodeSpecs.GetWorkerSpecs(EnvironmentType.DR)
                };
                perEnvInfra = new Dictionary<EnvironmentType, NodeSpecs>
                {
                    [EnvironmentType.Dev] = nodeSpecs.GetInfraSpecs(EnvironmentType.Dev),
                    [EnvironmentType.Test] = nodeSpecs.GetInfraSpecs(EnvironmentType.Test),
                    [EnvironmentType.Stage] = nodeSpecs.GetInfraSpecs(EnvironmentType.Stage),
                    [EnvironmentType.Prod] = nodeSpecs.GetInfraSpecs(EnvironmentType.Prod),
                    [EnvironmentType.DR] = nodeSpecs.GetInfraSpecs(EnvironmentType.DR)
                };
            }

            input.CustomNodeSpecs = new DistributionConfig
            {
                Distribution = selectedDistribution.Value,
                Name = distroConfig.Name,
                Vendor = distroConfig.Vendor,
                HasManagedControlPlane = distroConfig.HasManagedControlPlane,
                HasInfraNodes = distroConfig.HasInfraNodes,
                ProdControlPlane = new NodeSpecs(nodeSpecs.ProdMasterCpu, nodeSpecs.ProdMasterRam, nodeSpecs.ProdMasterDisk),
                NonProdControlPlane = new NodeSpecs(nodeSpecs.NonProdMasterCpu, nodeSpecs.NonProdMasterRam, nodeSpecs.NonProdMasterDisk),
                ProdWorker = new NodeSpecs(nodeSpecs.ProdWorkerCpu, nodeSpecs.ProdWorkerRam, nodeSpecs.ProdWorkerDisk),
                NonProdWorker = new NodeSpecs(nodeSpecs.NonProdWorkerCpu, nodeSpecs.NonProdWorkerRam, nodeSpecs.NonProdWorkerDisk),
                ProdInfra = new NodeSpecs(nodeSpecs.ProdInfraCpu, nodeSpecs.ProdInfraRam, nodeSpecs.ProdInfraDisk),
                NonProdInfra = new NodeSpecs(nodeSpecs.NonProdInfraCpu, nodeSpecs.NonProdInfraRam, nodeSpecs.NonProdInfraDisk),
                // Per-environment specs for multi-cluster mode
                PerEnvControlPlane = perEnvControlPlane,
                PerEnvWorker = perEnvWorker,
                PerEnvInfra = perEnvInfra
            };
        }

        results = K8sSizingService.Calculate(input);

        // Generate validation warnings and recommendations
        validationWarnings = ValidationService.Analyze(results, input);

        // Reset cost estimate and auto-calculate default costs
        k8sCostEstimate = null;
        k8sResultsTab = "sizing";
        StateHasChanged();

        // Auto-calculate costs in the background
        _ = AutoCalculateK8sCost();

        await Task.Delay(100);
        await JSRuntime.InvokeVoidAsync("scrollToElement", "results");
    }

    // Export functions
    private async Task ExportCsv()
    {
        if (results == null) return;
        var csv = ExportService.ExportToCsv(results);
        await JSRuntime.InvokeVoidAsync("downloadFile", $"sizing-{DateTime.Now:yyyyMMdd-HHmmss}.csv", csv, "text/csv");
    }

    private async Task ExportJson()
    {
        if (results == null) return;
        var json = ExportService.ExportToJson(results);
        await JSRuntime.InvokeVoidAsync("downloadFile", $"sizing-{DateTime.Now:yyyyMMdd-HHmmss}.json", json, "application/json");
    }

    private async Task ExportExcel()
    {
        if (results == null) return;
        var excel = ExportService.ExportToExcel(results);
        var base64 = Convert.ToBase64String(excel);
        await JSRuntime.InvokeVoidAsync("downloadFileBase64", $"sizing-{DateTime.Now:yyyyMMdd-HHmmss}.xlsx", base64, "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");
    }

    private async Task ExportHtml()
    {
        if (results == null) return;
        var html = ExportService.ExportToHtmlDiagram(results);
        await JSRuntime.InvokeVoidAsync("openInNewWindow", html, "Infrastructure Diagram");
    }

    private async Task ExportVMJson()
    {
        if (vmResults == null) return;
        var json = System.Text.Json.JsonSerializer.Serialize(vmResults, new System.Text.Json.JsonSerializerOptions
        {
            WriteIndented = true,
            PropertyNamingPolicy = System.Text.Json.JsonNamingPolicy.CamelCase
        });
        await JSRuntime.InvokeVoidAsync("downloadFile", $"vm-sizing-{DateTime.Now:yyyyMMdd-HHmmss}.json", json, "application/json");
    }

    private async Task ExportPdf()
    {
        if (results == null) return;
        var pdf = ExportService.ExportToPdf(results);
        var base64 = Convert.ToBase64String(pdf);
        await JSRuntime.InvokeVoidAsync("downloadFileBase64", $"sizing-{DateTime.Now:yyyyMMdd-HHmmss}.pdf", base64, "application/pdf");
    }

    private async Task ExportVMPdf()
    {
        if (vmResults == null) return;
        var pdf = ExportService.ExportToPdf(vmResults);
        var base64 = Convert.ToBase64String(pdf);
        await JSRuntime.InvokeVoidAsync("downloadFileBase64", $"vm-sizing-{DateTime.Now:yyyyMMdd-HHmmss}.pdf", base64, "application/pdf");
    }

    // Share functionality
    private async Task ShareConfiguration()
    {
        if (results == null) return;
        try
        {
            var input = BuildK8sInput();
            var url = await SharingService.GenerateShareUrlAsync(input);
            await SharingService.CopyShareUrlAsync(url);
            showShareCopied = true;
            StateHasChanged();
            await Task.Delay(2000);
            showShareCopied = false;
            StateHasChanged();
        }
        catch
        {
            // Silently fail - share is non-critical
        }
    }

    private async Task ShareVMConfiguration()
    {
        if (vmResults == null) return;
        try
        {
            var input = BuildVMInput();
            var url = await SharingService.GenerateShareUrlAsync(input);
            await SharingService.CopyShareUrlAsync(url);
            showShareCopied = true;
            StateHasChanged();
            await Task.Delay(2000);
            showShareCopied = false;
            StateHasChanged();
        }
        catch
        {
            // Silently fail - share is non-critical
        }
    }

    // Cost estimation methods
    private async Task HandleK8sCostCalculate((CloudProvider provider, string region, CostEstimationOptions options) args)
    {
        if (results == null) return;

        k8sCostLoading = true;
        StateHasChanged();

        try
        {
            var (provider, region, options) = args;
            options.Distribution = selectedDistribution?.ToString();
            k8sCostOptions = options;

            if (provider == CloudProvider.OnPrem)
            {
                var onPremPricing = PricingService.GetOnPremPricing();
                k8sCostEstimate = CostEstimationService.EstimateOnPremCost(results, onPremPricing, options);
            }
            else
            {
                k8sCostEstimate = await CostEstimationService.EstimateK8sCostAsync(results, provider, region, options);
            }
        }
        finally
        {
            k8sCostLoading = false;
            StateHasChanged();
        }
    }

    private async Task HandleVMCostCalculate((CloudProvider provider, string region, CostEstimationOptions options) args)
    {
        if (vmResults == null) return;

        vmCostLoading = true;
        StateHasChanged();

        try
        {
            var (provider, region, options) = args;
            options.Distribution = selectedTechnology?.ToString();
            vmCostOptions = options;

            if (provider == CloudProvider.OnPrem)
            {
                var onPremPricing = PricingService.GetOnPremPricing();
                vmCostEstimate = CostEstimationService.EstimateOnPremVMCost(vmResults, onPremPricing, options);
            }
            else
            {
                vmCostEstimate = await CostEstimationService.EstimateVMCostAsync(vmResults, provider, region, options);
            }
        }
        finally
        {
            vmCostLoading = false;
            StateHasChanged();
        }
    }

    // Growth planning methods
    private bool k8sGrowthCalculating = false;

    private void HandleK8sGrowthSettingsChanged()
    {
        // Settings changed - projection needs recalculation
        // Optionally auto-recalculate or just update UI
        StateHasChanged();
    }

    private void HandleK8sGrowthSettingsFromComponent(GrowthSettings settings)
    {
        // Settings changed from component - update local settings
        k8sGrowthSettings = settings;
        StateHasChanged();
    }

    private async Task CalculateK8sGrowth()
    {
        if (results == null || selectedDistribution == null) return;

        k8sGrowthCalculating = true;
        StateHasChanged();

        try
        {
            await Task.Delay(100); // Small delay for UI feedback
            k8sGrowthProjection = GrowthPlanningService.CalculateK8sGrowthProjection(
                results,
                k8sCostEstimate,
                k8sGrowthSettings,
                selectedDistribution.Value);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Growth calculation error: {ex.Message}");
        }
        finally
        {
            k8sGrowthCalculating = false;
            StateHasChanged();
        }
    }

    private async Task HandleK8sGrowthCalculate(GrowthSettings settings)
    {
        if (results == null || selectedDistribution == null) return;

        k8sGrowthSettings = settings;

        try
        {
            k8sGrowthProjection = GrowthPlanningService.CalculateK8sGrowthProjection(
                results,
                k8sCostEstimate,
                settings,
                selectedDistribution.Value);

            // Auto-switch to projection tab after calculation
            k8sGrowthSubTab = "projection";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Growth calculation error: {ex.Message}");
        }

        await Task.CompletedTask;
    }

    private async Task HandleVMGrowthCalculate(GrowthSettings settings)
    {
        if (vmResults == null) return;

        vmGrowthSettings = settings;

        try
        {
            vmGrowthProjection = GrowthPlanningService.CalculateVMGrowthProjection(
                vmResults,
                vmCostEstimate,
                settings);

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"VM Growth calculation error: {ex.Message}");
        }

        await Task.CompletedTask;
    }

    private void HandleVMGrowthSettingsFromComponent(GrowthSettings settings)
    {
        // Settings changed from component - update local settings
        vmGrowthSettings = settings;
        StateHasChanged();
    }

    private async Task AutoCalculateK8sCost()
    {
        if (results == null) return;

        // Auto-calculate with defaults: AWS us-east-1
        k8sCostOptions = new CostEstimationOptions
        {
            Distribution = selectedDistribution?.ToString(),
            IncludeLicenses = true,
            IncludeStorage = true,
            IncludeNetwork = true,
            SupportTier = SupportTier.Basic
        };

        k8sCostLoading = true;
        StateHasChanged();

        try
        {
            k8sCostEstimate = await CostEstimationService.EstimateK8sCostAsync(
                results,
                CloudProvider.AWS,
                "us-east-1",
                k8sCostOptions);
        }
        catch
        {
            // Silently fail - cost estimation is supplementary
        }
        finally
        {
            k8sCostLoading = false;
            StateHasChanged();
        }
    }

    private async Task AutoCalculateVMCost()
    {
        if (vmResults == null) return;

        // Auto-calculate with defaults: AWS us-east-1
        vmCostOptions = new CostEstimationOptions
        {
            Distribution = selectedTechnology?.ToString(),
            IncludeLicenses = true,
            IncludeStorage = true,
            IncludeNetwork = true,
            SupportTier = SupportTier.Basic
        };

        vmCostLoading = true;
        StateHasChanged();

        try
        {
            vmCostEstimate = await CostEstimationService.EstimateVMCostAsync(
                vmResults,
                CloudProvider.AWS,
                "us-east-1",
                vmCostOptions);
        }
        catch
        {
            // Silently fail - cost estimation is supplementary
        }
        finally
        {
            vmCostLoading = false;
            StateHasChanged();
        }
    }

    private string FormatCostPreview(decimal? amount)
    {
        if (!amount.HasValue) return "--";
        var value = amount.Value;
        if (value >= 1_000_000)
            return $"${value / 1_000_000:F2}M";
        if (value >= 1_000)
            return $"${value / 1_000:F1}K";
        return $"${value:F0}";
    }

    private string FormatCurrency(decimal amount)
    {
        if (amount >= 1_000_000)
            return $"${amount / 1_000_000:F2}M";
        if (amount >= 1_000)
            return $"${amount / 1_000:F1}K";
        return $"${amount:F2}";
    }

    private string GetCostCategoryIcon(CostCategory category)
    {
        return category switch
        {
            CostCategory.Compute => "CPU",
            CostCategory.Storage => "HDD",
            CostCategory.Network => "NET",
            CostCategory.License => "LIC",
            CostCategory.Support => "SUP",
            CostCategory.DataCenter => "DC",
            CostCategory.Labor => "OPS",
            _ => ""
        };
    }

    private K8sSizingInput BuildK8sInput()
    {
        // Build per-environment apps config
        var environmentApps = new Dictionary<EnvironmentType, AppConfig>();
        foreach (var env in enabledEnvironments)
        {
            if (envApps.TryGetValue(env, out var config))
            {
                environmentApps[env] = config;
            }
        }

        // Calculate ProdApps and NonProdApps from envApps for fallback
        var prodConfig = envApps.GetValueOrDefault(EnvironmentType.Prod, new AppConfig());
        var nonProdConfig = new AppConfig
        {
            Small = envApps.GetValueOrDefault(EnvironmentType.Dev)?.Small ?? 0,
            Medium = envApps.GetValueOrDefault(EnvironmentType.Dev)?.Medium ?? 0,
            Large = envApps.GetValueOrDefault(EnvironmentType.Dev)?.Large ?? 0,
            XLarge = envApps.GetValueOrDefault(EnvironmentType.Dev)?.XLarge ?? 0
        };

        return new K8sSizingInput
        {
            Distribution = selectedDistribution ?? Distribution.OpenShift,
            Technology = selectedTechnology ?? Technology.DotNet,
            ClusterMode = selectedClusterMode ?? ClusterMode.MultiCluster,
            EnabledEnvironments = enabledEnvironments,
            EnvironmentApps = environmentApps,
            ProdApps = prodConfig,
            NonProdApps = nonProdConfig,
            EnableHeadroom = headroom.Values.Any(h => h > 0),
            Headroom = new HeadroomSettings
            {
                Dev = (int)headroom.GetValueOrDefault(EnvironmentType.Dev, 33),
                Test = (int)headroom.GetValueOrDefault(EnvironmentType.Test, 33),
                Stage = (int)headroom.GetValueOrDefault(EnvironmentType.Stage, 0),
                Prod = (int)headroom.GetValueOrDefault(EnvironmentType.Prod, 40),
                DR = (int)headroom.GetValueOrDefault(EnvironmentType.DR, 40)
            },
            ProdOvercommit = new OvercommitSettings { Cpu = prodCpuOvercommit, Memory = prodMemoryOvercommit },
            NonProdOvercommit = new OvercommitSettings { Cpu = nonProdCpuOvercommit, Memory = nonProdMemoryOvercommit },
            HADRConfig = k8sHADRConfig
        };
    }

    private VMSizingInput BuildVMInput()
    {
        return new VMSizingInput
        {
            Technology = selectedTechnology ?? Technology.DotNet,
            EnvironmentConfigs = vmEnvironmentConfigs
        };
    }

    // Scenario helper methods
    private K8sSizingInput? GetK8sSizingInput()
    {
        if (results == null) return null;
        return BuildK8sInput();
    }

    private VMSizingInput? GetVMSizingInput()
    {
        if (vmResults == null) return null;
        return BuildVMInput();
    }

    private async Task HandleScenarioSaved(Scenario scenario)
    {
        // Show a brief notification that scenario was saved
        await JSRuntime.InvokeVoidAsync("alert", $"Scenario '{scenario.Name}' saved successfully!");
    }

    // ========================================
    // Navigation and Statistics Helper Methods
    // ========================================

    private bool ShouldShowResultsSection()
    {
        // Only show Results section when on or past the results step
        // K8s: step 7, Mendix VMs: step 7, OutSystems VMs: step 6
        if (selectedDeployment == DeploymentModel.Kubernetes)
        {
            return currentStep >= GetResultsStep() && results != null;
        }
        else if (selectedDeployment == DeploymentModel.VMs)
        {
            return currentStep >= GetResultsStep() && vmResults != null;
        }
        return false;
    }

    private string GetActiveResultsTab()
    {
        return results != null ? k8sResultsTab : vmResultsTab;
    }

    private void HandleResultTabSelected(string tab)
    {
        if (results != null)
        {
            k8sResultsTab = tab;
        }
        else if (vmResults != null)
        {
            vmResultsTab = tab;
        }
        StateHasChanged();
    }

    private string GetCurrentContext()
    {
        var parts = new List<string>();

        if (selectedPlatform != null)
        {
            parts.Add(selectedPlatform == PlatformType.Native ? "Native" : "Low-Code");
        }

        if (selectedDeployment != null)
        {
            parts.Add(selectedDeployment == DeploymentModel.Kubernetes ? "K8s" : "VM");
        }

        if (selectedTechnology != null)
        {
            var tech = GetAvailableTechnologies().FirstOrDefault(t => t.Technology == selectedTechnology);
            if (tech != null)
            {
                parts.Add(tech.Name);
            }
        }

        if (selectedDistribution != null)
        {
            var distro = DistributionService.GetAll().FirstOrDefault(d => d.Distribution == selectedDistribution);
            if (distro != null)
            {
                parts.Add(distro.Name);
            }
        }

        return parts.Count > 0 ? string.Join(" â†’ ", parts) : "";
    }

    private int GetInsightsCount()
    {
        var warnings = results != null ? validationWarnings : vmValidationWarnings;
        return warnings?.Count ?? 0;
    }

    private int GetWarningsCount()
    {
        var warnings = results != null ? validationWarnings : vmValidationWarnings;
        return warnings?.Count(w => w.Severity == Models.WarningSeverity.Warning) ?? 0;
    }

    private int GetCriticalCount()
    {
        var warnings = results != null ? validationWarnings : vmValidationWarnings;
        return warnings?.Count(w => w.Severity == Models.WarningSeverity.Critical) ?? 0;
    }

    private int GetRecommendationsCount()
    {
        var warnings = results != null ? validationWarnings : vmValidationWarnings;
        return warnings?.Count(w => w.Severity == Models.WarningSeverity.Info) ?? 0;
    }

    private void HandleHeaderAction(string action)
    {
        switch (action)
        {
            case "settings":
                OpenSettings();
                break;
            case "scenarios":
                NavigationManager.NavigateTo("/scenarios");
                break;
            case "reset":
                ResetWizard();
                break;
        }
    }

    private int GetTotalNodes()
    {
        if (results != null)
        {
            return results.Environments.Sum(e => e.TotalNodes);
        }
        if (vmResults != null)
        {
            return vmResults.Environments.Sum(e => e.TotalVMs);
        }
        return 0;
    }

    private double GetTotalCPU()
    {
        if (results != null)
        {
            return results.Environments.Sum(e => e.TotalCpu);
        }
        if (vmResults != null)
        {
            return vmResults.Environments.Sum(e => e.TotalCpu);
        }
        return 0;
    }

    private double GetTotalRAM()
    {
        if (results != null)
        {
            return results.Environments.Sum(e => e.TotalRam);
        }
        if (vmResults != null)
        {
            return vmResults.Environments.Sum(e => e.TotalRam);
        }
        return 0;
    }

    private double GetTotalDisk()
    {
        if (results != null)
        {
            return results.Environments.Sum(e => e.TotalDisk);
        }
        if (vmResults != null)
        {
            return vmResults.Environments.Sum(e => e.TotalDisk);
        }
        return 0;
    }

    private decimal GetMonthlyEstimate()
    {
        // If pricing should show N/A, return 0
        if (ShouldShowPricingNA())
        {
            return 0;
        }

        // For Mendix K8s deployments, use MendixCost from pricing result
        if (selectedTechnology == Technology.Mendix && selectedDeployment == DeploymentModel.Kubernetes && pricingResult?.MendixCost != null)
        {
            return pricingResult.MendixCost.TotalPerMonth;
        }

        // For Mendix VM deployments, calculate infrastructure + license cost
        if (selectedTechnology == Technology.Mendix && selectedDeployment == DeploymentModel.VMs && vmResults != null)
        {
            var infraCost = vmCostEstimate?.MonthlyTotal ?? 0;
            var licenseCost = GetMendixVMLicenseMonthly();
            return infraCost + licenseCost;
        }

        // Use pricingResult if available (from pricing step)
        if (pricingResult?.MonthlyCost.HasValue == true)
        {
            return pricingResult.MonthlyCost.Value;
        }

        if (k8sCostEstimate != null)
        {
            return k8sCostEstimate.MonthlyTotal;
        }
        if (vmCostEstimate != null)
        {
            return vmCostEstimate.MonthlyTotal;
        }
        return 0;
    }

    private decimal GetMendixVMLicenseMonthly()
    {
        var (perApp, unlimited) = GetMendixVMDeploymentPricing();
        var yearlyLicense = mendixIsUnlimitedApps ? unlimited : perApp * mendixNumberOfApps;
        return yearlyLicense / 12;
    }

    private string? GetCostProvider()
    {
        // Handle Mendix-specific deployments - always show Mendix as the provider
        if (selectedTechnology == Technology.Mendix)
        {
            if (selectedDeployment == DeploymentModel.Kubernetes)
            {
                // Mendix Cloud (SaaS/Dedicated)
                if (mendixDeploymentCategory == MendixDeploymentCategory.Cloud)
                {
                    return mendixCloudType == MendixCloudType.Dedicated ? "Mendix Dedicated" : "Mendix Cloud";
                }
                // Mendix Private Cloud
                if (mendixDeploymentCategory == MendixDeploymentCategory.PrivateCloud)
                {
                    return mendixPrivateCloudProvider switch
                    {
                        MendixPrivateCloudProvider.Azure => "Mendix Azure",
                        MendixPrivateCloudProvider.EKS => "Mendix EKS",
                        MendixPrivateCloudProvider.AKS => "Mendix AKS",
                        MendixPrivateCloudProvider.GKE => "Mendix GKE",
                        MendixPrivateCloudProvider.OpenShift => "Mendix OpenShift",
                        _ => "Mendix"
                    };
                }
                // Other K8s (Rancher, K3s, Generic)
                if (mendixDeploymentCategory == MendixDeploymentCategory.Other)
                {
                    return mendixOtherDeployment switch
                    {
                        MendixOtherDeployment.Server => "Mendix Server",
                        MendixOtherDeployment.StackIT => "Mendix StackIT",
                        MendixOtherDeployment.SapBtp => "Mendix SAP",
                        _ => mendixPrivateCloudProvider switch
                        {
                            MendixPrivateCloudProvider.Rancher => "Mendix Rancher",
                            MendixPrivateCloudProvider.K3s => "Mendix K3s",
                            MendixPrivateCloudProvider.GenericK8s => "Mendix K8s",
                            _ => "Mendix"
                        }
                    };
                }
            }
            // Mendix VM deployment
            if (selectedDeployment == DeploymentModel.VMs)
            {
                return "Mendix VM";
            }
            return "Mendix";
        }

        // Determine provider based on distribution for non-Mendix
        if (selectedDistribution.HasValue)
        {
            return selectedDistribution.Value switch
            {
                Distribution.EKS => "AWS",
                Distribution.AKS => "Azure",
                Distribution.GKE => "GCP",
                Distribution.OKE => "Oracle",
                Distribution.OpenShift or Distribution.Rancher or Distribution.K3s or Distribution.Tanzu => "On-Prem",
                _ => null
            };
        }
        return null;
    }

    private bool ShouldShowPricingNA()
    {
        // Mendix deployments always have pricing available
        if (selectedTechnology == Technology.Mendix)
        {
            return false;
        }

        // Show N/A when:
        // 1. It's an on-prem distribution AND
        // 2. Pricing is not configured (either pricingResult is null or HasCosts is false)
        if (!selectedDistribution.HasValue) return false;

        var isOnPrem = PricingSettingsService.IsOnPremDistribution(selectedDistribution.Value);
        if (!isOnPrem) return false;

        // Check if pricing was configured in the pricing step
        return pricingResult == null || !pricingResult.HasCosts;
    }

    private async Task HandleExport(RightStatsSidebar.ExportFormat format)
    {
        try
        {
            if (results != null)
            {
                switch (format)
                {
                    case RightStatsSidebar.ExportFormat.CSV:
                        var csv = ExportService.ExportToCsv(results);
                        await JSRuntime.InvokeVoidAsync("downloadFile", "k8s-sizing-export.csv", csv, "text/csv");
                        break;
                    case RightStatsSidebar.ExportFormat.JSON:
                        var json = ExportService.ExportToJson(results);
                        await JSRuntime.InvokeVoidAsync("downloadFile", "k8s-sizing-export.json", json, "application/json");
                        break;
                    case RightStatsSidebar.ExportFormat.Excel:
                        var excel = ExportService.ExportToExcel(results);
                        await JSRuntime.InvokeVoidAsync("downloadFileBytes", "k8s-sizing-export.xlsx", excel, "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");
                        break;
                    case RightStatsSidebar.ExportFormat.PDF:
                        var pdf = ExportService.ExportToPdf(results);
                        await JSRuntime.InvokeVoidAsync("downloadFileBytes", "k8s-sizing-export.pdf", pdf, "application/pdf");
                        break;
                    case RightStatsSidebar.ExportFormat.Diagram:
                        var html = ExportService.ExportToHtmlDiagram(results);
                        await JSRuntime.InvokeVoidAsync("downloadFile", "k8s-architecture.html", html, "text/html");
                        break;
                }
            }
            else if (vmResults != null)
            {
                switch (format)
                {
                    case RightStatsSidebar.ExportFormat.JSON:
                        var jsonContent = System.Text.Json.JsonSerializer.Serialize(vmResults, new System.Text.Json.JsonSerializerOptions { WriteIndented = true });
                        await JSRuntime.InvokeVoidAsync("downloadFile", "vm-sizing-export.json", jsonContent, "application/json");
                        break;
                    case RightStatsSidebar.ExportFormat.PDF:
                        var pdf = ExportService.ExportToPdf(vmResults);
                        await JSRuntime.InvokeVoidAsync("downloadFileBytes", "vm-sizing-export.pdf", pdf, "application/pdf");
                        break;
                    default:
                        // For unsupported formats, default to JSON
                        var defaultJson = System.Text.Json.JsonSerializer.Serialize(vmResults, new System.Text.Json.JsonSerializerOptions { WriteIndented = true });
                        await JSRuntime.InvokeVoidAsync("downloadFile", "vm-sizing-export.json", defaultJson, "application/json");
                        break;
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Export error: {ex.Message}");
        }
    }

    private async Task HandleShare()
    {
        try
        {
            string? shareUrl = null;

            if (results != null)
            {
                var input = GetK8sSizingInput();
                if (input != null)
                {
                    shareUrl = await SharingService.GenerateShareUrlAsync(input);
                }
            }
            else if (vmResults != null)
            {
                var input = GetVMSizingInput();
                if (input != null)
                {
                    shareUrl = await SharingService.GenerateShareUrlAsync(input);
                }
            }

            if (string.IsNullOrEmpty(shareUrl))
            {
                return;
            }

            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", shareUrl);
            showShareCopied = true;
            StateHasChanged();
            await Task.Delay(2000);
            showShareCopied = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Share error: {ex.Message}");
        }
    }

    // VM Configuration helpers
    private VMEnvironmentConfig GetOrCreateVMConfig(EnvironmentType env)
    {
        if (!vmEnvironmentConfigs.TryGetValue(env, out var config))
        {
            // For Prod: default to HA with load balancer
            // For Dev/Test/Stage: default to no redundancy
            // DR is now a configuration option per environment, not a separate environment
            var isProd = IsProdEnvironment(env);
            config = new VMEnvironmentConfig
            {
                Environment = env,
                Enabled = enabledEnvironments.Contains(env),
                HAPattern = isProd ? HAPattern.ActivePassive : HAPattern.None,
                DRPattern = DRPattern.None, // DR is enabled per-environment in HA/DR tab
                LoadBalancer = isProd ? LoadBalancerOption.HAPair : LoadBalancerOption.None,
                StorageGB = isProd ? 500 : 100,
                Roles = CreateTechnologySpecificRoles(env)
            };
            vmEnvironmentConfigs[env] = config;
        }
        return config;
    }

    // Create technology-specific VM roles based on selected technology
    private List<VMRoleConfig> CreateTechnologySpecificRoles(EnvironmentType env)
    {
        if (!selectedTechnology.HasValue) return CreateFallbackRoles(env);

        var techConfig = TechnologyService.GetConfig(selectedTechnology.Value);

        // For LifeTime environment, use management environment roles
        if (env == EnvironmentType.LifeTime && techConfig.ManagementEnvironmentRoles != null)
        {
            return techConfig.ManagementEnvironmentRoles.Roles
                .Where(r => r.Required)
                .Select(r => new VMRoleConfig
                {
                    Role = ServerRole.App,
                    RoleId = r.Id,
                    RoleName = r.Name,
                    RoleIcon = r.Icon,
                    RoleDescription = r.Description,
                    Size = r.DefaultSize,
                    InstanceCount = r.MinInstances,
                    DiskGB = r.DefaultDiskGB,
                    MemoryMultiplier = r.MemoryMultiplier
                })
                .ToList();
        }

        // For regular environments, use standard VM roles
        var vmRoles = TechnologyService.GetVMRoles(selectedTechnology.Value);
        if (vmRoles != null)
        {
            var isProd = IsProdEnvironment(env);
            return vmRoles.Roles
                .Where(r => r.Required)
                .Select(r => new VMRoleConfig
                {
                    Role = ServerRole.App,
                    RoleId = r.Id,
                    RoleName = r.Name,
                    RoleIcon = r.Icon,
                    RoleDescription = r.Description,
                    Size = r.DefaultSize,
                    InstanceCount = r.ScaleHorizontally && isProd ? Math.Max(2, r.MinInstances) : r.MinInstances,
                    DiskGB = r.DefaultDiskGB,
                    MemoryMultiplier = r.MemoryMultiplier
                })
                .ToList();
        }

        return CreateFallbackRoles(env);
    }

    // Fallback to generic roles if no technology-specific roles defined
    private List<VMRoleConfig> CreateFallbackRoles(EnvironmentType env)
    {
        return new List<VMRoleConfig>
        {
            new() { Role = ServerRole.Web, RoleName = "Web Server", RoleIcon = "web", Size = AppTier.Medium, InstanceCount = IsProdEnvironment(env) ? 2 : 1, DiskGB = 100 },
            new() { Role = ServerRole.App, RoleName = "Application Server", RoleIcon = "app", Size = AppTier.Medium, InstanceCount = IsProdEnvironment(env) ? 2 : 1, DiskGB = 100 },
            new() { Role = ServerRole.Database, RoleName = "Database Server", RoleIcon = "db", Size = AppTier.Large, InstanceCount = 1, DiskGB = 500 }
        };
    }

    // Get all available roles for the selected technology (for adding optional roles)
    private IEnumerable<TechnologyServerRole> GetAvailableTechnologyRoles()
    {
        if (!selectedTechnology.HasValue) return Enumerable.Empty<TechnologyServerRole>();
        var vmRoles = TechnologyService.GetVMRoles(selectedTechnology.Value);
        return vmRoles?.Roles ?? Enumerable.Empty<TechnologyServerRole>();
    }

    // Management Environment helpers (e.g., OutSystems LifeTime)
    private bool HasManagementEnvironment()
    {
        if (!selectedTechnology.HasValue) return false;
        var config = TechnologyService.GetConfig(selectedTechnology.Value);
        return config.HasSeparateManagementEnvironment;
    }

    private string GetManagementEnvironmentName()
    {
        if (!selectedTechnology.HasValue) return "Management";
        var config = TechnologyService.GetConfig(selectedTechnology.Value);
        return config.ManagementEnvironmentName;
    }

    private IEnumerable<TechnologyServerRole> GetManagementEnvironmentRoles()
    {
        if (!selectedTechnology.HasValue) return Enumerable.Empty<TechnologyServerRole>();
        var config = TechnologyService.GetConfig(selectedTechnology.Value);
        return config.ManagementEnvironmentRoles?.Roles ?? Enumerable.Empty<TechnologyServerRole>();
    }

    private void ToggleManagementVMRole(TechnologyServerRole techRole)
    {
        vmManagementEnvConfig ??= new VMEnvironmentConfig { Enabled = true };

        var existingRole = vmManagementEnvConfig.Roles.FirstOrDefault(r => r.RoleId == techRole.Id);
        if (existingRole != null)
        {
            vmManagementEnvConfig.Roles.Remove(existingRole);
        }
        else
        {
            var newRole = new VMRoleConfig
            {
                RoleId = techRole.Id,
                RoleName = techRole.Name,
                RoleIcon = techRole.Icon,
                Role = ServerRole.App, // Default role type
                Size = techRole.DefaultSize,
                InstanceCount = 1, // Management env roles typically single instance
                DiskGB = techRole.DefaultDiskGB
            };
            vmManagementEnvConfig.Roles.Add(newRole);
        }
    }

    private void RemoveManagementVMRole(VMRoleConfig roleConfig)
    {
        vmManagementEnvConfig?.Roles.Remove(roleConfig);
    }

    // Reset and initialize VM configs when technology changes
    private void OnTechnologyChanged()
    {
        vmEnvironmentConfigs.Clear();
        vmManagementEnvConfig = null; // Legacy - kept for compatibility

        // Add LifeTime to enabled environments for OutSystems
        if (selectedTechnology == Technology.OutSystems)
        {
            enabledEnvironments.Add(EnvironmentType.LifeTime);
        }
        else
        {
            enabledEnvironments.Remove(EnvironmentType.LifeTime);
        }

        // Pre-initialize all enabled environments with default roles
        // This ensures Front-End Server and Database Server are selected by default
        foreach (var env in enabledEnvironments)
        {
            GetOrCreateVMConfig(env);
        }
    }

    private void ToggleVMEnvironment(EnvironmentType env)
    {
        if (env == EnvironmentType.Prod) return; // Prod cannot be disabled
        if (enabledEnvironments.Contains(env))
        {
            enabledEnvironments.Remove(env);
            if (vmEnvironmentConfigs.TryGetValue(env, out var config))
                config.Enabled = false;
        }
        else
        {
            enabledEnvironments.Add(env);
            GetOrCreateVMConfig(env).Enabled = true;
        }
    }

    private void ToggleRoleBreakdownEnv(string envName)
    {
        // Accordion behavior: clicking same env collapses it, clicking different env switches to it
        expandedRoleBreakdownEnv = expandedRoleBreakdownEnv == envName ? null : envName;
    }

    private string GetShortEnvName(string envName) => envName switch
    {
        "Development" => "DEV",
        "Test" => "TEST",
        "Testing" => "TEST",
        "Staging" => "STG",
        "Production" => "PROD",
        "Disaster Recovery" => "DR",
        _ => envName.Length > 4 ? envName[..4].ToUpper() : envName.ToUpper()
    };

    private string GetEnvCssClass(string envName) => envName.ToLower() switch
    {
        "development" => "env-dev",
        "test" or "testing" => "env-test",
        "staging" => "env-stage",
        "production" => "env-prod",
        "disaster recovery" => "env-dr",
        _ => "env-default"
    };

    private string FormatHAPattern(HAPattern pattern) => pattern switch
    {
        HAPattern.None => "None",
        HAPattern.ActiveActive => "Active-Active",
        HAPattern.ActivePassive => "Active-Passive",
        HAPattern.NPlus1 => "N+1 Redundancy",
        HAPattern.NPlus2 => "N+2 Redundancy",
        _ => pattern.ToString()
    };

    private void ToggleVMRole(EnvironmentType env, ServerRole role)
    {
        var config = GetOrCreateVMConfig(env);
        var existing = config.Roles.FirstOrDefault(r => r.Role == role && string.IsNullOrEmpty(r.RoleId));
        if (existing != null)
        {
            config.Roles.Remove(existing);
        }
        else
        {
            config.Roles.Add(new VMRoleConfig
            {
                Role = role,
                RoleName = role.ToString(),
                RoleIcon = GetRoleIcon(role),
                Size = AppTier.Medium,
                InstanceCount = IsProdEnvironment(env) ? 2 : 1,
                DiskGB = role == ServerRole.Database ? 500 : 100
            });
        }
    }

    // Toggle technology-specific VM role
    private void ToggleTechVMRole(EnvironmentType env, TechnologyServerRole techRole)
    {
        var config = GetOrCreateVMConfig(env);
        var existing = config.Roles.FirstOrDefault(r => r.RoleId == techRole.Id);
        if (existing != null)
        {
            config.Roles.Remove(existing);
        }
        else
        {
            var isProd = IsProdEnvironment(env);
            config.Roles.Add(new VMRoleConfig
            {
                Role = ServerRole.App, // Fallback generic role
                RoleId = techRole.Id,
                RoleName = techRole.Name,
                RoleIcon = techRole.Icon,
                RoleDescription = techRole.Description,
                Size = techRole.DefaultSize,
                InstanceCount = techRole.ScaleHorizontally && isProd ? Math.Max(2, techRole.MinInstances) : techRole.MinInstances,
                DiskGB = techRole.DefaultDiskGB,
                MemoryMultiplier = techRole.MemoryMultiplier
            });
        }
    }

    private void RemoveVMRole(EnvironmentType env, ServerRole role)
    {
        var config = GetOrCreateVMConfig(env);
        var existing = config.Roles.FirstOrDefault(r => r.Role == role && string.IsNullOrEmpty(r.RoleId));
        if (existing != null)
            config.Roles.Remove(existing);
    }

    // Remove technology-specific VM role
    private void RemoveTechVMRole(EnvironmentType env, VMRoleConfig roleConfig)
    {
        var config = GetOrCreateVMConfig(env);
        config.Roles.Remove(roleConfig);
    }

    private string GetEnvIcon(EnvironmentType env) => env switch
    {
        EnvironmentType.Dev => "D",
        EnvironmentType.Test => "T",
        EnvironmentType.Stage => "S",
        EnvironmentType.Prod => "P",
        EnvironmentType.DR => "DR",
        _ => "E"
    };

    // Simpler helper methods for per-environment node specs (used in Razor template)
    private int GetMasterCpu() => nodeSpecs.GetControlPlaneSpecs(selectedNodeSpecsEnv).Cpu;
    private int GetMasterRam() => nodeSpecs.GetControlPlaneSpecs(selectedNodeSpecsEnv).Ram;
    private int GetMasterDisk() => nodeSpecs.GetControlPlaneSpecs(selectedNodeSpecsEnv).Disk;
    private int GetInfraCpu() => nodeSpecs.GetInfraSpecs(selectedNodeSpecsEnv).Cpu;
    private int GetInfraRam() => nodeSpecs.GetInfraSpecs(selectedNodeSpecsEnv).Ram;
    private int GetInfraDisk() => nodeSpecs.GetInfraSpecs(selectedNodeSpecsEnv).Disk;
    private int GetWorkerCpu() => nodeSpecs.GetWorkerSpecs(selectedNodeSpecsEnv).Cpu;
    private int GetWorkerRam() => nodeSpecs.GetWorkerSpecs(selectedNodeSpecsEnv).Ram;
    private int GetWorkerDisk() => nodeSpecs.GetWorkerSpecs(selectedNodeSpecsEnv).Disk;

    private void SetMasterCpu(ChangeEventArgs e) => SetEnvNodeSpec("Master", "Cpu", e);
    private void SetMasterRam(ChangeEventArgs e) => SetEnvNodeSpec("Master", "Ram", e);
    private void SetMasterDisk(ChangeEventArgs e) => SetEnvNodeSpec("Master", "Disk", e);
    private void SetInfraCpu(ChangeEventArgs e) => SetEnvNodeSpec("Infra", "Cpu", e);
    private void SetInfraRam(ChangeEventArgs e) => SetEnvNodeSpec("Infra", "Ram", e);
    private void SetInfraDisk(ChangeEventArgs e) => SetEnvNodeSpec("Infra", "Disk", e);
    private void SetWorkerCpu(ChangeEventArgs e) => SetEnvNodeSpec("Worker", "Cpu", e);
    private void SetWorkerRam(ChangeEventArgs e) => SetEnvNodeSpec("Worker", "Ram", e);
    private void SetWorkerDisk(ChangeEventArgs e) => SetEnvNodeSpec("Worker", "Disk", e);

    private void SetEnvNodeSpec(string nodeType, string spec, ChangeEventArgs e)
    {
        if (!int.TryParse(e.Value?.ToString(), out var value) || value < 1) return;
        var env = selectedNodeSpecsEnv;

        switch ((env, nodeType, spec))
        {
            case (EnvironmentType.Dev, "Master", "Cpu"): nodeSpecs.DevMasterCpu = value; break;
            case (EnvironmentType.Dev, "Master", "Ram"): nodeSpecs.DevMasterRam = value; break;
            case (EnvironmentType.Dev, "Master", "Disk"): nodeSpecs.DevMasterDisk = value; break;
            case (EnvironmentType.Dev, "Infra", "Cpu"): nodeSpecs.DevInfraCpu = value; break;
            case (EnvironmentType.Dev, "Infra", "Ram"): nodeSpecs.DevInfraRam = value; break;
            case (EnvironmentType.Dev, "Infra", "Disk"): nodeSpecs.DevInfraDisk = value; break;
            case (EnvironmentType.Dev, "Worker", "Cpu"): nodeSpecs.DevWorkerCpu = value; break;
            case (EnvironmentType.Dev, "Worker", "Ram"): nodeSpecs.DevWorkerRam = value; break;
            case (EnvironmentType.Dev, "Worker", "Disk"): nodeSpecs.DevWorkerDisk = value; break;
            case (EnvironmentType.Test, "Master", "Cpu"): nodeSpecs.TestMasterCpu = value; break;
            case (EnvironmentType.Test, "Master", "Ram"): nodeSpecs.TestMasterRam = value; break;
            case (EnvironmentType.Test, "Master", "Disk"): nodeSpecs.TestMasterDisk = value; break;
            case (EnvironmentType.Test, "Infra", "Cpu"): nodeSpecs.TestInfraCpu = value; break;
            case (EnvironmentType.Test, "Infra", "Ram"): nodeSpecs.TestInfraRam = value; break;
            case (EnvironmentType.Test, "Infra", "Disk"): nodeSpecs.TestInfraDisk = value; break;
            case (EnvironmentType.Test, "Worker", "Cpu"): nodeSpecs.TestWorkerCpu = value; break;
            case (EnvironmentType.Test, "Worker", "Ram"): nodeSpecs.TestWorkerRam = value; break;
            case (EnvironmentType.Test, "Worker", "Disk"): nodeSpecs.TestWorkerDisk = value; break;
            case (EnvironmentType.Stage, "Master", "Cpu"): nodeSpecs.StageMasterCpu = value; break;
            case (EnvironmentType.Stage, "Master", "Ram"): nodeSpecs.StageMasterRam = value; break;
            case (EnvironmentType.Stage, "Master", "Disk"): nodeSpecs.StageMasterDisk = value; break;
            case (EnvironmentType.Stage, "Infra", "Cpu"): nodeSpecs.StageInfraCpu = value; break;
            case (EnvironmentType.Stage, "Infra", "Ram"): nodeSpecs.StageInfraRam = value; break;
            case (EnvironmentType.Stage, "Infra", "Disk"): nodeSpecs.StageInfraDisk = value; break;
            case (EnvironmentType.Stage, "Worker", "Cpu"): nodeSpecs.StageWorkerCpu = value; break;
            case (EnvironmentType.Stage, "Worker", "Ram"): nodeSpecs.StageWorkerRam = value; break;
            case (EnvironmentType.Stage, "Worker", "Disk"): nodeSpecs.StageWorkerDisk = value; break;
            case (EnvironmentType.Prod, "Master", "Cpu"): nodeSpecs.ProdMasterCpu = value; break;
            case (EnvironmentType.Prod, "Master", "Ram"): nodeSpecs.ProdMasterRam = value; break;
            case (EnvironmentType.Prod, "Master", "Disk"): nodeSpecs.ProdMasterDisk = value; break;
            case (EnvironmentType.Prod, "Infra", "Cpu"): nodeSpecs.ProdInfraCpu = value; break;
            case (EnvironmentType.Prod, "Infra", "Ram"): nodeSpecs.ProdInfraRam = value; break;
            case (EnvironmentType.Prod, "Infra", "Disk"): nodeSpecs.ProdInfraDisk = value; break;
            case (EnvironmentType.Prod, "Worker", "Cpu"): nodeSpecs.ProdWorkerCpu = value; break;
            case (EnvironmentType.Prod, "Worker", "Ram"): nodeSpecs.ProdWorkerRam = value; break;
            case (EnvironmentType.Prod, "Worker", "Disk"): nodeSpecs.ProdWorkerDisk = value; break;
            case (EnvironmentType.DR, "Master", "Cpu"): nodeSpecs.DRMasterCpu = value; break;
            case (EnvironmentType.DR, "Master", "Ram"): nodeSpecs.DRMasterRam = value; break;
            case (EnvironmentType.DR, "Master", "Disk"): nodeSpecs.DRMasterDisk = value; break;
            case (EnvironmentType.DR, "Infra", "Cpu"): nodeSpecs.DRInfraCpu = value; break;
            case (EnvironmentType.DR, "Infra", "Ram"): nodeSpecs.DRInfraRam = value; break;
            case (EnvironmentType.DR, "Infra", "Disk"): nodeSpecs.DRInfraDisk = value; break;
            case (EnvironmentType.DR, "Worker", "Cpu"): nodeSpecs.DRWorkerCpu = value; break;
            case (EnvironmentType.DR, "Worker", "Ram"): nodeSpecs.DRWorkerRam = value; break;
            case (EnvironmentType.DR, "Worker", "Disk"): nodeSpecs.DRWorkerDisk = value; break;
        }
    }

    private string GetRoleIcon(ServerRole role) => role switch
    {
        ServerRole.Web => "web",
        ServerRole.App => "app",
        ServerRole.Database => "db",
        ServerRole.Cache => "cache",
        ServerRole.MessageQueue => "mq",
        ServerRole.Search => "search",
        ServerRole.Storage => "storage",
        ServerRole.Monitoring => "mon",
        ServerRole.Bastion => "bastion",
        _ => "server"
    };

    private int GetRoleMaxInstances(VMRoleConfig roleConfig)
    {
        if (string.IsNullOrEmpty(roleConfig.RoleId) || selectedTechnology == null)
            return 100; // Default max for generic roles

        var vmRoles = TechnologyService.GetVMRoles(selectedTechnology.Value);
        var techRole = vmRoles?.Roles.FirstOrDefault(r => r.Id == roleConfig.RoleId);
        return techRole?.MaxInstances ?? 100;
    }

    private bool IsRoleSingleInstance(VMRoleConfig roleConfig)
    {
        return GetRoleMaxInstances(roleConfig) == 1;
    }

    private string GetVMEnvSummary(EnvironmentType env)
    {
        if (!enabledEnvironments.Contains(env)) return "Disabled";
        if (!vmEnvironmentConfigs.TryGetValue(env, out var config)) return "Not configured";
        return $"{config.Roles.Count} roles, {config.Roles.Sum(r => r.InstanceCount)} VMs";
    }

    private string GetHAPatternDisplay(HAPattern pattern) => pattern switch
    {
        HAPattern.None => "None",
        HAPattern.ActiveActive => "Active-Active",
        HAPattern.ActivePassive => "Active-Passive",
        HAPattern.NPlus1 => "N+1",
        HAPattern.NPlus2 => "N+2",
        _ => pattern.ToString()
    };

    private string GetDRPatternDisplay(DRPattern pattern) => pattern switch
    {
        DRPattern.None => "None",
        DRPattern.WarmStandby => "Warm Standby",
        DRPattern.HotStandby => "Hot Standby",
        DRPattern.MultiRegion => "Multi-Region",
        _ => pattern.ToString()
    };

    private string GetLBOptionDisplay(LoadBalancerOption option) => option switch
    {
        LoadBalancerOption.None => "None",
        LoadBalancerOption.Single => "Single LB",
        LoadBalancerOption.HAPair => "HA Pair",
        LoadBalancerOption.CloudLB => "Cloud LB",
        _ => option.ToString()
    };

    private async Task CalculateVM()
    {
        if (selectedTechnology == null) return;

        // Build the input from VM configs
        var input = new VMSizingInput
        {
            Technology = selectedTechnology.Value,
            EnabledEnvironments = enabledEnvironments,
            EnvironmentConfigs = vmEnvironmentConfigs,
            SystemOverheadPercent = vmSystemOverhead
        };

        vmResults = VMSizingService.Calculate(input);

        // Generate validation warnings and recommendations
        vmValidationWarnings = ValidationService.Analyze(vmResults, input);

        // Reset cost estimate and auto-calculate default costs
        vmCostEstimate = null;
        vmResultsTab = "sizing";
        StateHasChanged();

        // Auto-calculate costs in the background
        _ = AutoCalculateVMCost();

        await Task.Delay(100);
        await JSRuntime.InvokeVoidAsync("scrollToElement", "results");
    }

    // Info modals
    private enum InfoType { Platform, Deployment, Technology, Distribution, ClusterMode, NodeSpecs, AppConfig }

    private void ShowInfo(InfoType type)
    {
        (infoModalTitle, infoModalContent) = type switch
        {
            InfoType.Platform => ("Platform Types", "<h3>Native Applications</h3><p>Traditional applications built with .NET, Java, Node.js, Python, or Go. Full control over code and dependencies.</p><h3>Low-Code Platforms</h3><p>Platforms like Mendix that enable rapid development with visual modeling. Higher resource requirements but faster development.</p>"),
            InfoType.Deployment => ("Deployment Models", "<h3>Kubernetes</h3><p>Container orchestration with auto-scaling, self-healing, and rolling updates. Best for microservices and cloud-native apps.</p><h3>Virtual Machines</h3><p>Traditional VM deployment with dedicated servers. Better for legacy apps or specific compliance requirements.</p>"),
            InfoType.Technology => ("Technologies", "<h3>.NET</h3><p>Microsoft's cross-platform framework. Efficient memory usage, great for enterprise apps.</p><h3>Java</h3><p>Enterprise runtime with higher memory footprint. Excellent ecosystem and tooling.</p><h3>Node.js</h3><p>JavaScript runtime for event-driven applications. Lightweight but single-threaded.</p><h3>Python</h3><p>Versatile language for web, data science, and automation. GIL impacts CPU-bound workloads.</p><h3>Go</h3><p>Google's compiled language. Very efficient, ideal for microservices.</p><h3>Mendix</h3><p>Enterprise low-code platform. Higher resource requirements due to runtime overhead.</p>"),
            InfoType.Distribution => ("Kubernetes Distributions", "<h3>OpenShift</h3><p>Enterprise Kubernetes from Red Hat with built-in CI/CD, monitoring, and security. Includes dedicated infra nodes.</p><h3>Vanilla Kubernetes</h3><p>Standard CNCF Kubernetes. Maximum flexibility, self-managed.</p><h3>Rancher</h3><p>Multi-cluster management from SUSE. Easy deployment and management.</p><h3>K3s</h3><p>Lightweight Kubernetes for edge and IoT.</p><h3>Cloud Managed (EKS/AKS/GKE)</h3><p>Control plane managed by cloud provider. Reduced operational overhead.</p>"),
            InfoType.ClusterMode => ("Cluster Modes", "<h3>Multi-Cluster</h3><p>Separate cluster per environment. Maximum isolation but higher cost.</p><h3>Shared Cluster</h3><p>Single cluster with namespace isolation. Cost-optimized but shared resources.</p><h3>Per Environment</h3><p>Calculate for a single specific environment.</p>"),
            InfoType.NodeSpecs => ("Node Specifications", "<h3>Control Plane</h3><p>Master nodes running API server, scheduler, controller manager. 3 nodes for HA, 5 for large clusters.</p><h3>Infrastructure</h3><p>OpenShift-specific nodes for platform services (router, registry, monitoring). Not all distributions require these.</p><h3>Worker Nodes</h3><p>Nodes running application workloads. Sized based on application requirements.</p>"),
            InfoType.AppConfig => ("Application Configuration", "<h3>App Tiers</h3><p>Small, Medium, Large, XLarge - each tier has specific CPU and memory allocations based on the selected technology.</p><h3>Environments</h3><p>Dev/Test for development, Stage for pre-production, Prod for production, DR for disaster recovery.</p>"),
            _ => ("Information", "")
        };
        showInfoModal = true;
    }

    private void ShowDistroInfo(Distribution distro)
    {
        (infoModalTitle, infoModalContent) = distro switch
        {
            Distribution.OpenShift => ("Red Hat OpenShift (On-Prem)", @"
                <div class='info-section'>
                    <p class='info-vendor'><strong>Vendor:</strong> Red Hat (IBM)</p>
                    <p class='info-desc'>Enterprise Kubernetes platform with integrated developer tools, CI/CD pipelines, and enhanced security features. Self-managed on-premises deployment.</p>
                </div>
                <h4>Node Architecture</h4>
                <ul>
                    <li><strong>Control Plane:</strong> 3 master nodes (HA required)</li>
                    <li><strong>Infrastructure:</strong> 3 dedicated nodes for router, registry, monitoring</li>
                    <li><strong>Worker:</strong> Application workload nodes</li>
                </ul>
                <h4>Key Features</h4>
                <ul>
                    <li>Built-in CI/CD with Tekton Pipelines</li>
                    <li>Integrated container registry</li>
                    <li>OperatorHub marketplace</li>
                    <li>Enhanced security (SCC, SELinux)</li>
                    <li>Web console for management</li>
                </ul>
                <h4>Sizing Notes</h4>
                <ul>
                    <li>Master: 8 vCPU, 32 GB RAM, 200 GB disk (prod)</li>
                    <li>Infra: 8 vCPU, 32 GB RAM, 500 GB disk (prod)</li>
                    <li>Worker: 16 vCPU, 64 GB RAM, 200 GB disk (prod)</li>
                </ul>
                <p class='info-note'><em>Note: Requires RHEL CoreOS for nodes. Subscription-based licensing.</em></p>"),

            Distribution.OpenShiftROSA => ("Red Hat OpenShift on AWS (ROSA)", @"
                <div class='info-section'>
                    <p class='info-vendor'><strong>Vendor:</strong> Red Hat + AWS</p>
                    <p class='info-desc'>Fully managed OpenShift service on AWS. AWS and Red Hat jointly manage the control plane - you focus on applications.</p>
                </div>
                <h4>Node Architecture</h4>
                <ul>
                    <li><strong>Control Plane:</strong> Managed by Red Hat/AWS (0 customer-managed masters)</li>
                    <li><strong>Infrastructure:</strong> 3 dedicated nodes for router, registry, monitoring</li>
                    <li><strong>Worker:</strong> Application workload nodes (EC2 instances)</li>
                </ul>
                <h4>Key Features</h4>
                <ul>
                    <li>SLA-backed managed control plane (99.95%)</li>
                    <li>Native AWS integration (IAM, VPC, EBS, S3)</li>
                    <li>AWS STS for secure token service</li>
                    <li>Integrated Red Hat support</li>
                    <li>Pay-as-you-go or annual commitment</li>
                </ul>
                <h4>Pricing</h4>
                <ul>
                    <li>Cluster fee: ~$0.171/hour (~$125/month)</li>
                    <li>Per-worker: ~$0.171/hour per 4 vCPU</li>
                    <li>EC2 instances: Standard AWS pricing</li>
                </ul>
                <p class='info-note'><em>Note: Best for enterprises wanting OpenShift experience on AWS without managing control plane.</em></p>"),

            Distribution.OpenShiftARO => ("Azure Red Hat OpenShift (ARO)", @"
                <div class='info-section'>
                    <p class='info-vendor'><strong>Vendor:</strong> Red Hat + Microsoft</p>
                    <p class='info-desc'>Jointly managed OpenShift service on Azure. First-party Azure service with integrated support from both vendors.</p>
                </div>
                <h4>Node Architecture</h4>
                <ul>
                    <li><strong>Control Plane:</strong> Managed by Red Hat/Microsoft (0 customer-managed masters)</li>
                    <li><strong>Infrastructure:</strong> 3 dedicated nodes for router, registry, monitoring</li>
                    <li><strong>Worker:</strong> Application workload nodes (Azure VMs)</li>
                </ul>
                <h4>Key Features</h4>
                <ul>
                    <li>Azure AD integration for SSO</li>
                    <li>Azure Monitor integration</li>
                    <li>Private Link support</li>
                    <li>Joint support from Microsoft and Red Hat</li>
                    <li>Billed through Azure</li>
                </ul>
                <h4>Pricing</h4>
                <ul>
                    <li>Cluster fee: Included in VM pricing</li>
                    <li>Master VMs: Standard_D8s_v3 (managed)</li>
                    <li>Worker VMs: Your choice of Azure VM sizes</li>
                </ul>
                <p class='info-note'><em>Note: Best for enterprises with Azure investment wanting full OpenShift experience.</em></p>"),

            Distribution.Kubernetes => ("Vanilla Kubernetes", @"
                <div class='info-section'>
                    <p class='info-vendor'><strong>Vendor:</strong> CNCF (Cloud Native Computing Foundation)</p>
                    <p class='info-desc'>Standard upstream Kubernetes - the foundation for all distributions. Maximum flexibility with full control.</p>
                </div>
                <h4>Node Architecture</h4>
                <ul>
                    <li><strong>Control Plane:</strong> 3+ master nodes for HA</li>
                    <li><strong>Worker:</strong> Application workload nodes</li>
                    <li><em>No dedicated infra nodes (services run on workers)</em></li>
                </ul>
                <h4>Key Features</h4>
                <ul>
                    <li>Full CNCF conformance</li>
                    <li>Choose your own CNI, CSI, ingress</li>
                    <li>Maximum customization</li>
                    <li>Large ecosystem and community</li>
                </ul>
                <h4>Deployment Options</h4>
                <ul>
                    <li>Self-managed: kubeadm, kubespray</li>
                    <li>Any infrastructure: bare metal, VMs, cloud</li>
                </ul>
                <p class='info-note'><em>Note: Requires more operational expertise. You manage everything.</em></p>"),

            Distribution.Rancher => ("Rancher (On-Prem)", @"
                <div class='info-section'>
                    <p class='info-vendor'><strong>Vendor:</strong> SUSE</p>
                    <p class='info-desc'>Multi-cluster Kubernetes management platform. Simplifies deployment and operations across any infrastructure. Self-managed on-premises.</p>
                </div>
                <h4>Node Architecture</h4>
                <ul>
                    <li><strong>Control Plane:</strong> 3 master nodes for HA (RKE2/K3s)</li>
                    <li><strong>Worker:</strong> Application workload nodes</li>
                    <li><strong>Rancher Server:</strong> Management cluster (separate)</li>
                </ul>
                <h4>Key Features</h4>
                <ul>
                    <li>Multi-cluster management UI</li>
                    <li>App catalog and Helm integration</li>
                    <li>Built-in monitoring (Prometheus/Grafana)</li>
                    <li>Fleet for GitOps at scale</li>
                    <li>Supports RKE2, K3s, EKS, AKS, GKE</li>
                </ul>
                <h4>Sizing Notes</h4>
                <ul>
                    <li>Master: 4 vCPU, 16 GB RAM, 100 GB disk (prod)</li>
                    <li>Worker: 8 vCPU, 32 GB RAM, 100 GB disk (prod)</li>
                </ul>
                <p class='info-note'><em>Note: Open source with enterprise support available.</em></p>"),

            Distribution.RancherHosted => ("Rancher Hosted (Cloud)", @"
                <div class='info-section'>
                    <p class='info-vendor'><strong>Vendor:</strong> SUSE</p>
                    <p class='info-desc'>Cloud-hosted Rancher management service. Control plane managed by SUSE - you manage downstream clusters.</p>
                </div>
                <h4>Node Architecture</h4>
                <ul>
                    <li><strong>Control Plane:</strong> Managed by SUSE (0 customer-managed masters)</li>
                    <li><strong>Worker:</strong> Application workload nodes</li>
                    <li><strong>Downstream Clusters:</strong> Can be any K8s distribution</li>
                </ul>
                <h4>Key Features</h4>
                <ul>
                    <li>Zero control plane management overhead</li>
                    <li>Same Rancher UI and features</li>
                    <li>Multi-cluster management across clouds</li>
                    <li>Fleet GitOps included</li>
                    <li>Enterprise support from SUSE</li>
                </ul>
                <h4>Pricing</h4>
                <ul>
                    <li>Per managed cluster fee</li>
                    <li>Worker nodes: Your cloud provider pricing</li>
                </ul>
                <p class='info-note'><em>Note: Best for multi-cloud management without self-hosting Rancher.</em></p>"),

            Distribution.K3s => ("K3s (Lightweight)", @"
                <div class='info-section'>
                    <p class='info-vendor'><strong>Vendor:</strong> SUSE</p>
                    <p class='info-desc'>Lightweight Kubernetes designed for edge computing, IoT, CI/CD, and resource-constrained environments.</p>
                </div>
                <h4>Node Architecture</h4>
                <ul>
                    <li><strong>Server:</strong> Combined control plane + etcd (3 for HA)</li>
                    <li><strong>Agent:</strong> Worker nodes</li>
                    <li><em>Single binary ~50MB</em></li>
                </ul>
                <h4>Key Features</h4>
                <ul>
                    <li>Minimal resource footprint (512MB RAM)</li>
                    <li>Built-in: Traefik, local-path-provisioner, CoreDNS</li>
                    <li>ARM64 and ARMv7 support</li>
                    <li>Embedded SQLite (single node) or etcd (HA)</li>
                    <li>CNCF certified conformant</li>
                </ul>
                <h4>Deployment Options</h4>
                <ul>
                    <li>Edge devices and IoT</li>
                    <li>Development environments</li>
                    <li>CI/CD runners</li>
                </ul>
                <p class='info-note'><em>Note: Great for dev/test but also production-ready for edge.</em></p>"),

            Distribution.MicroK8s => ("MicroK8s (Canonical)", @"
                <div class='info-section'>
                    <p class='info-vendor'><strong>Vendor:</strong> Canonical (Ubuntu)</p>
                    <p class='info-desc'>Low-ops, minimal Kubernetes for developers, edge, and IoT. Single-package installation with optional add-ons.</p>
                </div>
                <h4>Node Architecture</h4>
                <ul>
                    <li><strong>Control Plane:</strong> Embedded in every node</li>
                    <li><strong>HA Mode:</strong> 3+ nodes with dqlite (distributed SQLite)</li>
                    <li><strong>Single Node:</strong> All-in-one deployment option</li>
                </ul>
                <h4>Key Features</h4>
                <ul>
                    <li>Single snap package installation</li>
                    <li>Built-in add-ons (dns, dashboard, storage, gpu, istio)</li>
                    <li>Strict confinement with AppArmor</li>
                    <li>Automatic security updates</li>
                    <li>CNCF certified conformant</li>
                </ul>
                <h4>Sizing Notes</h4>
                <ul>
                    <li>Minimum: 1 vCPU, 1 GB RAM</li>
                    <li>Recommended: 2 vCPU, 4 GB RAM, 50 GB disk</li>
                </ul>
                <p class='info-note'><em>Note: Best for developers, CI/CD, and edge deployments on Ubuntu.</em></p>"),

            Distribution.Charmed => ("Charmed Kubernetes (Canonical)", @"
                <div class='info-section'>
                    <p class='info-vendor'><strong>Vendor:</strong> Canonical (Ubuntu)</p>
                    <p class='info-desc'>Production-grade Kubernetes built with Juju operators. Full enterprise features with model-driven operations.</p>
                </div>
                <h4>Node Architecture</h4>
                <ul>
                    <li><strong>Control Plane:</strong> 3 master nodes (HA with etcd)</li>
                    <li><strong>Worker:</strong> Application workload nodes</li>
                    <li><strong>Operators:</strong> Juju charms for each component</li>
                </ul>
                <h4>Key Features</h4>
                <ul>
                    <li>Model-driven operations with Juju</li>
                    <li>Automated day-2 operations (upgrades, scaling)</li>
                    <li>Integration with OpenStack, VMware, MAAS</li>
                    <li>Calico, Flannel, or Tigera CNI options</li>
                    <li>Ubuntu Pro support available</li>
                </ul>
                <h4>Sizing Notes</h4>
                <ul>
                    <li>Master: 4 vCPU, 16 GB RAM, 100 GB disk (prod)</li>
                    <li>Worker: 8 vCPU, 32 GB RAM, 100 GB disk (prod)</li>
                </ul>
                <p class='info-note'><em>Note: Best for enterprises using Juju for infrastructure automation.</em></p>"),

            Distribution.Tanzu => ("VMware Tanzu (On-Prem)", @"
                <div class='info-section'>
                    <p class='info-vendor'><strong>Vendor:</strong> Broadcom (formerly VMware)</p>
                    <p class='info-desc'>Enterprise Kubernetes platform integrated with vSphere. Kubernetes for VMware environments.</p>
                </div>
                <h4>Node Architecture</h4>
                <ul>
                    <li><strong>Supervisor Cluster:</strong> Runs on vSphere ESXi hosts</li>
                    <li><strong>Workload Cluster:</strong> Tanzu Kubernetes Grid clusters</li>
                    <li><strong>Control Plane:</strong> 3 master nodes per cluster</li>
                </ul>
                <h4>Key Features</h4>
                <ul>
                    <li>vSphere with Tanzu (integrated with vCenter)</li>
                    <li>Harbor container registry included</li>
                    <li>NSX-T networking integration</li>
                    <li>vSphere Pod Service (run pods on ESXi)</li>
                    <li>Tanzu Mission Control for multi-cluster</li>
                </ul>
                <h4>Sizing Notes</h4>
                <ul>
                    <li>Master: 4 vCPU, 16 GB RAM, 100 GB disk (prod)</li>
                    <li>Worker: 8 vCPU, 32 GB RAM, 100 GB disk (prod)</li>
                </ul>
                <p class='info-note'><em>Note: Best for existing VMware shops wanting Kubernetes on vSphere.</em></p>"),

            Distribution.TanzuCloud => ("VMware Tanzu Cloud", @"
                <div class='info-section'>
                    <p class='info-vendor'><strong>Vendor:</strong> Broadcom (formerly VMware)</p>
                    <p class='info-desc'>Cloud-managed Tanzu Kubernetes service. Fully managed control plane with multi-cloud support.</p>
                </div>
                <h4>Node Architecture</h4>
                <ul>
                    <li><strong>Control Plane:</strong> Managed by VMware (0 customer-managed masters)</li>
                    <li><strong>Worker:</strong> Customer-managed nodes on any cloud</li>
                    <li><strong>Multi-cloud:</strong> AWS, Azure, or on-premises</li>
                </ul>
                <h4>Key Features</h4>
                <ul>
                    <li>Tanzu Mission Control (TMC) management</li>
                    <li>Policy-as-code enforcement</li>
                    <li>Data protection with Velero</li>
                    <li>Multi-cluster networking</li>
                    <li>Integrated observability</li>
                </ul>
                <h4>Pricing</h4>
                <ul>
                    <li>Subscription-based per cluster</li>
                    <li>Worker nodes: Cloud provider pricing</li>
                </ul>
                <p class='info-note'><em>Note: Best for multi-cloud Kubernetes with centralized management.</em></p>"),

            Distribution.EKS => ("Amazon EKS", @"
                <div class='info-section'>
                    <p class='info-vendor'><strong>Vendor:</strong> Amazon Web Services</p>
                    <p class='info-desc'>Managed Kubernetes service on AWS. AWS handles the control plane - you manage worker nodes.</p>
                </div>
                <h4>Node Architecture</h4>
                <ul>
                    <li><strong>Control Plane:</strong> Managed by AWS (HA across 3 AZs)</li>
                    <li><strong>Worker:</strong> EC2 instances or Fargate (serverless)</li>
                    <li><em>No infra nodes needed - use AWS services</em></li>
                </ul>
                <h4>Key Features</h4>
                <ul>
                    <li>Native AWS integrations (IAM, VPC, ALB, EBS)</li>
                    <li>Fargate for serverless containers</li>
                    <li>Managed node groups with auto-scaling</li>
                    <li>EKS Anywhere for on-premises</li>
                </ul>
                <h4>Pricing</h4>
                <ul>
                    <li>Cluster: $0.10/hour (~$73/month)</li>
                    <li>Worker nodes: EC2 pricing</li>
                    <li>Fargate: per vCPU/GB-hour</li>
                </ul>
                <p class='info-note'><em>Note: Best for AWS-native workloads. Deep integration with AWS ecosystem.</em></p>"),

            Distribution.AKS => ("Azure AKS", @"
                <div class='info-section'>
                    <p class='info-vendor'><strong>Vendor:</strong> Microsoft Azure</p>
                    <p class='info-desc'>Managed Kubernetes on Azure. Free control plane - pay only for worker nodes.</p>
                </div>
                <h4>Node Architecture</h4>
                <ul>
                    <li><strong>Control Plane:</strong> Managed by Azure (free)</li>
                    <li><strong>System Pool:</strong> For cluster services</li>
                    <li><strong>User Pool:</strong> Application workloads</li>
                </ul>
                <h4>Key Features</h4>
                <ul>
                    <li>Azure AD integration</li>
                    <li>Azure Monitor and Container Insights</li>
                    <li>Virtual Nodes (ACI) for burst scaling</li>
                    <li>Azure Arc for hybrid/multi-cloud</li>
                    <li>Best .NET and Windows container support</li>
                </ul>
                <h4>Pricing</h4>
                <ul>
                    <li>Cluster: FREE (control plane)</li>
                    <li>Uptime SLA: $0.10/hour (optional)</li>
                    <li>Worker nodes: VM pricing</li>
                </ul>
                <p class='info-note'><em>Note: Best for Microsoft shops and hybrid cloud with Azure Arc.</em></p>"),

            Distribution.GKE => ("Google GKE", @"
                <div class='info-section'>
                    <p class='info-vendor'><strong>Vendor:</strong> Google Cloud</p>
                    <p class='info-desc'>The original managed Kubernetes. Google invented Kubernetes (from Borg). Most mature managed offering.</p>
                </div>
                <h4>Node Architecture</h4>
                <ul>
                    <li><strong>Control Plane:</strong> Managed by Google</li>
                    <li><strong>Node Pools:</strong> Groups of identical VMs</li>
                    <li><strong>Autopilot:</strong> Fully managed (Google manages nodes too)</li>
                </ul>
                <h4>Key Features</h4>
                <ul>
                    <li>GKE Autopilot - zero node management</li>
                    <li>Anthos for multi-cloud/hybrid</li>
                    <li>Best-in-class auto-scaling</li>
                    <li>Release channels (rapid, regular, stable)</li>
                    <li>4-way autoscaling (HPA, VPA, CA, NAP)</li>
                </ul>
                <h4>Pricing</h4>
                <ul>
                    <li>Standard: $0.10/hour (~$73/month)</li>
                    <li>Autopilot: Per pod resource usage</li>
                    <li>Worker nodes: Compute Engine pricing</li>
                </ul>
                <p class='info-note'><em>Note: Best for pure Kubernetes experience. Most innovative features.</em></p>"),

            Distribution.OKE => ("Oracle OKE", @"
                <div class='info-section'>
                    <p class='info-vendor'><strong>Vendor:</strong> Oracle Cloud Infrastructure</p>
                    <p class='info-desc'>Managed Kubernetes on Oracle Cloud. Optimized for Oracle workloads and databases.</p>
                </div>
                <h4>Node Architecture</h4>
                <ul>
                    <li><strong>Control Plane:</strong> Managed by Oracle (free)</li>
                    <li><strong>Node Pools:</strong> Worker node groups</li>
                    <li><strong>Virtual Nodes:</strong> Serverless option</li>
                </ul>
                <h4>Key Features</h4>
                <ul>
                    <li>Native Oracle DB integration</li>
                    <li>OCI Registry included</li>
                    <li>Flexible shapes (custom CPU/RAM ratios)</li>
                    <li>Arm-based Ampere nodes available</li>
                    <li>Free control plane</li>
                </ul>
                <h4>Pricing</h4>
                <ul>
                    <li>Cluster: FREE (control plane)</li>
                    <li>Worker nodes: OCI Compute pricing</li>
                    <li>Competitive pricing vs other clouds</li>
                </ul>
                <p class='info-note'><em>Note: Best for Oracle Database workloads and Java applications.</em></p>"),

            Distribution.RKE2 => ("RKE2 (Rancher Kubernetes Engine)", @"
                <div class='info-section'>
                    <p class='info-vendor'><strong>Vendor:</strong> SUSE</p>
                    <p class='info-desc'>Security-focused Kubernetes distribution. Also known as RKE Government. FIPS 140-2 compliant with CIS hardening.</p>
                </div>
                <h4>Node Architecture</h4>
                <ul>
                    <li><strong>Server:</strong> Control plane + etcd (3 for HA)</li>
                    <li><strong>Agent:</strong> Worker nodes</li>
                    <li><em>Single binary deployment like K3s</em></li>
                </ul>
                <h4>Key Features</h4>
                <ul>
                    <li>FIPS 140-2 compliance</li>
                    <li>CIS Benchmark hardening out-of-box</li>
                    <li>SELinux support</li>
                    <li>Embedded etcd (no external dependency)</li>
                    <li>Air-gap deployment support</li>
                </ul>
                <h4>Sizing Notes</h4>
                <ul>
                    <li>Server: 4 vCPU, 8 GB RAM, 100 GB disk</li>
                    <li>Agent: 4 vCPU, 8 GB RAM, 50 GB disk</li>
                </ul>
                <p class='info-note'><em>Note: Best for government, defense, and high-security environments.</em></p>"),

            Distribution.OpenShiftDedicated => ("OpenShift Dedicated (GCP)", @"
                <div class='info-section'>
                    <p class='info-vendor'><strong>Vendor:</strong> Red Hat</p>
                    <p class='info-desc'>Fully managed OpenShift on Google Cloud Platform. Red Hat manages the entire stack.</p>
                </div>
                <h4>Node Architecture</h4>
                <ul>
                    <li><strong>Control Plane:</strong> Fully managed by Red Hat</li>
                    <li><strong>Infrastructure:</strong> Managed nodes for cluster services</li>
                    <li><strong>Worker:</strong> Application workload nodes (GCE)</li>
                </ul>
                <h4>Key Features</h4>
                <ul>
                    <li>SLA-backed managed service (99.95%)</li>
                    <li>GCP native integrations</li>
                    <li>Anthos compatibility</li>
                    <li>Red Hat support included</li>
                    <li>Customer Cloud Subscription (CCS) option</li>
                </ul>
                <h4>Pricing</h4>
                <ul>
                    <li>Base cluster fee + per-worker pricing</li>
                    <li>GCE instances: Standard GCP pricing</li>
                </ul>
                <p class='info-note'><em>Note: Best for enterprises wanting OpenShift on GCP with full management.</em></p>"),

            Distribution.OpenShiftIBM => ("Red Hat OpenShift on IBM Cloud", @"
                <div class='info-section'>
                    <p class='info-vendor'><strong>Vendor:</strong> Red Hat (IBM)</p>
                    <p class='info-desc'>Managed OpenShift on IBM Cloud. Deep integration with IBM Cloud services and Watson AI.</p>
                </div>
                <h4>Node Architecture</h4>
                <ul>
                    <li><strong>Control Plane:</strong> Managed by IBM</li>
                    <li><strong>Worker:</strong> IBM Cloud virtual servers</li>
                    <li><strong>Satellite:</strong> Extend to on-premises/edge</li>
                </ul>
                <h4>Key Features</h4>
                <ul>
                    <li>Watson AI/ML integrations</li>
                    <li>IBM Cloud Pak support</li>
                    <li>IBM Cloud Satellite for hybrid</li>
                    <li>Integrated IBM Cloud services</li>
                    <li>Compliance certifications (SOC2, HIPAA)</li>
                </ul>
                <h4>Pricing</h4>
                <ul>
                    <li>Cluster fee: IBM Cloud pricing</li>
                    <li>Worker nodes: Virtual server pricing</li>
                </ul>
                <p class='info-note'><em>Note: Best for enterprises using IBM Cloud Paks and Watson services.</em></p>"),

            Distribution.RancherEKS => ("Rancher on Amazon EKS", @"
                <div class='info-section'>
                    <p class='info-vendor'><strong>Vendor:</strong> SUSE + AWS</p>
                    <p class='info-desc'>EKS clusters managed through Rancher. Combines AWS managed Kubernetes with Rancher's multi-cluster management.</p>
                </div>
                <h4>Node Architecture</h4>
                <ul>
                    <li><strong>Control Plane:</strong> Managed by AWS (EKS)</li>
                    <li><strong>Worker:</strong> EC2 instances</li>
                    <li><strong>Rancher:</strong> Manages cluster lifecycle</li>
                </ul>
                <h4>Key Features</h4>
                <ul>
                    <li>EKS control plane + Rancher management</li>
                    <li>Multi-cluster visibility in Rancher UI</li>
                    <li>Fleet GitOps for EKS clusters</li>
                    <li>Native AWS integrations preserved</li>
                    <li>Unified policy across clouds</li>
                </ul>
                <h4>Pricing</h4>
                <ul>
                    <li>EKS: $0.10/hour (~$73/month)</li>
                    <li>EC2 workers: AWS pricing</li>
                    <li>Rancher: Optional enterprise support</li>
                </ul>
                <p class='info-note'><em>Note: Best for multi-cloud management including AWS EKS clusters.</em></p>"),

            Distribution.RancherAKS => ("Rancher on Azure AKS", @"
                <div class='info-section'>
                    <p class='info-vendor'><strong>Vendor:</strong> SUSE + Microsoft</p>
                    <p class='info-desc'>AKS clusters managed through Rancher. Azure managed Kubernetes with Rancher's multi-cluster capabilities.</p>
                </div>
                <h4>Node Architecture</h4>
                <ul>
                    <li><strong>Control Plane:</strong> Managed by Azure (free)</li>
                    <li><strong>Worker:</strong> Azure VMs</li>
                    <li><strong>Rancher:</strong> Manages cluster lifecycle</li>
                </ul>
                <h4>Key Features</h4>
                <ul>
                    <li>Free AKS control plane</li>
                    <li>Rancher multi-cluster management</li>
                    <li>Azure AD integration through AKS</li>
                    <li>Fleet GitOps deployment</li>
                    <li>Unified monitoring across clouds</li>
                </ul>
                <h4>Pricing</h4>
                <ul>
                    <li>AKS: FREE (control plane)</li>
                    <li>Azure VMs: Standard pricing</li>
                    <li>Rancher: Optional enterprise support</li>
                </ul>
                <p class='info-note'><em>Note: Best for managing AKS as part of a multi-cloud strategy.</em></p>"),

            Distribution.RancherGKE => ("Rancher on Google GKE", @"
                <div class='info-section'>
                    <p class='info-vendor'><strong>Vendor:</strong> SUSE + Google</p>
                    <p class='info-desc'>GKE clusters managed through Rancher. Google's managed Kubernetes with Rancher's unified management.</p>
                </div>
                <h4>Node Architecture</h4>
                <ul>
                    <li><strong>Control Plane:</strong> Managed by Google</li>
                    <li><strong>Worker:</strong> GCE instances</li>
                    <li><strong>Rancher:</strong> Manages cluster lifecycle</li>
                </ul>
                <h4>Key Features</h4>
                <ul>
                    <li>GKE autopilot or standard mode</li>
                    <li>Rancher multi-cluster dashboard</li>
                    <li>Fleet GitOps across clouds</li>
                    <li>GKE release channels preserved</li>
                    <li>Unified RBAC management</li>
                </ul>
                <h4>Pricing</h4>
                <ul>
                    <li>GKE: $0.10/hour (~$73/month)</li>
                    <li>GCE workers: GCP pricing</li>
                    <li>Rancher: Optional enterprise support</li>
                </ul>
                <p class='info-note'><em>Note: Best for including GKE in a multi-cloud Rancher environment.</em></p>"),

            Distribution.TanzuAWS => ("VMware Tanzu on AWS", @"
                <div class='info-section'>
                    <p class='info-vendor'><strong>Vendor:</strong> Broadcom (VMware)</p>
                    <p class='info-desc'>Tanzu Kubernetes Grid running on AWS. Enterprise Kubernetes with VMware management on AWS infrastructure.</p>
                </div>
                <h4>Node Architecture</h4>
                <ul>
                    <li><strong>Management Cluster:</strong> Manages workload clusters</li>
                    <li><strong>Workload Clusters:</strong> Application environments</li>
                    <li><strong>All nodes:</strong> EC2 instances</li>
                </ul>
                <h4>Key Features</h4>
                <ul>
                    <li>Tanzu Mission Control integration</li>
                    <li>Cluster API for lifecycle management</li>
                    <li>AWS native integrations (ALB, EBS)</li>
                    <li>Consistent experience across clouds</li>
                    <li>VMware support</li>
                </ul>
                <h4>Pricing</h4>
                <ul>
                    <li>Tanzu subscription per cluster</li>
                    <li>EC2 instances: AWS pricing</li>
                </ul>
                <p class='info-note'><em>Note: Best for VMware shops extending to AWS with consistent tooling.</em></p>"),

            Distribution.TanzuAzure => ("VMware Tanzu on Azure", @"
                <div class='info-section'>
                    <p class='info-vendor'><strong>Vendor:</strong> Broadcom (VMware)</p>
                    <p class='info-desc'>Tanzu Kubernetes Grid on Azure. VMware's enterprise Kubernetes on Microsoft Azure.</p>
                </div>
                <h4>Node Architecture</h4>
                <ul>
                    <li><strong>Management Cluster:</strong> Manages workload clusters</li>
                    <li><strong>Workload Clusters:</strong> Application environments</li>
                    <li><strong>All nodes:</strong> Azure VMs</li>
                </ul>
                <h4>Key Features</h4>
                <ul>
                    <li>Tanzu Mission Control</li>
                    <li>Azure integration (Azure AD, Azure Monitor)</li>
                    <li>Cluster API automation</li>
                    <li>Multi-cloud consistency</li>
                    <li>VMware enterprise support</li>
                </ul>
                <h4>Pricing</h4>
                <ul>
                    <li>Tanzu subscription per cluster</li>
                    <li>Azure VMs: Standard pricing</li>
                </ul>
                <p class='info-note'><em>Note: Best for VMware environments extending to Azure.</em></p>"),

            Distribution.TanzuGCP => ("VMware Tanzu on GCP", @"
                <div class='info-section'>
                    <p class='info-vendor'><strong>Vendor:</strong> Broadcom (VMware)</p>
                    <p class='info-desc'>Tanzu Kubernetes Grid on Google Cloud. VMware enterprise Kubernetes on GCP infrastructure.</p>
                </div>
                <h4>Node Architecture</h4>
                <ul>
                    <li><strong>Management Cluster:</strong> Manages workload clusters</li>
                    <li><strong>Workload Clusters:</strong> Application environments</li>
                    <li><strong>All nodes:</strong> GCE instances</li>
                </ul>
                <h4>Key Features</h4>
                <ul>
                    <li>Tanzu Mission Control</li>
                    <li>GCP native integrations</li>
                    <li>Anthos interoperability</li>
                    <li>Cluster API automation</li>
                    <li>VMware enterprise support</li>
                </ul>
                <h4>Pricing</h4>
                <ul>
                    <li>Tanzu subscription per cluster</li>
                    <li>GCE instances: GCP pricing</li>
                </ul>
                <p class='info-note'><em>Note: Best for VMware environments extending to GCP.</em></p>"),

            Distribution.CharmedAWS => ("Charmed Kubernetes on AWS", @"
                <div class='info-section'>
                    <p class='info-vendor'><strong>Vendor:</strong> Canonical</p>
                    <p class='info-desc'>Charmed Kubernetes deployed on AWS EC2. Juju-managed Kubernetes with Ubuntu Pro support on AWS.</p>
                </div>
                <h4>Node Architecture</h4>
                <ul>
                    <li><strong>Control Plane:</strong> 3 master nodes (EC2)</li>
                    <li><strong>Worker:</strong> EC2 instances</li>
                    <li><strong>Juju Controller:</strong> Manages deployment</li>
                </ul>
                <h4>Key Features</h4>
                <ul>
                    <li>Juju model-driven operations</li>
                    <li>AWS integrations (EBS, ELB, IAM)</li>
                    <li>Ubuntu Pro security updates</li>
                    <li>Automated day-2 operations</li>
                    <li>Canonical support</li>
                </ul>
                <h4>Pricing</h4>
                <ul>
                    <li>EC2 instances: AWS pricing</li>
                    <li>Ubuntu Pro: Optional support subscription</li>
                </ul>
                <p class='info-note'><em>Note: Best for Juju/Ubuntu shops deploying on AWS.</em></p>"),

            Distribution.CharmedAzure => ("Charmed Kubernetes on Azure", @"
                <div class='info-section'>
                    <p class='info-vendor'><strong>Vendor:</strong> Canonical</p>
                    <p class='info-desc'>Charmed Kubernetes on Azure VMs. Model-driven Kubernetes with Ubuntu Pro on Microsoft Azure.</p>
                </div>
                <h4>Node Architecture</h4>
                <ul>
                    <li><strong>Control Plane:</strong> 3 master nodes (Azure VMs)</li>
                    <li><strong>Worker:</strong> Azure VMs</li>
                    <li><strong>Juju Controller:</strong> Manages deployment</li>
                </ul>
                <h4>Key Features</h4>
                <ul>
                    <li>Juju model-driven operations</li>
                    <li>Azure integrations (Disks, LB)</li>
                    <li>Ubuntu Pro on Azure marketplace</li>
                    <li>Automated upgrades and scaling</li>
                    <li>Canonical support</li>
                </ul>
                <h4>Pricing</h4>
                <ul>
                    <li>Azure VMs: Standard pricing</li>
                    <li>Ubuntu Pro: Optional support</li>
                </ul>
                <p class='info-note'><em>Note: Best for Juju/Ubuntu environments on Azure.</em></p>"),

            Distribution.CharmedGCP => ("Charmed Kubernetes on GCP", @"
                <div class='info-section'>
                    <p class='info-vendor'><strong>Vendor:</strong> Canonical</p>
                    <p class='info-desc'>Charmed Kubernetes on Google Cloud. Juju-managed Kubernetes with Ubuntu Pro on GCP.</p>
                </div>
                <h4>Node Architecture</h4>
                <ul>
                    <li><strong>Control Plane:</strong> 3 master nodes (GCE)</li>
                    <li><strong>Worker:</strong> GCE instances</li>
                    <li><strong>Juju Controller:</strong> Manages deployment</li>
                </ul>
                <h4>Key Features</h4>
                <ul>
                    <li>Juju model-driven operations</li>
                    <li>GCP integrations (PD, Cloud LB)</li>
                    <li>Ubuntu Pro support</li>
                    <li>Automated cluster lifecycle</li>
                    <li>Canonical enterprise support</li>
                </ul>
                <h4>Pricing</h4>
                <ul>
                    <li>GCE instances: GCP pricing</li>
                    <li>Ubuntu Pro: Optional support</li>
                </ul>
                <p class='info-note'><em>Note: Best for Juju/Ubuntu deployments on GCP.</em></p>"),

            Distribution.MicroK8sAWS => ("MicroK8s on AWS", @"
                <div class='info-section'>
                    <p class='info-vendor'><strong>Vendor:</strong> Canonical</p>
                    <p class='info-desc'>Lightweight MicroK8s deployed on AWS EC2. Minimal Kubernetes with snap-based deployment.</p>
                </div>
                <h4>Node Architecture</h4>
                <ul>
                    <li><strong>Single Node:</strong> All-in-one deployment</li>
                    <li><strong>HA Mode:</strong> 3+ nodes with dqlite</li>
                    <li><strong>EC2:</strong> Any Ubuntu instance</li>
                </ul>
                <h4>Key Features</h4>
                <ul>
                    <li>Single snap installation</li>
                    <li>Low resource overhead</li>
                    <li>Built-in add-ons ecosystem</li>
                    <li>Auto-updates via snap</li>
                    <li>AWS integrations via add-ons</li>
                </ul>
                <h4>Pricing</h4>
                <ul>
                    <li>EC2 instances: AWS pricing</li>
                    <li>MicroK8s: Free (open source)</li>
                </ul>
                <p class='info-note'><em>Note: Best for dev/test and edge workloads on AWS.</em></p>"),

            Distribution.MicroK8sAzure => ("MicroK8s on Azure", @"
                <div class='info-section'>
                    <p class='info-vendor'><strong>Vendor:</strong> Canonical</p>
                    <p class='info-desc'>Lightweight MicroK8s on Azure VMs. Snap-packaged Kubernetes on Microsoft Azure.</p>
                </div>
                <h4>Node Architecture</h4>
                <ul>
                    <li><strong>Single Node:</strong> All-in-one deployment</li>
                    <li><strong>HA Mode:</strong> 3+ nodes with dqlite</li>
                    <li><strong>Azure VMs:</strong> Ubuntu marketplace images</li>
                </ul>
                <h4>Key Features</h4>
                <ul>
                    <li>Single snap installation</li>
                    <li>Minimal footprint</li>
                    <li>Built-in add-ons</li>
                    <li>Azure Disk CSI via add-on</li>
                    <li>Automatic security updates</li>
                </ul>
                <h4>Pricing</h4>
                <ul>
                    <li>Azure VMs: Standard pricing</li>
                    <li>MicroK8s: Free (open source)</li>
                </ul>
                <p class='info-note'><em>Note: Best for dev/test environments on Azure.</em></p>"),

            Distribution.MicroK8sGCP => ("MicroK8s on GCP", @"
                <div class='info-section'>
                    <p class='info-vendor'><strong>Vendor:</strong> Canonical</p>
                    <p class='info-desc'>Lightweight MicroK8s on Google Cloud. Snap-based Kubernetes on GCE instances.</p>
                </div>
                <h4>Node Architecture</h4>
                <ul>
                    <li><strong>Single Node:</strong> All-in-one deployment</li>
                    <li><strong>HA Mode:</strong> 3+ nodes with dqlite</li>
                    <li><strong>GCE:</strong> Ubuntu images</li>
                </ul>
                <h4>Key Features</h4>
                <ul>
                    <li>Single snap installation</li>
                    <li>Low resource requirements</li>
                    <li>Built-in add-ons ecosystem</li>
                    <li>GCP PD CSI via add-on</li>
                    <li>Auto security updates</li>
                </ul>
                <h4>Pricing</h4>
                <ul>
                    <li>GCE instances: GCP pricing</li>
                    <li>MicroK8s: Free (open source)</li>
                </ul>
                <p class='info-note'><em>Note: Best for dev/test and lightweight workloads on GCP.</em></p>"),

            Distribution.K3sAWS => ("K3s on AWS", @"
                <div class='info-section'>
                    <p class='info-vendor'><strong>Vendor:</strong> SUSE</p>
                    <p class='info-desc'>Lightweight K3s deployed on AWS EC2. Minimal Kubernetes for edge and development on AWS.</p>
                </div>
                <h4>Node Architecture</h4>
                <ul>
                    <li><strong>Server:</strong> Control plane (3 for HA)</li>
                    <li><strong>Agent:</strong> Worker nodes</li>
                    <li><strong>EC2:</strong> Any Linux instance</li>
                </ul>
                <h4>Key Features</h4>
                <ul>
                    <li>Single binary (~50MB)</li>
                    <li>512MB RAM minimum</li>
                    <li>Built-in Traefik ingress</li>
                    <li>AWS integrations possible</li>
                    <li>CNCF certified</li>
                </ul>
                <h4>Pricing</h4>
                <ul>
                    <li>EC2 instances: AWS pricing</li>
                    <li>K3s: Free (open source)</li>
                </ul>
                <p class='info-note'><em>Note: Best for edge, IoT, and dev environments on AWS.</em></p>"),

            Distribution.K3sAzure => ("K3s on Azure", @"
                <div class='info-section'>
                    <p class='info-vendor'><strong>Vendor:</strong> SUSE</p>
                    <p class='info-desc'>Lightweight K3s on Azure VMs. Minimal Kubernetes footprint on Microsoft Azure.</p>
                </div>
                <h4>Node Architecture</h4>
                <ul>
                    <li><strong>Server:</strong> Control plane (3 for HA)</li>
                    <li><strong>Agent:</strong> Worker nodes</li>
                    <li><strong>Azure VMs:</strong> Any Linux VM</li>
                </ul>
                <h4>Key Features</h4>
                <ul>
                    <li>Single binary deployment</li>
                    <li>Minimal resource usage</li>
                    <li>Built-in load balancer</li>
                    <li>Azure Arc compatible</li>
                    <li>CNCF certified</li>
                </ul>
                <h4>Pricing</h4>
                <ul>
                    <li>Azure VMs: Standard pricing</li>
                    <li>K3s: Free (open source)</li>
                </ul>
                <p class='info-note'><em>Note: Best for edge and dev workloads on Azure.</em></p>"),

            Distribution.K3sGCP => ("K3s on GCP", @"
                <div class='info-section'>
                    <p class='info-vendor'><strong>Vendor:</strong> SUSE</p>
                    <p class='info-desc'>Lightweight K3s on Google Cloud. Minimal Kubernetes on GCE instances.</p>
                </div>
                <h4>Node Architecture</h4>
                <ul>
                    <li><strong>Server:</strong> Control plane (3 for HA)</li>
                    <li><strong>Agent:</strong> Worker nodes</li>
                    <li><strong>GCE:</strong> Any Linux instance</li>
                </ul>
                <h4>Key Features</h4>
                <ul>
                    <li>Single binary (~50MB)</li>
                    <li>Low resource footprint</li>
                    <li>Built-in Traefik ingress</li>
                    <li>GCP integrations</li>
                    <li>CNCF certified</li>
                </ul>
                <h4>Pricing</h4>
                <ul>
                    <li>GCE instances: GCP pricing</li>
                    <li>K3s: Free (open source)</li>
                </ul>
                <p class='info-note'><em>Note: Best for edge, dev, and lightweight workloads on GCP.</em></p>"),

            Distribution.RKE2AWS => ("RKE2 on AWS", @"
                <div class='info-section'>
                    <p class='info-vendor'><strong>Vendor:</strong> SUSE</p>
                    <p class='info-desc'>Security-hardened RKE2 on AWS EC2. FIPS-compliant Kubernetes on Amazon Web Services.</p>
                </div>
                <h4>Node Architecture</h4>
                <ul>
                    <li><strong>Server:</strong> Control plane (3 for HA)</li>
                    <li><strong>Agent:</strong> Worker nodes</li>
                    <li><strong>EC2:</strong> Linux instances</li>
                </ul>
                <h4>Key Features</h4>
                <ul>
                    <li>FIPS 140-2 compliance</li>
                    <li>CIS hardening out-of-box</li>
                    <li>AWS integrations (EBS CSI, ALB)</li>
                    <li>Air-gap deployment support</li>
                    <li>Government/defense ready</li>
                </ul>
                <h4>Pricing</h4>
                <ul>
                    <li>EC2 instances: AWS pricing</li>
                    <li>RKE2: Free (open source)</li>
                    <li>Enterprise support: Optional</li>
                </ul>
                <p class='info-note'><em>Note: Best for regulated/government workloads on AWS.</em></p>"),

            Distribution.RKE2Azure => ("RKE2 on Azure", @"
                <div class='info-section'>
                    <p class='info-vendor'><strong>Vendor:</strong> SUSE</p>
                    <p class='info-desc'>Security-hardened RKE2 on Azure VMs. FIPS-compliant Kubernetes on Microsoft Azure.</p>
                </div>
                <h4>Node Architecture</h4>
                <ul>
                    <li><strong>Server:</strong> Control plane (3 for HA)</li>
                    <li><strong>Agent:</strong> Worker nodes</li>
                    <li><strong>Azure VMs:</strong> Linux instances</li>
                </ul>
                <h4>Key Features</h4>
                <ul>
                    <li>FIPS 140-2 compliance</li>
                    <li>CIS Benchmark hardening</li>
                    <li>Azure integrations (Disks, LB)</li>
                    <li>Azure Government support</li>
                    <li>Air-gap capable</li>
                </ul>
                <h4>Pricing</h4>
                <ul>
                    <li>Azure VMs: Standard pricing</li>
                    <li>RKE2: Free (open source)</li>
                    <li>Enterprise support: Optional</li>
                </ul>
                <p class='info-note'><em>Note: Best for government/regulated workloads on Azure.</em></p>"),

            Distribution.RKE2GCP => ("RKE2 on GCP", @"
                <div class='info-section'>
                    <p class='info-vendor'><strong>Vendor:</strong> SUSE</p>
                    <p class='info-desc'>Security-hardened RKE2 on Google Cloud. FIPS-compliant Kubernetes on GCP.</p>
                </div>
                <h4>Node Architecture</h4>
                <ul>
                    <li><strong>Server:</strong> Control plane (3 for HA)</li>
                    <li><strong>Agent:</strong> Worker nodes</li>
                    <li><strong>GCE:</strong> Linux instances</li>
                </ul>
                <h4>Key Features</h4>
                <ul>
                    <li>FIPS 140-2 compliance</li>
                    <li>CIS hardening out-of-box</li>
                    <li>GCP integrations (PD CSI)</li>
                    <li>Air-gap deployment</li>
                    <li>Security-first design</li>
                </ul>
                <h4>Pricing</h4>
                <ul>
                    <li>GCE instances: GCP pricing</li>
                    <li>RKE2: Free (open source)</li>
                    <li>Enterprise support: Optional</li>
                </ul>
                <p class='info-note'><em>Note: Best for security-sensitive workloads on GCP.</em></p>"),

            Distribution.IKS => ("IBM Kubernetes Service (IKS)", @"
                <div class='info-section'>
                    <p class='info-vendor'><strong>Vendor:</strong> IBM Cloud</p>
                    <p class='info-desc'>Managed Kubernetes on IBM Cloud. Native integration with IBM Cloud services and Watson AI.</p>
                </div>
                <h4>Node Architecture</h4>
                <ul>
                    <li><strong>Control Plane:</strong> Managed by IBM</li>
                    <li><strong>Worker:</strong> IBM Cloud virtual servers</li>
                    <li><strong>Satellite:</strong> Extend to on-prem/edge</li>
                </ul>
                <h4>Key Features</h4>
                <ul>
                    <li>Watson AI/ML integration</li>
                    <li>IBM Cloud services native</li>
                    <li>IBM Cloud Satellite support</li>
                    <li>Vulnerability Advisor included</li>
                    <li>Compliance certifications</li>
                </ul>
                <h4>Pricing</h4>
                <ul>
                    <li>Control plane: Included</li>
                    <li>Worker nodes: Virtual server pricing</li>
                </ul>
                <p class='info-note'><em>Note: Best for IBM Cloud workloads and Watson AI integration.</em></p>"),

            Distribution.ACK => ("Alibaba Container Service (ACK)", @"
                <div class='info-section'>
                    <p class='info-vendor'><strong>Vendor:</strong> Alibaba Cloud</p>
                    <p class='info-desc'>Managed Kubernetes on Alibaba Cloud. Largest cloud provider in Asia Pacific region.</p>
                </div>
                <h4>Node Architecture</h4>
                <ul>
                    <li><strong>Control Plane:</strong> Managed by Alibaba</li>
                    <li><strong>Worker:</strong> ECS instances</li>
                    <li><strong>Serverless:</strong> ASK (Alibaba Serverless K8s)</li>
                </ul>
                <h4>Key Features</h4>
                <ul>
                    <li>Deep Alibaba Cloud integration</li>
                    <li>Asia Pacific regional strength</li>
                    <li>China region availability</li>
                    <li>AI/ML integrations (PAI)</li>
                    <li>Serverless Kubernetes option</li>
                </ul>
                <h4>Pricing</h4>
                <ul>
                    <li>Professional: ~$0.09/hour</li>
                    <li>Worker nodes: ECS pricing</li>
                </ul>
                <p class='info-note'><em>Note: Best for workloads targeting China and APAC markets.</em></p>"),

            Distribution.TKE => ("Tencent Kubernetes Engine (TKE)", @"
                <div class='info-section'>
                    <p class='info-vendor'><strong>Vendor:</strong> Tencent Cloud</p>
                    <p class='info-desc'>Managed Kubernetes on Tencent Cloud. Strong in China market with gaming and social integrations.</p>
                </div>
                <h4>Node Architecture</h4>
                <ul>
                    <li><strong>Control Plane:</strong> Managed by Tencent</li>
                    <li><strong>Worker:</strong> CVM instances</li>
                    <li><strong>Serverless:</strong> EKS (Elastic Kubernetes Service)</li>
                </ul>
                <h4>Key Features</h4>
                <ul>
                    <li>China region coverage</li>
                    <li>Gaming workload optimized</li>
                    <li>WeChat Mini Program support</li>
                    <li>Tencent Cloud AI integration</li>
                    <li>Serverless container option</li>
                </ul>
                <h4>Pricing</h4>
                <ul>
                    <li>Managed cluster fee</li>
                    <li>CVM workers: Tencent pricing</li>
                </ul>
                <p class='info-note'><em>Note: Best for gaming, social, and China-focused workloads.</em></p>"),

            Distribution.CCE => ("Huawei Cloud Container Engine (CCE)", @"
                <div class='info-section'>
                    <p class='info-vendor'><strong>Vendor:</strong> Huawei Cloud</p>
                    <p class='info-desc'>Managed Kubernetes on Huawei Cloud. Enterprise-focused with strong telecommunications heritage.</p>
                </div>
                <h4>Node Architecture</h4>
                <ul>
                    <li><strong>Control Plane:</strong> Managed by Huawei</li>
                    <li><strong>Worker:</strong> ECS instances</li>
                    <li><strong>CCE Turbo:</strong> High-performance option</li>
                </ul>
                <h4>Key Features</h4>
                <ul>
                    <li>Enterprise and telecom focus</li>
                    <li>China and global regions</li>
                    <li>AI/ML ModelArts integration</li>
                    <li>CCE Turbo for performance</li>
                    <li>Multi-cloud management</li>
                </ul>
                <h4>Pricing</h4>
                <ul>
                    <li>Cluster management fee</li>
                    <li>ECS workers: Huawei pricing</li>
                </ul>
                <p class='info-note'><em>Note: Best for enterprise/telecom workloads, especially in Asia.</em></p>"),

            Distribution.DOKS => ("DigitalOcean Kubernetes (DOKS)", @"
                <div class='info-section'>
                    <p class='info-vendor'><strong>Vendor:</strong> DigitalOcean</p>
                    <p class='info-desc'>Simple, developer-friendly managed Kubernetes. No control plane fees with predictable pricing.</p>
                </div>
                <h4>Node Architecture</h4>
                <ul>
                    <li><strong>Control Plane:</strong> Managed (free)</li>
                    <li><strong>Worker:</strong> Droplets (VMs)</li>
                    <li><strong>Node Pools:</strong> Grouped by size</li>
                </ul>
                <h4>Key Features</h4>
                <ul>
                    <li>Free control plane</li>
                    <li>Simple, predictable pricing</li>
                    <li>Developer-friendly UI</li>
                    <li>1-click apps marketplace</li>
                    <li>Integrated load balancers</li>
                </ul>
                <h4>Pricing</h4>
                <ul>
                    <li>Control plane: FREE</li>
                    <li>Droplets: From $12/month</li>
                    <li>Block storage: $0.10/GB/month</li>
                </ul>
                <p class='info-note'><em>Note: Best for startups, developers, and cost-sensitive workloads.</em></p>"),

            Distribution.LKE => ("Linode Kubernetes Engine (LKE)", @"
                <div class='info-section'>
                    <p class='info-vendor'><strong>Vendor:</strong> Akamai (Linode)</p>
                    <p class='info-desc'>Managed Kubernetes from Linode (now Akamai). Simple pricing with global edge presence.</p>
                </div>
                <h4>Node Architecture</h4>
                <ul>
                    <li><strong>Control Plane:</strong> Managed (free)</li>
                    <li><strong>Worker:</strong> Linode instances</li>
                    <li><strong>Node Pools:</strong> Auto-scaling groups</li>
                </ul>
                <h4>Key Features</h4>
                <ul>
                    <li>Free control plane</li>
                    <li>Simple, transparent pricing</li>
                    <li>Akamai edge network</li>
                    <li>NodeBalancers included</li>
                    <li>Global data centers</li>
                </ul>
                <h4>Pricing</h4>
                <ul>
                    <li>Control plane: FREE</li>
                    <li>Linodes: From $12/month</li>
                    <li>Block storage: $0.10/GB/month</li>
                </ul>
                <p class='info-note'><em>Note: Best for developers wanting simple, predictable Kubernetes.</em></p>"),

            Distribution.VKE => ("Vultr Kubernetes Engine (VKE)", @"
                <div class='info-section'>
                    <p class='info-vendor'><strong>Vendor:</strong> Vultr</p>
                    <p class='info-desc'>Managed Kubernetes from Vultr. High-performance cloud with global presence and competitive pricing.</p>
                </div>
                <h4>Node Architecture</h4>
                <ul>
                    <li><strong>Control Plane:</strong> Managed (free)</li>
                    <li><strong>Worker:</strong> Vultr Cloud Compute</li>
                    <li><strong>Node Pools:</strong> Scalable groups</li>
                </ul>
                <h4>Key Features</h4>
                <ul>
                    <li>Free control plane</li>
                    <li>High-performance NVMe</li>
                    <li>32 global locations</li>
                    <li>Bare metal options</li>
                    <li>Simple API</li>
                </ul>
                <h4>Pricing</h4>
                <ul>
                    <li>Control plane: FREE</li>
                    <li>Compute: From $5/month</li>
                    <li>Block storage: $0.10/GB/month</li>
                </ul>
                <p class='info-note'><em>Note: Best for performance-focused, cost-conscious deployments.</em></p>"),

            Distribution.HetznerK8s => ("Hetzner Kubernetes", @"
                <div class='info-section'>
                    <p class='info-vendor'><strong>Vendor:</strong> Hetzner Cloud</p>
                    <p class='info-desc'>Kubernetes on Hetzner Cloud via tools like k3s or kubeadm. Known for exceptional price/performance.</p>
                </div>
                <h4>Node Architecture</h4>
                <ul>
                    <li><strong>Control Plane:</strong> Self-managed (k3s/kubeadm)</li>
                    <li><strong>Worker:</strong> Hetzner Cloud servers</li>
                    <li><strong>Dedicated:</strong> Bare metal option</li>
                </ul>
                <h4>Key Features</h4>
                <ul>
                    <li>Best price/performance ratio</li>
                    <li>European data centers (GDPR)</li>
                    <li>Excellent network performance</li>
                    <li>Dedicated server options</li>
                    <li>Community CSI/CCM drivers</li>
                </ul>
                <h4>Pricing</h4>
                <ul>
                    <li>Cloud servers: From â‚¬3.79/month</li>
                    <li>Dedicated: From â‚¬39/month</li>
                    <li>Block storage: â‚¬0.044/GB/month</li>
                </ul>
                <p class='info-note'><em>Note: Best for European deployments and cost-optimized workloads.</em></p>"),

            Distribution.OVHKubernetes => ("OVHcloud Managed Kubernetes", @"
                <div class='info-section'>
                    <p class='info-vendor'><strong>Vendor:</strong> OVHcloud</p>
                    <p class='info-desc'>European cloud provider with managed Kubernetes. Strong focus on data sovereignty and GDPR compliance.</p>
                </div>
                <h4>Node Architecture</h4>
                <ul>
                    <li><strong>Control Plane:</strong> Managed (free)</li>
                    <li><strong>Worker:</strong> OVHcloud instances</li>
                    <li><strong>Node Pools:</strong> Auto-scaling</li>
                </ul>
                <h4>Key Features</h4>
                <ul>
                    <li>Free control plane</li>
                    <li>European sovereignty (GDPR)</li>
                    <li>Integrated private registry</li>
                    <li>Load balancer included</li>
                    <li>Anti-DDoS protection</li>
                </ul>
                <h4>Pricing</h4>
                <ul>
                    <li>Control plane: FREE</li>
                    <li>Instances: From â‚¬8/month</li>
                    <li>Competitive European pricing</li>
                </ul>
                <p class='info-note'><em>Note: Best for European data sovereignty requirements.</em></p>"),

            Distribution.ScalewayKapsule => ("Scaleway Kapsule", @"
                <div class='info-section'>
                    <p class='info-vendor'><strong>Vendor:</strong> Scaleway</p>
                    <p class='info-desc'>French cloud provider with managed Kubernetes (Kapsule). European focus with green energy commitment.</p>
                </div>
                <h4>Node Architecture</h4>
                <ul>
                    <li><strong>Control Plane:</strong> Managed (free)</li>
                    <li><strong>Worker:</strong> Scaleway instances</li>
                    <li><strong>Kosmos:</strong> Multi-cloud option</li>
                </ul>
                <h4>Key Features</h4>
                <ul>
                    <li>Free control plane</li>
                    <li>European data centers</li>
                    <li>Green energy powered</li>
                    <li>Kosmos for multi-cloud</li>
                    <li>Integrated container registry</li>
                </ul>
                <h4>Pricing</h4>
                <ul>
                    <li>Control plane: FREE</li>
                    <li>Instances: From â‚¬7.12/month</li>
                    <li>Block storage: â‚¬0.04/GB/month</li>
                </ul>
                <p class='info-note'><em>Note: Best for European deployments with sustainability focus.</em></p>"),

            _ => ("Distribution Information", "<p>Select a distribution to see details.</p>")
        };
        showInfoModal = true;
    }

    private void ShowTechInfo(Technology tech)
    {
        (infoModalTitle, infoModalContent) = tech switch
        {
            Technology.DotNet => (".NET Framework/Core", @"
                <div class='info-section'>
                    <p class='info-vendor'><strong>Vendor:</strong> Microsoft</p>
                    <p class='info-desc'>Cross-platform framework for building modern cloud, web, and desktop applications.</p>
                </div>
                <h4>Resource Profile</h4>
                <table class='info-table'>
                    <tr><th>Tier</th><th>CPU</th><th>Memory</th></tr>
                    <tr><td>Small</td><td>0.25 cores</td><td>0.5 GB</td></tr>
                    <tr><td>Medium</td><td>0.5 cores</td><td>1 GB</td></tr>
                    <tr><td>Large</td><td>1 core</td><td>2 GB</td></tr>
                    <tr><td>X-Large</td><td>2 cores</td><td>4 GB</td></tr>
                </table>
                <h4>Deployment Considerations</h4>
                <ul>
                    <li>Excellent memory efficiency</li>
                    <li>Native AOT compilation available (.NET 8+)</li>
                    <li>Kestrel web server built-in</li>
                    <li>Best Windows and Azure integration</li>
                </ul>
                <h4>VM Deployment Roles</h4>
                <ul>
                    <li><strong>IIS Web Server:</strong> Windows Server with IIS</li>
                    <li><strong>SQL Server:</strong> Database tier</li>
                    <li><strong>Cache Server:</strong> Redis (optional)</li>
                </ul>"),

            Technology.Java => ("Java Enterprise", @"
                <div class='info-section'>
                    <p class='info-vendor'><strong>Vendor:</strong> Oracle / Eclipse Foundation</p>
                    <p class='info-desc'>Enterprise-grade runtime with extensive ecosystem. Higher memory footprint but excellent tooling.</p>
                </div>
                <h4>Resource Profile</h4>
                <table class='info-table'>
                    <tr><th>Tier</th><th>CPU</th><th>Memory</th></tr>
                    <tr><td>Small</td><td>0.5 cores</td><td>1 GB</td></tr>
                    <tr><td>Medium</td><td>1 core</td><td>2 GB</td></tr>
                    <tr><td>Large</td><td>2 cores</td><td>4 GB</td></tr>
                    <tr><td>X-Large</td><td>4 cores</td><td>8 GB</td></tr>
                </table>
                <h4>Deployment Considerations</h4>
                <ul>
                    <li>JVM requires more memory (heap + metaspace)</li>
                    <li>App servers: Tomcat, WildFly, WebLogic</li>
                    <li>Spring Boot for microservices</li>
                    <li>GraalVM for native compilation</li>
                </ul>
                <h4>VM Deployment Roles</h4>
                <ul>
                    <li><strong>Web Server:</strong> Apache/Nginx reverse proxy</li>
                    <li><strong>App Server:</strong> WebLogic, JBoss, Tomcat</li>
                    <li><strong>Database:</strong> Oracle, PostgreSQL, MySQL</li>
                    <li><strong>Cache:</strong> Redis, Memcached (optional)</li>
                </ul>"),

            Technology.NodeJs => ("Node.js", @"
                <div class='info-section'>
                    <p class='info-vendor'><strong>Vendor:</strong> OpenJS Foundation</p>
                    <p class='info-desc'>JavaScript runtime for event-driven, non-blocking I/O applications. Great for APIs and real-time apps.</p>
                </div>
                <h4>Resource Profile</h4>
                <table class='info-table'>
                    <tr><th>Tier</th><th>CPU</th><th>Memory</th></tr>
                    <tr><td>Small</td><td>0.25 cores</td><td>0.5 GB</td></tr>
                    <tr><td>Medium</td><td>0.5 cores</td><td>1 GB</td></tr>
                    <tr><td>Large</td><td>1 core</td><td>2 GB</td></tr>
                    <tr><td>X-Large</td><td>2 cores</td><td>4 GB</td></tr>
                </table>
                <h4>Deployment Considerations</h4>
                <ul>
                    <li>Single-threaded event loop</li>
                    <li>Use PM2 or cluster mode for multi-core</li>
                    <li>Watch memory for V8 heap limits</li>
                    <li>Great for I/O-bound workloads</li>
                </ul>
                <h4>VM Deployment Roles</h4>
                <ul>
                    <li><strong>Web/Proxy:</strong> Nginx reverse proxy</li>
                    <li><strong>App Server:</strong> Node.js with PM2</li>
                    <li><strong>Database:</strong> MongoDB, PostgreSQL, MySQL</li>
                    <li><strong>Cache:</strong> Redis (optional)</li>
                </ul>"),

            Technology.Python => ("Python", @"
                <div class='info-section'>
                    <p class='info-vendor'><strong>Vendor:</strong> Python Software Foundation</p>
                    <p class='info-desc'>Versatile language for web, data science, ML, and automation. Django/Flask for web apps.</p>
                </div>
                <h4>Resource Profile</h4>
                <table class='info-table'>
                    <tr><th>Tier</th><th>CPU</th><th>Memory</th></tr>
                    <tr><td>Small</td><td>0.25 cores</td><td>0.5 GB</td></tr>
                    <tr><td>Medium</td><td>0.5 cores</td><td>1 GB</td></tr>
                    <tr><td>Large</td><td>1 core</td><td>2 GB</td></tr>
                    <tr><td>X-Large</td><td>2 cores</td><td>4 GB</td></tr>
                </table>
                <h4>Deployment Considerations</h4>
                <ul>
                    <li>GIL limits CPU-bound parallelism</li>
                    <li>Use Gunicorn/uWSGI for WSGI apps</li>
                    <li>AsyncIO for async workloads</li>
                    <li>Consider worker processes for CPU tasks</li>
                </ul>
                <h4>VM Deployment Roles</h4>
                <ul>
                    <li><strong>Web Server:</strong> Nginx reverse proxy</li>
                    <li><strong>App Server:</strong> Gunicorn/uWSGI</li>
                    <li><strong>Database:</strong> PostgreSQL, MySQL</li>
                    <li><strong>Cache:</strong> Redis (optional)</li>
                </ul>"),

            Technology.Go => ("Go (Golang)", @"
                <div class='info-section'>
                    <p class='info-vendor'><strong>Vendor:</strong> Google</p>
                    <p class='info-desc'>Compiled language designed for simplicity and efficiency. Excellent for microservices and CLI tools.</p>
                </div>
                <h4>Resource Profile</h4>
                <table class='info-table'>
                    <tr><th>Tier</th><th>CPU</th><th>Memory</th></tr>
                    <tr><td>Small</td><td>0.125 cores</td><td>0.25 GB</td></tr>
                    <tr><td>Medium</td><td>0.25 cores</td><td>0.5 GB</td></tr>
                    <tr><td>Large</td><td>0.5 cores</td><td>1 GB</td></tr>
                    <tr><td>X-Large</td><td>1 core</td><td>2 GB</td></tr>
                </table>
                <h4>Deployment Considerations</h4>
                <ul>
                    <li>Single static binary - no runtime needed</li>
                    <li>Excellent memory efficiency</li>
                    <li>Built-in concurrency (goroutines)</li>
                    <li>Fast startup, minimal footprint</li>
                </ul>
                <h4>VM Deployment Roles</h4>
                <ul>
                    <li><strong>App Server:</strong> Go binary with built-in HTTP</li>
                    <li><strong>Database:</strong> PostgreSQL, MySQL, CockroachDB</li>
                    <li><strong>Cache:</strong> Redis (optional)</li>
                </ul>"),

            Technology.Mendix => ("Mendix Low-Code", @"
                <div class='info-section'>
                    <p class='info-vendor'><strong>Vendor:</strong> Siemens</p>
                    <p class='info-desc'>Enterprise low-code platform for rapid application development. Visual modeling with extensibility.</p>
                </div>
                <h4>Resource Profile</h4>
                <table class='info-table'>
                    <tr><th>Tier</th><th>CPU</th><th>Memory</th></tr>
                    <tr><td>Small</td><td>1 core</td><td>2 GB</td></tr>
                    <tr><td>Medium</td><td>2 cores</td><td>4 GB</td></tr>
                    <tr><td>Large</td><td>4 cores</td><td>8 GB</td></tr>
                    <tr><td>X-Large</td><td>8 cores</td><td>16 GB</td></tr>
                </table>
                <h4>Deployment Considerations</h4>
                <ul>
                    <li>Java-based runtime (higher memory needs)</li>
                    <li>Mendix Cloud or self-hosted</li>
                    <li>Can run on Kubernetes or VMs</li>
                    <li>Horizontal scaling supported</li>
                </ul>
                <h4>VM Deployment Roles</h4>
                <ul>
                    <li><strong>Mendix App Server:</strong> Runs Mendix runtime</li>
                    <li><strong>Database:</strong> PostgreSQL or SQL Server</li>
                    <li><strong>File Storage:</strong> For attachments (optional)</li>
                </ul>"),

            Technology.OutSystems => ("OutSystems Low-Code", @"
                <div class='info-section'>
                    <p class='info-vendor'><strong>Vendor:</strong> OutSystems</p>
                    <p class='info-desc'>Enterprise low-code platform with full-stack development capabilities. Generates native .NET/mobile code.</p>
                </div>
                <h4>Resource Profile</h4>
                <table class='info-table'>
                    <tr><th>Tier</th><th>CPU</th><th>Memory</th></tr>
                    <tr><td>Small</td><td>1 core</td><td>2 GB</td></tr>
                    <tr><td>Medium</td><td>2 cores</td><td>4 GB</td></tr>
                    <tr><td>Large</td><td>4 cores</td><td>8 GB</td></tr>
                    <tr><td>X-Large</td><td>8 cores</td><td>16 GB</td></tr>
                </table>
                <h4>Deployment Considerations</h4>
                <ul>
                    <li>Windows/.NET based platform</li>
                    <li>Requires SQL Server or Oracle DB</li>
                    <li>Controller + Front-End architecture</li>
                    <li>LifeTime for environment management</li>
                </ul>
                <h4>VM Deployment Roles</h4>
                <ul>
                    <li><strong>Deployment Controller:</strong> Compiles and deploys apps</li>
                    <li><strong>Front-End Server:</strong> Runs applications (scale out)</li>
                    <li><strong>Database:</strong> SQL Server or Oracle</li>
                    <li><strong>LifeTime:</strong> CI/CD and environment management</li>
                </ul>
                <p class='info-note'><em>Note: LifeTime is typically shared across all environments.</em></p>"),

            _ => ("Technology Information", "<p>Select a technology to see details.</p>")
        };
        showInfoModal = true;
    }

    // Data helpers
    private IEnumerable<TechInfo> GetAvailableTechnologies()
    {
        var isLowCode = selectedPlatform == PlatformType.LowCode;
        var isK8s = selectedDeployment == DeploymentModel.Kubernetes;
        var techs = new List<TechInfo>();

        if (isLowCode)
        {
            techs.Add(new TechInfo(Technology.Mendix, "Mendix", "Siemens", "mendix", "Enterprise low-code platform", true, "#0CABF9"));
            // OutSystems only supports VM deployment (K8s only available on OutSystems Cloud/ODC)
            if (!isK8s)
            {
                techs.Add(new TechInfo(Technology.OutSystems, "OutSystems", "OutSystems", "outsystems", "Enterprise low-code platform (VM only)", true, "#FF6B35"));
            }
        }
        else
        {
            techs.Add(new TechInfo(Technology.DotNet, ".NET", "Microsoft", "dotnet", "Cross-platform framework", false, "#512BD4"));
            techs.Add(new TechInfo(Technology.Java, "Java", "Oracle/OpenJDK", "java", "Enterprise runtime", false, "#007396"));
            techs.Add(new TechInfo(Technology.NodeJs, "Node.js", "OpenJS Foundation", "nodejs", "JavaScript runtime", false, "#339933"));
            techs.Add(new TechInfo(Technology.Python, "Python", "Python Software Foundation", "python", "Web, data science & automation", false, "#3776AB"));
            techs.Add(new TechInfo(Technology.Go, "Go", "Google", "go", "Lightweight compiled language", false, "#00ADD8"));
        }

        return techs;
    }

    private IEnumerable<DistroInfo> GetFilteredDistributions()
    {
        var distros = GetAllDistributions();

        // Apply type filter (tabs)
        IEnumerable<DistroInfo> filtered = distributionFilter switch
        {
            "on-prem" => distros.Where(d => d.Tags.Any(t => t.CssClass == "on-prem")),
            "cloud" => distros.Where(d => d.Tags.Any(t => t.CssClass == "cloud")),
            _ => distros
        };

        // Apply cloud sub-category filter (always applies for cloud since no "all" option)
        if (distributionFilter == "cloud")
        {
            filtered = cloudCategory switch
            {
                "major" => filtered.Where(d => d.Distribution is Distribution.EKS or Distribution.AKS or Distribution.GKE or Distribution.OKE or Distribution.IKS or Distribution.ACK or Distribution.TKE or Distribution.CCE),
                "openshift" => filtered.Where(d => d.Distribution is Distribution.OpenShiftROSA or Distribution.OpenShiftARO or Distribution.OpenShiftDedicated or Distribution.OpenShiftIBM),
                "rancher" => filtered.Where(d => d.Distribution is Distribution.RancherHosted or Distribution.RancherEKS or Distribution.RancherAKS or Distribution.RancherGKE or Distribution.K3sAWS or Distribution.K3sAzure or Distribution.K3sGCP or Distribution.RKE2AWS or Distribution.RKE2Azure or Distribution.RKE2GCP),
                "tanzu" => filtered.Where(d => d.Distribution is Distribution.TanzuCloud or Distribution.TanzuAWS or Distribution.TanzuAzure or Distribution.TanzuGCP),
                "ubuntu" => filtered.Where(d => d.Distribution is Distribution.CharmedAWS or Distribution.CharmedAzure or Distribution.CharmedGCP or Distribution.MicroK8sAWS or Distribution.MicroK8sAzure or Distribution.MicroK8sGCP),
                "developer" => filtered.Where(d => d.Distribution is Distribution.DOKS or Distribution.LKE or Distribution.VKE or Distribution.HetznerK8s or Distribution.OVHKubernetes or Distribution.ScalewayKapsule),
                _ => filtered
            };
        }

        // Apply search filter
        if (!string.IsNullOrWhiteSpace(distributionSearch))
        {
            var search = distributionSearch.ToLowerInvariant();
            filtered = filtered.Where(d =>
                d.Name.ToLowerInvariant().Contains(search) ||
                d.Vendor.ToLowerInvariant().Contains(search) ||
                d.Tags.Any(t => t.Label.ToLowerInvariant().Contains(search)));
        }

        return filtered;
    }

    private int GetDistributionCount(string filter)
    {
        var distros = GetAllDistributions();
        return filter switch
        {
            "on-prem" => distros.Count(d => d.Tags.Any(t => t.CssClass == "on-prem")),
            "cloud" => distros.Count(d => d.Tags.Any(t => t.CssClass == "cloud")),
            _ => distros.Count
        };
    }

    private int GetCloudCategoryCount(string category)
    {
        var cloudDistros = GetAllDistributions().Where(d => d.Tags.Any(t => t.CssClass == "cloud"));
        return category switch
        {
            "all" => cloudDistros.Count(),
            "major" => cloudDistros.Count(d => d.Distribution is Distribution.EKS or Distribution.AKS or Distribution.GKE or Distribution.OKE or Distribution.IKS or Distribution.ACK or Distribution.TKE or Distribution.CCE),
            "openshift" => cloudDistros.Count(d => d.Distribution is Distribution.OpenShiftROSA or Distribution.OpenShiftARO or Distribution.OpenShiftDedicated or Distribution.OpenShiftIBM),
            "rancher" => cloudDistros.Count(d => d.Distribution is Distribution.RancherHosted or Distribution.RancherEKS or Distribution.RancherAKS or Distribution.RancherGKE or Distribution.K3sAWS or Distribution.K3sAzure or Distribution.K3sGCP or Distribution.RKE2AWS or Distribution.RKE2Azure or Distribution.RKE2GCP),
            "tanzu" => cloudDistros.Count(d => d.Distribution is Distribution.TanzuCloud or Distribution.TanzuAWS or Distribution.TanzuAzure or Distribution.TanzuGCP),
            "ubuntu" => cloudDistros.Count(d => d.Distribution is Distribution.CharmedAWS or Distribution.CharmedAzure or Distribution.CharmedGCP or Distribution.MicroK8sAWS or Distribution.MicroK8sAzure or Distribution.MicroK8sGCP),
            "developer" => cloudDistros.Count(d => d.Distribution is Distribution.DOKS or Distribution.LKE or Distribution.VKE or Distribution.HetznerK8s or Distribution.OVHKubernetes or Distribution.ScalewayKapsule),
            _ => 0
        };
    }

    private List<DistroInfo> GetAllDistributions()
    {
        return new List<DistroInfo>
        {
            // ========== On-Premises Distributions ==========
            new(Distribution.OpenShift, "OpenShift (On-Prem)", "Red Hat", "openshift", "#EE0000", new[] { ("enterprise", "Enterprise"), ("on-prem", "On-Prem"), ("infra", "Infra Nodes") }),
            new(Distribution.Kubernetes, "Kubernetes", "CNCF", "kubernetes", "#326CE5", new[] { ("free", "Free"), ("on-prem", "On-Prem") }),
            new(Distribution.Rancher, "Rancher (On-Prem)", "SUSE", "rancher", "#0075A8", new[] { ("free", "Free"), ("on-prem", "On-Prem") }),
            new(Distribution.RKE2, "RKE2", "SUSE", "rke2", "#0075A8", new[] { ("free", "Free"), ("on-prem", "On-Prem"), ("security", "Security") }),
            new(Distribution.K3s, "K3s", "SUSE", "k3s", "#FFC61C", new[] { ("free", "Free"), ("on-prem", "On-Prem"), ("lightweight", "Lightweight") }),
            new(Distribution.MicroK8s, "MicroK8s", "Canonical", "microk8s", "#E95420", new[] { ("free", "Free"), ("on-prem", "On-Prem") }),
            new(Distribution.Charmed, "Charmed Kubernetes", "Canonical", "charmed", "#772953", new[] { ("enterprise", "Enterprise"), ("on-prem", "On-Prem") }),
            new(Distribution.Tanzu, "VMware Tanzu (On-Prem)", "Broadcom", "tanzu", "#1D428A", new[] { ("enterprise", "Enterprise"), ("on-prem", "On-Prem") }),

            // ========== OpenShift Cloud Variants ==========
            new(Distribution.OpenShiftROSA, "OpenShift ROSA", "Red Hat / AWS", "openshift", "#EE0000", new[] { ("enterprise", "Enterprise"), ("cloud", "Cloud"), ("managed", "Managed"), ("infra", "Infra Nodes") }),
            new(Distribution.OpenShiftARO, "OpenShift ARO", "Red Hat / Azure", "openshift", "#EE0000", new[] { ("enterprise", "Enterprise"), ("cloud", "Cloud"), ("managed", "Managed"), ("infra", "Infra Nodes") }),
            new(Distribution.OpenShiftDedicated, "OpenShift Dedicated", "Red Hat / GCP", "openshift", "#EE0000", new[] { ("enterprise", "Enterprise"), ("cloud", "Cloud"), ("managed", "Managed"), ("infra", "Infra Nodes") }),
            new(Distribution.OpenShiftIBM, "OpenShift on IBM", "Red Hat / IBM", "openshift", "#EE0000", new[] { ("enterprise", "Enterprise"), ("cloud", "Cloud"), ("managed", "Managed"), ("infra", "Infra Nodes") }),

            // ========== Rancher/SUSE Cloud Variants ==========
            new(Distribution.RancherHosted, "Rancher Hosted", "SUSE", "rancher", "#0075A8", new[] { ("cloud", "Cloud"), ("managed", "Managed") }),
            new(Distribution.RancherEKS, "Rancher on EKS", "SUSE / AWS", "rancher", "#0075A8", new[] { ("cloud", "Cloud"), ("managed", "Managed") }),
            new(Distribution.RancherAKS, "Rancher on AKS", "SUSE / Azure", "rancher", "#0075A8", new[] { ("cloud", "Cloud"), ("managed", "Managed") }),
            new(Distribution.RancherGKE, "Rancher on GKE", "SUSE / Google", "rancher", "#0075A8", new[] { ("cloud", "Cloud"), ("managed", "Managed") }),

            // ========== Tanzu Cloud Variants ==========
            new(Distribution.TanzuCloud, "VMware Tanzu Cloud", "Broadcom", "tanzu", "#1D428A", new[] { ("enterprise", "Enterprise"), ("cloud", "Cloud"), ("managed", "Managed") }),
            new(Distribution.TanzuAWS, "Tanzu on AWS", "Broadcom / AWS", "tanzu", "#1D428A", new[] { ("enterprise", "Enterprise"), ("cloud", "Cloud"), ("managed", "Managed") }),
            new(Distribution.TanzuAzure, "Tanzu on Azure", "Broadcom / Azure", "tanzu", "#1D428A", new[] { ("enterprise", "Enterprise"), ("cloud", "Cloud"), ("managed", "Managed") }),
            new(Distribution.TanzuGCP, "Tanzu on GCP", "Broadcom / Google", "tanzu", "#1D428A", new[] { ("enterprise", "Enterprise"), ("cloud", "Cloud"), ("managed", "Managed") }),

            // ========== Canonical/Ubuntu Cloud Variants ==========
            new(Distribution.CharmedAWS, "Charmed K8s on AWS", "Canonical / AWS", "charmed", "#772953", new[] { ("cloud", "Cloud"), ("ubuntu", "Ubuntu") }),
            new(Distribution.CharmedAzure, "Charmed K8s on Azure", "Canonical / Azure", "charmed", "#772953", new[] { ("cloud", "Cloud"), ("ubuntu", "Ubuntu") }),
            new(Distribution.CharmedGCP, "Charmed K8s on GCP", "Canonical / Google", "charmed", "#772953", new[] { ("cloud", "Cloud"), ("ubuntu", "Ubuntu") }),
            new(Distribution.MicroK8sAWS, "MicroK8s on AWS", "Canonical / AWS", "microk8s", "#E95420", new[] { ("cloud", "Cloud"), ("ubuntu", "Ubuntu"), ("lightweight", "Lightweight") }),
            new(Distribution.MicroK8sAzure, "MicroK8s on Azure", "Canonical / Azure", "microk8s", "#E95420", new[] { ("cloud", "Cloud"), ("ubuntu", "Ubuntu"), ("lightweight", "Lightweight") }),
            new(Distribution.MicroK8sGCP, "MicroK8s on GCP", "Canonical / Google", "microk8s", "#E95420", new[] { ("cloud", "Cloud"), ("ubuntu", "Ubuntu"), ("lightweight", "Lightweight") }),

            // ========== K3s Cloud Variants ==========
            new(Distribution.K3sAWS, "K3s on AWS", "SUSE / AWS", "k3s", "#FFC61C", new[] { ("cloud", "Cloud"), ("lightweight", "Lightweight") }),
            new(Distribution.K3sAzure, "K3s on Azure", "SUSE / Azure", "k3s", "#FFC61C", new[] { ("cloud", "Cloud"), ("lightweight", "Lightweight") }),
            new(Distribution.K3sGCP, "K3s on GCP", "SUSE / Google", "k3s", "#FFC61C", new[] { ("cloud", "Cloud"), ("lightweight", "Lightweight") }),

            // ========== RKE2 Cloud Variants ==========
            new(Distribution.RKE2AWS, "RKE2 on AWS", "SUSE / AWS", "rke2", "#0075A8", new[] { ("cloud", "Cloud"), ("security", "Security") }),
            new(Distribution.RKE2Azure, "RKE2 on Azure", "SUSE / Azure", "rke2", "#0075A8", new[] { ("cloud", "Cloud"), ("security", "Security") }),
            new(Distribution.RKE2GCP, "RKE2 on GCP", "SUSE / Google", "rke2", "#0075A8", new[] { ("cloud", "Cloud"), ("security", "Security") }),

            // ========== Major Cloud Managed K8s ==========
            new(Distribution.EKS, "Amazon EKS", "AWS", "eks", "#FF9900", new[] { ("cloud", "Cloud"), ("managed", "Managed") }),
            new(Distribution.AKS, "Azure AKS", "Microsoft", "aks", "#0078D4", new[] { ("cloud", "Cloud"), ("managed", "Managed") }),
            new(Distribution.GKE, "Google GKE", "Google", "gke", "#4285F4", new[] { ("cloud", "Cloud"), ("managed", "Managed") }),
            new(Distribution.OKE, "Oracle OKE", "Oracle", "oke", "#C74634", new[] { ("cloud", "Cloud"), ("managed", "Managed") }),
            new(Distribution.IKS, "IBM Kubernetes", "IBM", "iks", "#054ADA", new[] { ("cloud", "Cloud"), ("managed", "Managed") }),
            new(Distribution.ACK, "Alibaba ACK", "Alibaba", "ack", "#FF6A00", new[] { ("cloud", "Cloud"), ("managed", "Managed") }),
            new(Distribution.TKE, "Tencent TKE", "Tencent", "tke", "#00A4FF", new[] { ("cloud", "Cloud"), ("managed", "Managed") }),
            new(Distribution.CCE, "Huawei CCE", "Huawei", "cce", "#CF0A2C", new[] { ("cloud", "Cloud"), ("managed", "Managed") }),

            // ========== Developer-Friendly Cloud K8s ==========
            new(Distribution.DOKS, "DigitalOcean DOKS", "DigitalOcean", "doks", "#0080FF", new[] { ("cloud", "Cloud"), ("managed", "Managed"), ("developer", "Developer") }),
            new(Distribution.LKE, "Linode LKE", "Akamai", "lke", "#00A95C", new[] { ("cloud", "Cloud"), ("managed", "Managed"), ("developer", "Developer") }),
            new(Distribution.VKE, "Vultr VKE", "Vultr", "vke", "#007BFC", new[] { ("cloud", "Cloud"), ("managed", "Managed"), ("developer", "Developer") }),
            new(Distribution.HetznerK8s, "Hetzner K8s", "Hetzner", "hetzner", "#D50C2D", new[] { ("cloud", "Cloud"), ("developer", "Developer"), ("cost", "Cost-Effective") }),
            new(Distribution.OVHKubernetes, "OVHcloud K8s", "OVH", "ovh", "#000E9C", new[] { ("cloud", "Cloud"), ("managed", "Managed"), ("developer", "Developer") }),
            new(Distribution.ScalewayKapsule, "Scaleway Kapsule", "Scaleway", "scaleway", "#4F0599", new[] { ("cloud", "Cloud"), ("managed", "Managed"), ("developer", "Developer") }),
        };
    }

    private string GetTechnologyName(Technology? tech) => tech switch
    {
        Technology.DotNet => ".NET",
        Technology.Java => "Java",
        Technology.NodeJs => "Node.js",
        Technology.Python => "Python",
        Technology.Go => "Go",
        Technology.Mendix => "Mendix",
        Technology.OutSystems => "OutSystems",
        _ => "Unknown"
    };

    private string GetDistributionName(Distribution? distro) => distro switch
    {
        // On-Premises
        Distribution.OpenShift => "OpenShift (On-Prem)",
        Distribution.Kubernetes => "Kubernetes",
        Distribution.Rancher => "Rancher (On-Prem)",
        Distribution.RKE2 => "RKE2",
        Distribution.K3s => "K3s",
        Distribution.MicroK8s => "MicroK8s",
        Distribution.Charmed => "Charmed",
        Distribution.Tanzu => "Tanzu (On-Prem)",

        // OpenShift Cloud
        Distribution.OpenShiftROSA => "OpenShift ROSA",
        Distribution.OpenShiftARO => "OpenShift ARO",
        Distribution.OpenShiftDedicated => "OpenShift Dedicated",
        Distribution.OpenShiftIBM => "OpenShift on IBM",

        // Rancher Cloud
        Distribution.RancherHosted => "Rancher Hosted",
        Distribution.RancherEKS => "Rancher on EKS",
        Distribution.RancherAKS => "Rancher on AKS",
        Distribution.RancherGKE => "Rancher on GKE",

        // Tanzu Cloud
        Distribution.TanzuCloud => "Tanzu Cloud",
        Distribution.TanzuAWS => "Tanzu on AWS",
        Distribution.TanzuAzure => "Tanzu on Azure",
        Distribution.TanzuGCP => "Tanzu on GCP",

        // Canonical/Ubuntu Cloud
        Distribution.CharmedAWS => "Charmed K8s on AWS",
        Distribution.CharmedAzure => "Charmed K8s on Azure",
        Distribution.CharmedGCP => "Charmed K8s on GCP",
        Distribution.MicroK8sAWS => "MicroK8s on AWS",
        Distribution.MicroK8sAzure => "MicroK8s on Azure",
        Distribution.MicroK8sGCP => "MicroK8s on GCP",

        // K3s Cloud
        Distribution.K3sAWS => "K3s on AWS",
        Distribution.K3sAzure => "K3s on Azure",
        Distribution.K3sGCP => "K3s on GCP",

        // RKE2 Cloud
        Distribution.RKE2AWS => "RKE2 on AWS",
        Distribution.RKE2Azure => "RKE2 on Azure",
        Distribution.RKE2GCP => "RKE2 on GCP",

        // Major Cloud K8s
        Distribution.EKS => "Amazon EKS",
        Distribution.AKS => "Azure AKS",
        Distribution.GKE => "Google GKE",
        Distribution.OKE => "Oracle OKE",
        Distribution.IKS => "IBM Kubernetes",
        Distribution.ACK => "Alibaba ACK",
        Distribution.TKE => "Tencent TKE",
        Distribution.CCE => "Huawei CCE",

        // Developer Cloud K8s
        Distribution.DOKS => "DigitalOcean DOKS",
        Distribution.LKE => "Linode LKE",
        Distribution.VKE => "Vultr VKE",
        Distribution.HetznerK8s => "Hetzner K8s",
        Distribution.OVHKubernetes => "OVHcloud K8s",
        Distribution.ScalewayKapsule => "Scaleway Kapsule",

        _ => "Unknown"
    };

    // Records and classes
    private record TechInfo(Technology Technology, string Name, string Vendor, string Icon, string Description, bool IsLowCode, string BrandColor);
    private record DistroTag(string CssClass, string Label);
    private record DistroInfo(Distribution Distribution, string Name, string Vendor, string Icon, string BrandColor, (string CssClass, string Label)[] TagData)
    {
        public IEnumerable<DistroTag> Tags => TagData.Select(t => new DistroTag(t.CssClass, t.Label));
    }

    // NodeSpecsConfig is now in InfraSizingCalculator.Models namespace

    public class UICalculatorSettings
    {
        // Infrastructure thresholds
        public int LargeDeploymentThreshold { get; set; } = 50;
        public int LargeClusterThreshold { get; set; } = 100;
        public int AppsPerInfraNode { get; set; } = 25;
        public int MinProdInfraLarge { get; set; } = 5;
        public int MinProdInfraSmall { get; set; } = 3;
        public int MaxInfraNodes { get; set; } = 10;

        // Kubernetes parameters - Production
        public double ProdCpuOvercommit { get; set; } = 1.0;
        public double ProdMemoryOvercommit { get; set; } = 1.0;
        public int ProdResourceBuffer { get; set; } = 30;

        // Kubernetes parameters - Non-Production
        public double NonProdCpuOvercommit { get; set; } = 1.0;
        public double NonProdMemoryOvercommit { get; set; } = 1.0;
        public int NonProdResourceBuffer { get; set; } = 15;

        // System settings
        public int NodeSystemReserve { get; set; } = 15;
        public int MinWorkerNodes { get; set; } = 3;

        // Headroom
        public int HeadroomDev { get; set; } = 33;
        public int HeadroomTest { get; set; } = 33;
        public int HeadroomStage { get; set; } = 0;
        public double HeadroomProd { get; set; } = 37.5;
        public double HeadroomDR { get; set; } = 37.5;

        // Replicas
        public int ReplicasDev { get; set; } = 1;
        public int ReplicasTest { get; set; } = 1;
        public int ReplicasStage { get; set; } = 2;
        public int ReplicasProd { get; set; } = 3;
        public int ReplicasDR { get; set; } = 3;

        // Default node specs - Control Plane
        public int ProdMasterCpu { get; set; } = 8;
        public int ProdMasterRam { get; set; } = 32;
        public int ProdMasterDisk { get; set; } = 200;
        public int NonProdMasterCpu { get; set; } = 8;
        public int NonProdMasterRam { get; set; } = 32;
        public int NonProdMasterDisk { get; set; } = 100;

        // Default node specs - Infrastructure
        public int ProdInfraCpu { get; set; } = 8;
        public int ProdInfraRam { get; set; } = 32;
        public int ProdInfraDisk { get; set; } = 500;
        public int NonProdInfraCpu { get; set; } = 8;
        public int NonProdInfraRam { get; set; } = 32;
        public int NonProdInfraDisk { get; set; } = 200;

        // Default node specs - Worker
        public int ProdWorkerCpu { get; set; } = 16;
        public int ProdWorkerRam { get; set; } = 64;
        public int ProdWorkerDisk { get; set; } = 200;
        public int NonProdWorkerCpu { get; set; } = 8;
        public int NonProdWorkerRam { get; set; } = 32;
        public int NonProdWorkerDisk { get; set; } = 100;

        // .NET tier specs
        public double DotNetSmallCpu { get; set; } = 0.25;
        public double DotNetSmallRam { get; set; } = 0.5;
        public double DotNetMediumCpu { get; set; } = 0.5;
        public double DotNetMediumRam { get; set; } = 1;
        public double DotNetLargeCpu { get; set; } = 1;
        public double DotNetLargeRam { get; set; } = 2;
        public double DotNetXLargeCpu { get; set; } = 2;
        public double DotNetXLargeRam { get; set; } = 4;

        // Java tier specs
        public double JavaSmallCpu { get; set; } = 0.5;
        public double JavaSmallRam { get; set; } = 1;
        public double JavaMediumCpu { get; set; } = 1;
        public double JavaMediumRam { get; set; } = 2;
        public double JavaLargeCpu { get; set; } = 2;
        public double JavaLargeRam { get; set; } = 4;
        public double JavaXLargeCpu { get; set; } = 4;
        public double JavaXLargeRam { get; set; } = 8;

        // Node.js tier specs (Small RAM increased to 1 GB per official docs - V8 heap management)
        public double NodeJsSmallCpu { get; set; } = 0.25;
        public double NodeJsSmallRam { get; set; } = 1;
        public double NodeJsMediumCpu { get; set; } = 0.5;
        public double NodeJsMediumRam { get; set; } = 1;
        public double NodeJsLargeCpu { get; set; } = 1;
        public double NodeJsLargeRam { get; set; } = 2;
        public double NodeJsXLargeCpu { get; set; } = 2;
        public double NodeJsXLargeRam { get; set; } = 4;

        // Python tier specs (Small RAM increased to 1 GB per official docs - WSGI/Django overhead)
        public double PythonSmallCpu { get; set; } = 0.25;
        public double PythonSmallRam { get; set; } = 1;
        public double PythonMediumCpu { get; set; } = 0.5;
        public double PythonMediumRam { get; set; } = 1;
        public double PythonLargeCpu { get; set; } = 1;
        public double PythonLargeRam { get; set; } = 2;
        public double PythonXLargeCpu { get; set; } = 2;
        public double PythonXLargeRam { get; set; } = 4;

        // Go tier specs
        public double GoSmallCpu { get; set; } = 0.125;
        public double GoSmallRam { get; set; } = 0.25;
        public double GoMediumCpu { get; set; } = 0.25;
        public double GoMediumRam { get; set; } = 0.5;
        public double GoLargeCpu { get; set; } = 0.5;
        public double GoLargeRam { get; set; } = 1;
        public double GoXLargeCpu { get; set; } = 1;
        public double GoXLargeRam { get; set; } = 2;

        // Mendix tier specs
        public double MendixSmallCpu { get; set; } = 0.5;
        public double MendixSmallRam { get; set; } = 1;
        public double MendixMediumCpu { get; set; } = 1;
        public double MendixMediumRam { get; set; } = 2;
        public double MendixLargeCpu { get; set; } = 2;
        public double MendixLargeRam { get; set; } = 4;
        public double MendixXLargeCpu { get; set; } = 4;
        public double MendixXLargeRam { get; set; } = 8;

        // Mendix Operator settings
        public int MendixOperatorReplicas { get; set; } = 2;
    }
}
