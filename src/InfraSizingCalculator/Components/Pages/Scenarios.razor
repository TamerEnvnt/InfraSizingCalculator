@page "/scenarios"
@rendermode InteractiveServer

@*
    Scenarios.razor - v0.4.4 Scenarios List Page
    Matches wireframe: 17-scenarios.html

    - Auth header with user info
    - My Scenarios title with count
    - Search + Filter + New Scenario toolbar
    - 3-column grid of scenario cards
*@

@using InfraSizingCalculator.Models
@using InfraSizingCalculator.Models.Pricing
@using InfraSizingCalculator.Services
@using InfraSizingCalculator.Services.Interfaces
@using InfraSizingCalculator.Services.Auth
@using InfraSizingCalculator.Data.Identity
@inject IScenarioService ScenarioService
@inject ConfigurationSharingService SharingService
@inject NavigationManager NavigationManager
@inject IAuthService AuthService

<PageTitle>Scenarios - Infrastructure Sizing Calculator</PageTitle>

<div class="scenarios-page" data-testid="scenarios-page">
    <!-- Header - Auth -->
    <header class="page-header-bar">
        <div class="header-logo" @onclick="NavigateToLanding" style="cursor: pointer;">InfraSizing Calculator</div>
        <div class="header-right">
            <a href="/settings" class="btn btn-ghost btn-sm">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4"/>
                </svg>
            </a>
            <div class="user-info" @onclick="NavigateToLanding" style="cursor: pointer;">
                <div class="user-avatar">@GetUserInitials()</div>
                <span class="user-name">@_displayName</span>
            </div>
        </div>
    </header>

    <!-- Scenarios Content -->
    <div class="scenarios-content">
        <!-- Header -->
        <div class="scenarios-header">
            <div>
                <h1>My Scenarios</h1>
                <p class="scenarios-count">@scenarios.Count scenarios saved</p>
            </div>
            <div class="scenarios-toolbar">
                <div class="search-box">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/>
                    </svg>
                    <input type="text" placeholder="Search scenarios..." @bind="searchQuery" @bind:event="oninput" />
                </div>
                <button class="filter-btn" @onclick="ToggleFilterDropdown">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>
                    </svg>
                    @GetFilterLabel()
                </button>
                <a href="/dashboard/k8s" class="btn btn-primary btn-sm">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    New Scenario
                </a>
            </div>
        </div>

        @if (_showFilterDropdown)
        {
            <div class="filter-dropdown">
                <button class="filter-option @(filterType == "" ? "active" : "")" @onclick='() => SetFilter("")'>All</button>
                <button class="filter-option @(filterType == "k8s" ? "active" : "")" @onclick='() => SetFilter("k8s")'>Kubernetes</button>
                <button class="filter-option @(filterType == "vm" ? "active" : "")" @onclick='() => SetFilter("vm")'>VM</button>
            </div>
        }

        <!-- Scenarios Grid -->
        @if (isLoading)
        {
            <div class="empty-state">
                <p>Loading scenarios...</p>
            </div>
        }
        else if (!FilteredScenarios.Any())
        {
            <div class="empty-state">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                </svg>
                <p>No scenarios found. Create your first one!</p>
            </div>
        }
        else
        {
            <div class="scenarios-grid">
                @foreach (var scenario in FilteredScenarios)
                {
                    <div class="scenario-card" @onclick="() => OpenScenario(scenario)" data-testid="scenario-@scenario.Type">
                        <div class="scenario-card-header">
                            <span class="scenario-card-title">@scenario.Name</span>
                            <span class="badge badge-@scenario.Type">@(scenario.Type == "k8s" ? "K8s" : "VM")</span>
                        </div>
                        <div class="scenario-card-desc">@GetDescription(scenario)</div>
                        <div class="scenario-card-meta">@scenario.DistributionOrTechnology &bull; Modified @GetRelativeTime(scenario.CreatedAt)</div>
                        <div class="scenario-card-stats">
                            <div class="scenario-card-stat">
                                @if (scenario.Type == "k8s")
                                {
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="4" y="4" width="16" height="16" rx="2"/>
                                    </svg>
                                }
                                else
                                {
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="2" y="4" width="20" height="14" rx="2"/>
                                    </svg>
                                }
                                @scenario.TotalNodes @(scenario.Type == "k8s" ? "nodes" : "VMs")
                            </div>
                            <div class="scenario-card-stat">@FormatCurrency(scenario.MonthlyEstimate)/mo</div>
                        </div>
                    </div>
                }
            </div>
        }
    </div>
</div>

@code {
    private List<ScenarioSummary> scenarios = new();
    private bool isLoading = true;
    private string filterType = "";
    private string searchQuery = "";
    private bool _showFilterDropdown = false;
    private ApplicationUser? _currentUser;
    private string _displayName = "User";

    private IEnumerable<ScenarioSummary> FilteredScenarios
    {
        get
        {
            var filtered = scenarios.Where(s => !s.IsDraft);

            // Apply type filter
            if (filterType == "k8s")
                filtered = filtered.Where(s => s.Type == "k8s");
            else if (filterType == "vm")
                filtered = filtered.Where(s => s.Type == "vm");

            // Apply search
            if (!string.IsNullOrWhiteSpace(searchQuery))
            {
                var query = searchQuery.ToLowerInvariant();
                filtered = filtered.Where(s =>
                    s.Name.Contains(query, StringComparison.InvariantCultureIgnoreCase) ||
                    (s.DistributionOrTechnology?.Contains(query, StringComparison.InvariantCultureIgnoreCase) ?? false));
            }

            return filtered.OrderByDescending(s => s.CreatedAt);
        }
    }

    protected override async Task OnInitializedAsync()
    {
        _currentUser = await AuthService.GetCurrentUserAsync();
        _displayName = _currentUser?.DisplayName ?? "User";
        await LoadScenarios();
    }

    private async Task LoadScenarios()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            scenarios = await ScenarioService.GetScenarioSummariesAsync();
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private string GetUserInitials()
    {
        if (string.IsNullOrEmpty(_displayName) || _displayName == "User")
            return "U";

        var parts = _displayName.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
            return $"{parts[0][0]}{parts[1][0]}".ToUpper();
        if (parts.Length == 1 && parts[0].Length >= 1)
            return parts[0][0].ToString().ToUpper();
        return "U";
    }

    private void NavigateToLanding()
    {
        NavigationManager.NavigateTo("/landing");
    }

    private void ToggleFilterDropdown()
    {
        _showFilterDropdown = !_showFilterDropdown;
    }

    private void SetFilter(string type)
    {
        filterType = type;
        _showFilterDropdown = false;
    }

    private string GetFilterLabel()
    {
        return filterType switch
        {
            "k8s" => "K8s",
            "vm" => "VM",
            _ => "Filter"
        };
    }

    private string GetDescription(ScenarioSummary scenario)
    {
        if (scenario.TotalApps > 0)
            return $"{scenario.TotalApps} applications configured";
        return scenario.Type == "k8s" ? "Kubernetes cluster configuration" : "VM infrastructure configuration";
    }

    private async Task OpenScenario(ScenarioSummary scenario)
    {
        try
        {
            var fullScenario = await ScenarioService.GetScenarioAsync(scenario.Id);
            if (fullScenario == null)
            {
                var route = scenario.Type == "k8s" ? "/dashboard/k8s" : "/dashboard/vm";
                NavigationManager.NavigateTo(route);
                return;
            }

            string configParam;
            if (fullScenario.Type == "k8s" && fullScenario.K8sInput != null)
            {
                configParam = await SharingService.GenerateConfigParamAsync(fullScenario.K8sInput);
                NavigationManager.NavigateTo($"/dashboard/k8s?config={configParam}", forceLoad: true);
            }
            else if (fullScenario.Type == "vm" && fullScenario.VMInput != null)
            {
                configParam = await SharingService.GenerateConfigParamAsync(fullScenario.VMInput);
                NavigationManager.NavigateTo($"/dashboard/vm?config={configParam}", forceLoad: true);
            }
            else
            {
                var route = scenario.Type == "k8s" ? "/dashboard/k8s" : "/dashboard/vm";
                NavigationManager.NavigateTo(route);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"OpenScenario error: {ex.Message}");
            var route = scenario.Type == "k8s" ? "/dashboard/k8s" : "/dashboard/vm";
            NavigationManager.NavigateTo(route);
        }
    }

    private string FormatCurrency(decimal amount)
    {
        if (amount <= 0) return "N/A";
        if (amount >= 1_000_000)
            return $"${amount / 1_000_000:F1}M";
        if (amount >= 1_000)
            return $"${amount:N0}";
        return $"${amount:F0}";
    }

    private string GetRelativeTime(DateTime dateTime)
    {
        var diff = DateTime.UtcNow - dateTime;

        if (diff.TotalMinutes < 60)
            return $"{(int)diff.TotalMinutes} minutes ago";
        if (diff.TotalHours < 24)
            return $"{(int)diff.TotalHours} hours ago";
        if (diff.TotalDays < 2)
            return "yesterday";
        if (diff.TotalDays < 7)
            return $"{(int)diff.TotalDays} days ago";
        if (diff.TotalDays < 30)
            return $"{(int)(diff.TotalDays / 7)} weeks ago";

        return dateTime.ToString("MMM d, yyyy", System.Globalization.CultureInfo.InvariantCulture);
    }
}
