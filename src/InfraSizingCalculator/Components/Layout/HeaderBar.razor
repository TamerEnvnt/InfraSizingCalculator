@inject IJSRuntime JSRuntime
@inject ISettingsPersistenceService SettingsService
@inject NavigationManager Navigation
@using InfraSizingCalculator.Services.Interfaces

<header class="header-bar">
    <div class="header-left">
        <span class="logo-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="2" y="3" width="20" height="14" rx="2"/>
                <line x1="8" y1="21" x2="16" y2="21"/>
                <line x1="12" y1="17" x2="12" y2="21"/>
                <circle cx="7" cy="10" r="1.5" fill="currentColor"/>
                <circle cx="12" cy="10" r="1.5" fill="currentColor"/>
                <circle cx="17" cy="10" r="1.5" fill="currentColor"/>
            </svg>
        </span>
        <h1>Infrastructure Sizing Calculator</h1>
    </div>

    <div class="header-actions">
        <button class="header-btn settings-btn" @onclick="NavigateToSettings" title="Pricing & Defaults">
            <span class="btn-icon icon icon-settings"></span>
            <span class="btn-text">Settings</span>
        </button>
        <button class="header-btn" @onclick="OnScenariosClick">Saved</button>
        <button class="header-btn" @onclick="OnResetClick">Reset</button>
    </div>

    <div class="header-right">
        <button class="theme-toggle" @onclick="ToggleTheme" title="@(_isDark ? "Switch to Light Mode" : "Switch to Dark Mode")">
            @if (_isDark)
            {
                <span class="theme-icon icon icon-sun"></span>
            }
            else
            {
                <span class="theme-icon icon icon-moon"></span>
            }
        </button>
    </div>
</header>

@code {
    [Parameter] public EventCallback<string> OnAction { get; set; }

    private bool _isDark = true;

    private void NavigateToSettings() => Navigation.NavigateTo("/settings");
    private async Task OnScenariosClick() => await OnAction.InvokeAsync("scenarios");
    private async Task OnResetClick() => await OnAction.InvokeAsync("reset");

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                var theme = await JSRuntime.InvokeAsync<string>("ThemeManager.get");
                _isDark = theme == "dark";
                StateHasChanged();
            }
            catch
            {
                // Use default
            }
        }
    }

    private async Task ToggleTheme()
    {
        try
        {
            _isDark = !_isDark;
            var newTheme = _isDark ? "dark" : "light";
            await JSRuntime.InvokeVoidAsync("ThemeManager.apply", newTheme);
            await SettingsService.SetThemeAsync(newTheme);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Theme toggle error: {ex.Message}");
        }
    }
}

<style>
    .logo-icon {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        background: var(--accent-color);
        color: white;
        font-size: 0.7rem;
        font-weight: 700;
        border-radius: 6px;
    }

    .header-actions {
        display: flex;
        gap: 8px;
    }

    .header-btn {
        padding: 6px 12px;
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        color: var(--text-primary);
        font-size: 0.85rem;
        cursor: pointer;
        text-decoration: none;
        transition: all 0.2s ease;
    }

    .header-btn:hover {
        background: var(--bg-elevated, var(--bg-secondary));
    }

    .settings-btn {
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .btn-icon {
        font-size: 0.9rem;
    }

    .btn-text {
        font-size: 0.85rem;
    }

    .theme-toggle {
        width: 36px;
        height: 36px;
        padding: 0;
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        color: var(--text-primary);
        font-size: 1.1rem;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .theme-toggle:hover {
        background: var(--accent-color);
        border-color: var(--accent-color);
    }

    .theme-icon {
        line-height: 1;
    }
</style>
