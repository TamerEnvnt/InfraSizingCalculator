@using InfraSizingCalculator.Models.Pricing
@using InfraSizingCalculator.Services.Interfaces

<div class="outsystems-pricing-panel">
    <!-- Platform Selection -->
    <div class="config-section">
        <h3 class="section-header">Platform</h3>
        <div class="option-grid">
            <div class="option-card @(Config.Platform == OutSystemsPlatform.ODC ? "selected" : "")"
                 @onclick="() => SetPlatform(OutSystemsPlatform.ODC)">
                <span class="option-label">ODC</span>
                <span class="option-desc">OutSystems Developer Cloud - Cloud-native, Kubernetes-based</span>
                <span class="option-price">From @FormatCurrency(Settings.OdcPlatformBasePrice)/year</span>
            </div>
            <div class="option-card @(Config.Platform == OutSystemsPlatform.O11 ? "selected" : "")"
                 @onclick="() => SetPlatform(OutSystemsPlatform.O11)">
                <span class="option-label">O11</span>
                <span class="option-desc">OutSystems 11 - Traditional .NET platform</span>
                <span class="option-price">From @FormatCurrency(Settings.O11EnterpriseBasePrice)/year</span>
            </div>
        </div>
    </div>

    <!-- O11 Deployment Type Selection -->
    @if (Config.Platform == OutSystemsPlatform.O11)
    {
        <div class="config-section">
            <h3 class="section-header">Deployment Type</h3>
            <div class="option-grid">
                <div class="option-card @(Config.Deployment == OutSystemsDeployment.Cloud ? "selected" : "")"
                     @onclick="() => SetDeployment(OutSystemsDeployment.Cloud)">
                    <span class="option-label">OutSystems Cloud</span>
                    <span class="option-desc">Managed PaaS by OutSystems</span>
                </div>
                <div class="option-card @(Config.Deployment == OutSystemsDeployment.SelfManaged ? "selected" : "")"
                     @onclick="() => SetDeployment(OutSystemsDeployment.SelfManaged)">
                    <span class="option-label">Self-Managed</span>
                    <span class="option-desc">On-premises or private cloud</span>
                </div>
            </div>
        </div>
    }

    <!-- Region Selection -->
    <div class="config-section">
        <h3 class="section-header">Region</h3>
        <p class="hint">Affects Services pricing (Bootcamps, Expert Days)</p>
        <select class="region-select" @bind="Config.Region" @bind:after="RecalculateCost">
            @foreach (var region in Enum.GetValues<OutSystemsRegion>())
            {
                <option value="@region">@GetRegionDisplayName(region)</option>
            }
        </select>
    </div>

    <!-- Application Objects -->
    <details class="config-section expandable" open>
        <summary>
            <span class="section-title">Application Objects</span>
            <span class="section-badge">@Config.AOPacks pack(s)</span>
        </summary>
        <div class="section-content">
            <p class="info-text">
                AOs = Screens + Database Tables + API Methods. Each pack includes @Settings.AOPackSize AOs.
            </p>
            <div class="slider-group">
                <label>Total Application Objects: <strong>@Config.TotalApplicationObjects</strong></label>
                <input type="range"
                       min="150"
                       max="3000"
                       step="150"
                       value="@Config.TotalApplicationObjects"
                       @onchange="HandleAOChange" />
                <div class="slider-labels">
                    <span>150</span>
                    <span>1500</span>
                    <span>3000</span>
                </div>
            </div>
            <div class="ao-breakdown">
                <div class="breakdown-row">
                    <span class="label">Included in @(Config.Platform == OutSystemsPlatform.ODC ? "ODC Platform" : "O11 Enterprise")</span>
                    <span class="value">@Settings.AOPackSize AOs (1 pack)</span>
                </div>
                <div class="breakdown-row">
                    <span class="label">Additional AO packs</span>
                    <span class="value">@Math.Max(0, Config.AOPacks - 1) pack(s)</span>
                </div>
                @if (Config.AOPacks > 1)
                {
                    var aoPackPrice = Config.Platform == OutSystemsPlatform.ODC
                        ? Settings.OdcAOPackPrice
                        : Settings.O11AOPackPrice;
                    <div class="breakdown-row cost">
                        <span class="label">Additional AOs cost</span>
                        <span class="value">@FormatCurrency((Config.AOPacks - 1) * aoPackPrice)/year</span>
                    </div>
                }
            </div>
        </div>
    </details>

    <!-- Self-Managed Cloud Provider (O11 Self-Managed only) -->
    @if (Config.Platform == OutSystemsPlatform.O11 && Config.Deployment == OutSystemsDeployment.SelfManaged)
    {
        <details class="config-section expandable" open>
            <summary>
                <span class="section-title">Cloud Infrastructure</span>
                <span class="section-badge">@Config.CloudProvider</span>
            </summary>
            <div class="section-content">
                <div class="provider-selection">
                    <label>Infrastructure Provider</label>
                    <select @bind="Config.CloudProvider" @bind:after="RecalculateCost">
                        <option value="@OutSystemsCloudProvider.OnPremises">On-Premises</option>
                        <option value="@OutSystemsCloudProvider.Azure">Microsoft Azure</option>
                        <option value="@OutSystemsCloudProvider.AWS">Amazon Web Services</option>
                    </select>
                </div>

                @if (Config.CloudProvider == OutSystemsCloudProvider.Azure)
                {
                    <div class="instance-selection">
                        <label>Azure VM Instance Type</label>
                        <select @bind="Config.AzureInstanceType" @bind:after="RecalculateCost">
                            @foreach (var instance in Enum.GetValues<OutSystemsAzureInstanceType>())
                            {
                                <option value="@instance">@GetAzureInstanceDisplayName(instance)</option>
                            }
                        </select>
                        <p class="hint">Hourly rate: @FormatCurrency(Settings.AzureVMHourlyPricing.GetValueOrDefault(Config.AzureInstanceType, 0))/hour</p>
                    </div>
                }
                else if (Config.CloudProvider == OutSystemsCloudProvider.AWS)
                {
                    <div class="instance-selection">
                        <label>AWS EC2 Instance Type</label>
                        <select @bind="Config.AwsInstanceType" @bind:after="RecalculateCost">
                            @foreach (var instance in Enum.GetValues<OutSystemsAwsInstanceType>())
                            {
                                <option value="@instance">@GetAwsInstanceDisplayName(instance)</option>
                            }
                        </select>
                        <p class="hint">Hourly rate: @FormatCurrency(Settings.AwsEC2HourlyPricing.GetValueOrDefault(Config.AwsInstanceType, 0))/hour</p>
                    </div>
                }

                <div class="server-config">
                    <label>Front-End Servers per Environment</label>
                    <input type="number"
                           min="1"
                           max="10"
                           @bind="Config.FrontEndServersPerEnvironment"
                           @bind:after="RecalculateCost" />
                </div>

                <div class="server-config">
                    <label>Total Environments</label>
                    <input type="number"
                           min="1"
                           max="10"
                           @bind="Config.TotalEnvironments"
                           @bind:after="RecalculateCost" />
                </div>
            </div>
        </details>
    }

    <!-- User Licensing -->
    <details class="config-section expandable">
        <summary>
            <span class="section-title">User Licensing</span>
            <span class="section-badge">@GetUserLicenseSummary()</span>
        </summary>
        <div class="section-content">
            <div class="user-option">
                <label class="checkbox-container">
                    <input type="checkbox"
                           checked="@Config.UseUnlimitedUsers"
                           @onchange="HandleUnlimitedUsersToggle" />
                    <span class="checkbox-label">Unlimited Users</span>
                    <span class="checkbox-price">@FormatCurrency(Settings.UnlimitedUsersPerAOPack * Config.AOPacks)/year</span>
                </label>
                <p class="hint">Formula: $60,500 × @Config.AOPacks AO pack(s)</p>
            </div>

            @if (!Config.UseUnlimitedUsers)
            {
                <div class="user-inputs">
                    <div class="user-input">
                        <label>Internal Users</label>
                        <input type="number"
                               min="0"
                               max="100000"
                               @bind="Config.InternalUsers"
                               @bind:after="RecalculateCost" />
                        <span class="hint">
                            @if (Config.Platform == OutSystemsPlatform.ODC)
                            {
                                @:100 included, then @FormatCurrency(Settings.OdcInternalUserPackPrice) per 100 users
                            }
                            else
                            {
                                @:100 included (tiered pricing applies)
                            }
                        </span>
                    </div>
                    <div class="user-input">
                        <label>External Users</label>
                        <input type="number"
                               min="0"
                               max="10000000"
                               step="1000"
                               @bind="Config.ExternalUsers"
                               @bind:after="RecalculateCost" />
                        <span class="hint">
                            @if (Config.Platform == OutSystemsPlatform.ODC)
                            {
                                @:@FormatCurrency(Settings.OdcExternalUserPackPrice) per 1,000 users
                            }
                            else
                            {
                                @:Tiered pricing (starting at @FormatCurrency(4840m) per 1,000 users)
                            }
                        </span>
                    </div>
                </div>
            }
            else
            {
                <!-- AppShield User Volume when using Unlimited Users -->
                @if ((Config.Platform == OutSystemsPlatform.ODC && Config.OdcAppShield) ||
                     (Config.Platform == OutSystemsPlatform.O11 && Config.O11AppShield))
                {
                    <div class="user-input" style="margin-top: 1rem;">
                        <label>Expected User Volume (for AppShield pricing)</label>
                        <input type="number"
                               min="0"
                               max="15000000"
                               step="1000"
                               @bind="Config.AppShieldUserVolume"
                               @bind:after="RecalculateCost" />
                        <span class="hint">Required to calculate AppShield tier pricing</span>
                    </div>
                }
            }
        </div>
    </details>

    <!-- Platform-Specific Add-ons -->
    @if (Config.Platform == OutSystemsPlatform.ODC)
    {
        <!-- ODC Add-ons -->
        <details class="config-section expandable">
            <summary>
                <span class="section-title">ODC Add-ons</span>
                <span class="section-badge">@GetOdcAddonsCount() selected</span>
            </summary>
            <div class="section-content">
                <p class="info-text">Add-on costs scale with AO pack count: cost = rate × @Config.AOPacks pack(s)</p>

                <div class="addon-list">
                    <!-- Support Options -->
                    <div class="subsection-header">Support (mutually exclusive)</div>
                    <label class="addon-item">
                        <input type="radio"
                               name="odcSupport"
                               checked="@(!Config.OdcSupport24x7Extended && !Config.OdcSupport24x7Premium)"
                               @onchange="() => SetOdcSupport(null)" />
                        <span class="addon-name">8x5 Support (Included)</span>
                        <span class="addon-price">Included</span>
                    </label>
                    <label class="addon-item">
                        <input type="radio"
                               name="odcSupport"
                               checked="@Config.OdcSupport24x7Extended"
                               @onchange="() => SetOdcSupport(true)" />
                        <span class="addon-name">24x7 Extended Support</span>
                        <span class="addon-price">@FormatCurrency(Settings.OdcSupport24x7ExtendedPerPack * Config.AOPacks)/year</span>
                    </label>
                    <label class="addon-item">
                        <input type="radio"
                               name="odcSupport"
                               checked="@Config.OdcSupport24x7Premium"
                               @onchange="() => SetOdcSupport(false)" />
                        <span class="addon-name">24x7 Premium Support</span>
                        <span class="addon-price">@FormatCurrency(Settings.OdcSupport24x7PremiumPerPack * Config.AOPacks)/year</span>
                    </label>

                    <div class="subsection-header" style="margin-top: 1rem;">Other Add-ons</div>

                    <label class="addon-item">
                        <input type="checkbox"
                               checked="@Config.OdcHighAvailability"
                               @onchange="e => { Config.OdcHighAvailability = (bool)(e.Value ?? false); RecalculateCost(); }" />
                        <span class="addon-name">High Availability</span>
                        <span class="addon-price">@FormatCurrency(Settings.OdcHighAvailabilityPerPack * Config.AOPacks)/year</span>
                    </label>

                    <label class="addon-item">
                        <input type="checkbox"
                               checked="@Config.OdcPrivateGateway"
                               @onchange="e => { Config.OdcPrivateGateway = (bool)(e.Value ?? false); RecalculateCost(); }" />
                        <span class="addon-name">Private Gateway</span>
                        <span class="addon-price">@FormatCurrency(Settings.OdcPrivateGatewayPerPack * Config.AOPacks)/year</span>
                    </label>

                    <label class="addon-item">
                        <input type="checkbox"
                               checked="@Config.OdcSentry"
                               @onchange="e => { Config.OdcSentry = (bool)(e.Value ?? false); RecalculateCost(); }" />
                        <span class="addon-name">Sentry</span>
                        <span class="addon-price">@FormatCurrency(Settings.OdcSentryPerPack * Config.AOPacks)/year</span>
                    </label>

                    <label class="addon-item">
                        <input type="checkbox"
                               checked="@Config.OdcAppShield"
                               @onchange="e => { Config.OdcAppShield = (bool)(e.Value ?? false); RecalculateCost(); }" />
                        <span class="addon-name">AppShield</span>
                        <span class="addon-price">@GetAppShieldPrice()</span>
                    </label>

                    <div class="quantity-addon">
                        <label>Non-Production Runtimes</label>
                        <input type="number"
                               min="0"
                               max="10"
                               @bind="Config.OdcNonProdRuntimeQuantity"
                               @bind:after="RecalculateCost" />
                        <span class="hint">@FormatCurrency(Settings.OdcNonProdRuntimePerPack * Config.AOPacks) per runtime/year</span>
                    </div>
                </div>
            </div>
        </details>
    }
    else
    {
        <!-- O11 Add-ons -->
        <details class="config-section expandable">
            <summary>
                <span class="section-title">O11 Add-ons</span>
                <span class="section-badge">@GetO11AddonsCount() selected</span>
            </summary>
            <div class="section-content">
                <p class="info-text">Add-on costs scale with AO pack count: cost = rate × @Config.AOPacks pack(s)</p>

                <div class="addon-list">
                    <!-- Support -->
                    <label class="addon-item">
                        <input type="checkbox"
                               checked="@Config.O11Support24x7Premium"
                               @onchange="e => { Config.O11Support24x7Premium = (bool)(e.Value ?? false); RecalculateCost(); }" />
                        <span class="addon-name">24x7 Premium Support</span>
                        <span class="addon-price">@FormatCurrency(Settings.O11Support24x7PremiumPerPack * Config.AOPacks)/year</span>
                    </label>

                    @if (IsO11Cloud)
                    {
                        <!-- Cloud-only add-ons -->
                        <div class="subsection-header" style="margin-top: 1rem;">
                            Cloud-Only Features
                        </div>

                        <label class="addon-item @(Config.O11Sentry ? "ha-included" : "")">
                            <input type="checkbox"
                                   checked="@Config.O11HighAvailability"
                                   disabled="@Config.O11Sentry"
                                   @onchange="e => { Config.O11HighAvailability = (bool)(e.Value ?? false); RecalculateCost(); }" />
                            <span class="addon-name">High Availability</span>
                            <span class="cloud-badge">Cloud Only</span>
                            @if (Config.O11Sentry)
                            {
                                <span class="included-badge">Included with Sentry</span>
                            }
                            else
                            {
                                <span class="addon-price">@FormatCurrency(Settings.O11HighAvailabilityPerPack * Config.AOPacks)/year</span>
                            }
                        </label>

                        <label class="addon-item">
                            <input type="checkbox"
                                   checked="@Config.O11Sentry"
                                   @onchange="e => HandleO11SentryChange((bool)(e.Value ?? false))" />
                            <span class="addon-name">Sentry (includes HA)</span>
                            <span class="cloud-badge">Cloud Only</span>
                            <span class="addon-price">@FormatCurrency(Settings.O11SentryPerPack * Config.AOPacks)/year</span>
                        </label>

                        <div class="quantity-addon">
                            <label>Log Streaming</label>
                            <span class="cloud-badge small">Cloud Only</span>
                            <input type="number"
                                   min="0"
                                   max="5"
                                   @bind="Config.O11LogStreamingQuantity"
                                   @bind:after="RecalculateCost" />
                            <span class="hint">@FormatCurrency(Settings.O11LogStreamingFlat) flat fee each</span>
                        </div>

                        <div class="quantity-addon">
                            <label>Load Test Environment</label>
                            <span class="cloud-badge small">Cloud Only</span>
                            <input type="number"
                                   min="0"
                                   max="5"
                                   @bind="Config.O11LoadTestEnvQuantity"
                                   @bind:after="RecalculateCost" />
                            <span class="hint">@FormatCurrency(Settings.O11LoadTestEnvPerPack * Config.AOPacks) per env/year</span>
                        </div>

                        <div class="quantity-addon">
                            <label>Database Replica</label>
                            <span class="cloud-badge small">Cloud Only</span>
                            <input type="number"
                                   min="0"
                                   max="5"
                                   @bind="Config.O11DatabaseReplicaQuantity"
                                   @bind:after="RecalculateCost" />
                            <span class="hint">@FormatCurrency(Settings.O11DatabaseReplicaFlat) flat fee each</span>
                        </div>
                    }
                    else
                    {
                        <!-- Self-Managed only -->
                        <div class="subsection-header" style="margin-top: 1rem;">
                            Self-Managed Only
                        </div>

                        <label class="addon-item">
                            <input type="checkbox"
                                   checked="@Config.O11DisasterRecovery"
                                   @onchange="e => { Config.O11DisasterRecovery = (bool)(e.Value ?? false); RecalculateCost(); }" />
                            <span class="addon-name">Disaster Recovery</span>
                            <span class="sm-badge">Self-Managed Only</span>
                            <span class="addon-price">@FormatCurrency(Settings.O11DisasterRecoveryPerPack * Config.AOPacks)/year</span>
                        </label>
                    }

                    <div class="subsection-header" style="margin-top: 1rem;">Environments</div>

                    <div class="quantity-addon">
                        <label>Non-Production Environment</label>
                        <input type="number"
                               min="0"
                               max="10"
                               @bind="Config.O11NonProdEnvQuantity"
                               @bind:after="RecalculateCost" />
                        <span class="hint">@FormatCurrency(Settings.O11NonProdEnvPerPack * Config.AOPacks) per env/year</span>
                    </div>

                    <div class="quantity-addon">
                        <label>Environment Pack</label>
                        <input type="number"
                               min="0"
                               max="10"
                               @bind="Config.O11EnvPackQuantity"
                               @bind:after="RecalculateCost" />
                        <span class="hint">@FormatCurrency(Settings.O11EnvironmentPackPerPack * Config.AOPacks) per pack/year</span>
                    </div>

                    <div class="subsection-header" style="margin-top: 1rem;">Security</div>

                    <label class="addon-item">
                        <input type="checkbox"
                               checked="@Config.O11AppShield"
                               @onchange="e => { Config.O11AppShield = (bool)(e.Value ?? false); RecalculateCost(); }" />
                        <span class="addon-name">AppShield</span>
                        <span class="addon-price">@GetAppShieldPrice()</span>
                    </label>
                </div>
            </div>
        </details>
    }

    <!-- Services -->
    <details class="config-section expandable">
        <summary>
            <span class="section-title">Services & Support</span>
            <span class="section-badge">@GetServicesCount() items</span>
        </summary>
        <div class="section-content">
            @{
                var regionPricing = Settings.GetServicesPricing(Config.Region);
            }

            <div class="services-grid">
                <div class="service-input">
                    <label>Essential Success Plan</label>
                    <input type="number"
                           min="0"
                           max="5"
                           @bind="Config.EssentialSuccessPlanQuantity"
                           @bind:after="RecalculateCost" />
                    <span class="hint">@FormatCurrency(regionPricing.EssentialSuccessPlan)/year each</span>
                </div>

                <div class="service-input">
                    <label>Premier Success Plan</label>
                    <input type="number"
                           min="0"
                           max="5"
                           @bind="Config.PremierSuccessPlanQuantity"
                           @bind:after="RecalculateCost" />
                    <span class="hint">@FormatCurrency(regionPricing.PremierSuccessPlan)/year each</span>
                </div>

                <div class="service-input">
                    <label>Dedicated Group Sessions</label>
                    <input type="number"
                           min="0"
                           max="50"
                           @bind="Config.DedicatedGroupSessionQuantity"
                           @bind:after="RecalculateCost" />
                    <span class="hint">@FormatCurrency(regionPricing.DedicatedGroupSession) each</span>
                </div>

                <div class="service-input">
                    <label>Public Sessions</label>
                    <input type="number"
                           min="0"
                           max="100"
                           @bind="Config.PublicSessionQuantity"
                           @bind:after="RecalculateCost" />
                    <span class="hint">@FormatCurrency(regionPricing.PublicSession) each</span>
                </div>

                <div class="service-input">
                    <label>Expert Days</label>
                    <input type="number"
                           min="0"
                           max="100"
                           @bind="Config.ExpertDayQuantity"
                           @bind:after="RecalculateCost" />
                    <span class="hint">@FormatCurrency(regionPricing.ExpertDay)/day</span>
                </div>
            </div>
        </div>
    </details>

    <!-- Discount -->
    <details class="config-section expandable">
        <summary>
            <span class="section-title">Discount</span>
            <span class="section-badge">@GetDiscountSummary()</span>
        </summary>
        <div class="section-content">
            <div class="discount-grid">
                <div class="discount-input">
                    <label>Discount Type</label>
                    <select @bind="DiscountType" @bind:after="UpdateDiscount">
                        <option value="">None</option>
                        <option value="Percentage">Percentage</option>
                        <option value="FixedAmount">Fixed Amount</option>
                    </select>
                </div>

                @if (!string.IsNullOrEmpty(DiscountType))
                {
                    <div class="discount-input">
                        <label>@(DiscountType == "Percentage" ? "Discount %" : "Discount Amount ($)")</label>
                        <input type="number"
                               min="0"
                               max="@(DiscountType == "Percentage" ? 100 : 10000000)"
                               step="@(DiscountType == "Percentage" ? 1 : 100)"
                               @bind="DiscountValue"
                               @bind:after="UpdateDiscount" />
                    </div>

                    <div class="discount-input">
                        <label>Apply To</label>
                        <select @bind="DiscountScope" @bind:after="UpdateDiscount">
                            <option value="Total">Entire Quote</option>
                            <option value="LicenseOnly">License Only</option>
                            <option value="AddOnsOnly">Add-Ons Only</option>
                            <option value="ServicesOnly">Services Only</option>
                        </select>
                    </div>

                    <div class="discount-input full-width">
                        <label>Notes (optional)</label>
                        <input type="text"
                               placeholder="e.g., Partner discount, Renewal discount"
                               @bind="DiscountNotes"
                               @bind:after="UpdateDiscount" />
                    </div>
                }
            </div>
        </div>
    </details>

    <!-- Warnings -->
    @if (Result?.Warnings?.Count > 0)
    {
        <div class="warnings-section">
            @foreach (var warning in Result.Warnings)
            {
                <div class="warning-item">
                    <span class="warning-text">@warning</span>
                </div>
            }
        </div>
    }

    <!-- Cost Summary -->
    @if (Result != null)
    {
        <div class="cost-summary">
            <div class="summary-header">
                OutSystems @(Config.Platform) @(Config.Platform == OutSystemsPlatform.O11 ? $"({Config.Deployment})" : "") Cost Estimate
            </div>

            <!-- Detailed Breakdown -->
            <div class="cost-breakdown">
                <div class="breakdown-row">
                    <span class="label">License (Platform + AOs + Users)</span>
                    <span class="value">@FormatCurrency(Result.LicenseSubtotal)/year</span>
                </div>
                @if (Result.AddOnsSubtotal > 0)
                {
                    <div class="breakdown-row">
                        <span class="label">Add-ons</span>
                        <span class="value">@FormatCurrency(Result.AddOnsSubtotal)/year</span>
                    </div>
                }
                @if (Result.InfrastructureSubtotal > 0)
                {
                    <div class="breakdown-row">
                        <span class="label">Cloud Infrastructure (@Result.TotalVMCount VMs)</span>
                        <span class="value">@FormatCurrency(Result.InfrastructureSubtotal)/year</span>
                    </div>
                }
                @if (Result.ServicesSubtotal > 0)
                {
                    <div class="breakdown-row">
                        <span class="label">Services</span>
                        <span class="value">@FormatCurrency(Result.ServicesSubtotal)/year</span>
                    </div>
                }
                @if (Result.DiscountAmount > 0)
                {
                    <div class="breakdown-row discount">
                        <span class="label">Discount @(Result.DiscountDescription)</span>
                        <span class="value">-@FormatCurrency(Result.DiscountAmount)</span>
                    </div>
                }
            </div>

            <!-- Total Grid -->
            <div class="summary-grid">
                <div class="summary-item">
                    <span class="label">Monthly</span>
                    <span class="value">@FormatCurrency(Result.TotalPerMonth)</span>
                </div>
                <div class="summary-item primary">
                    <span class="label">Yearly</span>
                    <span class="value">@FormatCurrency(Result.NetTotal)</span>
                </div>
                <div class="summary-item">
                    <span class="label">3-Year TCO</span>
                    <span class="value">@FormatCurrency(Result.TotalThreeYear)</span>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public OutSystemsPricingSettings Settings { get; set; } = new();
    [Parameter] public OutSystemsDeploymentConfig Config { get; set; } = new();
    [Parameter] public EventCallback<OutSystemsDeploymentConfig> ConfigChanged { get; set; }
    [Parameter] public EventCallback<OutSystemsPricingResult> OnCostCalculated { get; set; }
    [Inject] private IPricingSettingsService? PricingService { get; set; }

    private OutSystemsPricingResult? Result { get; set; }
    private bool IsO11Cloud => Config.Platform == OutSystemsPlatform.O11 && Config.Deployment == OutSystemsDeployment.Cloud;

    // Discount state
    private string DiscountType { get; set; } = "";
    private decimal DiscountValue { get; set; }
    private string DiscountScope { get; set; } = "Total";
    private string DiscountNotes { get; set; } = "";

    protected override void OnInitialized()
    {
        SyncDiscountFromConfig();
        RecalculateCost();
    }

    protected override void OnParametersSet()
    {
        SyncDiscountFromConfig();
        RecalculateCost();
    }

    private void SyncDiscountFromConfig()
    {
        if (Config.Discount != null)
        {
            DiscountType = Config.Discount.Type.ToString();
            DiscountValue = Config.Discount.Value;
            DiscountScope = Config.Discount.Scope.ToString();
            DiscountNotes = Config.Discount.Notes ?? "";
        }
    }

    private void SetPlatform(OutSystemsPlatform platform)
    {
        Config.Platform = platform;

        // Reset platform-specific settings when switching
        if (platform == OutSystemsPlatform.ODC)
        {
            // ODC is always cloud-managed
            Config.Deployment = OutSystemsDeployment.Cloud;
            // Reset O11 add-ons
            Config.O11Support24x7Premium = false;
            Config.O11HighAvailability = false;
            Config.O11Sentry = false;
            Config.O11DisasterRecovery = false;
            Config.O11AppShield = false;
            Config.O11LogStreamingQuantity = 0;
            Config.O11LoadTestEnvQuantity = 0;
            Config.O11NonProdEnvQuantity = 0;
            Config.O11EnvPackQuantity = 0;
            Config.O11DatabaseReplicaQuantity = 0;
        }
        else
        {
            // Reset ODC add-ons
            Config.OdcSupport24x7Extended = false;
            Config.OdcSupport24x7Premium = false;
            Config.OdcHighAvailability = false;
            Config.OdcPrivateGateway = false;
            Config.OdcSentry = false;
            Config.OdcAppShield = false;
            Config.OdcNonProdRuntimeQuantity = 0;
        }

        RecalculateCost();
    }

    private void SetDeployment(OutSystemsDeployment deployment)
    {
        Config.Deployment = deployment;

        // Clear cloud-only features when switching to self-managed
        if (deployment == OutSystemsDeployment.SelfManaged)
        {
            Config.O11HighAvailability = false;
            Config.O11Sentry = false;
            Config.O11LogStreamingQuantity = 0;
            Config.O11LoadTestEnvQuantity = 0;
            Config.O11DatabaseReplicaQuantity = 0;
        }
        else
        {
            // Clear self-managed only features when switching to cloud
            Config.O11DisasterRecovery = false;
        }

        RecalculateCost();
    }

    private void SetOdcSupport(bool? extended)
    {
        if (extended == null)
        {
            Config.OdcSupport24x7Extended = false;
            Config.OdcSupport24x7Premium = false;
        }
        else if (extended.Value)
        {
            Config.OdcSupport24x7Extended = true;
            Config.OdcSupport24x7Premium = false;
        }
        else
        {
            Config.OdcSupport24x7Extended = false;
            Config.OdcSupport24x7Premium = true;
        }
        RecalculateCost();
    }

    private void HandleO11SentryChange(bool enabled)
    {
        Config.O11Sentry = enabled;
        if (enabled)
        {
            // Sentry includes HA
            Config.O11HighAvailability = false;
        }
        RecalculateCost();
    }

    private void HandleAOChange(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var value))
        {
            Config.TotalApplicationObjects = value;
            RecalculateCost();
        }
    }

    private void HandleUnlimitedUsersToggle(ChangeEventArgs e)
    {
        Config.UseUnlimitedUsers = (bool)(e.Value ?? false);
        RecalculateCost();
    }

    private void UpdateDiscount()
    {
        if (string.IsNullOrEmpty(DiscountType))
        {
            Config.Discount = null;
        }
        else
        {
            Config.Discount = new OutSystemsDiscount
            {
                Type = Enum.Parse<OutSystemsDiscountType>(DiscountType),
                Scope = Enum.Parse<OutSystemsDiscountScope>(DiscountScope),
                Value = DiscountValue,
                Notes = string.IsNullOrWhiteSpace(DiscountNotes) ? null : DiscountNotes
            };
        }
        RecalculateCost();
    }

    private async void RecalculateCost()
    {
        if (PricingService != null)
        {
            Result = PricingService.CalculateOutSystemsCost(Config);
            await ConfigChanged.InvokeAsync(Config);
            await OnCostCalculated.InvokeAsync(Result);
            StateHasChanged();
        }
    }

    private string GetUserLicenseSummary()
    {
        if (Config.UseUnlimitedUsers)
            return "Unlimited";
        return $"{Config.InternalUsers:N0} int, {Config.ExternalUsers:N0} ext";
    }

    private int GetOdcAddonsCount()
    {
        var count = 0;
        if (Config.OdcSupport24x7Extended || Config.OdcSupport24x7Premium) count++;
        if (Config.OdcHighAvailability) count++;
        if (Config.OdcPrivateGateway) count++;
        if (Config.OdcSentry) count++;
        if (Config.OdcAppShield) count++;
        count += Config.OdcNonProdRuntimeQuantity;
        return count;
    }

    private int GetO11AddonsCount()
    {
        var count = 0;
        if (Config.O11Support24x7Premium) count++;
        if (Config.O11HighAvailability) count++;
        if (Config.O11Sentry) count++;
        if (Config.O11DisasterRecovery) count++;
        if (Config.O11AppShield) count++;
        count += Config.O11LogStreamingQuantity;
        count += Config.O11LoadTestEnvQuantity;
        count += Config.O11NonProdEnvQuantity;
        count += Config.O11EnvPackQuantity;
        count += Config.O11DatabaseReplicaQuantity;
        return count;
    }

    private int GetServicesCount()
    {
        return Config.EssentialSuccessPlanQuantity +
               Config.PremierSuccessPlanQuantity +
               Config.DedicatedGroupSessionQuantity +
               Config.PublicSessionQuantity +
               Config.ExpertDayQuantity;
    }

    private string GetDiscountSummary()
    {
        if (Config.Discount == null || string.IsNullOrEmpty(DiscountType))
            return "None";

        if (Config.Discount.Type == OutSystemsDiscountType.Percentage)
            return $"{Config.Discount.Value}% off";
        return $"{FormatCurrency(Config.Discount.Value)} off";
    }

    private string GetAppShieldPrice()
    {
        int userVolume;
        if (Config.UseUnlimitedUsers)
        {
            userVolume = Config.AppShieldUserVolume ?? 0;
        }
        else
        {
            userVolume = Config.InternalUsers + Config.ExternalUsers;
        }

        var price = Settings.GetAppShieldPrice(userVolume);
        return $"{FormatCurrency(price)}/year";
    }

    private string GetRegionDisplayName(OutSystemsRegion region)
    {
        return region switch
        {
            OutSystemsRegion.Africa => "Africa",
            OutSystemsRegion.MiddleEast => "Middle East",
            OutSystemsRegion.Americas => "Americas",
            OutSystemsRegion.Europe => "Europe",
            OutSystemsRegion.AsiaPacific => "Asia Pacific",
            _ => region.ToString()
        };
    }

    private string GetAzureInstanceDisplayName(OutSystemsAzureInstanceType instance)
    {
        return instance switch
        {
            OutSystemsAzureInstanceType.F4s_v2 => "F4s_v2 (4 vCPU, 8 GB RAM)",
            OutSystemsAzureInstanceType.D4s_v3 => "D4s_v3 (4 vCPU, 16 GB RAM)",
            OutSystemsAzureInstanceType.D8s_v3 => "D8s_v3 (8 vCPU, 32 GB RAM)",
            OutSystemsAzureInstanceType.D16s_v3 => "D16s_v3 (16 vCPU, 64 GB RAM)",
            _ => instance.ToString()
        };
    }

    private string GetAwsInstanceDisplayName(OutSystemsAwsInstanceType instance)
    {
        return instance switch
        {
            OutSystemsAwsInstanceType.M5Large => "m5.large (2 vCPU, 8 GB RAM)",
            OutSystemsAwsInstanceType.M5XLarge => "m5.xlarge (4 vCPU, 16 GB RAM)",
            OutSystemsAwsInstanceType.M52XLarge => "m5.2xlarge (8 vCPU, 32 GB RAM)",
            _ => instance.ToString()
        };
    }

    private string FormatCurrency(decimal value)
    {
        return value.ToString("C0", System.Globalization.CultureInfo.GetCultureInfo("en-US"));
    }
}

<style>
    .outsystems-pricing-panel {
        max-width: 900px;
    }

    .config-section {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1.25rem;
        margin-bottom: 1rem;
    }

    .config-section.expandable {
        padding: 0;
    }

    .config-section.expandable summary {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 1rem 1.25rem;
        cursor: pointer;
        list-style: none;
    }

    .config-section.expandable summary::-webkit-details-marker {
        display: none;
    }

    .config-section.expandable summary::after {
        content: '\25B6';
        margin-left: auto;
        font-size: 0.75rem;
        color: var(--text-secondary);
        transition: transform 0.2s ease;
    }

    .config-section.expandable[open] summary::after {
        transform: rotate(90deg);
    }

    .section-header {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0 0 1rem 0;
    }

    .section-title {
        flex: 1;
        font-weight: 500;
        color: var(--text-primary);
    }

    .section-badge {
        background: var(--accent-color-light, rgba(33, 150, 243, 0.1));
        color: var(--accent-color);
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 500;
    }

    .section-content {
        padding: 0 1.25rem 1.25rem;
        border-top: 1px solid var(--border-color);
    }

    .option-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
    }

    .option-card {
        background: var(--surface-bg, #f8f9fa);
        border: 2px solid var(--border-color);
        border-radius: 8px;
        padding: 1.25rem;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .option-card:hover {
        border-color: var(--accent-color);
        background: var(--accent-color-light, rgba(33, 150, 243, 0.05));
    }

    .option-card.selected {
        border-color: var(--accent-color);
        background: var(--accent-color-light, rgba(33, 150, 243, 0.1));
    }

    .option-label {
        font-weight: 600;
        color: var(--text-primary);
    }

    .option-desc {
        font-size: 0.85rem;
        color: var(--text-secondary);
    }

    .option-price {
        font-weight: 600;
        color: var(--accent-color);
        margin-top: auto;
    }

    .region-select {
        width: 100%;
        max-width: 300px;
        padding: 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        background: var(--card-bg);
        color: var(--text-primary);
        font-size: 1rem;
        margin-top: 0.5rem;
    }

    .slider-group {
        margin: 1rem 0;
    }

    .slider-group label {
        display: block;
        margin-bottom: 0.5rem;
        color: var(--text-primary);
    }

    .slider-group input[type="range"] {
        width: 100%;
        height: 8px;
        border-radius: 4px;
        background: var(--border-color);
        cursor: pointer;
    }

    .slider-labels {
        display: flex;
        justify-content: space-between;
        font-size: 0.75rem;
        color: var(--text-secondary);
        margin-top: 0.5rem;
    }

    .ao-breakdown, .cost-breakdown {
        margin-top: 1rem;
    }

    .breakdown-row {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
        border-bottom: 1px dashed var(--border-color);
    }

    .breakdown-row.cost {
        border-bottom: none;
        font-weight: 600;
    }

    .breakdown-row.discount {
        color: var(--success-color, #2e7d32);
    }

    .breakdown-row .label {
        color: var(--text-secondary);
    }

    .breakdown-row .value {
        color: var(--text-primary);
    }

    .breakdown-row.cost .value {
        color: var(--accent-color);
    }

    .info-text {
        font-size: 0.875rem;
        color: var(--text-secondary);
        margin: 1rem 0;
        padding: 0.75rem;
        background: var(--info-bg, rgba(33, 150, 243, 0.05));
        border-radius: 6px;
        border-left: 3px solid var(--accent-color);
    }

    .hint {
        font-size: 0.8rem;
        color: var(--text-secondary);
        margin-top: 0.25rem;
    }

    .provider-selection, .instance-selection, .server-config {
        margin-bottom: 1rem;
    }

    .provider-selection label,
    .instance-selection label,
    .server-config label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: var(--text-primary);
    }

    .provider-selection select,
    .instance-selection select,
    .server-config input {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        background: var(--card-bg);
        color: var(--text-primary);
        font-size: 1rem;
    }

    .services-grid, .discount-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }

    .service-input label,
    .user-input label,
    .discount-input label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: var(--text-primary);
    }

    .service-input input,
    .user-input input,
    .discount-input input,
    .discount-input select {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        background: var(--card-bg);
        color: var(--text-primary);
        font-size: 1rem;
    }

    .discount-input.full-width {
        grid-column: 1 / -1;
    }

    .user-option {
        margin: 1rem 0;
    }

    .checkbox-container {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        cursor: pointer;
    }

    .checkbox-label {
        font-weight: 500;
        color: var(--text-primary);
    }

    .checkbox-price {
        color: var(--accent-color);
        font-weight: 600;
        margin-left: auto;
    }

    .user-inputs {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }

    .addon-list {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        margin-top: 1rem;
    }

    .addon-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem;
        background: var(--surface-bg, #f8f9fa);
        border-radius: 6px;
        cursor: pointer;
    }

    .addon-item:hover {
        background: var(--accent-color-light, rgba(33, 150, 243, 0.05));
    }

    .addon-item.ha-included {
        opacity: 0.6;
    }

    .addon-name {
        flex: 1;
        color: var(--text-primary);
    }

    .addon-price {
        font-weight: 600;
        color: var(--accent-color);
    }

    .cloud-badge, .sm-badge {
        font-size: 0.65rem;
        padding: 0.15rem 0.4rem;
        border-radius: 4px;
        text-transform: uppercase;
        font-weight: 600;
    }

    .cloud-badge {
        background: var(--info-bg, rgba(33, 150, 243, 0.1));
        color: var(--accent-color);
    }

    .cloud-badge.small {
        font-size: 0.6rem;
    }

    .sm-badge {
        background: var(--warning-bg, rgba(255, 152, 0, 0.1));
        color: var(--warning-color, #f57c00);
    }

    .included-badge {
        font-size: 0.75rem;
        color: var(--success-color, #2e7d32);
        font-style: italic;
    }

    .subsection-header {
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--text-secondary);
        margin-bottom: 0.5rem;
        margin-top: 0.5rem;
    }

    .quantity-addon {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem;
        background: var(--surface-bg, #f8f9fa);
        border-radius: 6px;
        flex-wrap: wrap;
    }

    .quantity-addon label {
        flex: 1;
        min-width: 150px;
        color: var(--text-primary);
        font-weight: 500;
    }

    .quantity-addon input {
        width: 80px;
        padding: 0.5rem;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        text-align: center;
    }

    .quantity-addon .hint {
        width: 100%;
        margin-top: 0.25rem;
    }

    .warnings-section {
        margin-bottom: 1rem;
    }

    .warning-item {
        display: flex;
        align-items: flex-start;
        gap: 0.5rem;
        padding: 0.75rem;
        background: var(--warning-bg, rgba(255, 152, 0, 0.1));
        border: 1px solid var(--warning-color, #f57c00);
        border-radius: 6px;
        margin-bottom: 0.5rem;
    }

    .warning-text {
        font-size: 0.875rem;
        color: var(--warning-color, #f57c00);
    }

    .cost-summary {
        background: linear-gradient(135deg, var(--accent-color) 0%, var(--accent-color-dark, #1565C0) 100%);
        border-radius: 8px;
        padding: 1.5rem;
        color: white;
    }

    .summary-header {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 1rem;
    }

    .cost-summary .cost-breakdown {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 6px;
        padding: 1rem;
        margin-bottom: 1rem;
    }

    .cost-summary .breakdown-row {
        border-bottom-color: rgba(255, 255, 255, 0.2);
    }

    .cost-summary .breakdown-row .label {
        color: rgba(255, 255, 255, 0.8);
    }

    .cost-summary .breakdown-row .value {
        color: white;
        font-weight: 500;
    }

    .cost-summary .breakdown-row.discount .value {
        color: #a5d6a7;
    }

    .summary-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
    }

    .summary-item {
        text-align: center;
        padding: 0.75rem;
        border-radius: 6px;
    }

    .summary-item.primary {
        background: rgba(255, 255, 255, 0.15);
    }

    .summary-item .label {
        display: block;
        font-size: 0.75rem;
        opacity: 0.8;
        margin-bottom: 0.25rem;
    }

    .summary-item .value {
        display: block;
        font-size: 1.25rem;
        font-weight: 700;
    }

    .summary-item.primary .value {
        font-size: 1.5rem;
    }
</style>
